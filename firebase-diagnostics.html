<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Diagnostika - CX.TECH Rack Manager</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #0ff;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { 
            color: #f89a55; 
            border-bottom: 2px solid #f89a55;
            padding-bottom: 0.5rem;
        }
        .test-section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .test-result {
            margin: 0.5rem 0;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        .success { background: rgba(0, 255, 0, 0.1); color: #0f0; }
        .error { background: rgba(255, 0, 0, 0.1); color: #f00; }
        .warning { background: rgba(255, 165, 0, 0.1); color: #fa0; }
        .info { background: rgba(0, 255, 255, 0.1); color: #0ff; }
        button {
            background: #f89a55;
            color: #000;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin: 0.25rem;
        }
        button:hover { background: #ff7a35; }
        pre {
            background: #000;
            padding: 0.5rem;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.8rem;
        }
        .spinner {
            border: 2px solid #333;
            border-top: 2px solid #f89a55;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>üîß Firebase Diagnostika - CX.TECH Rack Manager</h1>
    
    <div class="test-section">
        <h2>üìã Test 1: API Endpoint</h2>
        <button onclick="testAPIEndpoint()">Spustit test</button>
        <div id="apiTest"></div>
    </div>

    <div class="test-section">
        <h2>üî• Test 2: Firestore Inicializace</h2>
        <button onclick="testFirestoreInit()">Spustit test</button>
        <div id="firestoreTest"></div>
    </div>

    <div class="test-section">
        <h2>üíæ Test 3: Firestore Z√°pis</h2>
        <button onclick="testFirestoreWrite()">Spustit test</button>
        <div id="writeTest"></div>
    </div>

    <div class="test-section">
        <h2>üìñ Test 4: Firestore ƒåten√≠</h2>
        <button onclick="testFirestoreRead()">Spustit test</button>
        <div id="readTest"></div>
    </div>

    <div class="test-section">
        <h2>üîí Test 5: Security Rules</h2>
        <button onclick="testSecurityRules()">Spustit test</button>
        <div id="rulesTest"></div>
    </div>

    <div class="test-section">
        <h2>üåê Test 6: API Key Restrictions</h2>
        <button onclick="testAPIKeyRestrictions()">Spustit test</button>
        <div id="apiKeyTest"></div>
    </div>

    <div class="test-section">
        <h2>üöÄ Kompletn√≠ test</h2>
        <button onclick="runAllTests()">Spustit v≈°echny testy</button>
        <div id="allTests"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let firebaseApp = null;
        let firestoreDb = null;

        // Test 1: API Endpoint
        window.testAPIEndpoint = async function() {
            const testDiv = document.getElementById('apiTest');
            testDiv.innerHTML = '<div class="test-result info">‚è≥ Testov√°n√≠ API endpointu...</div>';
            
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                
                let html = '';
                if (response.ok) {
                    html += '<div class="test-result success">‚úÖ API endpoint funguje (status ' + response.status + ')</div>';
                    
                    const requiredFields = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
                    const missingFields = requiredFields.filter(field => !data[field]);
                    
                    if (missingFields.length === 0) {
                        html += '<div class="test-result success">‚úÖ V≈°echny povinn√© hodnoty jsou nastaven√©</div>';
                        html += '<div class="test-result info">Project ID: ' + data.projectId + '</div>';
                        html += '<div class="test-result info">API Key (prvn√≠ch 10 znak≈Ø): ' + data.apiKey.substring(0, 10) + '...</div>';
                    } else {
                        html += '<div class="test-result error">‚ùå Chyb√≠ hodnoty: ' + missingFields.join(', ') + '</div>';
                        html += '<div class="test-result warning">‚ö†Ô∏è Zkontrolujte environment variables v Vercelu</div>';
                    }
                } else {
                    html += '<div class="test-result error">‚ùå API endpoint vr√°til chybu ' + response.status + '</div>';
                    if (data.error) {
                        html += '<div class="test-result error">Chyba: ' + data.error + '</div>';
                    }
                    if (data.missing) {
                        html += '<div class="test-result error">Chyb√≠ promƒõnn√©: ' + data.missing.join(', ') + '</div>';
                    }
                }
                
                testDiv.innerHTML = html;
                return data;
            } catch (error) {
                testDiv.innerHTML = '<div class="test-result error">‚ùå Kritick√° chyba: ' + error.message + '</div>';
                return null;
            }
        }

        // Test 2: Firestore Inicializace
        window.testFirestoreInit = async function() {
            const testDiv = document.getElementById('firestoreTest');
            testDiv.innerHTML = '<div class="test-result info">‚è≥ Inicializace Firestore...</div>';
            
            try {
                // Nejd≈ô√≠v naƒç√≠st config
                const config = await testAPIEndpoint();
                if (!config || !config.apiKey) {
                    testDiv.innerHTML = '<div class="test-result error">‚ùå Nelze inicializovat bez platn√© konfigurace</div>';
                    return;
                }
                
                // Inicializovat Firebase
                if (!firebaseApp) {
                    firebaseApp = initializeApp(config);
                }
                firestoreDb = getFirestore(firebaseApp);
                
                testDiv.innerHTML = `
                    <div class="test-result success">‚úÖ Firebase App inicializov√°n</div>
                    <div class="test-result success">‚úÖ Firestore DB inicializov√°n</div>
                    <div class="test-result info">Project ID: ${firebaseApp.options.projectId}</div>
                `;
                
                window.firestoreTestDb = firestoreDb;
                return true;
            } catch (error) {
                testDiv.innerHTML = `
                    <div class="test-result error">‚ùå Chyba inicializace: ${error.message}</div>
                    <div class="test-result warning">Tip: Zkontrolujte API kl√≠ƒç v Firebase Console</div>
                `;
                return false;
            }
        }

        // Test 3: Firestore Z√°pis
        window.testFirestoreWrite = async function() {
            const testDiv = document.getElementById('writeTest');
            testDiv.innerHTML = '<div class="test-result info">‚è≥ Test z√°pisu do Firestore...</div>';
            
            try {
                if (!firestoreDb) {
                    await testFirestoreInit();
                    if (!firestoreDb) {
                        testDiv.innerHTML = '<div class="test-result error">‚ùå Firestore nen√≠ inicializov√°n</div>';
                        return;
                    }
                }
                
                const testData = {
                    test: true,
                    timestamp: new Date().toISOString(),
                    source: 'diagnostics',
                    random: Math.random()
                };
                
                const testId = 'test-' + Date.now();
                const docRef = doc(firestoreDb, "clients", testId);
                
                await setDoc(docRef, { rackData: testData }, { merge: true });
                
                testDiv.innerHTML = `
                    <div class="test-result success">‚úÖ Z√°pis √∫spƒõ≈°n√Ω!</div>
                    <div class="test-result info">Document ID: ${testId}</div>
                    <div class="test-result info">Data: <pre>${JSON.stringify(testData, null, 2)}</pre></div>
                `;
                
                window.lastTestId = testId;
                return true;
            } catch (error) {
                let errorHtml = `<div class="test-result error">‚ùå Chyba z√°pisu: ${error.message}</div>`;
                
                if (error.code === 'permission-denied') {
                    errorHtml += `
                        <div class="test-result warning">‚ö†Ô∏è Probl√©m s opr√°vnƒõn√≠mi</div>
                        <div class="test-result info">≈òe≈°en√≠:
                            <br>1. Firebase Console ‚Üí Firestore ‚Üí Rules
                            <br>2. Nastavte: allow read, write: if true;
                            <br>3. Kliknƒõte Publish
                        </div>
                    `;
                } else if (error.message.includes('API key')) {
                    errorHtml += `
                        <div class="test-result warning">‚ö†Ô∏è Probl√©m s API kl√≠ƒçem</div>
                        <div class="test-result info">≈òe≈°en√≠:
                            <br>1. Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials
                            <br>2. Najdƒõte v√°≈° API Key
                            <br>3. Zkontrolujte restrictions (mƒõl by obsahovat Firestore API)
                            <br>4. Nebo odstra≈àte v≈°echny restrictions pro test
                        </div>
                    `;
                }
                
                testDiv.innerHTML = errorHtml;
                return false;
            }
        }

        // Test 4: Firestore ƒåten√≠
        window.testFirestoreRead = async function() {
            const testDiv = document.getElementById('readTest');
            testDiv.innerHTML = '<div class="test-result info">‚è≥ Test ƒçten√≠ z Firestore...</div>';
            
            try {
                if (!firestoreDb) {
                    await testFirestoreInit();
                    if (!firestoreDb) {
                        testDiv.innerHTML = '<div class="test-result error">‚ùå Firestore nen√≠ inicializov√°n</div>';
                        return;
                    }
                }
                
                const testId = window.lastTestId || 'global';
                const docRef = doc(firestoreDb, "clients", testId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    testDiv.innerHTML = `
                        <div class="test-result success">‚úÖ ƒåten√≠ √∫spƒõ≈°n√©!</div>
                        <div class="test-result info">Document ID: ${testId}</div>
                        <div class="test-result info">Data: <pre>${JSON.stringify(data, null, 2)}</pre></div>
                    `;
                } else {
                    testDiv.innerHTML = `
                        <div class="test-result warning">‚ö†Ô∏è Dokument neexistuje: ${testId}</div>
                        <div class="test-result info">Zkuste nejd≈ô√≠v spustit Test 3 (Z√°pis)</div>
                    `;
                }
                return true;
            } catch (error) {
                testDiv.innerHTML = `
                    <div class="test-result error">‚ùå Chyba ƒçten√≠: ${error.message}</div>
                `;
                return false;
            }
        }

        // Test 5: Security Rules
        window.testSecurityRules = async function() {
            const testDiv = document.getElementById('rulesTest');
            testDiv.innerHTML = '<div class="test-result info">‚è≥ Test Security Rules...</div>';
            
            try {
                if (!firestoreDb) {
                    await testFirestoreInit();
                    if (!firestoreDb) {
                        testDiv.innerHTML = '<div class="test-result error">‚ùå Firestore nen√≠ inicializov√°n</div>';
                        return;
                    }
                }
                
                // Test r≈Øzn√Ωch operac√≠
                const tests = [];
                
                // Test 1: Z√°pis do clients collection
                try {
                    await setDoc(doc(firestoreDb, "clients", "rules-test"), { test: true }, { merge: true });
                    tests.push('<div class="test-result success">‚úÖ Z√°pis do /clients povolen</div>');
                } catch (e) {
                    tests.push('<div class="test-result error">‚ùå Z√°pis do /clients zak√°z√°n</div>');
                }
                
                // Test 2: ƒåten√≠ z clients collection
                try {
                    await getDoc(doc(firestoreDb, "clients", "rules-test"));
                    tests.push('<div class="test-result success">‚úÖ ƒåten√≠ z /clients povoleno</div>');
                } catch (e) {
                    tests.push('<div class="test-result error">‚ùå ƒåten√≠ z /clients zak√°z√°no</div>');
                }
                
                // Test 3: Test jin√© collection (mƒõla by selhat pokud rules jsou spr√°vnƒõ nastaven√©)
                try {
                    await setDoc(doc(firestoreDb, "test-collection", "test"), { test: true });
                    tests.push('<div class="test-result warning">‚ö†Ô∏è Z√°pis do jin√Ωch kolekc√≠ povolen (mo≈æn√© bezpeƒçnostn√≠ riziko)</div>');
                } catch (e) {
                    tests.push('<div class="test-result success">‚úÖ Z√°pis do jin√Ωch kolekc√≠ spr√°vnƒõ zak√°z√°n</div>');
                }
                
                testDiv.innerHTML = tests.join('');
            } catch (error) {
                testDiv.innerHTML = `<div class="test-result error">‚ùå Chyba testu: ${error.message}</div>`;
            }
        }

        // Test 6: API Key Restrictions
        window.testAPIKeyRestrictions = async function() {
            const testDiv = document.getElementById('apiKeyTest');
            testDiv.innerHTML = '<div class="test-result info">‚è≥ Kontrola API Key restrictions...</div>';
            
            let html = '';
            
            // Z√≠skat aktu√°ln√≠ URL
            const currentUrl = window.location.origin;
            html += `<div class="test-result info">üìç Aktu√°ln√≠ dom√©na: ${currentUrl}</div>`;
            
            // Testovat r≈Øzn√© Firebase slu≈æby
            try {
                if (!firestoreDb) {
                    await testFirestoreInit();
                }
                
                // Test Firestore
                try {
                    await getDoc(doc(firestoreDb, "test", "test"));
                    html += '<div class="test-result success">‚úÖ Firestore API funguje</div>';
                } catch (e) {
                    if (e.message.includes('API key')) {
                        html += '<div class="test-result error">‚ùå Firestore API - probl√©m s API key</div>';
                    }
                }
                
                html += `
                    <div class="test-result warning">
                        <strong>‚ö†Ô∏è Doporuƒçen√≠ pro API Key:</strong><br>
                        1. Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials<br>
                        2. Najdƒõte v√°≈° API Key<br>
                        3. V "Application restrictions" p≈ôidejte:<br>
                        &nbsp;&nbsp;‚Ä¢ ${currentUrl}/*<br>
                        &nbsp;&nbsp;‚Ä¢ https://*.vercel.app/* (pro preview deployments)<br>
                        &nbsp;&nbsp;‚Ä¢ http://localhost:* (pro lok√°ln√≠ v√Ωvoj)<br>
                        4. V "API restrictions" povolte:<br>
                        &nbsp;&nbsp;‚Ä¢ Cloud Firestore API<br>
                        &nbsp;&nbsp;‚Ä¢ Identity Toolkit API<br>
                        &nbsp;&nbsp;‚Ä¢ Firebase Installations API
                    </div>
                `;
            } catch (error) {
                html += `<div class="test-result error">‚ùå Test selhal: ${error.message}</div>`;
            }
            
            testDiv.innerHTML = html;
        }

        // Spustit v≈°echny testy
        window.runAllTests = async function() {
            const testDiv = document.getElementById('allTests');
            testDiv.innerHTML = '<div class="test-result info">‚è≥ Spou≈°t√≠m v≈°echny testy... <div class="spinner"></div></div>';
            
            const results = [];
            
            // Test 1
            results.push('üìã Test API Endpoint...');
            const apiResult = await testAPIEndpoint();
            results.push(apiResult ? '‚úÖ API Endpoint OK' : '‚ùå API Endpoint FAILED');
            
            // Test 2
            results.push('üî• Test Firestore Init...');
            const initResult = await testFirestoreInit();
            results.push(initResult ? '‚úÖ Firestore Init OK' : '‚ùå Firestore Init FAILED');
            
            if (initResult) {
                // Test 3
                results.push('üíæ Test Firestore Write...');
                const writeResult = await testFirestoreWrite();
                results.push(writeResult ? '‚úÖ Firestore Write OK' : '‚ùå Firestore Write FAILED');
                
                // Test 4
                results.push('üìñ Test Firestore Read...');
                const readResult = await testFirestoreRead();
                results.push(readResult ? '‚úÖ Firestore Read OK' : '‚ùå Firestore Read FAILED');
                
                // Test 5
                results.push('üîí Test Security Rules...');
                await testSecurityRules();
                results.push('‚úÖ Security Rules tested');
                
                // Test 6
                results.push('üåê Test API Key...');
                await testAPIKeyRestrictions();
                results.push('‚úÖ API Key tested');
            }
            
            let finalHtml = '<h3>üìä Souhrn test≈Ø:</h3>';
            finalHtml += results.map(r => `<div class="test-result ${r.includes('‚úÖ') ? 'success' : r.includes('‚ùå') ? 'error' : 'info'}">${r}</div>`).join('');
            
            if (results.filter(r => r.includes('‚ùå')).length === 0) {
                finalHtml += '<div class="test-result success"><strong>üéâ V≈°echny testy pro≈°ly! Firebase je spr√°vnƒõ nakonfigurov√°n.</strong></div>';
            } else {
                finalHtml += '<div class="test-result warning"><strong>‚ö†Ô∏è Nƒõkter√© testy selhaly. Zkontrolujte v√Ωsledky v√Ω≈°e.</strong></div>';
            }
            
            testDiv.innerHTML = finalHtml;
        }

        // Automaticky spustit test API p≈ôi naƒçten√≠
        window.addEventListener('load', () => {
            console.log('üîß Firebase Diagnostics loaded');
            console.log('üìç Current URL:', window.location.href);
            console.log('üîó API Endpoint:', window.location.origin + '/api/config');
        });
    </script>
</body>
</html>
