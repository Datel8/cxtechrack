<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CX.TECH Rack Manager Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* CX.TECH Brand Colors */
            --cx-orange: #f89a55;
            --cx-black: #000000;
            --cx-white: #ffffff;
            
            /* Application colors based on CX.TECH brand */
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --accent-primary: #f89a55;
            --accent-secondary: #ff7a35;
            --accent-tertiary: #ffaa75;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #3a3a3a;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
            --info: #60a5fa;
            
            /* Legacy color mappings for compatibility */
            --accent-cyan: var(--accent-primary);
            --accent-magenta: var(--accent-secondary);
            --accent-yellow: var(--accent-tertiary);
            --rack-bg: #0f0f0f;
            --rack-border: rgba(248, 154, 85, 0.3);
            --sidebar-bg: #0c0c0c;
            --panel-surface: #151515;
            --panel-surface-2: #1f1f1f;
            --shadow-soft: 0 20px 60px rgba(0, 0, 0, 0.45);
        }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body.auth-locked .app-shell {
            pointer-events: none;
            user-select: none;
            filter: blur(2px);
            opacity: 0.6;
        }
        
        /* Animated background with CX.TECH orange accents */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, var(--cx-orange) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, var(--cx-orange) 0%, transparent 40%),
                radial-gradient(circle at 40% 20%, var(--cx-orange) 0%, transparent 45%);
            opacity: 0.02;
            z-index: -1;
            animation: backgroundPulse 20s ease-in-out infinite;
        }
        
        @keyframes backgroundPulse {
            0%, 100% { opacity: 0.03; }
            50% { opacity: 0.06; }
        }
        
        /* MSP layout */
        .app-shell {
            display: grid;
            grid-template-columns: 320px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: linear-gradient(180deg, var(--sidebar-bg), #121212 80%);
            border-right: none;
            padding: 2rem 1.5rem;
            min-height: 100vh;
            position: relative;
            overflow: visible;
        }

        .sidebar-brand {
            margin-bottom: 2rem;
        }

        .brand-title {
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .brand-title .cx,
        .brand-title .tech {
            color: var(--cx-white);
        }

        .brand-title .dot {
            color: var(--cx-orange);
        }

        .brand-subtitle {
            margin-top: 0.35rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .sidebar-section {
            margin-bottom: 1.75rem;
        }

        .section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .sidebar-nav {
            display: grid;
            gap: 0.5rem;
        }

        .nav-btn {
            text-align: left;
            width: 100%;
            padding: 0.75rem 0.9rem;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--panel-surface);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .nav-btn.active {
            border-color: var(--cx-orange);
            box-shadow: 0 0 0 1px rgba(248, 154, 85, 0.4);
            background: linear-gradient(135deg, rgba(248, 154, 85, 0.25), rgba(20, 20, 20, 0.8));
        }

        .nav-btn:hover:not(.active) {
            transform: translateX(6px);
            border-color: rgba(248, 154, 85, 0.5);
        }

        .main-content {
            padding: 2rem;
        }

        .topbar {
            background: linear-gradient(120deg, #1b1b1b, #101010);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
            flex-wrap: wrap;
            box-shadow: var(--shadow-soft);
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .topbar::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 40%;
            height: 100%;
            background: radial-gradient(circle at right, rgba(248, 154, 85, 0.2), transparent 70%);
            opacity: 0.8;
        }

        .topbar-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .topbar-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.35rem;
        }

        .topbar-actions {
            display: grid;
            gap: 0.75rem;
            z-index: 1;
            padding: 0.9rem 1rem;
            border-radius: 16px;
            border: 1px solid rgba(248, 154, 85, 0.35);
            background: linear-gradient(160deg, rgba(18, 18, 18, 0.95), rgba(10, 10, 10, 0.9));
            min-width: 260px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-soft);
        }

        .topbar-actions::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 80% 20%, rgba(248, 154, 85, 0.2), transparent 55%);
            opacity: 0.7;
        }

        .topbar-actions > * {
            position: relative;
            z-index: 1;
        }

        .topbar-menu-title {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.24em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .session-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0.6rem;
            border-radius: 999px;
            border: 1px solid var(--border-color);
            background: rgba(8, 8, 8, 0.7);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .topbar-actions .auth-status {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: var(--text-secondary);
        }

        .topbar-menu-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
        }

        .topbar-actions .btn,
        .topbar-actions .btn-small,
        .topbar-actions .btn-secondary {
            width: 100%;
            padding: 0.6rem 0.95rem;
            font-size: 0.85rem;
        }

        .auth-status {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
        }

        .auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(8, 8, 8, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-card {
            background: var(--panel-surface-2);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            padding: 2rem;
            width: min(420px, 90vw);
            box-shadow: var(--shadow-soft);
            text-align: left;
        }

        .auth-card h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .auth-card p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .auth-stack {
            display: grid;
            gap: 0.75rem;
        }

        .auth-hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .role-manager-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .role-manager-table th,
        .role-manager-table td {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
        }

        .role-manager-table th {
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
        }

        .role-select {
            width: 100%;
            padding: 0.4rem 0.6rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
        }

        .role-note {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .role-invite-form {
            display: grid;
            grid-template-columns: 1fr 160px 140px;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .role-invite-form input {
            width: 100%;
            padding: 0.5rem 0.6rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
        }

        .role-invite-list {
            margin-top: 1rem;
        }

        @media (max-width: 1100px) {
            .app-shell {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: relative;
                height: auto;
            }

            .main-content {
                padding: 1.5rem;
            }

            .dashboard-shell {
                grid-template-columns: 1fr;
            }

            .dashboard-hero-card {
                grid-template-columns: 1fr;
                min-height: auto;
            }

            .dashboard-logo-wall {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
        }

        @media (max-width: 700px) {
            .sidebar {
                padding: 1.5rem 1rem;
            }

            .topbar {
                padding: 1rem 1.25rem;
            }

            .topbar-actions {
                width: 100%;
            }

            .dashboard-section {
                padding: 1.25rem;
            }

            .dashboard-hero-card {
                padding: 1.5rem;
            }

            .dashboard-logo-wall {
                grid-template-columns: 1fr;
            }

            .module-expansion-grid {
                grid-template-columns: 1fr;
            }

            .report-actions {
                align-items: stretch;
            }

            .report-actions .btn-small {
                width: 100%;
            }
        }
        
        .control-section {
            margin-bottom: 2rem;
        }
        
        .control-section h3 {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-weight: 500;
        }
        
        .btn {
            width: 100%;
            padding: 0.85rem 1.1rem;
            background: linear-gradient(135deg, var(--cx-orange), #ff6a25);
            color: var(--cx-white);
            border: none;
            border-radius: 12px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            line-height: 1.2;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: none;
            letter-spacing: 0.02em;
            margin-bottom: 0.5rem;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(248, 154, 85, 0.25);
            background: linear-gradient(135deg, #ff6a25, #ff915a);
        }
        
        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled,
        .btn-small:disabled,
        .delete-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: rgba(248, 154, 85, 0.08);
            border: 1px solid rgba(248, 154, 85, 0.55);
            color: var(--cx-orange);
        }
        
        .btn-secondary:hover {
            background: rgba(248, 154, 85, 0.16);
            border-color: rgba(248, 154, 85, 0.75);
            box-shadow: 0 6px 18px rgba(248, 154, 85, 0.2);
        }
        
        /* Form elements */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-family: 'IBM Plex Mono', monospace;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
        }
        
        /* Rack visualization */
        .rack-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-color);
        }
        
        .rack-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .rack-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .rack-stats {
            display: flex;
            gap: 2rem;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--accent-cyan);
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .rack-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        .rack {
            background: var(--rack-bg);
            border: 2px solid var(--rack-border);
            border-radius: 8px;
            padding: 1rem;
            position: relative;
            transition: all 0.3s;
        }
        
        .rack:hover {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
            transform: translateY(-4px);
        }
        
        .rack-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--accent-cyan);
        }
        
        .rack-units {
            display: flex;
            flex-direction: column-reverse;
            gap: 2px;
            background: #000;
            padding: 4px;
            border-radius: 4px;
        }
        
        .rack-unit {
            height: 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            position: relative;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.625rem;
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
        }
        
        .rack-unit.occupied {
            cursor: pointer;
            background: var(--device-gradient, var(--bg-tertiary));
            border-color: var(--device-color, var(--border-color));
            color: var(--device-text, var(--text-primary));
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.4rem;
            padding: 0 0.5rem;
            text-align: left;
        }
        
        
        .rack-unit.occupied:hover {
            transform: scaleX(1.05);
            z-index: 10;
            box-shadow: 0 0 20px currentColor;
        }

        .rack-unit-content {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 0.4rem;
            min-width: 0;
            flex: 1;
        }

        .rack-unit-name {
            font-weight: 600;
            font-size: 0.65rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        .rack-unit-ports {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.55rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .ports-count {
            font-family: 'IBM Plex Mono', monospace;
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.35);
            padding: 0.1rem 0.35rem;
            border-radius: 999px;
            color: var(--device-text, #ffffff);
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.4);
        }

        .ports-dots {
            display: inline-flex;
            gap: 2px;
        }

        .ports-dot {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            background: var(--device-text, rgba(255, 255, 255, 0.85));
            border: 1px solid rgba(0, 0, 0, 0.2);
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.35);
            opacity: 0.85;
        }

        .ports-overflow {
            font-size: 0.55rem;
            color: var(--device-text, rgba(255, 255, 255, 0.85));
        }
        
        /* Device info tooltip */
        .device-tooltip {
            position: fixed;
            background: linear-gradient(145deg, rgba(28, 28, 28, 0.96), rgba(12, 12, 12, 0.96));
            border: 1px solid rgba(248, 154, 85, 0.45);
            border-radius: 12px;
            padding: 1rem 1.1rem;
            z-index: 6000;
            min-width: 260px;
            max-width: 320px;
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
            display: none;
            animation: tooltipFadeIn 0.2s ease-out;
            pointer-events: none;
            backdrop-filter: blur(10px);
        }
        
        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .device-tooltip.active {
            display: block;
        }
        
        .tooltip-header {
            font-weight: 700;
            margin-bottom: 0.6rem;
            color: var(--accent-primary);
            font-family: 'IBM Plex Mono', monospace;
            letter-spacing: 0.03em;
        }
        
        .tooltip-detail {
            font-size: 0.78rem;
            color: var(--text-secondary);
            margin-bottom: 0.35rem;
            font-family: 'IBM Plex Mono', monospace;
        }
        
        /* Device list */
        .device-list {
            margin-top: 2rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-color);
        }
        
        .device-list h3 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }
        
        .device-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .device-table th {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 2px solid var(--border-color);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
        }
        
        .device-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
        }
        
        .device-table tr:hover {
            background: var(--bg-tertiary);
        }
        
        .device-type-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            background: var(--badge-bg, rgba(248, 154, 85, 0.15));
            color: var(--badge-color, var(--text-primary));
            border: 1px solid var(--badge-border, transparent);
        }
        
        .delete-btn {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s;
        }
        
        .delete-btn:hover {
            background: var(--danger);
            color: var(--text-primary);
        }

        /* Module management */
        .module-list {
            display: grid;
            gap: 0.75rem;
        }

        .module-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .module-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
        }

        .module-color {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .module-id {
            color: var(--text-secondary);
        }

        /* MSP modules */
        .msp-modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .msp-module-card {
            background: var(--panel-surface-2);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-height: 160px;
            box-shadow: 0 20px 35px rgba(0, 0, 0, 0.25);
            transition: transform 0.25s ease, border-color 0.25s ease;
        }

        .msp-module-card:hover {
            transform: translateY(-4px);
            border-color: rgba(248, 154, 85, 0.6);
        }

        .msp-module-title {
            font-size: 1.05rem;
            font-weight: 600;
        }

        .msp-module-meta {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-secondary);
        }

        .msp-module-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .msp-module-status {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--cx-orange);
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .overview-card {
            background: linear-gradient(135deg, rgba(248, 154, 85, 0.15), rgba(20, 20, 20, 0.9));
            border: 1px solid rgba(248, 154, 85, 0.4);
            border-radius: 14px;
            padding: 1.25rem;
            cursor: pointer;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }

        .overview-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
        }

        .overview-card-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: var(--text-secondary);
        }

        .overview-card-value {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 0.35rem;
        }

        .overview-card-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .overview-section {
            margin-top: 2rem;
        }

        .overview-section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .dashboard-view {
            display: block;
            background: transparent;
            border: none;
            padding: 0;
        }

        .dashboard-shell {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 320px;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .dashboard-hero-card {
            background: linear-gradient(150deg, rgba(248, 154, 85, 0.22), rgba(10, 10, 10, 0.95));
            border: 1px solid rgba(248, 154, 85, 0.45);
            border-radius: 24px;
            padding: 2rem;
            position: relative;
            overflow: hidden;
            min-height: 320px;
            display: grid;
            grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.8fr);
            gap: 1.5rem;
            box-shadow: var(--shadow-soft);
        }

        .dashboard-hero-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 15% 20%, rgba(248, 154, 85, 0.28), transparent 55%),
                        radial-gradient(circle at 80% 10%, rgba(248, 154, 85, 0.2), transparent 60%);
            opacity: 0.9;
        }

        .dashboard-hero-content {
            position: relative;
            z-index: 1;
            display: grid;
            gap: 0.75rem;
        }

        .dashboard-hero-kicker {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.28em;
            color: var(--text-secondary);
        }

        .dashboard-hero-title {
            font-size: 2rem;
            font-weight: 700;
        }

        .dashboard-hero-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
            max-width: 560px;
        }

        .dashboard-hero-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .dashboard-metric {
            background: rgba(8, 8, 8, 0.6);
            border: 1px solid rgba(248, 154, 85, 0.35);
            border-radius: 14px;
            padding: 0.85rem 1rem;
        }

        .dashboard-metric-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.22em;
            color: var(--text-secondary);
        }

        .dashboard-metric-value {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 0.45rem;
            color: var(--cx-orange);
        }

        .dashboard-logo-wall {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.75rem;
            align-content: start;
        }

        .dashboard-logo-title {
            grid-column: 1 / -1;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.22em;
            color: var(--text-secondary);
        }

        .dashboard-logo-slot {
            background: rgba(8, 8, 8, 0.65);
            border: 1px dashed rgba(248, 154, 85, 0.4);
            border-radius: 16px;
            padding: 0.9rem;
            min-height: 110px;
            display: grid;
            place-items: center;
            gap: 0.4rem;
            text-align: center;
        }

        .logo-mark {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--cx-orange), #ff6a25);
            color: #0b0b0b;
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 700;
            display: grid;
            place-items: center;
            letter-spacing: 0.12em;
        }

        .logo-caption {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--text-secondary);
        }

        .dashboard-rail {
            display: grid;
            gap: 1rem;
        }

        .dashboard-rail-card {
            background: linear-gradient(160deg, rgba(18, 18, 18, 0.95), rgba(10, 10, 10, 0.9));
            border: 1px solid var(--border-color);
            border-radius: 18px;
            padding: 1.25rem;
            box-shadow: var(--shadow-soft);
        }

        .dashboard-rail-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .dashboard-contact-list {
            display: grid;
            gap: 0.75rem;
        }

        .dashboard-contact-item {
            display: grid;
            gap: 0.25rem;
        }

        .dashboard-contact-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: var(--text-secondary);
        }

        .dashboard-contact-value {
            font-size: 0.9rem;
            color: var(--text-primary);
            word-break: break-word;
        }

        .dashboard-rail-actions {
            display: grid;
            gap: 0.6rem;
        }

        .dashboard-body {
            display: grid;
            gap: 1.5rem;
        }

        .dashboard-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: var(--shadow-soft);
        }

        .dashboard-section-alt {
            background: linear-gradient(160deg, rgba(248, 154, 85, 0.08), rgba(20, 20, 20, 0.92));
            border-color: rgba(248, 154, 85, 0.25);
        }

        .dashboard-section-head {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .dashboard-section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: var(--text-secondary);
        }

        .dashboard-section-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.35rem;
        }

        .dashboard-view .overview-grid {
            margin-top: 0.5rem;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        }

        .dashboard-view .overview-card {
            background: linear-gradient(140deg, rgba(16, 16, 16, 0.95), rgba(28, 28, 28, 0.9));
            border: 1px solid rgba(248, 154, 85, 0.25);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }

        .dashboard-view .overview-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(248, 154, 85, 0.2), transparent 60%);
            opacity: 0.9;
        }

        .dashboard-view .overview-card > * {
            position: relative;
            z-index: 1;
        }

        .dashboard-view .overview-card-title {
            font-size: 0.75rem;
        }

        .dashboard-view .overview-card-value {
            font-size: 2.2rem;
        }

        .dashboard-view .msp-modules-grid {
            margin-top: 0;
        }

        .dashboard-view .msp-module-card {
            background: linear-gradient(160deg, rgba(18, 18, 18, 0.95), rgba(10, 10, 10, 0.9));
            border: 1px solid rgba(248, 154, 85, 0.25);
        }

        .dashboard-view .msp-module-card:hover {
            border-color: rgba(248, 154, 85, 0.6);
        }

        .module-expansion {
            margin-top: 1rem;
            display: grid;
            gap: 0.6rem;
        }

        .module-expansion-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--text-secondary);
        }

        .module-expansion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
        }

        .module-expansion-tile {
            border: 1px dashed rgba(248, 154, 85, 0.35);
            border-radius: 14px;
            padding: 0.9rem;
            background: rgba(8, 8, 8, 0.6);
            display: grid;
            gap: 0.35rem;
        }

        .module-expansion-icon {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            background: rgba(248, 154, 85, 0.2);
            color: var(--cx-orange);
            display: grid;
            place-items: center;
            font-weight: 700;
        }

        .module-expansion-label {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .module-expansion-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .dashboard-grid {
            margin-top: 0.5rem;
        }

        .report-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .report-field {
            display: grid;
            gap: 0.25rem;
            min-width: 150px;
        }

        .report-field label {
            font-size: 0.7rem;
            text-transform: none;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .report-filters select,
        .report-filters input {
            padding: 0.4rem 0.6rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
        }

        .report-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            justify-content: space-between;
            margin-top: 1rem;
        }

        .report-actions-right {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .reports-layout {
            display: grid;
            grid-template-columns: minmax(260px, 320px) minmax(0, 1fr);
            gap: 1.75rem;
            align-items: start;
        }

        .reports-layout.reports-layout-single {
            grid-template-columns: 1fr;
        }

        .report-filter-panel {
            display: grid;
            gap: 1rem;
        }

        .reports-layout-single .report-filter-panel {
            width: 100%;
            max-width: 760px;
            margin: 0 auto;
        }

        .report-filter-card {
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 16px;
            padding: 1.25rem;
            color: #1c1c1c;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.06);
        }

        .report-filter-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: #6f6a63;
            margin-bottom: 0.85rem;
            font-weight: 600;
        }

        .report-filter-card-full {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .report-filter-section {
            display: grid;
            gap: 0.85rem;
        }

        .report-filter-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: #6f6a63;
            font-weight: 600;
        }

        .report-filter-divider {
            height: 1px;
            background: #eee5da;
        }

        .report-filter-card-full .report-actions {
            margin-top: auto;
        }

        .report-form-grid {
            display: grid;
            gap: 0.85rem;
        }

        .report-form-row {
            display: grid;
            gap: 0.35rem;
        }

        .report-share-row {
            display: grid;
            grid-template-columns: auto minmax(0, 1fr);
            gap: 0.75rem;
            align-items: center;
        }

        .report-share-actions {
            display: grid;
            gap: 0.75rem;
        }

        .report-share-note {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .report-form-row label {
            font-size: 0.7rem;
            color: #7a756e;
            letter-spacing: 0.08em;
        }

        .report-action-row {
            display: grid;
            gap: 0.5rem;
        }

        .report-display {
            min-height: 420px;
            display: flex;
            justify-content: flex-start;
            align-items: stretch;
            width: 100%;
        }

        .report-sheet {
            background: #ffffff;
            border-radius: 18px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            padding: 2rem;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.08);
            color: #1c1c1c;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        .report-sheet-wide {
            max-width: none;
            padding: 2.5rem;
            margin: 0;
        }

        .report-sheet-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1.5rem;
        }

        .report-sheet-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .report-live {
            display: inline-flex;
            align-items: center;
            padding: 0.1rem 0.5rem;
            border-radius: 999px;
            background: rgba(34, 197, 94, 0.12);
            color: #1f7a44;
            font-size: 0.7rem;
            margin-left: 0.4rem;
        }

        .report-sheet-subtitle {
            margin-top: 0.3rem;
            color: #7a756e;
            font-size: 0.85rem;
        }

        .report-sheet-logo {
            font-weight: 700;
            letter-spacing: 0.08em;
            color: #f89a55;
            font-size: 1rem;
        }

        .report-sheet-toolbar {
            display: flex;
            justify-content: flex-end;
            margin: 1rem 0 0.75rem;
        }

        .report-sheet-meta {
            display: grid;
            gap: 0.5rem;
            margin: 1.5rem 0 1.25rem;
            color: #4f4a45;
        }

        .report-meta-item {
            display: grid;
            grid-template-columns: 140px minmax(0, 1fr);
            gap: 0.75rem;
            align-items: center;
            font-size: 0.85rem;
        }

        .report-meta-item span {
            color: #7a756e;
        }

        .report-sheet-totals {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #eee5da;
            border-bottom: 1px solid #eee5da;
            padding: 0.75rem 0;
            margin-bottom: 0.75rem;
            font-size: 0.85rem;
            color: #4f4a45;
        }

        #reportsView .time-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            color: #1c1c1c;
        }

        #reportsView .time-table th,
        #reportsView .time-table td {
            padding: 0.65rem 0.75rem;
            border-bottom: 1px solid #eee5da;
            text-align: left;
        }

        #reportsView .time-table th {
            background: #f7f4ef;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            font-size: 0.6rem;
            color: #7a756e;
        }

        #reportsView .time-table tr:last-child td {
            border-bottom: none;
        }

        #reportsView .empty-state {
            background: transparent;
            border: 1px dashed #e1d8cd;
            color: #7a756e;
        }

        #reportsView #timeReportTable {
            width: 100%;
        }

        .report-list {
            display: grid;
            gap: 0.9rem;
        }

        .report-list-group {
            padding: 0;
            background: transparent;
            border: none;
        }

        .report-list-group + .report-list-group {
            border-top: 1px solid var(--border-color);
            padding-top: 1.25rem;
            margin-top: 0.35rem;
        }

        .report-list-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .report-list-grid {
            display: grid;
            gap: 0;
        }

        .report-list-card {
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--border-color);
            border-radius: 0;
            padding: 0.9rem 0;
            text-align: left;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .report-list-card:hover {
            border-color: rgba(248, 154, 85, 0.5);
            transform: none;
        }

        .report-list-name {
            font-weight: 600;
            font-size: 1.05rem;
            line-height: 1.4;
        }

        .report-list-meta {
            margin-top: 0.45rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: none;
            letter-spacing: 0.06em;
            line-height: 1.5;
        }

        .report-sheet .report-list-title {
            color: #6f6a63;
        }

        .report-sheet .report-list-group + .report-list-group {
            border-top: 1px solid #eee5da;
        }

        .report-sheet .report-list-card {
            color: #1c1c1c;
            border-bottom: 1px solid #eee5da;
        }

        .report-sheet .report-list-meta {
            color: #7a756e;
        }

        .report-sheet-wide .report-sheet-meta {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem 1.5rem;
            margin: 1.75rem 0 1.5rem;
        }

        .report-sheet-wide .report-list {
            gap: 1.15rem;
        }

        .report-sheet-wide .report-list-card {
            padding: 1.05rem 0;
        }

        #reportsView {
            background: #f4f2ee;
            border: none;
            padding: 1.5rem;
            border-radius: 18px;
            color: #1c1c1c;
        }

        #reportsView .time-panel {
            background: transparent;
            border: none;
            padding: 0;
        }

        #reportsView .report-actions {
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
            margin-top: 1.25rem;
        }

        #reportsView .report-filters {
            display: grid;
            gap: 0.75rem;
        }

        #reportsView .report-field label {
            text-transform: none;
            letter-spacing: 0.08em;
        }

        #reportsView .report-field {
            min-width: 0;
        }

        #reportsView .report-filters select,
        #reportsView .report-filters input,
        #reportsView .report-form-row input,
        #reportsView .report-form-row select {
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            color: #1c1c1c;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.9rem;
            padding: 0.6rem 0.7rem;
        }

        #reportsView .report-actions {
            flex-direction: column;
            align-items: stretch;
            border-top: none;
            padding-top: 0;
            margin-top: 1rem;
        }

        @media (max-width: 1100px) {
            .reports-layout {
                grid-template-columns: 1fr;
            }

            .report-sheet {
                padding: 1.5rem;
            }

            .report-sheet-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .report-meta-item {
                grid-template-columns: 1fr;
            }
        }

        .device-list,
        .connections-container {
            display: none !important;
        }

        .report-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            flex: 1 1 auto;
        }

        .report-presets input,
        .report-presets select {
            padding: 0.4rem 0.6rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
        }

        .report-share-link {
            min-width: 240px;
            flex: 1 1 240px;
        }

        .topology-group {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid var(--border-color);
        }

        .topology-group-grid {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            backdrop-filter: blur(10px);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border: 2px solid var(--accent-cyan);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-header h2 {
            font-size: 1.5rem;
            color: var(--accent-cyan);
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .modal-close:hover {
            color: var(--accent-cyan);
        }
        
        /* Connections view */
        .connections-container {
            margin-top: 2rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-color);
        }
        
        .connection-item {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }
        
        .connection-item:hover {
            transform: translateX(10px);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }
        
        .connection-from, .connection-to {
            font-family: 'IBM Plex Mono', monospace;
        }

        .connection-arrow {
            margin: 0 1rem;
            color: var(--accent-cyan);
            font-size: 1.5rem;
        }

        .connection-path-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.35rem;
        }

        .connection-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
        }

        /* Time tracking */
        .time-tracking {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-color);
        }

        .time-layout {
            display: grid;
            grid-template-columns: minmax(320px, 1.2fr) minmax(320px, 1fr);
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        @media (max-width: 1100px) {
            .time-layout {
                grid-template-columns: 1fr;
            }
        }

        .time-panel {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .calendar-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .time-week-header,
        .time-week-grid {
            display: grid;
            grid-template-columns: 70px repeat(7, 1fr);
            gap: 0.35rem;
        }

        .time-week-header {
            margin-bottom: 0.4rem;
        }

        .time-header-cell {
            background: var(--panel-surface);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-secondary);
        }

        .time-header-cell strong {
            display: block;
            font-size: 0.75rem;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            margin-top: 0.15rem;
            text-transform: none;
        }

        .time-header-cell span {
            display: block;
            font-size: 0.65rem;
            color: var(--accent-primary);
            margin-top: 0.1rem;
            font-family: 'IBM Plex Mono', monospace;
        }

        .time-week-grid {
            grid-auto-rows: 28px;
            user-select: none;
            max-height: 560px;
            overflow: auto;
        }

        .time-hour-cell {
            background: var(--panel-surface);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.35rem 0.5rem;
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
            text-align: right;
        }

        .time-slot {
            background: #101010;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .time-slot:hover {
            border-color: rgba(248, 154, 85, 0.6);
        }

        .time-slot.in-range {
            background: rgba(248, 154, 85, 0.15);
            border-color: rgba(248, 154, 85, 0.65);
        }

        .time-slot.range-start,
        .time-slot.range-end {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 1px rgba(248, 154, 85, 0.35);
        }

        .time-slot.today {
            border-color: rgba(248, 154, 85, 0.9);
        }

        .time-slot.has-entry::after {
            content: '';
            position: absolute;
            inset: 4px;
            border-radius: 4px;
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
        }

        .time-activity-manager {
            margin-top: 1rem;
        }

        .time-activity-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .time-activity-form input {
            flex: 1;
            padding: 0.5rem 0.6rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
        }

        .time-activity-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.6rem;
        }

        .time-activity-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.5rem;
            border-radius: 999px;
            background: rgba(248, 154, 85, 0.15);
            color: var(--text-primary);
            font-size: 0.7rem;
            border: 1px solid rgba(248, 154, 85, 0.4);
        }

        .time-activity-chip button {
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
        }

        .time-preset-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.5rem;
        }

        .time-preset-btn {
            border: 1px solid rgba(248, 154, 85, 0.5);
            background: rgba(248, 154, 85, 0.12);
            color: var(--text-primary);
            border-radius: 999px;
            padding: 0.2rem 0.6rem;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .time-preset-btn:hover {
            border-color: rgba(248, 154, 85, 0.85);
        }

        .time-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .summary-card {
            background: var(--panel-surface);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 0.75rem;
        }

        .summary-value {
            font-size: 1.2rem;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--accent-primary);
        }

        .summary-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .time-form {
            display: grid;
            gap: 0.75rem;
        }

        .time-form .btn {
            margin-bottom: 0;
        }

        .time-report-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .time-report-header select {
            padding: 0.4rem 0.6rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
        }

        .time-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.75rem;
            font-size: 0.8rem;
        }

        .time-table th,
        .time-table td {
            padding: 0.5rem 0.6rem;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
            font-family: 'IBM Plex Mono', monospace;
        }

        .time-table th {
            text-transform: uppercase;
            font-size: 0.65rem;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
        }
        
        
        /* Client selector */
        .client-selector-container {
            display: grid;
            gap: 0.75rem;
            align-items: center;
            margin: 0 0 1rem;
            padding: 0;
            background: transparent;
            border-radius: 0;
            border: none;
        }
        
        .client-selector {
            width: 100%;
            max-width: none;
            padding: 0.75rem;
            background: var(--panel-surface-2);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .client-selector:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(248, 154, 85, 0.35);
            border-color: rgba(248, 154, 85, 0.6);
        }
        
        .btn-small {
            padding: 0.65rem 0.95rem;
            background: linear-gradient(135deg, var(--cx-orange), #ff6a25);
            color: #101010;
            border: none;
            border-radius: 10px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            line-height: 1.2;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 22px rgba(248, 154, 85, 0.25);
        }
        
        /* Client info panel */
        .client-info {
            background: linear-gradient(135deg, rgba(248, 154, 85, 0.15), rgba(40, 40, 40, 0.4));
            border: 1px solid rgba(248, 154, 85, 0.4);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        
        .client-info h4 {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--cx-orange);
            margin-bottom: 0.5rem;
        }
        
        .client-info-detail {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            font-family: 'IBM Plex Mono', monospace;
        }
        
        .client-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: linear-gradient(135deg, var(--cx-orange), #ff6a25);
            color: #0b0b0b;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 0.5rem;
        }
        
        .no-client-warning {
            background: rgba(255, 170, 0, 0.1);
            border: 2px dashed var(--warning);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            color: var(--warning);
            margin: 2rem 0;
        }
        
        .client-list {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .client-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .client-card:hover {
            border-color: var(--accent-cyan);
            transform: translateX(5px);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }
        
        .client-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .client-card-name {
            font-weight: 600;
            color: var(--accent-cyan);
            font-family: 'IBM Plex Mono', monospace;
        }
        
        .client-card-stats {
            display: flex;
            gap: 1.5rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .client-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-icon {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-icon:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }
        
        .btn-icon.danger:hover {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Network Visualization */
        .view-toggle {
            display: none;
        }
        
        .view-toggle-btn {
            text-align: left;
            width: 100%;
            padding: 0.75rem 0.9rem;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--panel-surface);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        
        .view-toggle-btn.active {
            border-color: var(--cx-orange);
            box-shadow: 0 0 0 1px rgba(248, 154, 85, 0.4);
            background: linear-gradient(135deg, rgba(248, 154, 85, 0.25), rgba(20, 20, 20, 0.8));
        }
        
        .view-toggle-btn:hover:not(.active) {
            transform: translateX(6px);
            border-color: rgba(248, 154, 85, 0.5);
        }
        
        /* Network Map Container */
        .network-map {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
            min-height: 500px;
            position: relative;
            overflow: hidden;
        }
        
        #networkCanvas {
            width: 100%;
            height: 500px;
            cursor: grab;
        }
        
        #networkCanvas:active {
            cursor: grabbing;
        }
        
        /* Port Management */
        .port-details-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .port-details-overlay.active {
            display: flex;
            animation: fadeIn 0.3s;
        }
        
        .port-details-container {
            background: var(--bg-secondary);
            border: 2px solid var(--accent-cyan);
            border-radius: 12px;
            padding: 2rem;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }
        
        .port-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .port-details-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-cyan);
            font-family: 'IBM Plex Mono', monospace;
        }
        
        .port-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .port-hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }

        .port-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .port-filter-input {
            flex: 1 1 200px;
            padding: 0.5rem 0.6rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
        }

        .port-device-select {
            min-width: 220px;
            padding: 0.5rem 0.6rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
        }

        .port-filter-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .port-filter-toggle input {
            accent-color: var(--accent-primary);
        }
        
        .port-item {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .port-item:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        .port-item.pending {
            border-color: var(--warning);
            box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.35);
        }

        .port-item.connected {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 255, 136, 0.05));
        }
        
        .port-item.connected::after {
            content: '';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .port-item.trunk {
            border-color: var(--accent-magenta);
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.1), rgba(255, 0, 255, 0.05));
        }
        
        .port-item.uplink {
            border-color: var(--accent-cyan);
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(0, 255, 255, 0.05));
        }

        .port-item.conflict {
            border-color: var(--danger);
            box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.35);
        }
        
        .port-item.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .port-number {
            font-size: 0.75rem;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-primary);
        }
        
        .port-label {
            font-size: 0.625rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Connection Lines */
        .connection-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-magenta));
            transform-origin: left center;
            pointer-events: none;
            z-index: 1;
            opacity: 0.6;
            animation: flowAnimation 3s linear infinite;
        }
        
        @keyframes flowAnimation {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 100% 50%;
            }
        }
        
        .connection-line.active {
            opacity: 1;
            box-shadow: 0 0 10px var(--accent-cyan);
        }
        
        /* Port configuration modal */
        .port-config-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .port-config-form .form-group {
            margin-bottom: 0;
        }
        
        .port-config-form .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        /* VLAN tags */
        .vlan-tag {
            display: inline-block;
            padding: 0.125rem 0.375rem;
            background: rgba(255, 255, 0, 0.2);
            color: var(--accent-yellow);
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 600;
            margin-right: 0.25rem;
        }
        
        /* Connection path visualization */
        .connection-path {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 1rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
        }
        
        .connection-path-device {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
            color: var(--bg-primary);
            border-radius: 6px;
            font-weight: 600;
        }
        
        .connection-path-arrow {
            margin: 0 1rem;
            color: var(--accent-cyan);
        }
        
        .connection-path-port {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }
        
        /* Network stats */
        .network-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .network-stat-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }
        
        .network-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .network-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 0.25rem;
        }
    </style>
</head>


<body class="auth-locked">
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-card">
            <h2>Prihlaseni</h2>
            <p>Pro pristup do MSP konzole se prihlaste pres Google ucet.</p>
            <div class="auth-stack">
                <button class="btn" onclick="loginWithGoogle()">Prihlasit pres Google</button>
                <input type="email" id="emailLoginInput" placeholder="email@firma.cz">
                <button class="btn btn-secondary" onclick="sendMagicLink()">Poslat magic link</button>
                <div class="auth-hint">Magic link prijde na e-mail.</div>
                <button class="btn btn-secondary" id="localAdminBtn" onclick="enableLocalAdmin()" style="display: none;">Lokalni admin</button>
            </div>
        </div>
    </div>
    <div class="app-shell">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="brand-title"><span class="cx">CX</span><span class="dot">.</span><span class="tech">TECH</span></div>
                <div class="brand-subtitle">Rack Manager - MSP Console</div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">Klient</div>
                <div class="client-selector-container">
                    <select id="clientSelector" class="client-selector" onchange="switchClient()">
                        <option value="">-- Vyberte klienta --</option>
                    </select>
                    <button class="btn-small" onclick="openClientModal()">+ Novy klient</button>
                </div>
                <div class="client-info" id="clientInfo" style="display: none;">
                    <h4>Aktivni klient</h4>
                    <div class="client-info-detail" id="clientName"></div>
                    <div class="client-info-detail" id="userRole"></div>
                    <div class="client-info-detail" id="clientContact"></div>
                    <div class="client-info-detail" id="clientLocation"></div>
                    <div style="margin-top: 0.5rem;">
                        <span class="client-badge" id="clientType"></span>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="openClientManagerModal()">Spravovat klienty</button>
                <button class="btn btn-secondary" id="roleManagerBtn" onclick="openRoleManagerModal()">Sprava roli</button>
            </div>

            <div class="sidebar-section">
                <div class="section-title">Navigace</div>
                <div class="sidebar-nav">
                    <button class="view-toggle-btn nav-btn" data-view="dashboard" onclick="switchView('dashboard', this)">Dashboard</button>
                    <button class="view-toggle-btn nav-btn active" data-view="racks" onclick="switchView('racks', this)">Racky</button>
                    <button class="view-toggle-btn nav-btn" data-view="network" onclick="switchView('network', this)">Sitova mapa</button>
                    <button class="view-toggle-btn nav-btn" data-view="topology" onclick="switchView('topology', this)">Topologie</button>
                    <button class="view-toggle-btn nav-btn" data-view="overview" onclick="switchView('overview', this)">Prehled klienta</button>
                    <button class="view-toggle-btn nav-btn" data-view="time" onclick="switchView('time', this)">Vykazovani</button>
                    <button class="view-toggle-btn nav-btn" data-view="reports" onclick="switchView('reports', this)">Reporty</button>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">Racky</div>
                <button class="btn" onclick="openRackModal()" id="addRackBtn" disabled>Pridat rack</button>
                <button class="btn btn-secondary" onclick="clearAllRacks()" id="clearRacksBtn" disabled>Vymazat vse</button>
            </div>

            <div class="sidebar-section">
                <div class="section-title">Zarizeni</div>
                <button class="btn" onclick="openDeviceModal()" id="addDeviceBtn" disabled>Pridat zarizeni</button>
                <button class="btn" onclick="openConnectionModal()" id="addConnectionBtn" disabled>Pridat propojeni</button>
            </div>

            <div class="sidebar-section">
                <div class="section-title">Kategorie zarizeni</div>
                <button class="btn btn-secondary" onclick="openModuleModal()">Sprava kategorii</button>
            </div>

            <div class="sidebar-section">
                <div class="section-title">Statistiky</div>
                <div class="stat">
                    <div class="stat-value" id="totalDevices">0</div>
                    <div class="stat-label">Celkem zarizeni</div>
                </div>
                <div class="stat" style="margin-top: 1rem;">
                    <div class="stat-value" id="totalRacks">0</div>
                    <div class="stat-label">Celkem racku</div>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div class="topbar">
                <div>
                    <div class="topbar-title">MSP Operations Desk</div>
                    <div class="topbar-subtitle">Multi-tenant sprava infrastruktury</div>
                </div>
                <div class="topbar-actions">
                    <div class="topbar-menu-title">Ucet</div>
                    <div class="session-status">
                        <span class="status-dot" aria-hidden="true"></span>
                        <div id="authStatus" class="auth-status">Neprihlasen</div>
                    </div>
                    <div class="topbar-menu-actions">
                        <button class="btn-small" id="loginBtn" onclick="loginWithGoogle()">Prihlasit</button>
                        <button class="btn btn-secondary" id="logoutBtn" onclick="logout()" style="display: none;">Odhlasit</button>
                    </div>
                </div>
            </div>

            <div id="dashboardView" class="rack-container dashboard-view" style="display: none;">
                <div class="dashboard-shell">
                    <section class="dashboard-hero-card">
                        <div class="dashboard-hero-content">
                            <div class="dashboard-hero-kicker">CX.TECH MSP</div>
                            <h2 class="dashboard-hero-title">Operations Canvas</h2>
                            <p class="dashboard-hero-subtitle">Prehled klientu, role a rychly vstup do hlavni agendy s mistem pro brandy a kontakty.</p>
                            <div class="dashboard-hero-metrics">
                                <div class="dashboard-metric">
                                    <div class="dashboard-metric-label">Role</div>
                                    <div class="dashboard-metric-value" id="dashboardRole">-</div>
                                </div>
                                <div class="dashboard-metric">
                                    <div class="dashboard-metric-label">Aktivni klient</div>
                                    <div class="dashboard-metric-value" id="dashboardClient">-</div>
                                </div>
                                <div class="dashboard-metric">
                                    <div class="dashboard-metric-label">Typ klienta</div>
                                    <div class="dashboard-metric-value" id="dashboardType">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="dashboard-logo-wall">
                            <div class="dashboard-logo-title">Loga klienta</div>
                            <div class="dashboard-logo-slot">
                                <div class="logo-mark" id="dashboardLogoPrimary">LOGO</div>
                                <div class="logo-caption">Primarni</div>
                            </div>
                            <div class="dashboard-logo-slot">
                                <div class="logo-mark">LOGO</div>
                                <div class="logo-caption">Dalsi brand</div>
                            </div>
                            <div class="dashboard-logo-slot">
                                <div class="logo-mark">LOGO</div>
                                <div class="logo-caption">Projekt</div>
                            </div>
                            <div class="dashboard-logo-slot">
                                <div class="logo-mark">LOGO</div>
                                <div class="logo-caption">Vychozi</div>
                            </div>
                        </div>
                    </section>

                    <aside class="dashboard-rail">
                        <div class="dashboard-rail-card">
                            <div class="dashboard-rail-title">Kontaktni udaje</div>
                            <div class="dashboard-contact-list">
                                <div class="dashboard-contact-item">
                                    <div class="dashboard-contact-label">Kontakt</div>
                                    <div class="dashboard-contact-value" id="dashboardContact">-</div>
                                </div>
                                <div class="dashboard-contact-item">
                                    <div class="dashboard-contact-label">Adresa</div>
                                    <div class="dashboard-contact-value" id="dashboardLocation">-</div>
                                </div>
                                <div class="dashboard-contact-item">
                                    <div class="dashboard-contact-label">ICO</div>
                                    <div class="dashboard-contact-value" id="dashboardIco">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="dashboard-rail-card">
                            <div class="dashboard-rail-title">Rychle akce</div>
                            <div class="dashboard-rail-actions">
                                <button class="btn" onclick="openClientModal()">Novy klient</button>
                                <button class="btn btn-secondary" onclick="openClientManagerModal()">Sprava klientu</button>
                                <button class="btn btn-secondary" onclick="switchView('time')">Vykazovani</button>
                                <button class="btn btn-secondary" id="dashboardReportsBtn" onclick="switchView('reports')">Reporty</button>
                            </div>
                        </div>
                    </aside>
                </div>

                <div class="dashboard-body">
                    <section class="dashboard-section">
                        <div class="dashboard-section-head">
                            <div>
                                <div class="dashboard-section-title">Prehled</div>
                                <div class="dashboard-section-subtitle">Stav klientu a rychly prechod do detailu.</div>
                            </div>
                        </div>
                        <div id="dashboardGrid" class="overview-grid dashboard-grid"></div>
                    </section>
                    <section class="dashboard-section dashboard-section-alt">
                        <div class="dashboard-section-head">
                            <div>
                                <div class="dashboard-section-title">MSP sluzby</div>
                                <div class="dashboard-section-subtitle">Dostupne moduly a pripravene workflow.</div>
                            </div>
                        </div>
                        <div id="dashboardModulesGrid" class="msp-modules-grid"></div>
                        <div class="module-expansion">
                            <div class="module-expansion-title">Priprava na expanzi</div>
                            <div class="module-expansion-grid">
                                <div class="module-expansion-tile">
                                    <div class="module-expansion-icon">+</div>
                                    <div class="module-expansion-label">Novy modul</div>
                                    <div class="module-expansion-desc">Slot pro dalsi workflow a integrace.</div>
                                </div>
                                <div class="module-expansion-tile">
                                    <div class="module-expansion-icon">+</div>
                                    <div class="module-expansion-label">Automatizace</div>
                                    <div class="module-expansion-desc">Pripraveno pro budoucni automat.</div>
                                </div>
                                <div class="module-expansion-tile">
                                    <div class="module-expansion-icon">+</div>
                                    <div class="module-expansion-label">Compliance</div>
                                    <div class="module-expansion-desc">Misto pro governance a audit.</div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <div id="overviewView" class="rack-container" style="display: none;">
                <div class="rack-header">
                    <h2>Prehled klienta</h2>
                    <div class="rack-stats">
                        <div class="stat">
                            <div class="stat-value" id="overviewClientName">-</div>
                            <div class="stat-label">Aktivni klient</div>
                        </div>
                    </div>
                </div>
                <p class="msp-module-desc">Kliknete na karty pro rychly prechod do detailu racku, zarizeni nebo site.</p>
                <div id="overviewGrid" class="overview-grid"></div>

                <div class="overview-section">
                    <div class="overview-section-title">MSP sluzby</div>
                    <div id="mspModulesGrid" class="msp-modules-grid"></div>
                </div>
            </div>
            
            <div id="racksView" class="rack-container">
                <div class="rack-header">
                    <h2>Racky</h2>
                    <div class="rack-stats">
                        <div class="stat">
                            <div class="stat-value" id="usedUnits">0</div>
                            <div class="stat-label">Obsazeno U</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="freeUnits">0</div>
                            <div class="stat-label">Volno U</div>
                        </div>
                    </div>
                </div>
                <div id="rackGrid" class="rack-grid">
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <p>Zatm nemte dn racky.<br>Kliknte na "Pidat rack" pro vytvoen prvnho racku.</p>
                    </div>
                </div>
            </div>
            
            <div id="networkView" class="network-map" style="display: none;">
                <div class="rack-header">
                    <h2>Sov mapa</h2>
                    <div class="rack-stats">
                        <button class="btn-small" onclick="resetNetworkView()"> Reset View</button>
                        <button class="btn-small" onclick="exportNetworkDiagram()"> Export SVG</button>
                    </div>
                </div>
                <div class="network-stats">
                    <div class="network-stat-card">
                        <div class="network-stat-value" id="totalConnections">0</div>
                        <div class="network-stat-label">Propojen</div>
                    </div>
                    <div class="network-stat-card">
                        <div class="network-stat-value" id="totalPorts">0</div>
                        <div class="network-stat-label">Port celkem</div>
                    </div>
                    <div class="network-stat-card">
                        <div class="network-stat-value" id="usedPorts">0</div>
                        <div class="network-stat-label">Obsazeno</div>
                    </div>
                    <div class="network-stat-card">
                        <div class="network-stat-value" id="trunkPorts">0</div>
                        <div class="network-stat-label">Trunk port</div>
                    </div>
                </div>
                <canvas id="networkCanvas"></canvas>
            </div>

            <div id="timeView" class="time-tracking" style="display: none;">
                <div class="rack-header">
                    <h2>Vykazovani hodin</h2>
                    <div class="rack-stats">
                        <button class="btn-small" onclick="exportTimeReport()">Export PDF</button>
                    </div>
                </div>
                <div class="time-layout">
                    <div class="time-panel">
                        <div class="calendar-header">
                            <button class="btn-small" onclick="shiftTimeWeek(-1)"></button>
                            <div class="calendar-title" id="timeCalendarTitle">-</div>
                            <button class="btn-small" onclick="shiftTimeWeek(1)"></button>
                        </div>
                        <div class="time-week-header" id="timeWeekHeader"></div>
                        <div class="time-week-grid" id="timeWeekGrid"></div>
                    </div>
                    <div class="time-panel">
                        <div class="time-summary" id="timeSummary"></div>
                        <button class="btn" id="addTimeEntryBtn" onclick="openTimeEntryModal()">Novy zapis</button>
                        <div class="role-note" style="margin-top: 0.75rem;">Tip: oznac si rozsah v kalendari tahem mysi.</div>
                        <div class="time-activity-manager">
                            <div class="section-title">Preddefinovane cinnosti</div>
                            <div class="time-activity-form">
                                <input type="text" id="timeActivityInput" placeholder="Nova cinnost">
                                <button class="btn-small" onclick="addTimeActivity()">Pridat</button>
                            </div>
                            <div id="timeActivityList" class="time-activity-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="reportsView" class="time-tracking" style="display: none;">
                <div class="rack-header">
                    <h2>Live reporty</h2>
                </div>
                <div id="reportsAccessNote" class="empty-state" style="display: none;">
                    <p>Reporty jsou dostupne jen pro administratory.</p>
                </div>
                <div class="reports-layout">
                    <aside class="report-filter-panel">
                        <div class="report-filter-card report-filter-card-full">
                            <div class="report-filter-title">Vytvorit report</div>
                            <div class="report-form-grid">
                                <div class="report-form-row">
                                    <label for="reportPresetName">Nazev</label>
                                    <input type="text" id="reportPresetName" placeholder="Administrativa CXTech">
                                </div>
                                <div class="report-form-row">
                                    <label for="reportShareLink">Sdileni</label>
                                    <div class="report-share-row">
                                        <button class="btn-small" onclick="openReportShareModal()">Sdilet report</button>
                                        <input type="text" id="reportShareLink" class="report-share-link" placeholder="Permanentni odkaz" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="report-filter-divider"></div>
                            <div class="report-filter-section">
                                <div class="report-filter-section-title">Filtry</div>
                                <div class="report-filters">
                                    <div class="report-field">
                                        <label for="reportRangePreset">Casovy interval</label>
                                        <select id="reportRangePreset" onchange="onReportRangePresetChange()">
                                            <option value="all">Vsechno</option>
                                            <option value="current-month">Soucasny mesic</option>
                                            <option value="previous-month">Predchozi mesic</option>
                                            <option value="year">Aktualni rok</option>
                                            <option value="custom">Vlastni rozsah</option>
                                        </select>
                                    </div>
                                    <div class="report-field">
                                        <label for="reportClientFilter">Zakaznici</label>
                                        <select id="reportClientFilter" onchange="onReportFilterChange()"></select>
                                    </div>
                                    <div class="report-field">
                                        <label for="reportTechnicianFilter">Uzivatele</label>
                                        <select id="reportTechnicianFilter" onchange="onReportFilterChange()"></select>
                                    </div>
                                    <div class="report-field">
                                        <label for="reportStartDate">Od</label>
                                        <input type="date" id="reportStartDate" onchange="onReportDateChange()">
                                    </div>
                                    <div class="report-field">
                                        <label for="reportEndDate">Do</label>
                                        <input type="date" id="reportEndDate" onchange="onReportDateChange()">
                                    </div>
                                </div>
                            </div>
                            <div class="report-actions">
                                <button class="btn-small" onclick="createReportFromBuilder()">Vytvorit report</button>
                                <button class="btn-small" onclick="showReportList()">Zpet na seznam</button>
                            </div>
                        </div>
                    </aside>
                    <section class="report-display">
                        <div id="timeReportTable"></div>
                    </section>
                </div>
            </div>
            
            <div id="topologyView" style="display: none;">
                <!-- Topology view will be dynamically generated -->
            </div>
            
            <div class="device-list" id="deviceListContainer" style="display: none;">
                <h3>Seznam zazen</h3>
                <table class="device-table">
                    <thead>
                        <tr>
                            <th>Nzev</th>
                            <th>Typ</th>
                            <th>Rack</th>
                            <th>Pozice</th>
                            <th>IP adresa</th>
                            <th>Model</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody id="deviceTableBody">
                    </tbody>
                </table>
            </div>
            
            <div class="connections-container" id="connectionsContainer" style="display: none;">
                <h3>Propojen</h3>
                <div id="connectionsList">
                </div>
            </div>
        </main>
    </div>

    <!-- Port Details Overlay -->
    <div id="portDetailsOverlay" class="port-details-overlay">
        <div class="port-details-container">
            <div class="port-details-header">
                <h2 class="port-details-title" id="portDetailsTitle">Port Management</h2>
                <button class="modal-close" onclick="closePortDetails()"></button>
            </div>
            <div id="portDetailsContent">
                <!-- Port details will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Time Entry Modal -->
    <div id="timeEntryModal" class="modal">
        <div class="modal-content" style="max-width: 560px;">
            <div class="modal-header">
                <h2>Novy zapis hodin</h2>
                <button class="modal-close" onclick="closeTimeEntryModal()"></button>
            </div>
            <div class="time-form">
                <div class="form-group">
                    <label>Klient</label>
                    <select id="timeEntryClient"></select>
                </div>
                <div class="form-group">
                    <label>Cinnost</label>
                    <input type="text" id="timeEntryActivity" list="timeActivityOptions" placeholder="Nap. Monitoring">
                    <datalist id="timeActivityOptions"></datalist>
                </div>
                <div class="form-group">
                    <label>Od</label>
                    <input type="date" id="timeEntryStart" onchange="updateTimeEntrySummary()">
                </div>
                <div class="form-group">
                    <label>Do</label>
                    <input type="date" id="timeEntryEnd" onchange="updateTimeEntrySummary()">
                </div>
                <div class="form-group">
                    <label>Hodiny na den</label>
                    <input type="number" id="timeEntryHours" min="0" step="0.25" placeholder="napr. 1.5" oninput="updateTimeEntrySummary()">
                    <div class="time-preset-group">
                        <button class="time-preset-btn" type="button" onclick="setTimePreset(0.5)">0.5h</button>
                        <button class="time-preset-btn" type="button" onclick="setTimePreset(1)">1h</button>
                        <button class="time-preset-btn" type="button" onclick="setTimePreset(2)">2h</button>
                        <button class="time-preset-btn" type="button" onclick="setTimePreset(4)">4h</button>
                        <button class="time-preset-btn" type="button" onclick="setTimePreset(8)">8h</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Popis</label>
                    <input type="text" id="timeEntryDesc" placeholder="Co se delalo">
                </div>
                <div class="role-note" id="timeEntrySummary"></div>
                <button class="btn" onclick="saveTimeEntryRange()">Ulozit</button>
            </div>
        </div>
    </div>

    <!-- Report Share Modal -->
    <div id="reportShareModal" class="modal">
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-header">
                <h2>Sdilet report</h2>
                <button class="modal-close" onclick="closeReportShareModal()">-</button>
            </div>
            <div class="report-share-note">Vyberte zpusob sdileni pro aktualni filtry.</div>
            <div class="report-share-actions" style="margin-top: 1rem;">
                <button class="btn" onclick="handleReportShareOption('link')">Permanentni odkaz</button>
                <button class="btn-secondary" onclick="handleReportShareOption('internal')">Sdilet interne</button>
            </div>
        </div>
    </div>
    
    <!-- Connection Modal -->
    <div id="connectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nov propojen</h2>
                <button class="modal-close" onclick="closeConnectionModal()"></button>
            </div>
            <div class="form-group">
                <label>Z zazen</label>
                <select id="connFromDevice" onchange="updateFromPorts()"></select>
            </div>
            <div class="form-group">
                <label>Z portu</label>
                <select id="connFromPort"></select>
            </div>
            <div class="form-group">
                <label>Do zazen</label>
                <select id="connToDevice" onchange="updateToPorts()"></select>
            </div>
            <div class="form-group">
                <label>Do portu</label>
                <select id="connToPort"></select>
            </div>
            <div class="form-group">
                <label>Typ spojen</label>
                <select id="connType">
                    <option value="access">Access</option>
                    <option value="trunk">Trunk</option>
                    <option value="uplink">Uplink</option>
                    <option value="crossover">Crossover</option>
                </select>
            </div>
            <div class="form-group">
                <label>VLAN (rkou oddlen pro trunk)</label>
                <input type="text" id="connVlans" placeholder="nap. 10,20,30">
            </div>
            <div class="form-group">
                <label>Rychlost</label>
                <select id="connSpeed">
                    <option value="10">10 Mbps</option>
                    <option value="100">100 Mbps</option>
                    <option value="1000" selected>1 Gbps</option>
                    <option value="10000">10 Gbps</option>
                    <option value="25000">25 Gbps</option>
                    <option value="40000">40 Gbps</option>
                    <option value="100000">100 Gbps</option>
                </select>
            </div>
            <div class="form-group">
                <label>Popis</label>
                <input type="text" id="connDescription" placeholder="nap. Uplink to core switch">
            </div>
            <button class="btn" onclick="addConnection()">Vytvoit propojen</button>
        </div>
    </div>
    
    <!-- Client Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nov klient</h2>
                <button class="modal-close" onclick="closeClientModal()"></button>
            </div>
            <div class="form-group">
                <label>Nzev klienta *</label>
                <input type="text" id="newClientName" placeholder="nap. Firma ABC s.r.o.">
            </div>
            <div class="form-group">
                <label>IO</label>
                <input type="text" id="newClientICO" placeholder="nap. 12345678">
            </div>
            <div class="form-group">
                <label>Typ klienta</label>
                <select id="newClientType">
                    <option value="standard">Standard</option>
                    <option value="premium">Premium</option>
                    <option value="enterprise">Enterprise</option>
                </select>
            </div>
            <div class="form-group">
                <label>Kontaktn osoba</label>
                <input type="text" id="newClientContact" placeholder="nap. Jan Novk">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="newClientEmail" placeholder="nap. info@firma.cz">
            </div>
            <div class="form-group">
                <label>Telefon</label>
                <input type="tel" id="newClientPhone" placeholder="nap. +420 123 456 789">
            </div>
            <div class="form-group">
                <label>Adresa</label>
                <input type="text" id="newClientAddress" placeholder="nap. Vclavsk nmst 1, Praha">
            </div>
            <div class="form-group">
                <label>Poznmky</label>
                <textarea id="newClientNotes" rows="3" style="width: 100%; padding: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-family: 'IBM Plex Mono', monospace; font-size: 0.875rem;"></textarea>
            </div>
            <button class="btn" onclick="addClient()">Vytvoit klienta</button>
        </div>
    </div>
    
    <!-- Client Manager Modal -->
    <div id="clientManagerModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Sprva klient</h2>
                <button class="modal-close" onclick="closeClientManagerModal()"></button>
            </div>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <input type="text" id="clientSearch" placeholder="Hledat klienta..." style="flex: 1; padding: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary);" onkeyup="searchClients()">
                <button class="btn-small" onclick="openClientModal()">+ Nov klient</button>
            </div>
            <div id="clientList" class="client-list">
                <!-- Clients will be rendered here -->
            </div>
        </div>
    </div>
    
    <!-- Role Manager Modal -->
    <div id="roleManagerModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Sprava roli</h2>
                <button class="modal-close" onclick="closeRoleManagerModal()">X</button>
            </div>
            <div class="role-note">Role jsou nacitane z Firestore cesty clients/{id}/users.</div>
            <div class="role-invite-form">
                <input type="email" id="roleInviteEmail" placeholder="email@firma.cz">
                <select id="roleInviteRole" class="role-select">
                    <option value="admin">Admin</option>
                    <option value="technician">Technik</option>
                    <option value="readonly">Read-only</option>
                    <option value="auditor">Auditor</option>
                </select>
                <button class="btn btn-secondary" onclick="addRoleInvite()">Pozvat</button>
            </div>
            <div id="roleManagerList"></div>
        </div>
    </div>

    <!-- Rack Modal -->
    <div id="rackModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nov rack</h2>
                <button class="modal-close" onclick="closeRackModal()"></button>
            </div>
            <div class="form-group">
                <label>Nzev racku</label>
                <input type="text" id="rackName" placeholder="nap. RACK-01">
            </div>
            <div class="form-group">
                <label>Poet U (vka)</label>
                <input type="number" id="rackUnits" value="42" min="1" max="50">
            </div>
            <div class="form-group">
                <label>Umstn</label>
                <input type="text" id="rackLocation" placeholder="nap. Serverovna A">
            </div>
            <button class="btn" onclick="addRack()">Vytvoit rack</button>
        </div>
    </div>
    
    <!-- Device Modal -->
    <div id="deviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nov zazen</h2>
                <button class="modal-close" onclick="closeDeviceModal()"></button>
            </div>
            <div class="form-group">
                <label>Nzev zazen</label>
                <input type="text" id="deviceName" placeholder="nap. SW-CORE-01">
            </div>
            <div class="form-group">
                <label>Typ zazen</label>
                <select id="deviceType"></select>
                <div style="margin-top: 0.5rem; text-align: right;">
                    <button class="btn-small" onclick="openModuleModal()">Sprava kategorii</button>
                </div>
            </div>
            <div class="form-group">
                <label>Rack</label>
                <select id="deviceRack"></select>
            </div>
            <div class="form-group">
                <label>Pozice U (od spodu)</label>
                <input type="number" id="devicePosition" min="1" placeholder="nap. 10">
            </div>
            <div class="form-group">
                <label>Vka (poet U)</label>
                <input type="number" id="deviceHeight" value="1" min="1" max="10">
            </div>
            <div class="form-group">
                <label>IP adresa</label>
                <input type="text" id="deviceIP" placeholder="nap. 192.168.1.1">
            </div>
            <div class="form-group">
                <label>Model</label>
                <input type="text" id="deviceModel" placeholder="nap. Cisco Catalyst 2960">
            </div>
            <div class="form-group">
                <label>Sriov slo</label>
                <input type="text" id="deviceSerial" placeholder="nap. ABC123456">
            </div>
            <div class="form-group">
                <label>Poet port</label>
                <input type="number" id="devicePorts" value="24" min="1" max="48" placeholder="nap. 24">
            </div>
    <button class="btn" onclick="addDevice()">Pidat zazen</button>
        </div>
    </div>

    <!-- Module Modal -->
    <div id="moduleModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Kategorie zarizeni</h2>
                <button class="modal-close" onclick="closeModuleModal()">X</button>
            </div>
            <div class="form-group">
                <label>Nazev kategorie</label>
                <input type="text" id="moduleName" placeholder="napr. Firewall">
            </div>
            <div class="form-group">
                <label>ID kategorie (volitelne)</label>
                <input type="text" id="moduleId" placeholder="napr. firewall">
            </div>
            <div class="form-group">
                <label>Kategorie</label>
                <select id="moduleGroup">
                    <option value="Network">Network</option>
                    <option value="Compute">Compute</option>
                    <option value="Storage">Storage</option>
                    <option value="Security">Security</option>
                    <option value="Cabling">Cabling</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Barva</label>
                <input type="color" id="moduleColor" value="#00ff88">
            </div>
            <button class="btn" onclick="addModuleType()">Pridat kategorii</button>

            <div style="margin-top: 1.5rem;">
                <h3 style="margin-bottom: 0.75rem; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary);">Seznam kategorii</h3>
                <div id="moduleList" class="module-list"></div>
            </div>
        </div>
    </div>

    <!-- Device Tooltip -->
    <div id="deviceTooltip" class="device-tooltip">
        <div class="tooltip-header" id="tooltipName"></div>
        <div class="tooltip-detail" id="tooltipType"></div>
        <div class="tooltip-detail" id="tooltipPosition"></div>
        <div class="tooltip-detail" id="tooltipIP"></div>
        <div class="tooltip-detail" id="tooltipModel"></div>
        <div class="tooltip-detail" id="tooltipPorts"></div>
        <div class="tooltip-detail" id="tooltipSerial"></div>
    </div>
    
    <script>
        // Data storage - now with multi-tenant support
        let clients = [];
        let currentClientId = null;
        let clientData = {}; // Will store data per client
        
        // Current client's data
        let racks = [];
        let devices = [];
        let connections = [];
        let timeEntries = [];
        let reportEntries = [];
        let reportPresetsLoaded = false;
        let reportSharedLoaded = false;
        let sharedReportPresets = [];
        let pendingReportShareId = null;
        let reportHasLoaded = false;
        let reportFiltersVisible = false;
        let currentView = 'racks';
        let timeViewWeekStart = new Date();
        let timeSelectionStart = null;
        let timeSelectionEnd = null;
        let isTimeSelecting = false;
        let timeSelectionActive = false;
        try {
            pendingReportShareId = new URLSearchParams(window.location.search).get('reportShare');
        } catch (err) {
            pendingReportShareId = null;
        }

        // Module types
        const DEFAULT_MODULE_TYPES = [
            { id: 'fortigate', label: 'Fortigate', color: '#f8fafc', gradient: ['#f8fafc', '#e2e8f0'], text: '#111827', group: 'Security' },
            { id: 'zyxel', label: 'Zyxel', color: '#5b1e2d', gradient: ['#5b1e2d', '#7a2438'], text: '#ffffff', group: 'Network' },
            { id: 'router', label: 'Ubiquity router', color: '#2563eb', gradient: ['#3b82f6', '#1d4ed8'], text: '#ffffff', group: 'Network' },
            { id: 'switch', label: 'Switch', color: '#6b7280', gradient: ['#6b7280', '#4b5563'], text: '#ffffff', group: 'Network' },
            { id: 'ap', label: 'Access point', color: '#f1f5f9', gradient: ['#f1f5f9', '#e2e8f0'], text: '#111827', group: 'Wireless' },
            { id: 'server', label: 'Server', color: '#fbbf24', gradient: ['#fbbf24', '#f59e0b'], text: '#111827', group: 'Compute' },
            { id: 'patch', label: 'Patch panel', color: '#00ff88', gradient: ['#00ff88', '#00cc66'], text: '#000000', group: 'Cabling' }
        ];
        let moduleTypes = [];
        let customModuleTypes = [];

        const ROLE_PERMISSIONS = {
            admin: {
                deleteRacks: true,
                editTopology: true,
                viewSensitive: true,
                manageRacks: true,
                manageDevices: true,
                manageCategories: true,
                manageRoles: true,
                manageTime: true,
                viewTimeAll: true
            },
            technician: {
                deleteRacks: false,
                editTopology: true,
                viewSensitive: true,
                manageRacks: true,
                manageDevices: true,
                manageCategories: false,
                manageRoles: false,
                manageTime: true,
                viewTimeAll: false
            },
            readonly: {
                deleteRacks: false,
                editTopology: false,
                viewSensitive: false,
                manageRacks: false,
                manageDevices: false,
                manageCategories: false,
                manageRoles: false,
                manageTime: false,
                viewTimeAll: false
            },
            auditor: {
                deleteRacks: false,
                editTopology: false,
                viewSensitive: true,
                manageRacks: false,
                manageDevices: false,
                manageCategories: false,
                manageRoles: false,
                manageTime: false,
                viewTimeAll: true
            }
        };

        const ROLE_LABELS = {
            admin: 'Admin',
            technician: 'Technik',
            readonly: 'Read-only',
            auditor: 'Auditor'
        };

        const BOOTSTRAP_ADMINS = [
            'ondrej.hriadel@cxtech.cz'
        ];

        let currentUserRole = 'readonly';

        const mspModules = [
            {
                id: 'config-backup',
                name: 'Zaloha konfiguraci',
                category: 'Backup',
                status: 'planned',
                description: 'Automaticke ukladani konfiguraci sitovych zarizeni.'
            },
            {
                id: 'compliance-audit',
                name: 'Kontrola konfiguraci',
                category: 'Security',
                status: 'planned',
                description: 'Kontrola odchylek od standardu a schvalenych sablon.'
            },
            {
                id: 'patch-management',
                name: 'Patch management',
                category: 'Maintenance',
                status: 'planned',
                description: 'Planovani a evidovani aktualizaci firmware a OS.'
            }
        ];

        const DEFAULT_TIME_ACTIVITIES = [
            'Monitoring',
            'Support',
            'Implementace',
            'Incident',
            'Maintenance',
            'Backup',
            'Audit',
            'Dokumentace'
        ];

        const TIME_GRID_START = 0;
        const TIME_GRID_END = 23;

        let timeActivities = [];

        function getRolePermissions(role) {
            return ROLE_PERMISSIONS[role] || ROLE_PERMISSIONS.readonly;
        }

        function canViewSensitive() {
            return getRolePermissions(currentUserRole).viewSensitive;
        }

        function getSensitiveValue(value) {
            return canViewSensitive() ? value : 'Skryto';
        }

        function canEditTopology() {
            return getRolePermissions(currentUserRole).editTopology;
        }

        function canManageRacks() {
            return getRolePermissions(currentUserRole).manageRacks;
        }

        function canManageDevices() {
            return getRolePermissions(currentUserRole).manageDevices;
        }

        function canManageCategories() {
            return getRolePermissions(currentUserRole).manageCategories;
        }

        function canManageRoles() {
            return getRolePermissions(currentUserRole).manageRoles;
        }

        function canDeleteRacks() {
            return getRolePermissions(currentUserRole).deleteRacks;
        }

        function canManageTimeEntries() {
            return getRolePermissions(currentUserRole).manageTime;
        }

        function canViewAllTimeEntries() {
            return getRolePermissions(currentUserRole).viewTimeAll;
        }

        function canViewReports() {
            return currentUserRole === 'admin';
        }

        function updateRoleLabel() {
            const roleLabel = document.getElementById('userRole');
            if (roleLabel) {
                const label = ROLE_LABELS[currentUserRole] || ROLE_LABELS.readonly;
                roleLabel.textContent = `Role: ${label}`;
            }
        }

        function normalizeEmailKey(email) {
            return (email || '').trim().toLowerCase().replace(/\./g, '_');
        }

        function applyRolePermissions() {
            const addRackBtn = document.getElementById('addRackBtn');
            const clearRacksBtn = document.getElementById('clearRacksBtn');
            const addDeviceBtn = document.getElementById('addDeviceBtn');
            const addConnectionBtn = document.getElementById('addConnectionBtn');
            const moduleButtons = document.querySelectorAll('[onclick="openModuleModal()"]');
            const roleManagerBtn = document.getElementById('roleManagerBtn');
            const addTimeEntryBtn = document.getElementById('addTimeEntryBtn');
            const reportsNavBtn = document.querySelector('.view-toggle-btn[data-view="reports"]');
            const dashboardReportsBtn = document.getElementById('dashboardReportsBtn');

            moduleButtons.forEach((button) => {
                button.disabled = !canManageCategories();
            });
            if (roleManagerBtn) {
                roleManagerBtn.disabled = !canManageRoles();
            }
            if (reportsNavBtn) {
                reportsNavBtn.style.display = canViewReports() ? 'block' : 'none';
            }
            if (dashboardReportsBtn) {
                dashboardReportsBtn.style.display = canViewReports() ? 'inline-flex' : 'none';
            }
            if (!canViewReports() && currentView === 'reports') {
                switchView('dashboard');
            }

            if (!currentClientId) {
                disableControls();
                return;
            }

            if (addRackBtn) addRackBtn.disabled = !canManageRacks();
            if (clearRacksBtn) clearRacksBtn.disabled = !canDeleteRacks();
            if (addDeviceBtn) addDeviceBtn.disabled = !canManageDevices();
            if (addConnectionBtn) addConnectionBtn.disabled = !canEditTopology();
            if (addTimeEntryBtn) addTimeEntryBtn.disabled = !canManageTimeEntries();
        }

        function setCurrentRole(role) {
            currentUserRole = ROLE_PERMISSIONS[role] ? role : 'readonly';
            updateRoleLabel();
            applyRolePermissions();
            renderDashboard();
        }

        async function fetchUserRole() {
            if (!currentClientId || !window.auth || !window.db || !auth.currentUser) {
                setCurrentRole('readonly');
                return;
            }

            try {
                const uid = auth.currentUser.uid;
                const email = (auth.currentUser.email || '').toLowerCase();
                const isBootstrapAdmin = BOOTSTRAP_ADMINS.includes(email);
                const clientDoc = db.collection('clients').doc(currentClientId);
                const usersRef = clientDoc.collection('users');
                const userRef = usersRef.doc(uid);

                const [userSnap, usersSnap] = await Promise.all([
                    userRef.get(),
                    usersRef.limit(1).get()
                ]);

                const existing = userSnap.exists ? userSnap.data() : {};
                let role = existing && existing.role ? existing.role : 'technician';

                if (usersSnap.empty) {
                    role = 'admin';
                }

                if ((!existing || !existing.role) && auth.currentUser.email) {
                    const emailKey = normalizeEmailKey(auth.currentUser.email);
                    const inviteSnap = await clientDoc.collection('roleInvites').doc(emailKey).get();
                    if (inviteSnap.exists) {
                        const invite = inviteSnap.data();
                        if (invite && invite.role) {
                            role = invite.role;
                        }
                    }
                }

                if (isBootstrapAdmin) {
                    role = 'admin';
                }

                await userRef.set({
                    role: role,
                    email: auth.currentUser.email || '',
                    name: auth.currentUser.displayName || '',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                setCurrentRole(role);
            } catch (err) {
                console.warn('Role fetch failed:', err);
                setCurrentRole('readonly');
            }
        }

        window.onAuthRoleChanged = function (user) {
            if (user && currentClientId) {
                fetchUserRole();
                initTimeTracking();
            } else {
                setCurrentRole('readonly');
            }
        };

        async function openRoleManagerModal() {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            if (!canManageRoles()) {
                alert('Nemate opravneni spravovat role');
                return;
            }
            await loadRoleManagerList();
            document.getElementById('roleManagerModal').classList.add('active');
        }

        function closeRoleManagerModal() {
            document.getElementById('roleManagerModal').classList.remove('active');
        }

        async function loadRoleManagerList() {
            if (!window.db || !currentClientId) return;
            try {
                const clientDoc = db.collection('clients').doc(currentClientId);
                const [usersSnap, invitesSnap] = await Promise.all([
                    clientDoc.collection('users').get(),
                    clientDoc.collection('roleInvites').get()
                ]);

                const users = {};
                usersSnap.forEach((doc) => {
                    users[doc.id] = doc.data();
                });

                const invites = {};
                invitesSnap.forEach((doc) => {
                    invites[doc.id] = doc.data();
                });

                renderRoleManagerList(users, invites);
            } catch (err) {
                console.warn('Role list load failed:', err);
            }
        }

        async function addRoleInvite() {
            if (!canManageRoles()) {
                alert('Nemate opravneni spravovat role');
                return;
            }
            if (!window.db || !currentClientId) return;

            const emailInput = document.getElementById('roleInviteEmail');
            const roleSelect = document.getElementById('roleInviteRole');
            const email = emailInput ? emailInput.value.trim().toLowerCase() : '';
            const role = roleSelect ? roleSelect.value : 'technician';

            if (!email || !email.includes('@')) {
                alert('Zadejte platny email');
                return;
            }

            const safeRole = ROLE_PERMISSIONS[role] ? role : 'readonly';
            const emailKey = normalizeEmailKey(email);

            try {
                await db.collection('clients')
                    .doc(currentClientId)
                    .collection('roleInvites')
                    .doc(emailKey)
                    .set({
                        email: email,
                        role: safeRole,
                        invitedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                if (emailInput) emailInput.value = '';
                await loadRoleManagerList();
            } catch (err) {
                console.warn('Role invite failed:', err);
            }
        }

        async function removeRoleInvite(emailKey) {
            if (!canManageRoles()) {
                alert('Nemate opravneni spravovat role');
                return;
            }
            if (!window.db || !currentClientId) return;
            try {
                await db.collection('clients')
                    .doc(currentClientId)
                    .collection('roleInvites')
                    .doc(emailKey)
                    .delete();
                await loadRoleManagerList();
            } catch (err) {
                console.warn('Role invite remove failed:', err);
            }
        }

        function renderRoleManagerList(users, invites) {
            const container = document.getElementById('roleManagerList');
            if (!container) return;
            const entries = Object.entries(users || {});
            const inviteEntries = Object.entries(invites || {});

            const roleOptions = Object.keys(ROLE_LABELS)
                .map((role) => `<option value="${role}">${ROLE_LABELS[role]}</option>`)
                .join('');

            const userRows = entries.map(([uid, user]) => {
                const email = user.email || uid;
                const name = user.name || '';
                return `
                    <tr>
                        <td>${name || '-'}</td>
                        <td>${email}</td>
                        <td>
                            <select class="role-select" onchange="updateUserRole('${uid}', this.value)">
                                ${roleOptions}
                            </select>
                        </td>
                    </tr>
                `;
            });

            const inviteRows = inviteEntries.map(([emailKey, invite]) => {
                return `
                    <tr>
                        <td>${invite.email || emailKey}</td>
                        <td>${ROLE_LABELS[invite.role] || invite.role || 'Read-only'}</td>
                        <td>
                            <button class="delete-btn" onclick="removeRoleInvite('${emailKey}')">Odebrat</button>
                        </td>
                    </tr>
                `;
            });

            const userTable = entries.length
                ? `
                    <table class="role-manager-table">
                        <thead>
                            <tr>
                                <th>Uzivatel</th>
                                <th>Email / UID</th>
                                <th>Role</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${userRows.join('')}
                        </tbody>
                    </table>
                `
                : '<div class="empty-state"><p>Zadni uzivatele</p></div>';

            const inviteTable = inviteEntries.length
                ? `
                    <div class="role-invite-list">
                        <div class="role-note">Pozvanky</div>
                        <table class="role-manager-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Akce</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${inviteRows.join('')}
                            </tbody>
                        </table>
                    </div>
                `
                : '';

            container.innerHTML = userTable + inviteTable;

            entries.forEach(([uid, user], index) => {
                const select = container.querySelectorAll('.role-select')[index];
                if (select) {
                    select.value = user.role || 'readonly';
                }
            });
        }

        async function updateUserRole(uid, role) {
            if (!canManageRoles()) {
                alert('Nemate opravneni spravovat role');
                return;
            }
            if (!window.db || !currentClientId) return;
            try {
                const safeRole = ROLE_PERMISSIONS[role] ? role : 'readonly';
                await db.collection('clients')
                    .doc(currentClientId)
                    .collection('users')
                    .doc(uid)
                    .set({
                        role: safeRole,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                if (auth && auth.currentUser && uid === auth.currentUser.uid) {
                    setCurrentRole(safeRole);
                }
            } catch (err) {
                console.warn('Role update failed:', err);
            }
        }

        function renderMspModules(targetId) {
            const grid = document.getElementById(targetId || 'mspModulesGrid');
            if (!grid) return;

            const cards = mspModules.map((module) => {
                const statusLabel = module.status === 'active' ? 'Active' : 'Planned';
                return `
                    <div class="msp-module-card">
                        <div class="msp-module-meta">${module.category}</div>
                        <div class="msp-module-title">${module.name}</div>
                        <div class="msp-module-desc">${module.description}</div>
                        <div class="msp-module-status">${statusLabel}</div>
                    </div>
                `;
            });

            grid.innerHTML = cards.join('');
        }

        function renderClientOverview() {
            const grid = document.getElementById('overviewGrid');
            const name = document.getElementById('overviewClientName');
            if (!grid) return;

            const client = clients.find((c) => c.id === currentClientId);
            if (name) {
                name.textContent = client ? client.name : '-';
            }

            const totalUnits = racks.reduce((sum, rack) => sum + rack.units, 0);
            const usedUnits = devices.reduce((sum, device) => sum + device.height, 0);
            const freeUnits = Math.max(totalUnits - usedUnits, 0);

            const cards = [
                {
                    title: 'Racky',
                    value: racks.length,
                    desc: 'Sprava fyzickych racku',
                    view: 'racks'
                },
                {
                    title: 'Zarizeni',
                    value: devices.length,
                    desc: 'Aktivni inventar zarizeni',
                    view: 'racks'
                },
                {
                    title: 'Propojeni',
                    value: connections.length,
                    desc: 'Topologie a linky',
                    view: 'network'
                },
                {
                    title: 'Volne U',
                    value: freeUnits,
                    desc: 'Kapacita pro rozsireni',
                    view: 'racks'
                }
            ];

            grid.innerHTML = cards.map((card) => `
                <div class="overview-card" onclick="switchView('${card.view}')">
                    <div class="overview-card-title">${card.title}</div>
                    <div class="overview-card-value">${card.value}</div>
                    <div class="overview-card-desc">${card.desc}</div>
                </div>
            `).join('');

            renderMspModules();
        }

        function getClientSnapshot(clientId) {
            if (clientId === currentClientId) {
                return {
                    racks: racks || [],
                    devices: devices || [],
                    connections: connections || []
                };
            }
            const data = clientData[clientId] || {};
            return {
                racks: data.racks || [],
                devices: data.devices || [],
                connections: data.connections || []
            };
        }

        function getAggregateStats() {
            const totals = {
                clients: clients.length,
                racks: 0,
                devices: 0,
                connections: 0
            };

            clients.forEach((client) => {
                const snapshot = getClientSnapshot(client.id);
                totals.racks += snapshot.racks.length;
                totals.devices += snapshot.devices.length;
                totals.connections += snapshot.connections.length;
            });

            return totals;
        }

        function renderDashboard() {
            const grid = document.getElementById('dashboardGrid');
            const roleEl = document.getElementById('dashboardRole');
            const clientEl = document.getElementById('dashboardClient');
            if (!grid) return;

            const totals = getAggregateStats();
            const client = clients.find((c) => c.id === currentClientId);
            const roleLabel = ROLE_LABELS[currentUserRole] || ROLE_LABELS.readonly;

            if (roleEl) roleEl.textContent = roleLabel;
            if (clientEl) clientEl.textContent = client ? client.name : 'Nezvoleno';

            const cards = [
                {
                    title: 'Klienti',
                    value: totals.clients,
                    desc: 'Prehled spravovanych klientu',
                    action: "openClientManagerModal()"
                },
                {
                    title: 'Racky',
                    value: totals.racks,
                    desc: 'Celkem racku napric klienty',
                    action: currentClientId ? "switchView('racks')" : "openClientManagerModal()"
                },
                {
                    title: 'Zarizeni',
                    value: totals.devices,
                    desc: 'Inventar zarizeni',
                    action: currentClientId ? "switchView('racks')" : "openClientManagerModal()"
                },
                {
                    title: 'Propojeni',
                    value: totals.connections,
                    desc: 'Topologie a linky',
                    action: currentClientId ? "switchView('network')" : "openClientManagerModal()"
                }
            ];

            grid.innerHTML = cards.map((card) => `
                <div class="overview-card" onclick="${card.action}">
                    <div class="overview-card-title">${card.title}</div>
                    <div class="overview-card-value">${card.value}</div>
                    <div class="overview-card-desc">${card.desc}</div>
                </div>
            `).join('');

            renderMspModules('dashboardModulesGrid');
            applyRolePermissions();
        }

        async function syncZabbixClients() {
            try {
                const response = await fetch('/api/zabbix-hostgroups');
                if (!response.ok) {
                    console.warn('Zabbix sync failed:', response.status);
                    return;
                }
                const data = await response.json();
                if (!data || !Array.isArray(data.groups)) return;

                const zabbixClients = data.groups.map((group) => ({
                    id: `zbx-${group.id}`,
                    name: group.name,
                    type: 'zabbix',
                    source: 'zabbix',
                    createdAt: new Date().toISOString()
                }));

                const manualClients = clients.filter((client) => client.source !== 'zabbix');
                clients = [...manualClients, ...zabbixClients].sort((a, b) =>
                    a.name.localeCompare(b.name, 'cs', { sensitivity: 'base' })
                );
            } catch (err) {
                console.warn('Zabbix sync failed:', err);
            }
        }

        function normalizeModuleId(value) {
            if (!value) return '';
            return value
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }

        function hexToRgb(hex) {
            if (!hex) return null;
            let clean = hex.replace('#', '').trim();
            if (clean.length === 3) {
                clean = clean.split('').map((c) => c + c).join('');
            }
            if (clean.length !== 6) return null;
            const num = parseInt(clean, 16);
            if (Number.isNaN(num)) return null;
            return {
                r: (num >> 16) & 255,
                g: (num >> 8) & 255,
                b: num & 255
            };
        }

        function hexToRgba(hex, alpha) {
            const rgb = hexToRgb(hex);
            if (!rgb) return `rgba(248, 154, 85, ${alpha})`;
            return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`;
        }

        function darkenColor(hex, percent) {
            const rgb = hexToRgb(hex);
            if (!rgb) return '#64748b';
            const factor = Math.max(0, Math.min(1, 1 - percent / 100));
            const r = Math.round(rgb.r * factor);
            const g = Math.round(rgb.g * factor);
            const b = Math.round(rgb.b * factor);
            return `rgb(${r}, ${g}, ${b})`;
        }

        function getContrastColor(hex) {
            const rgb = hexToRgb(hex);
            if (!rgb) return '#000000';
            const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
            return brightness > 160 ? '#000000' : '#ffffff';
        }

        function loadModuleTypes() {
            const saved = localStorage.getItem('rackManagerModuleTypes');
            customModuleTypes = saved ? JSON.parse(saved) : [];
            const merged = [...DEFAULT_MODULE_TYPES, ...customModuleTypes];
            const seen = new Set();
            moduleTypes = merged.filter((type) => {
                if (!type || !type.id || seen.has(type.id)) return false;
                seen.add(type.id);
                return true;
            });
        }

        function saveModuleTypes() {
            localStorage.setItem('rackManagerModuleTypes', JSON.stringify(customModuleTypes));
        }

        function getModuleType(typeId) {
            return moduleTypes.find((type) => type.id === typeId) || null;
        }

        function getModuleTypeLabel(typeId) {
            const type = getModuleType(typeId);
            return type ? type.label : typeId;
        }

        function getModuleTypeColors(typeId) {
            const type = getModuleType(typeId);
            const base = type && type.color ? type.color : '#94a3b8';
            const gradient = type && type.gradient ? type.gradient : [base, darkenColor(base, 30)];
            const text = type && type.text ? type.text : getContrastColor(base);
            const label = type && type.label ? type.label : typeId;
            const group = type && type.group ? type.group : 'Other';
            return { base, gradient, text, label, group };
        }

        function getModuleStyleVars(typeId) {
            const colors = getModuleTypeColors(typeId);
            return `--device-color: ${colors.base}; --device-gradient: linear-gradient(90deg, ${colors.gradient[0]}, ${colors.gradient[1]}); --device-text: ${colors.text};`;
        }

        function getModuleBadgeVars(typeId) {
            const colors = getModuleTypeColors(typeId);
            return `--badge-bg: ${hexToRgba(colors.base, 0.2)}; --badge-border: ${hexToRgba(colors.base, 0.5)}; --badge-color: ${colors.base};`;
        }

        function renderDeviceTypeOptions(selectedId) {
            const select = document.getElementById('deviceType');
            if (!select) return;
            const current = selectedId || select.value;
            if (!moduleTypes.length) {
                select.innerHTML = '<option value="">Zadne kategorie</option>';
                return;
            }
            select.innerHTML = moduleTypes.map((type) => {
                return `<option value="${type.id}">${type.label}</option>`;
            }).join('');
            const fallback = moduleTypes[0].id;
            select.value = moduleTypes.some((type) => type.id === current) ? current : fallback;
        }

        function renderModuleList() {
            const list = document.getElementById('moduleList');
            if (!list) return;
            const customIds = new Set(customModuleTypes.map((type) => type.id));
            const items = moduleTypes.map((type) => {
                const colors = getModuleTypeColors(type.id);
                const isCustom = customIds.has(type.id);
                const action = isCustom
                    ? `<button class="delete-btn" onclick="deleteModuleType('${type.id}')">Smazat</button>`
                    : `<span class="module-id">system</span>`;
                return `
                    <div class="module-item">
                        <div class="module-meta">
                            <span class="module-color" style="background: ${colors.base};"></span>
                            <span>${type.label}</span>
                            <span class="module-id">${type.id}</span>
                            <span class="module-id">${type.group || 'Other'}</span>
                        </div>
                        ${action}
                    </div>
                `;
            });
            list.innerHTML = items.join('') || '<div class="empty-state"><p>Zadne kategorie</p></div>';
        }

        function clearModuleForm() {
            document.getElementById('moduleName').value = '';
            document.getElementById('moduleId').value = '';
            document.getElementById('moduleGroup').value = 'Network';
            document.getElementById('moduleColor').value = '#00ff88';
        }

        function openModuleModal() {
            if (!canManageCategories()) {
                alert('Nemate opravneni spravovat kategorie');
                return;
            }
            loadModuleTypes();
            renderModuleList();
            renderDeviceTypeOptions();
            document.getElementById('moduleModal').classList.add('active');
        }

        function closeModuleModal() {
            document.getElementById('moduleModal').classList.remove('active');
            clearModuleForm();
        }

        function addModuleType() {
            if (!canManageCategories()) {
                alert('Nemate opravneni spravovat kategorie');
                return;
            }
            const name = document.getElementById('moduleName').value.trim();
            const rawId = document.getElementById('moduleId').value.trim();
            const group = document.getElementById('moduleGroup').value;
            const color = document.getElementById('moduleColor').value || '#00ff88';

            if (!name) {
                alert('Nazev kategorie je povinny');
                return;
            }

            const id = normalizeModuleId(rawId || name);
            if (!id) {
                alert('ID kategorie je neplatne');
                return;
            }

            if (moduleTypes.some((type) => type.id === id)) {
                alert('Kategorie s timto ID uz existuje');
                return;
            }

            customModuleTypes.push({
                id,
                label: name,
                color,
                gradient: [color, darkenColor(color, 30)],
                text: getContrastColor(color),
                group
            });

            saveModuleTypes();
            loadModuleTypes();
            renderDeviceTypeOptions(id);
            renderModuleList();
            clearModuleForm();
        }

        function deleteModuleType(id) {
            if (!canManageCategories()) {
                alert('Nemate opravneni spravovat kategorie');
                return;
            }
            const inUse = devices.some((device) => device.type === id);
            if (inUse && !confirm('Kategorie je pouzita v zarizenich. Pokracovat?')) {
                return;
            }
            customModuleTypes = customModuleTypes.filter((type) => type.id !== id);
            saveModuleTypes();
            loadModuleTypes();
            renderDeviceTypeOptions();
            renderModuleList();
        }
        
        // Initialize from localStorage
        async function init() {
            // Load clients
            const savedClients = localStorage.getItem('rackManagerClients');
            if (savedClients) {
                clients = JSON.parse(savedClients);
            }
            
            // Load all client data
            const savedClientData = localStorage.getItem('rackManagerClientData');
            if (savedClientData) {
                clientData = JSON.parse(savedClientData);
            }
            
            // Check if there was a previously selected client
            const lastClientId = localStorage.getItem('rackManagerLastClient');
            if (lastClientId && clients.find(c => c.id === lastClientId)) {
                currentClientId = lastClientId;
                loadClientData(currentClientId);
            }
            
            loadModuleTypes();
            renderDeviceTypeOptions();
            await syncZabbixClients();
            updateClientSelector();
            render();
            fetchUserRole();
        }
        
        // Save data to localStorage
        function saveData() {
            // Save current client's data
            if (currentClientId) {
                clientData[currentClientId] = {
                    racks,
                    devices,
                    connections
                };
            }
            
            localStorage.setItem('rackManagerClients', JSON.stringify(clients));
            localStorage.setItem('rackManagerClientData', JSON.stringify(clientData));
            if (currentClientId) {
                localStorage.setItem('rackManagerLastClient', currentClientId);
            }
        }
        
        // Load data for specific client
        function loadClientData(clientId) {
            if (clientData[clientId]) {
                racks = clientData[clientId].racks || [];
                devices = clientData[clientId].devices || [];
                connections = clientData[clientId].connections || [];
            } else {
                racks = [];
                devices = [];
                connections = [];
            }
        }
        
        // Switch client
        function switchClient() {
            const selector = document.getElementById('clientSelector');
            const clientId = selector.value;
            
            if (!clientId) {
                currentClientId = null;
                racks = [];
                devices = [];
                connections = [];
                document.getElementById('clientInfo').style.display = 'none';
                disableControls();
                render();
                return;
            } else {
                currentClientId = clientId;
                loadClientData(clientId);
                updateClientInfo();
                enableControls();
            }
            render();
            fetchUserRole();
            initTimeTracking();
            switchView('overview');
        }
        
        // Update client selector
        function updateClientSelector() {
            const selector = document.getElementById('clientSelector');
            selector.innerHTML = '<option value="">-- Vyberte klienta --</option>' + 
                clients.map(client => 
                    `<option value="${client.id}" ${client.id === currentClientId ? 'selected' : ''}>${client.name}</option>`
                ).join('');
        }
        
        // Update client info panel
        function updateClientInfo() {
            const client = clients.find(c => c.id === currentClientId);
            const dashboardContact = document.getElementById('dashboardContact');
            const dashboardLocation = document.getElementById('dashboardLocation');
            const dashboardType = document.getElementById('dashboardType');
            const dashboardIco = document.getElementById('dashboardIco');
            const dashboardLogo = document.getElementById('dashboardLogoPrimary');
            if (client) {
                document.getElementById('clientInfo').style.display = 'block';
                document.getElementById('clientName').textContent = client.name + (client.ico ? ` (ICO: ${client.ico})` : '');
                updateRoleLabel();
                document.getElementById('clientContact').textContent = client.contact ? `Kontakt: ${client.contact}` : '';
                document.getElementById('clientLocation').textContent = client.address ? `Adresa: ${client.address}` : '';
                document.getElementById('clientType').textContent = client.type.toUpperCase();
                if (dashboardContact) dashboardContact.textContent = client.contact || 'Neuvedeno';
                if (dashboardLocation) dashboardLocation.textContent = client.address || 'Neuvedeno';
                if (dashboardType) dashboardType.textContent = client.type ? client.type.toUpperCase() : '-';
                if (dashboardIco) dashboardIco.textContent = client.ico || 'Neuvedeno';
                if (dashboardLogo) {
                    const parts = (client.name || '').trim().split(/\s+/).filter(Boolean);
                    const initials = parts.slice(0, 2).map(part => part[0]).join('').toUpperCase();
                    dashboardLogo.textContent = initials || 'LOGO';
                }
            } else {
                document.getElementById('clientInfo').style.display = 'none';
                if (dashboardContact) dashboardContact.textContent = '-';
                if (dashboardLocation) dashboardLocation.textContent = '-';
                if (dashboardType) dashboardType.textContent = '-';
                if (dashboardIco) dashboardIco.textContent = '-';
                if (dashboardLogo) dashboardLogo.textContent = 'LOGO';
            }
        }
        
        // Enable/disable controls
        function enableControls() {
            applyRolePermissions();
        }
        
        function disableControls() {
            document.getElementById('addRackBtn').disabled = true;
            document.getElementById('clearRacksBtn').disabled = true;
            document.getElementById('addDeviceBtn').disabled = true;
            document.getElementById('addConnectionBtn').disabled = true;
        }
        
        // View switching
        function switchView(view, button) {
            if (view === 'reports' && !canViewReports()) {
                alert('Nemate opravneni zobrazit reporty');
                view = 'dashboard';
            }
            currentView = view;
            // Update toggle buttons
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeButton = button || document.querySelector(`.view-toggle-btn[data-view="${view}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Hide all views
            document.getElementById('racksView').style.display = 'none';
            document.getElementById('networkView').style.display = 'none';
            document.getElementById('topologyView').style.display = 'none';
            document.getElementById('overviewView').style.display = 'none';
            document.getElementById('timeView').style.display = 'none';
            document.getElementById('reportsView').style.display = 'none';
            document.getElementById('dashboardView').style.display = 'none';
            
            // Show selected view
            switch(view) {
                case 'dashboard':
                    document.getElementById('dashboardView').style.display = 'block';
                    renderDashboard();
                    break;
                case 'racks':
                    document.getElementById('racksView').style.display = 'block';
                    break;
                case 'network':
                    document.getElementById('networkView').style.display = 'block';
                    initNetworkVisualization();
                    break;
                case 'topology':
                    document.getElementById('topologyView').style.display = 'block';
                    renderTopologyView();
                    break;
                case 'overview':
                    document.getElementById('overviewView').style.display = 'block';
                    renderClientOverview();
                    break;
                case 'time':
                    document.getElementById('timeView').style.display = 'block';
                    if (currentClientId) {
                        loadTimeEntriesForWeek();
                    } else {
                        renderTimeTracking();
                    }
                    break;
                case 'reports':
                    document.getElementById('reportsView').style.display = 'block';
                    reportHasLoaded = false;
                    reportFiltersVisible = false;
                    renderReportsView();
                    break;
            }
        }
        
        // Network Visualization
        let networkCanvas, networkCtx;
        let networkNodes = [];
        let networkEdges = [];
        let isDragging = false;
        let dragNode = null;
        let offsetX, offsetY;
        let networkLinkDraft = null;
        
        function initNetworkVisualization() {
            if (!currentClientId) return;
            
            networkCanvas = document.getElementById('networkCanvas');
            if (!networkCanvas) return;
            
            networkCtx = networkCanvas.getContext('2d');
            
            // Set canvas size
            networkCanvas.width = networkCanvas.clientWidth;
            networkCanvas.height = 500;
            
            // Build network data
            buildNetworkData();
            
            // Draw network
            drawNetwork();
            
            // Update stats
            updateNetworkStats();
            
            // Add event listeners
            networkCanvas.addEventListener('mousedown', handleNetworkMouseDown);
            networkCanvas.addEventListener('mousemove', handleNetworkMouseMove);
            networkCanvas.addEventListener('mouseup', handleNetworkMouseUp);
            networkCanvas.addEventListener('dblclick', handleNetworkDoubleClick);
        }
        
        function buildNetworkData() {
            networkNodes = [];
            networkEdges = [];
            
            // Create nodes for each device
            devices.forEach((device, index) => {
                const angle = (index / devices.length) * Math.PI * 2;
                const radius = 150;
                const centerX = networkCanvas.width / 2;
                const centerY = networkCanvas.height / 2;
                
                networkNodes.push({
                    id: device.id,
                    name: device.name,
                    type: device.type,
                    x: centerX + Math.cos(angle) * radius,
                    y: centerY + Math.sin(angle) * radius,
                    ports: device.ports || 24,
                    device: device
                });
            });
            
            // Create edges for connections
            connections.forEach(conn => {
                const fromNode = networkNodes.find(n => n.id === conn.fromDevice);
                const toNode = networkNodes.find(n => n.id === conn.toDevice);
                
                if (fromNode && toNode) {
                    networkEdges.push({
                        from: fromNode,
                        to: toNode,
                        connection: conn
                    });
                }
            });
        }
        
        function drawNetwork() {
            if (!networkCtx) return;
            
            // Clear canvas
            networkCtx.clearRect(0, 0, networkCanvas.width, networkCanvas.height);
            
            // Draw edges
            networkEdges.forEach(edge => {
                networkCtx.beginPath();
                networkCtx.moveTo(edge.from.x, edge.from.y);
                networkCtx.lineTo(edge.to.x, edge.to.y);
                
                // Style based on connection type
                if (edge.connection.type === 'trunk') {
                    networkCtx.strokeStyle = '#ff00ff';
                    networkCtx.lineWidth = 3;
                } else if (edge.connection.type === 'uplink') {
                    networkCtx.strokeStyle = '#00ffff';
                    networkCtx.lineWidth = 4;
                } else {
                    networkCtx.strokeStyle = '#00ff88';
                    networkCtx.lineWidth = 2;
                }
                
                networkCtx.stroke();
                
                // Draw speed label
                const midX = (edge.from.x + edge.to.x) / 2;
                const midY = (edge.from.y + edge.to.y) / 2;
                networkCtx.fillStyle = '#ffffff';
                networkCtx.font = '10px IBM Plex Mono';
                networkCtx.textAlign = 'center';
                const speed = edge.connection.speed >= 1000 ? 
                    (edge.connection.speed / 1000) + 'G' : 
                    edge.connection.speed + 'M';
                networkCtx.fillText(speed, midX, midY - 5);
            });

            if (networkLinkDraft) {
                networkCtx.beginPath();
                networkCtx.setLineDash([6, 6]);
                networkCtx.moveTo(networkLinkDraft.from.x, networkLinkDraft.from.y);
                networkCtx.lineTo(networkLinkDraft.x, networkLinkDraft.y);
                networkCtx.strokeStyle = '#fbbf24';
                networkCtx.lineWidth = 2;
                networkCtx.stroke();
                networkCtx.setLineDash([]);
            }
            
            // Draw nodes
            networkNodes.forEach(node => {
                const nodeColors = getModuleTypeColors(node.type);

                // Node circle
                networkCtx.beginPath();
                networkCtx.arc(node.x, node.y, 30, 0, Math.PI * 2);
                networkCtx.fillStyle = nodeColors.base;
                networkCtx.fill();
                networkCtx.strokeStyle = '#ffffff';
                networkCtx.lineWidth = 2;
                networkCtx.stroke();
                
                // Node label
                networkCtx.fillStyle = nodeColors.text;
                networkCtx.font = 'bold 12px IBM Plex Mono';
                networkCtx.textAlign = 'center';
                networkCtx.fillText(node.name, node.x, node.y + 5);
                
                // Port count
                networkCtx.fillStyle = nodeColors.text;
                networkCtx.font = '10px IBM Plex Mono';
                networkCtx.fillText(node.ports + ' ports', node.x, node.y + 45);
            });
        }

        function getNodeAtPosition(x, y) {
            return networkNodes.find(node => {
                const dx = x - node.x;
                const dy = y - node.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                return distance <= 30;
            });
        }
        
        function handleNetworkMouseDown(e) {
            const rect = networkCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const node = getNodeAtPosition(x, y);

            if (networkLinkDraft) {
                if (!node) {
                    networkLinkDraft = null;
                    drawNetwork();
                }
                return;
            }

            if (e.shiftKey && node) {
                if (!canEditTopology()) {
                    return;
                }
                networkLinkDraft = {
                    from: node,
                    x,
                    y
                };
                networkCanvas.style.cursor = 'crosshair';
                drawNetwork();
                return;
            }

            if (!canEditTopology()) {
                return;
            }

            if (node) {
                const dx = x - node.x;
                const dy = y - node.y;
                isDragging = true;
                dragNode = node;
                offsetX = dx;
                offsetY = dy;
                networkCanvas.style.cursor = 'grabbing';
            }
        }
        
        function handleNetworkMouseMove(e) {
            const rect = networkCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (networkLinkDraft) {
                networkLinkDraft.x = x;
                networkLinkDraft.y = y;
                drawNetwork();
                return;
            }

            if (isDragging && dragNode) {
                dragNode.x = x - offsetX;
                dragNode.y = y - offsetY;
                drawNetwork();
            }
        }
        
        function handleNetworkMouseUp(e) {
            const rect = networkCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (networkLinkDraft) {
                const targetNode = getNodeAtPosition(x, y);
                if (targetNode && targetNode.id !== networkLinkDraft.from.id) {
                    openConnectionModal({
                        fromDevice: networkLinkDraft.from.id,
                        toDevice: targetNode.id
                    });
                }
                networkLinkDraft = null;
                networkCanvas.style.cursor = 'grab';
                drawNetwork();
                return;
            }

            isDragging = false;
            dragNode = null;
            networkCanvas.style.cursor = 'grab';
        }
        
        function handleNetworkDoubleClick(e) {
            const rect = networkCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Check if double-clicking on a node
            const node = getNodeAtPosition(x, y);
            if (node) {
                showPortDetails(node.device);
            }
        }
        
        function resetNetworkView() {
            buildNetworkData();
            drawNetwork();
        }
        
        function exportNetworkDiagram() {
            const link = document.createElement('a');
            link.download = 'network-diagram.png';
            link.href = networkCanvas.toDataURL();
            link.click();
        }
        
        function updateNetworkStats() {
            const totalPortsCount = devices.reduce((sum, d) => sum + (d.ports || 24), 0);
            const usedPortsCount = connections.length * 2; // Each connection uses 2 ports
            const trunkPortsCount = connections.filter(c => c.type === 'trunk').length * 2;
            
            document.getElementById('totalConnections').textContent = connections.length;
            document.getElementById('totalPorts').textContent = totalPortsCount;
            document.getElementById('usedPorts').textContent = usedPortsCount;
            document.getElementById('trunkPorts').textContent = trunkPortsCount;
        }
        
        // Port Management
        let currentPortDeviceId = null;
        let pendingPortSelection = null;
        let portFilterState = {
            query: '',
            showFree: true,
            showConnected: true,
            showTrunk: true,
            showUplink: true
        };

        function findPortConnection(deviceId, portNumber) {
            return connections.find(c =>
                (c.fromDevice === deviceId && c.fromPort === portNumber) ||
                (c.toDevice === deviceId && c.toPort === portNumber)
            );
        }

        function getPortConnections(deviceId, portNumber) {
            return connections.filter(c =>
                (c.fromDevice === deviceId && c.fromPort === portNumber) ||
                (c.toDevice === deviceId && c.toPort === portNumber)
            );
        }

        function isPortUsed(deviceId, portNumber) {
            return getPortConnections(deviceId, portNumber).length > 0;
        }

        function setPortFilter(key, value) {
            portFilterState[key] = value;
            renderPortDetails();
        }

        function renderPortDetails() {
            if (!currentPortDeviceId) return;
            const device = devices.find(d => d.id === currentPortDeviceId);
            if (!device) return;
            document.getElementById('portDetailsTitle').textContent = device.name + ' - Port Management';
            renderPortDetailsContent(device);
        }

        function showPortDetails(device) {
            currentPortDeviceId = device.id;
            document.getElementById('portDetailsOverlay').classList.add('active');
            document.getElementById('portDetailsTitle').textContent = device.name + ' - Port Management';
            renderPortDetailsContent(device);
        }

        function switchPortDevice(deviceId) {
            currentPortDeviceId = deviceId;
            renderPortDetails();
        }

        function renderPortDetailsContent(device) {
            
            const content = document.getElementById('portDetailsContent');
            const portCount = device.ports || 24;
            const hint = canEditTopology()
                ? 'Klikni na volny port pro rychle propojeni.'
                : 'Pro propojeni potrebujes prava pro topologii.';
            
            // Get connections for this device
            const deviceConnections = connections.filter(c => 
                c.fromDevice === device.id || c.toDevice === device.id
            );
            
            const pendingDevice = pendingPortSelection
                ? devices.find(d => d.id === pendingPortSelection.deviceId)
                : null;
            const pendingLabel = pendingPortSelection
                ? `Vybrano: ${(pendingDevice ? pendingDevice.name : 'Zarizeni')}:${pendingPortSelection.portNumber}`
                : '';

            const deviceOptions = devices.map(d =>
                `<option value="${d.id}" ${d.id === device.id ? 'selected' : ''}>${d.name}</option>`
            ).join('');

            let html = `
                <div class="port-hint">${hint}${pendingLabel ? ' | ' + pendingLabel : ''}</div>
                <div class="port-filters">
                    <select class="port-device-select" onchange="switchPortDevice(this.value)">
                        ${deviceOptions}
                    </select>
                    <input class="port-filter-input" type="text" placeholder="Filtr portu (cislo / nazev)" value="${portFilterState.query}" oninput="setPortFilter('query', this.value)">
                    <label class="port-filter-toggle"><input type="checkbox" ${portFilterState.showFree ? 'checked' : ''} onchange="setPortFilter('showFree', this.checked)">Volne</label>
                    <label class="port-filter-toggle"><input type="checkbox" ${portFilterState.showConnected ? 'checked' : ''} onchange="setPortFilter('showConnected', this.checked)">Obsazene</label>
                    <label class="port-filter-toggle"><input type="checkbox" ${portFilterState.showTrunk ? 'checked' : ''} onchange="setPortFilter('showTrunk', this.checked)">Trunk</label>
                    <label class="port-filter-toggle"><input type="checkbox" ${portFilterState.showUplink ? 'checked' : ''} onchange="setPortFilter('showUplink', this.checked)">Uplink</label>
                </div>
                <div class="port-grid">
            `;
            
            for (let i = 1; i <= portCount; i++) {
                const portConnections = deviceConnections.filter(c =>
                    (c.fromDevice === device.id && c.fromPort === i) ||
                    (c.toDevice === device.id && c.toPort === i)
                );
                const conn = portConnections[0];
                
                let portClass = 'port-item';
                let portLabel = '';
                const isConnected = portConnections.length > 0;
                const isTrunk = portConnections.some(c => c.type === 'trunk');
                const isUplink = portConnections.some(c => c.type === 'uplink');
                const isConflict = portConnections.length > 1;
                
                if (isConnected) {
                    portClass += ' connected';
                    if (isTrunk) portClass += ' trunk';
                    if (isUplink) portClass += ' uplink';
                    if (isConflict) portClass += ' conflict';
                    
                    // Find connected device
                    const connectedDeviceId = conn.fromDevice === device.id ? 
                        conn.toDevice : conn.fromDevice;
                    const connectedDevice = devices.find(d => d.id === connectedDeviceId);
                    portLabel = connectedDevice ? connectedDevice.name : 'Connected';
                }

                if (pendingPortSelection && pendingPortSelection.deviceId === device.id && pendingPortSelection.portNumber === i) {
                    portClass += ' pending';
                }

                const searchValue = `${i} ${portLabel} ${isTrunk ? 'trunk' : ''} ${isUplink ? 'uplink' : ''}`.toLowerCase();
                const query = (portFilterState.query || '').trim().toLowerCase();
                if (query && !searchValue.includes(query)) {
                    continue;
                }
                if (!isConnected && !portFilterState.showFree) continue;
                if (isConnected && !portFilterState.showConnected) continue;
                if (isTrunk && !portFilterState.showTrunk) continue;
                if (isUplink && !portFilterState.showUplink) continue;
                
                html += `
                    <div class="${portClass}" onclick="configurePort('${device.id}', ${i})">
                        <div class="port-number">${i}</div>
                        ${portLabel ? `<div class="port-label">${portLabel}</div>` : ''}
                        ${isConflict ? `<div class="port-label" style="color: var(--danger);">Konflikt</div>` : ''}
                        ${conn && conn.vlans ? `<div class="vlan-tag">VLAN ${conn.vlans}</div>` : ''}
                    </div>
                `;
            }
            
            html += `
                </div>
                <div style="margin-top: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Aktivn propojen</h3>
            `;
            
            if (deviceConnections.length > 0) {
                deviceConnections.forEach(conn => {
                    const otherDeviceId = conn.fromDevice === device.id ? 
                        conn.toDevice : conn.fromDevice;
                    const otherDevice = devices.find(d => d.id === otherDeviceId);
                    const fromPort = conn.fromDevice === device.id ? conn.fromPort : conn.toPort;
                    const toPort = conn.fromDevice === device.id ? conn.toPort : conn.fromPort;
                    let tailLabel = '';
                    if (otherDevice && otherDevice.type === 'patch') {
                        const patchPort = otherDevice.id === conn.fromDevice ? conn.fromPort : conn.toPort;
                        tailLabel = getPatchTailLabel(otherDevice.id, patchPort, conn.id);
                    } else if (device.type === 'patch') {
                        const patchPort = device.id === conn.fromDevice ? conn.fromPort : conn.toPort;
                        tailLabel = getPatchTailLabel(device.id, patchPort, conn.id);
                    }
                    
                    html += `
                        <div class="connection-path">
                            <div class="connection-path-device">${device.name}:${fromPort}</div>
                            <div class="connection-path-arrow"></div>
                            <div class="connection-path-device">${otherDevice ? otherDevice.name : 'Unknown'}:${toPort}</div>
                            ${tailLabel ? `<div class="connection-path-arrow"></div><div class="connection-path-device">${tailLabel}</div>` : ''}
                            <div style="margin-left: auto;">
                                <span class="connection-path-port">
                                    ${conn.type} | ${conn.speed >= 1000 ? (conn.speed/1000) + 'G' : conn.speed + 'M'}
                                    ${conn.description ? ' | ' + conn.description : ''}
                                </span>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p style="color: var(--text-secondary);">dn aktivn propojen</p>';
            }
            
            html += '</div>';
            
            content.innerHTML = html;
        }
        
        function closePortDetails() {
            document.getElementById('portDetailsOverlay').classList.remove('active');
            pendingPortSelection = null;
            currentPortDeviceId = null;
        }
        
        function configurePort(deviceId, portNumber) {
            if (!canEditTopology()) {
                alert('Nemate opravneni upravovat topologii');
                return;
            }

            if (isPortUsed(deviceId, portNumber)) {
                alert('Port je uz obsazeny.');
                return;
            }

            if (!pendingPortSelection) {
                pendingPortSelection = { deviceId, portNumber };
                renderPortDetails();
                return;
            }

            if (pendingPortSelection.deviceId === deviceId && pendingPortSelection.portNumber === portNumber) {
                pendingPortSelection = null;
                renderPortDetails();
                return;
            }

            if (pendingPortSelection.deviceId === deviceId) {
                alert('Nelze propojit porty na stejnem zarizeni.');
                return;
            }

            createQuickConnection(pendingPortSelection.deviceId, pendingPortSelection.portNumber, deviceId, portNumber);
            pendingPortSelection = null;
            renderPortDetails();
        }

        function createQuickConnection(fromDevice, fromPort, toDevice, toPort) {
            if (!canEditTopology()) {
                alert('Nemate opravneni upravovat topologii');
                return;
            }
            if (fromDevice === toDevice) {
                alert('Nelze propojit zarizeni samo se sebou');
                return;
            }
            if (isPortUsed(fromDevice, fromPort) || isPortUsed(toDevice, toPort)) {
                alert('Jeden z portu je uz obsazeny');
                return;
            }

            const connection = {
                id: Date.now().toString(),
                fromDevice: fromDevice,
                fromPort: parseInt(fromPort, 10),
                toDevice: toDevice,
                toPort: parseInt(toPort, 10),
                type: 'access',
                vlans: '',
                speed: 1000,
                description: 'Quick link',
                createdAt: new Date().toISOString()
            };

            connections.push(connection);
            saveData();
            render();
        }
        
        // Connection Management
        function openConnectionModal(prefill) {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            if (!canEditTopology()) {
                alert('Nemate opravneni upravovat topologii');
                return;
            }
            if (devices.length < 2) {
                alert('Pro vytvoreni propojeni potrebujete alespon 2 zarizeni');
                return;
            }

            const deviceOptions = devices.map(d => 
                `<option value="${d.id}">${d.name} (${d.type})</option>`
            ).join('');

            const fromSelect = document.getElementById('connFromDevice');
            const toSelect = document.getElementById('connToDevice');

            fromSelect.innerHTML = deviceOptions;
            toSelect.innerHTML = deviceOptions;

            if (prefill && prefill.fromDevice) {
                fromSelect.value = prefill.fromDevice;
            }

            let targetDevice = prefill && prefill.toDevice ? prefill.toDevice : '';
            if (!targetDevice || targetDevice === fromSelect.value) {
                const other = devices.find(d => d.id !== fromSelect.value);
                targetDevice = other ? other.id : fromSelect.value;
            }
            toSelect.value = targetDevice;

            updateFromPorts();
            updateToPorts();

            if (prefill && prefill.fromPort) {
                document.getElementById('connFromPort').value = String(prefill.fromPort);
            }
            if (prefill && prefill.toPort) {
                document.getElementById('connToPort').value = String(prefill.toPort);
            }

            document.getElementById('connectionModal').classList.add('active');
        }
        
        function closeConnectionModal() {
            document.getElementById('connectionModal').classList.remove('active');
            clearConnectionForm();
        }
        
        function updateFromPorts() {
            const deviceId = document.getElementById('connFromDevice').value;
            const device = devices.find(d => d.id === deviceId);
            const portCount = device ? (device.ports || 24) : 24;
            
            let options = '';
            for (let i = 1; i <= portCount; i++) {
                // Check if port is already used
                const isUsed = connections.some(c => 
                    (c.fromDevice === deviceId && c.fromPort === i) ||
                    (c.toDevice === deviceId && c.toPort === i)
                );
                
                if (!isUsed) {
                    options += `<option value="${i}">Port ${i}</option>`;
                }
            }
            
            document.getElementById('connFromPort').innerHTML = options || '<option>Vechny porty obsazeny</option>';
        }
        
        function updateToPorts() {
            const deviceId = document.getElementById('connToDevice').value;
            const device = devices.find(d => d.id === deviceId);
            const portCount = device ? (device.ports || 24) : 24;
            
            let options = '';
            for (let i = 1; i <= portCount; i++) {
                // Check if port is already used
                const isUsed = connections.some(c => 
                    (c.fromDevice === deviceId && c.fromPort === i) ||
                    (c.toDevice === deviceId && c.toPort === i)
                );
                
                if (!isUsed) {
                    options += `<option value="${i}">Port ${i}</option>`;
                }
            }
            
            document.getElementById('connToPort').innerHTML = options || '<option>Vechny porty obsazeny</option>';
        }
        
        function addConnection() {
            if (!canEditTopology()) {
                alert('Nemate opravneni upravovat topologii');
                return;
            }
            const fromDevice = document.getElementById('connFromDevice').value;
            const fromPort = parseInt(document.getElementById('connFromPort').value);
            const toDevice = document.getElementById('connToDevice').value;
            const toPort = parseInt(document.getElementById('connToPort').value);
            const type = document.getElementById('connType').value;
            const vlans = document.getElementById('connVlans').value;
            const speed = parseInt(document.getElementById('connSpeed').value);
            const description = document.getElementById('connDescription').value;

            if (!fromDevice || !toDevice || !fromPort || !toPort) {
                alert('Vyplnte vsechny povinne udaje');
                return;
            }

            if (fromDevice === toDevice) {
                alert('Nelze propojit zarizeni samo se sebou');
                return;
            }

            const connection = {
                id: Date.now().toString(),
                fromDevice,
                fromPort,
                toDevice,
                toPort,
                type,
                vlans,
                speed,
                description,
                createdAt: new Date().toISOString()
            };

            connections.push(connection);
            saveData();
            render();
            closeConnectionModal();
        }
        
        function clearConnectionForm() {
            document.getElementById('connFromPort').value = '';
            document.getElementById('connToPort').value = '';
            document.getElementById('connType').value = 'access';
            document.getElementById('connVlans').value = '';
            document.getElementById('connSpeed').value = '1000';
            document.getElementById('connDescription').value = '';
        }
        
        // Render topology view
        function renderTopologyView() {
            const container = document.getElementById('topologyView');
            
            if (!currentClientId) {
                container.innerHTML = `
                    <div class="no-client-warning">
                        <div class="empty-state-icon"></div>
                        <p><strong>Nejprve vyberte klienta</strong><br>
                        Pro zobrazen topologie muste vybrat klienta z hornho menu.</p>
                    </div>
                `;
                return;
            }
            
            if (devices.length === 0) {
                container.innerHTML = `
                    <div class="rack-container">
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>dn zazen k zobrazen topologie</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Group devices by module type
            const groups = moduleTypes.map((type) => ({
                type,
                devices: devices.filter((device) => device.type === type.id)
            })).filter((group) => group.devices.length > 0);

            const unknownDevices = devices.filter((device) =>
                !moduleTypes.some((type) => type.id === device.type)
            );
            if (unknownDevices.length > 0) {
                groups.push({
                    type: { id: 'other', label: 'Other', color: '#94a3b8', group: 'Other' },
                    devices: unknownDevices
                });
            }

            let html = `
                <div class="rack-container">
                    <h2>Sitova topologie</h2>
                    <div style="display: grid; gap: 2rem; margin-top: 2rem;">
            `;

            groups.forEach((group) => {
                const colors = getModuleTypeColors(group.type.id);
                const heading = group.type.group ? `${group.type.group} - ${group.type.label}` : group.type.label;

                html += `
                    <div class="topology-group" style="border-color: ${colors.base};">
                        <h3 style="color: ${colors.base}; margin-bottom: 1rem;">${heading}</h3>
                        <div class="topology-group-grid">
                `;

                group.devices.forEach((device) => {
                    const label = getModuleTypeLabel(device.type);
                    html += `
                        <div class="client-card" style="cursor: pointer;" onclick="showPortDetails(devices.find(d => d.id === '${device.id}'))">
                            <div style="font-weight: 600; color: ${colors.base};">${device.name}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                ${getSensitiveValue(device.ip || 'No IP')} | ${device.ports || 24} ports
                            </div>
                            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: ${colors.base};">${label}</div>
                        </div>
                    `;
                });

                html += '</div></div>';
            });

            if (groups.length === 0) {
                html += `
                    <div class="topology-group">
                        <p>No devices to display</p>
                    </div>
                `;
            }

            html += '</div></div>';
            container.innerHTML = html;
        }
        
        // Client management functions
        function openClientModal() {
            document.getElementById('clientModal').classList.add('active');
        }
        
        function closeClientModal() {
            document.getElementById('clientModal').classList.remove('active');
            clearClientForm();
        }
        
        function openClientManagerModal() {
            renderClientList();
            document.getElementById('clientManagerModal').classList.add('active');
        }
        
        function closeClientManagerModal() {
            document.getElementById('clientManagerModal').classList.remove('active');
        }
        
        function clearClientForm() {
            document.getElementById('newClientName').value = '';
            document.getElementById('newClientICO').value = '';
            document.getElementById('newClientType').value = 'standard';
            document.getElementById('newClientContact').value = '';
            document.getElementById('newClientEmail').value = '';
            document.getElementById('newClientPhone').value = '';
            document.getElementById('newClientAddress').value = '';
            document.getElementById('newClientNotes').value = '';
        }
        
        function addClient() {
            const name = document.getElementById('newClientName').value;
            const ico = document.getElementById('newClientICO').value;
            const type = document.getElementById('newClientType').value;
            const contact = document.getElementById('newClientContact').value;
            const email = document.getElementById('newClientEmail').value;
            const phone = document.getElementById('newClientPhone').value;
            const address = document.getElementById('newClientAddress').value;
            const notes = document.getElementById('newClientNotes').value;
            
            if (!name) {
                alert('Nzev klienta je povinn');
                return;
            }
            
            const client = {
                id: Date.now().toString(),
                name,
                ico,
                type,
                contact,
                email,
                phone,
                address,
                notes,
                createdAt: new Date().toISOString()
            };
            
            clients.push(client);
            saveData();
            updateClientSelector();
            closeClientModal();
            
            // Automatically select the new client
            document.getElementById('clientSelector').value = client.id;
            switchClient();
        }
        
        function deleteClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            if (confirm(`Opravdu chcete smazat klienta "${client.name}" vetn vech jeho dat?`)) {
                // Remove client
                clients = clients.filter(c => c.id !== clientId);
                
                // Remove client data
                delete clientData[clientId];
                
                // If this was the current client, clear selection
                if (currentClientId === clientId) {
                    currentClientId = null;
                    racks = [];
                    devices = [];
                    connections = [];
                }
                
                saveData();
                updateClientSelector();
                render();
                renderClientList();
            }
        }
        
        function renderClientList() {
            const list = document.getElementById('clientList');
            const searchTerm = document.getElementById('clientSearch').value.toLowerCase();
            
            const filteredClients = clients.filter(client => 
                client.name.toLowerCase().includes(searchTerm) ||
                (client.ico && client.ico.includes(searchTerm)) ||
                (client.contact && client.contact.toLowerCase().includes(searchTerm))
            );
            
            if (filteredClients.length === 0) {
                list.innerHTML = '<div class="empty-state"><p>dn klienti nenalezeni</p></div>';
                return;
            }
            
            list.innerHTML = filteredClients.map(client => {
                const data = clientData[client.id] || { racks: [], devices: [] };
                return `
                    <div class="client-card" onclick="selectClientFromList('${client.id}')">
                        <div class="client-card-header">
                            <div class="client-card-name">${client.name}</div>
                            <div class="client-actions" onclick="event.stopPropagation()">
                                <button class="btn-icon danger" onclick="deleteClient('${client.id}')"></button>
                            </div>
                        </div>
                        <div class="client-card-stats">
                            <span> ${data.racks.length} rack</span>
                            <span> ${data.devices.length} zazen</span>
                            <span class="client-badge">${client.type}</span>
                        </div>
                        ${client.contact ? `<div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);"> ${client.contact}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function selectClientFromList(clientId) {
            document.getElementById('clientSelector').value = clientId;
            switchClient();
            closeClientManagerModal();
        }
        
        function searchClients() {
            renderClientList();
        }
        
        // Render all components
        function render() {
            renderRacks();
            renderDeviceTable();
            renderConnections();
            updateStats();
            renderDashboard();
        }
        
        // Render racks
        function renderRacks() {
            const grid = document.getElementById('rackGrid');
            
            if (!currentClientId) {
                grid.innerHTML = `
                    <div class="no-client-warning">
                        <div class="empty-state-icon"></div>
                        <p><strong>Nejprve vyberte klienta</strong><br>
                        Pro zobrazen a sprvu rack muste vybrat klienta z hornho menu.</p>
                    </div>
                `;
                return;
            }
            
            if (racks.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <p>Klient ${clients.find(c => c.id === currentClientId)?.name} zatm nem dn racky.<br>Kliknte na "Pidat rack" pro vytvoen prvnho racku.</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = racks.map(rack => `
                <div class="rack">
                    <div class="rack-title">${rack.name}</div>
                    <div class="rack-units">
                        ${generateRackUnits(rack)}
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
                         ${rack.location || 'Neureno'}
                    </div>
                </div>
            `).join('');
            
            // Add event listeners for device hover
            document.querySelectorAll('.rack-unit.occupied').forEach(unit => {
                unit.addEventListener('mouseenter', showDeviceTooltip);
                unit.addEventListener('mouseleave', hideDeviceTooltip);
                unit.addEventListener('click', () => {
                    const deviceId = unit.dataset.deviceId;
                    if (deviceId) {
                        const device = devices.find(d => d.id === deviceId);
                        if (device) {
                            showPortDetails(device);
                        }
                    }
                });
            });
        }
        
        function renderPortDots(portCount) {
            const total = parseInt(portCount, 10) || 0;
            if (total <= 0) {
                return '';
            }
            const maxDots = 12;
            const dots = Math.min(total, maxDots);
            let html = '<span class="ports-dots">';
            for (let i = 0; i < dots; i++) {
                html += '<span class="ports-dot"></span>';
            }
            html += '</span>';
            if (total > maxDots) {
                html += `<span class="ports-overflow">+${total - maxDots}</span>`;
            }
            return html;
        }

        // Generate rack units HTML
        function generateRackUnits(rack) {
            let html = '';
            const rackDevices = devices.filter(d => d.rack === rack.id);
            
            for (let i = 1; i <= rack.units; i++) {
                const device = rackDevices.find(d => 
                    i >= d.position && i < d.position + d.height
                );
                
                if (device) {
                    if (i === device.position) {
                        const moduleStyle = getModuleStyleVars(device.type);
                        const portCount = device.ports || 0;
                        const portDots = renderPortDots(portCount);
                        html += `<div class="rack-unit occupied ${device.type}" 
                                      data-device-id="${device.id}"
                                      data-device-name="${device.name}"
                                      data-device-type="${device.type}"
                                      data-device-position="U${device.position}"
                                      data-device-ip="${device.ip || 'N/A'}"
                                      data-device-model="${device.model || 'N/A'}"
                                      data-device-serial="${device.serial || 'N/A'}"
                                      data-device-ports="${portCount}"
                                      style="${moduleStyle} height: ${20 * device.height + 2 * (device.height - 1)}px;">
                                    <div class="rack-unit-content">
                                        <div class="rack-unit-name">${device.name}</div>
                                        <div class="rack-unit-ports">
                                            <span class="ports-count">${portCount}p</span>
                                            ${portDots}
                                        </div>
                                    </div>
                                </div>`;
                    }
                } else {
                    const isPartOfDevice = rackDevices.some(d => 
                        i > d.position && i < d.position + d.height
                    );
                    if (!isPartOfDevice) {
                        html += `<div class="rack-unit">U${i}</div>`;
                    }
                }
            }
            
            return html;
        }
        
        // Show device tooltip
        function showDeviceTooltip(e) {
            const tooltip = document.getElementById('deviceTooltip');
            const unit = e.currentTarget;
            
            document.getElementById('tooltipName').textContent = unit.dataset.deviceName;
            document.getElementById('tooltipType').textContent = `Typ: ${getModuleTypeLabel(unit.dataset.deviceType)}`;
            document.getElementById('tooltipPosition').textContent = `Pozice: ${unit.dataset.devicePosition}`;
            document.getElementById('tooltipIP').textContent = `IP: ${getSensitiveValue(unit.dataset.deviceIp)}`;
            document.getElementById('tooltipModel').textContent = `Model: ${unit.dataset.deviceModel}`;
            document.getElementById('tooltipPorts').textContent = `Porty: ${unit.dataset.devicePorts || 'N/A'}`;
            document.getElementById('tooltipSerial').textContent = `S/N: ${getSensitiveValue(unit.dataset.deviceSerial)}`;
            
            tooltip.classList.add('active');
            
            const rect = unit.getBoundingClientRect();
            const tooltipWidth = tooltip.offsetWidth;
            const tooltipHeight = tooltip.offsetHeight;
            const padding = 12;

            let left = rect.right + 12;
            if (left + tooltipWidth + padding > window.innerWidth) {
                left = rect.left - tooltipWidth - 12;
            }
            if (left < padding) {
                left = padding;
            }

            let top = rect.top;
            if (top + tooltipHeight + padding > window.innerHeight) {
                top = window.innerHeight - tooltipHeight - padding;
            }
            if (top < padding) {
                top = padding;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }
        
        // Hide device tooltip
        function hideDeviceTooltip() {
            document.getElementById('deviceTooltip').classList.remove('active');
        }
        
        // Render device table
        function renderDeviceTable() {
            const container = document.getElementById('deviceListContainer');
            const tbody = document.getElementById('deviceTableBody');
            
            if (devices.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            tbody.innerHTML = devices.map(device => {
                const rack = racks.find(r => r.id === device.rack);
                const typeLabel = getModuleTypeLabel(device.type);
                const badgeStyle = getModuleBadgeVars(device.type);
                const ipValue = getSensitiveValue(device.ip || 'N/A');
                const deleteDisabled = canManageDevices() ? '' : 'disabled';
                return `
                    <tr style="cursor: pointer;" onclick="openDeviceFromTable('${device.id}')">
                        <td>${device.name}</td>
                        <td><span class="device-type-badge ${device.type}" style="${badgeStyle}">${typeLabel}</span></td>
                        <td>${rack ? rack.name : 'N/A'}</td>
                        <td>U${device.position}</td>
                        <td>${ipValue}</td>
                        <td>${device.model || 'N/A'}</td>
                        <td>
                            <button class="delete-btn" onclick="deleteDeviceFromTable(event, '${device.id}')" ${deleteDisabled}>Smazat</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openDeviceFromTable(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (device) {
                showPortDetails(device);
            }
        }

        function deleteDeviceFromTable(event, deviceId) {
            if (event) {
                event.stopPropagation();
            }
            deleteDevice(deviceId);
        }
        
        // Render connections
        function renderConnections() {
            const container = document.getElementById('connectionsContainer');
            const list = document.getElementById('connectionsList');
            
            if (connections.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            list.innerHTML = connections.map(conn => {
                const fromDevice = devices.find(d => d.id === conn.fromDevice);
                const toDevice = devices.find(d => d.id === conn.toDevice);
                const fromLabel = `${fromDevice ? fromDevice.name : 'Unknown'}:${conn.fromPort}`;
                const toLabel = `${toDevice ? toDevice.name : 'Unknown'}:${conn.toPort}`;

                let tailLabel = '';
                if (toDevice && toDevice.type === 'patch') {
                    tailLabel = getPatchTailLabel(toDevice.id, conn.toPort, conn.id);
                } else if (fromDevice && fromDevice.type === 'patch') {
                    tailLabel = getPatchTailLabel(fromDevice.id, conn.fromPort, conn.id);
                }

                const speedLabel = getConnectionSpeedLabel(conn.speed);
                const metaParts = [conn.type || 'link', speedLabel];
                if (conn.vlans) metaParts.push(`VLAN ${conn.vlans}`);
                if (conn.description) metaParts.push(conn.description);
                const meta = metaParts.join(' | ');

                return `
                    <div class="connection-item">
                        <div class="connection-path-row">
                            <div class="connection-from">${fromLabel}</div>
                            <div class="connection-arrow"></div>
                            <div class="connection-to">${toLabel}</div>
                            ${tailLabel ? `<div class="connection-arrow"></div><div class="connection-to">${tailLabel}</div>` : ''}
                        </div>
                        <div class="connection-meta">${meta}</div>
                    </div>
                `;
            }).join('');
        }

        function getConnectionSpeedLabel(speed) {
            if (!speed) return 'N/A';
            return speed >= 1000 ? (speed / 1000) + 'G' : speed + 'M';
        }

        function getPatchTailLabel(patchId, patchPort, currentConnectionId) {
            const match = connections.find(c => c.id !== currentConnectionId && (
                (c.fromDevice === patchId && c.fromPort === patchPort) ||
                (c.toDevice === patchId && c.toPort === patchPort)
            ));
            if (!match) return '';
            const otherDeviceId = match.fromDevice === patchId ? match.toDevice : match.fromDevice;
            const otherPort = match.fromDevice === patchId ? match.fromPort : match.toPort;
            const otherDevice = devices.find(d => d.id === otherDeviceId);
            return `${otherDevice ? otherDevice.name : 'Unknown'}:${otherPort}`;
        }

        // Time tracking
        function getWeekStart(date) {
            const base = new Date(date);
            const day = (base.getDay() + 6) % 7;
            base.setDate(base.getDate() - day);
            base.setHours(0, 0, 0, 0);
            return base;
        }

        function getWeekBounds(date) {
            const startDate = getWeekStart(date);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            return {
                start: formatDateKey(startDate),
                end: formatDateKey(endDate)
            };
        }

        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function parseDateKey(dateKey) {
            if (!dateKey) return null;
            return new Date(dateKey + 'T00:00:00');
        }

        function shiftTimeWeek(delta) {
            const base = timeViewWeekStart || getWeekStart(new Date());
            const next = new Date(base);
            next.setDate(base.getDate() + delta * 7);
            timeViewWeekStart = getWeekStart(next);
            timeSelectionActive = false;
            loadTimeEntriesForWeek();
        }

        function onTimeReportScopeChange() {
            loadReportEntries();
        }

        function initTimeTracking() {
            timeViewWeekStart = getWeekStart(new Date());
            timeSelectionActive = false;
            loadTimeActivities();
            if (!timeSelectionStart) {
                const todayKey = formatDateKey(new Date());
                timeSelectionStart = { date: todayKey, hour: TIME_GRID_START };
                timeSelectionEnd = { date: todayKey, hour: TIME_GRID_START };
            }
            if (!window.timeMouseUpBound) {
                window.timeMouseUpBound = true;
                document.addEventListener('mouseup', () => {
                    if (isTimeSelecting) {
                        isTimeSelecting = false;
                        openTimeEntryModal();
                    }
                });
            }
            loadTimeEntriesForWeek();
        }

        async function loadTimeEntriesForWeek() {
            if (!currentClientId) {
                timeEntries = [];
                renderTimeTracking();
                return;
            }
            if (!window.db || !window.auth || !auth.currentUser) {
                timeEntries = [];
                renderTimeTracking();
                return;
            }

            const bounds = getWeekBounds(timeViewWeekStart || new Date());
            let ref = db.collection('clients')
                .doc(currentClientId)
                .collection('timeEntries')
                .where('date', '>=', bounds.start)
                .where('date', '<=', bounds.end);

            if (!canViewAllTimeEntries()) {
                ref = ref.where('userId', '==', auth.currentUser.uid);
            }

            try {
                const snapshot = await ref.orderBy('date', 'desc').get();
                timeEntries = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderTimeTracking();
            } catch (err) {
                console.warn('Time entries load failed:', err);
                timeEntries = [];
                renderTimeTracking();
            }
        }

        async function fetchReportEntries(filters) {
            if (!canViewReports() || !window.db || !window.auth || !auth.currentUser) {
                return [];
            }
            const startDate = filters.startDate;
            const endDate = filters.endDate;
            const clientIds = filters.clientId === 'all'
                ? clients.map(c => c.id)
                : [filters.clientId];

            if (!startDate || !endDate || !clientIds.length) {
                return [];
            }

            const results = await Promise.all(clientIds.map(async (clientId) => {
                const clientName = clients.find(c => c.id === clientId)?.name || clientId;
                let ref = db.collection('clients')
                    .doc(clientId)
                    .collection('timeEntries')
                    .where('date', '>=', startDate)
                    .where('date', '<=', endDate);

                if (filters.technician && filters.technician !== 'all') {
                    const field = filters.technician.includes('@') ? 'userEmail' : 'userId';
                    ref = ref.where(field, '==', filters.technician);
                }

                const snapshot = await ref.get();
                return snapshot.docs.map(doc => ({
                    id: doc.id,
                    clientId,
                    clientName,
                    ...doc.data()
                }));
            }));

            return results.flat().sort((a, b) => (b.date || '').localeCompare(a.date || ''));
        }

        async function loadReportEntries() {
            if (!canViewReports()) {
                reportEntries = [];
                reportHasLoaded = false;
                renderReportsView();
                return;
            }
            if (!window.db || !window.auth || !auth.currentUser) {
                reportEntries = [];
                reportHasLoaded = false;
                renderReportsView();
                return;
            }

            ensureReportFilterDefaults();
            buildReportClientOptions();
            const filters = getReportFilters();

            try {
                reportHasLoaded = true;
                reportEntries = await fetchReportEntries(filters);
                reportFiltersVisible = false;
                renderReportsView();
            } catch (err) {
                console.warn('Report entries load failed:', err);
                reportEntries = [];
                renderReportsView();
            }
        }

        function renderTimeTracking() {
            const view = document.getElementById('timeView');
            if (!view) return;
            renderTimeWeek();
            renderTimeSummary();
            renderTimeActivities();
            applyRolePermissions();
        }

        function renderReportsView() {
            const view = document.getElementById('reportsView');
            if (!view) return;
            const accessNote = document.getElementById('reportsAccessNote');
            const filterPanel = view.querySelector('.report-filter-panel');
            const layout = view.querySelector('.reports-layout');
            const reportDisplay = view.querySelector('.report-display');
            const filters = view.querySelector('.report-filters');
            const actions = view.querySelector('.report-actions');
            const showFilters = reportFiltersVisible && !reportHasLoaded;
            if (!canViewReports()) {
                if (accessNote) accessNote.style.display = 'block';
                if (filterPanel) filterPanel.style.display = 'none';
                if (filters) filters.style.display = 'none';
                if (actions) actions.style.display = 'none';
                if (layout) layout.classList.add('reports-layout-single');
                if (reportDisplay) reportDisplay.style.display = 'none';
                const table = document.getElementById('timeReportTable');
                if (table) table.innerHTML = '';
                return;
            }
            if (accessNote) accessNote.style.display = 'none';
            if (filterPanel) filterPanel.style.display = showFilters ? 'grid' : 'none';
            if (layout) layout.classList.add('reports-layout-single');
            if (filters) filters.style.display = showFilters ? 'grid' : 'none';
            if (actions) actions.style.display = showFilters ? 'flex' : 'none';
            if (reportDisplay) reportDisplay.style.display = showFilters ? 'none' : 'flex';
            ensureReportFilterDefaults();
            buildReportClientOptions();
            buildReportTechnicianOptions(reportHasLoaded ? reportEntries : []);
            loadReportPresetsFromCloud();
            loadSharedReportPresets(true);
            buildReportPresetOptions();
            buildSharedReportOptions();
            if (showFilters) {
                const table = document.getElementById('timeReportTable');
                if (table) table.innerHTML = '';
                return;
            }
            if (reportHasLoaded) {
                renderTimeReportTable();
            } else {
                renderReportLanding();
            }
        }

        function getTimeSelectionRange() {
            if (!timeSelectionStart || !timeSelectionEnd) return null;
            if (!timeSelectionActive && !isTimeSelecting) return null;
            const startDate = timeSelectionStart.date;
            const endDate = timeSelectionEnd.date;
            if (!startDate || !endDate) return null;
            const startHour = Number.isFinite(timeSelectionStart.hour) ? timeSelectionStart.hour : TIME_GRID_START;
            const endHour = Number.isFinite(timeSelectionEnd.hour) ? timeSelectionEnd.hour : TIME_GRID_START;
            const normalized = {
                startDate: startDate <= endDate ? startDate : endDate,
                endDate: startDate <= endDate ? endDate : startDate,
                startHour: Math.min(startHour, endHour),
                endHour: Math.max(startHour, endHour)
            };
            return normalized;
        }

        function renderTimeWeek() {
            const titleEl = document.getElementById('timeCalendarTitle');
            const header = document.getElementById('timeWeekHeader');
            const grid = document.getElementById('timeWeekGrid');
            if (!titleEl || !header || !grid) return;

            const weekStart = timeViewWeekStart || getWeekStart(new Date());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            const formatShort = (date) => date.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'numeric' });
            titleEl.textContent = `Tyden ${formatShort(weekStart)} - ${formatShort(weekEnd)}`;

            const weekdays = ['Po', 'Ut', 'St', 'Ct', 'Pa', 'So', 'Ne'];
            const entriesByDate = {};
            timeEntries.forEach(entry => {
                if (!entriesByDate[entry.date]) {
                    entriesByDate[entry.date] = [];
                }
                entriesByDate[entry.date].push(entry);
            });

            let headerHtml = '<div class="time-header-cell">Hod</div>';
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + i);
                const dateKey = formatDateKey(dayDate);
                const dayEntries = entriesByDate[dateKey] || [];
                const totalHours = dayEntries.reduce((sum, entry) => sum + (parseFloat(entry.hours) || 0), 0);
                headerHtml += `
                    <div class="time-header-cell">
                        ${weekdays[i]}
                        <strong>${dateKey.split('-')[2]}.${dateKey.split('-')[1]}.</strong>
                        <span>${totalHours} h</span>
                    </div>
                `;
            }
            header.innerHTML = headerHtml;

            const selection = getTimeSelectionRange();
            const todayKey = formatDateKey(new Date());
            const canSelect = canManageTimeEntries();

            let cells = '';
            for (let hour = TIME_GRID_START; hour <= TIME_GRID_END; hour++) {
                const label = String(hour).padStart(2, '0') + ':00';
                cells += `<div class="time-hour-cell">${label}</div>`;

                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    const dayDate = new Date(weekStart);
                    dayDate.setDate(weekStart.getDate() + dayIndex);
                    const dateKey = formatDateKey(dayDate);
                    const dayEntries = entriesByDate[dateKey] || [];
                    const hasEntry = dayEntries.some(entry =>
                        Number.isFinite(entry.startHour) &&
                        Number.isFinite(entry.endHour) &&
                        hour >= entry.startHour &&
                        hour <= entry.endHour
                    );

                    const inRange = selection &&
                        dateKey >= selection.startDate &&
                        dateKey <= selection.endDate &&
                        hour >= selection.startHour &&
                        hour <= selection.endHour;
                    const isStart = selection &&
                        dateKey === selection.startDate &&
                        hour === selection.startHour;
                    const isEnd = selection &&
                        dateKey === selection.endDate &&
                        hour === selection.endHour;
                    const isToday = dateKey === todayKey;

                    const classes = [
                        'time-slot',
                        hasEntry ? 'has-entry' : '',
                        inRange ? 'in-range' : '',
                        isStart ? 'range-start' : '',
                        isEnd ? 'range-end' : '',
                        isToday ? 'today' : ''
                    ].filter(Boolean).join(' ');

                    const handlers = canSelect
                        ? `onmousedown="startTimeSelection('${dateKey}', ${hour})" onmouseenter="updateTimeSelection('${dateKey}', ${hour})" onmouseup="finishTimeSelection('${dateKey}', ${hour})"`
                        : '';

                    cells += `<div class="${classes}" ${handlers}></div>`;
                }
            }

            grid.innerHTML = cells;
        }

        function startTimeSelection(dateKey, hour) {
            if (!canManageTimeEntries()) return;
            isTimeSelecting = true;
            timeSelectionActive = true;
            timeSelectionStart = { date: dateKey, hour };
            timeSelectionEnd = { date: dateKey, hour };
            renderTimeTracking();
        }

        function updateTimeSelection(dateKey, hour) {
            if (!isTimeSelecting) return;
            timeSelectionEnd = { date: dateKey, hour };
            renderTimeTracking();
        }

        function finishTimeSelection(dateKey, hour) {
            if (!isTimeSelecting) return;
            timeSelectionEnd = { date: dateKey, hour };
            isTimeSelecting = false;
            openTimeEntryModal();
        }

        function openTimeEntryModal() {
            if (!canManageTimeEntries()) {
                alert('Nemate opravneni zapisovat hodiny');
                return;
            }
            if (!clients.length) {
                alert('Nejprve vytvorte klienta');
                return;
            }
            const modal = document.getElementById('timeEntryModal');
            if (!modal) return;
            buildTimeClientOptions();
            buildTimeActivityOptions();
            fillTimeEntryModal();
            modal.classList.add('active');
        }

        function closeTimeEntryModal() {
            const modal = document.getElementById('timeEntryModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function buildTimeClientOptions() {
            const select = document.getElementById('timeEntryClient');
            if (!select) return;
            select.innerHTML = clients.map(client =>
                `<option value="${client.id}">${client.name}</option>`
            ).join('');
            if (currentClientId && clients.some(c => c.id === currentClientId)) {
                select.value = currentClientId;
            }
        }

        function buildTimeActivityOptions() {
            const list = document.getElementById('timeActivityOptions');
            if (!list) return;
            list.innerHTML = timeActivities.map(item => `<option value="${item}"></option>`).join('');
        }

        function loadTimeActivities() {
            const saved = localStorage.getItem('rackManagerTimeActivities');
            if (saved) {
                try {
                    timeActivities = JSON.parse(saved);
                } catch (err) {
                    timeActivities = [...DEFAULT_TIME_ACTIVITIES];
                }
            } else {
                timeActivities = [...DEFAULT_TIME_ACTIVITIES];
            }
        }

        function saveTimeActivities() {
            localStorage.setItem('rackManagerTimeActivities', JSON.stringify(timeActivities));
        }

        function renderTimeActivities() {
            const list = document.getElementById('timeActivityList');
            if (!list) return;
            const items = timeActivities.length ? timeActivities : DEFAULT_TIME_ACTIVITIES;
            list.innerHTML = items.map(item => `
                <span class="time-activity-chip">
                    ${item}
                    <button onclick="removeTimeActivity('${item}')">x</button>
                </span>
            `).join('');
            buildTimeActivityOptions();
        }

        function addTimeActivity() {
            const input = document.getElementById('timeActivityInput');
            if (!input) return;
            const value = input.value.trim();
            if (!value) return;
            if (!timeActivities.includes(value)) {
                timeActivities.push(value);
                saveTimeActivities();
                renderTimeActivities();
            }
            input.value = '';
        }

        function removeTimeActivity(name) {
            timeActivities = timeActivities.filter(item => item !== name);
            if (!timeActivities.length) {
                timeActivities = [...DEFAULT_TIME_ACTIVITIES];
            }
            saveTimeActivities();
            renderTimeActivities();
        }

        function fillTimeEntryModal() {
            const range = getTimeSelectionRange();
            const start = range ? range.startDate : formatDateKey(new Date());
            const end = range ? range.endDate : start;
            const defaultHours = range ? Math.max(1, range.endHour - range.startHour + 1) : 1;

            const startInput = document.getElementById('timeEntryStart');
            const endInput = document.getElementById('timeEntryEnd');
            const hoursInput = document.getElementById('timeEntryHours');
            const descInput = document.getElementById('timeEntryDesc');
            const activityInput = document.getElementById('timeEntryActivity');

            if (startInput) startInput.value = start;
            if (endInput) endInput.value = end;
            if (hoursInput) hoursInput.value = String(defaultHours);
            if (descInput) descInput.value = '';
            if (activityInput) activityInput.value = '';
            updateTimeEntrySummary();
        }

        function setTimePreset(hours) {
            const hoursInput = document.getElementById('timeEntryHours');
            if (!hoursInput) return;
            hoursInput.value = String(hours);
            updateTimeEntrySummary();
        }

        function updateTimeEntrySummary() {
            const startInput = document.getElementById('timeEntryStart');
            const endInput = document.getElementById('timeEntryEnd');
            const hoursInput = document.getElementById('timeEntryHours');
            const summary = document.getElementById('timeEntrySummary');
            if (!summary) return;

            const start = startInput ? startInput.value : '';
            const end = endInput ? endInput.value : '';
            const hours = hoursInput ? parseFloat(hoursInput.value) || 0 : 0;
            if (!start || !end) {
                summary.textContent = '';
                return;
            }

            const startDate = parseDateKey(start);
            const endDate = parseDateKey(end);
            if (!startDate || !endDate) return;

            const min = startDate <= endDate ? startDate : endDate;
            const max = startDate <= endDate ? endDate : startDate;
            const days = Math.floor((max - min) / (1000 * 60 * 60 * 24)) + 1;
            summary.textContent = `Pocet dni: ${days}, celkem: ${days * hours} h`;
        }

        function renderTimeSummary() {
            const summary = document.getElementById('timeSummary');
            if (!summary) return;
            if (!currentClientId) {
                summary.innerHTML = '';
                return;
            }

            const weekTotal = timeEntries.reduce((sum, entry) => sum + (parseFloat(entry.hours) || 0), 0);
            const todayKey = formatDateKey(new Date());
            const todayTotal = timeEntries
                .filter(entry => entry.date === todayKey)
                .reduce((sum, entry) => sum + (parseFloat(entry.hours) || 0), 0);

            const range = getTimeSelectionRange();
            const rangeTotal = range
                ? timeEntries.filter(entry => entry.date >= range.startDate && entry.date <= range.endDate)
                    .reduce((sum, entry) => sum + (parseFloat(entry.hours) || 0), 0)
                : null;

            summary.innerHTML = `
                <div class="summary-card">
                    <div class="summary-value">${weekTotal} h</div>
                    <div class="summary-label">Tyden</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${todayTotal} h</div>
                    <div class="summary-label">Dnes</div>
                </div>
                ${rangeTotal !== null ? `
                    <div class="summary-card">
                        <div class="summary-value">${rangeTotal} h</div>
                        <div class="summary-label">Vybrany rozsah</div>
                    </div>
                ` : ''}
            `;
        }

        function ensureReportFilterDefaults() {
            const presetSelect = document.getElementById('reportRangePreset');
            const startInput = document.getElementById('reportStartDate');
            const endInput = document.getElementById('reportEndDate');
            if (!startInput || !endInput) return;
            if (presetSelect && !presetSelect.value) {
                presetSelect.value = 'all';
            }
            const preset = presetSelect ? presetSelect.value : 'all';
            if (preset === 'custom') {
                toggleReportDateInputs(true);
                if (!startInput.value || !endInput.value) {
                    const now = new Date();
                    const start = new Date(now.getFullYear(), now.getMonth(), 1);
                    startInput.value = formatDateKey(start);
                    endInput.value = formatDateKey(now);
                }
                return;
            }
            applyReportRangePreset(preset, true);
        }

        function toggleReportDateInputs(isCustom) {
            const startInput = document.getElementById('reportStartDate');
            const endInput = document.getElementById('reportEndDate');
            if (!startInput || !endInput) return;
            startInput.disabled = !isCustom;
            endInput.disabled = !isCustom;
        }

        function applyReportRangePreset(preset, silent) {
            const startInput = document.getElementById('reportStartDate');
            const endInput = document.getElementById('reportEndDate');
            if (!startInput || !endInput) return;
            const now = new Date();
            let start = new Date(now);
            let end = new Date(now);

            switch (preset) {
                case 'all':
                    start = new Date(2000, 0, 1);
                    end = new Date(now);
                    break;
                case 'previous-month':
                    start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    end = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
                case 'year':
                    start = new Date(now.getFullYear(), 0, 1);
                    end = new Date(now);
                    break;
                case 'custom':
                    toggleReportDateInputs(true);
                    if (!startInput.value || !endInput.value) {
                        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                        startInput.value = formatDateKey(monthStart);
                        endInput.value = formatDateKey(now);
                    }
                    if (!silent) loadReportEntries();
                    return;
                default:
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    end = new Date(now);
            }

            startInput.value = formatDateKey(start);
            endInput.value = formatDateKey(end);
            toggleReportDateInputs(false);
            if (!silent) loadReportEntries();
        }

        function onReportRangePresetChange() {
            const presetSelect = document.getElementById('reportRangePreset');
            if (!presetSelect) return;
            const silent = reportFiltersVisible || !reportHasLoaded;
            applyReportRangePreset(presetSelect.value, silent);
        }

        function onReportDateChange() {
            const presetSelect = document.getElementById('reportRangePreset');
            if (presetSelect && presetSelect.value !== 'custom') {
                presetSelect.value = 'custom';
            }
            toggleReportDateInputs(true);
            onReportFilterChange();
        }

        function buildReportClientOptions() {
            const select = document.getElementById('reportClientFilter');
            if (!select) return;
            const preferred = select.value || 'all';
            select.innerHTML = [
                '<option value="all">Vsechny klienty</option>',
                ...clients.map(client => `<option value="${client.id}">${client.name}</option>`)
            ].join('');
            if (preferred === 'all' || clients.some(c => c.id === preferred)) {
                select.value = preferred;
            } else if (currentClientId && clients.some(c => c.id === currentClientId)) {
                select.value = currentClientId;
            } else {
                select.value = 'all';
            }
        }

        function buildReportTechnicianOptions(entries) {
            const select = document.getElementById('reportTechnicianFilter');
            if (!select) return;
            const previous = select.value || 'all';
            const technicians = Array.from(new Set(
                (entries || []).map(entry => entry.userEmail || entry.userId).filter(Boolean)
            )).sort((a, b) => a.localeCompare(b, 'cs', { sensitivity: 'base' }));
            select.innerHTML = [
                '<option value="all">Vsechni technici</option>',
                ...technicians.map(name => `<option value="${name}">${name}</option>`)
            ].join('');
            select.value = technicians.includes(previous) ? previous : 'all';
        }

        function getReportFilters() {
            const clientSelect = document.getElementById('reportClientFilter');
            const techSelect = document.getElementById('reportTechnicianFilter');
            const presetSelect = document.getElementById('reportRangePreset');
            const startInput = document.getElementById('reportStartDate');
            const endInput = document.getElementById('reportEndDate');
            return {
                clientId: clientSelect ? clientSelect.value : 'all',
                technician: techSelect ? techSelect.value : 'all',
                rangePreset: presetSelect ? presetSelect.value : 'custom',
                startDate: startInput ? startInput.value : '',
                endDate: endInput ? endInput.value : ''
            };
        }

        function onReportFilterChange() {
            reportHasLoaded = false;
            if (reportFiltersVisible) {
                renderReportsView();
            } else {
                renderReportLanding();
            }
        }

        function showReportFilters() {
            reportHasLoaded = false;
            reportFiltersVisible = true;
            renderReportsView();
            setTimeout(() => {
                document.getElementById('reportPresetName')?.focus();
            }, 0);
        }

        function showReportList() {
            reportHasLoaded = false;
            reportFiltersVisible = false;
            renderReportsView();
        }

        async function createReportFromBuilder() {
            const nameInput = document.getElementById('reportPresetName');
            ensureReportFilterDefaults();
            const filters = getReportFilters();
            const name = (nameInput?.value || '').trim();
            const presets = getSavedReportPresets();
            const presetName = name || buildReportPresetName(filters);
            const preset = {
                id: `preset-${Date.now()}`,
                name: presetName,
                filters
            };
            presets.unshift(preset);
            saveReportPresets(presets.slice(0, 30));
            buildReportPresetOptions();
            if (nameInput && !name) {
                nameInput.value = presetName;
            }
            await saveReportPresetToCloud(preset);
            loadReportEntries();
        }

        function getSavedReportPresets() {
            try {
                return JSON.parse(localStorage.getItem('cxtechReportPresets') || '[]');
            } catch (err) {
                return [];
            }
        }

        function saveReportPresets(presets) {
            localStorage.setItem('cxtechReportPresets', JSON.stringify(presets));
        }

        function getReportPresetCollection() {
            if (!window.db || !window.auth || !auth.currentUser) return null;
            return db.collection('users')
                .doc(auth.currentUser.uid)
                .collection('reportPresets');
        }

        async function loadReportPresetsFromGlobal() {
            if (!window.db || !window.auth || !auth.currentUser || !window.GLOBAL_PATH) return false;
            try {
                const snap = await db.doc(GLOBAL_PATH).get();
                if (!snap.exists) return false;
                const data = snap.data() || {};
                const presetsByUser = data.reportPresetsByUser || {};
                const presetMap = presetsByUser[auth.currentUser.uid] || {};
                const presets = Object.values(presetMap).filter(Boolean);
                if (presets.length) {
                    saveReportPresets(presets);
                    buildReportPresetOptions();
                    if (!reportHasLoaded) {
                        renderReportLanding();
                    }
                    return true;
                }
            } catch (err) {
                console.warn('Load report presets from global failed:', err);
            }
            return false;
        }

        async function saveReportPresetToGlobal(preset) {
            if (!window.db || !window.auth || !auth.currentUser || !window.GLOBAL_PATH || !preset) return;
            const fieldPath = `reportPresetsByUser.${auth.currentUser.uid}.${preset.id}`;
            const payload = {
                id: preset.id,
                name: preset.name,
                filters: preset.filters || {},
                updatedAtMs: Date.now(),
                updatedBy: auth.currentUser?.email || auth.currentUser?.uid || ''
            };
            try {
                await db.doc(GLOBAL_PATH).set({ [fieldPath]: payload }, { merge: true });
            } catch (err) {
                console.warn('Save report preset to global failed:', err);
            }
        }

        async function loadReportPresetsFromCloud(force) {
            if (reportPresetsLoaded && !force) return;
            const collectionRef = getReportPresetCollection();
            if (!collectionRef) return;
            reportPresetsLoaded = true;
            const localPresets = getSavedReportPresets();
            try {
                const snapshot = await collectionRef.orderBy('updatedAtMs', 'desc').get();
                if (snapshot.empty) {
                    if (localPresets.length) {
                        await Promise.all(localPresets.map((preset) => saveReportPresetToCloud(preset)));
                    } else {
                        await loadReportPresetsFromGlobal();
                    }
                } else {
                    const presets = snapshot.docs.map(doc => {
                        const data = doc.data() || {};
                        return {
                            id: doc.id,
                            name: data.name || 'Report',
                            filters: data.filters || {}
                        };
                    });
                    saveReportPresets(presets);
                    buildReportPresetOptions();
                    if (!reportHasLoaded) {
                        renderReportLanding();
                    }
                }
            } catch (err) {
                console.warn('Load report presets failed:', err);
                reportPresetsLoaded = false;
                await loadReportPresetsFromGlobal();
            }
        }

        async function saveReportPresetToCloud(preset) {
            const collectionRef = getReportPresetCollection();
            if (!collectionRef || !preset) return;
            try {
                const payload = {
                    name: preset.name,
                    filters: preset.filters || {},
                    updatedAtMs: Date.now(),
                    updatedBy: auth.currentUser?.email || auth.currentUser?.uid || ''
                };
                if (window.firebase?.firestore?.FieldValue) {
                    payload.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                }
                await collectionRef.doc(preset.id).set(payload, { merge: true });
            } catch (err) {
                console.warn('Save report preset failed:', err);
                await saveReportPresetToGlobal(preset);
            }
        }

        function buildReportPresetOptions() {
            const select = document.getElementById('reportPresetSelect');
            if (!select) return;
            const presets = getSavedReportPresets();
            const previous = select.value;
            select.innerHTML = [
                '<option value="">Ulozene reporty</option>',
                ...presets.map(preset => `<option value="${preset.id}">${preset.name}</option>`)
            ].join('');
            if (presets.some(preset => preset.id === previous)) {
                select.value = previous;
            }
        }

        function buildSharedReportOptions() {
            const select = document.getElementById('reportSharedSelect');
            if (!select) return;
            const previous = select.value;
            select.innerHTML = [
                '<option value="">Sdilene reporty</option>',
                ...sharedReportPresets.map(preset => `<option value="${preset.id}">${preset.name}</option>`)
            ].join('');
            if (sharedReportPresets.some(preset => preset.id === previous)) {
                select.value = previous;
            }
        }

        function getReportSummary(filters) {
            const clientId = filters.clientId || 'all';
            const technician = filters.technician || 'all';
            const clientLabel = clientId === 'all'
                ? 'Vsechny klienty'
                : (clients.find(c => c.id === clientId)?.name || clientId);
            const techLabel = technician === 'all' ? 'Vsechni technici' : technician;
            const rangeLabel = getReportRangeLabel(filters);
            return `Klient: ${clientLabel} | Obdobi: ${rangeLabel} | Technik: ${techLabel}`;
        }

        function renderReportLanding() {
            const container = document.getElementById('timeReportTable');
            if (!container) return;
            const saved = getSavedReportPresets();
            const shared = sharedReportPresets || [];

            const buildCards = (items, source) => {
                if (!items.length) {
                    return '<div class="empty-state"><p>Zadne reporty.</p></div>';
                }
                return `
                    <div class="report-list-grid">
                        ${items.map(item => `
                            <button class="report-list-card" onclick="openReportPreset('${source}', '${item.id}')">
                                <div class="report-list-name">${item.name || 'Report'}</div>
                                <div class="report-list-meta">${getReportSummary(item.filters || {})}</div>
                            </button>
                        `).join('')}
                    </div>
                `;
            };

            container.innerHTML = `
                <div class="report-sheet report-sheet-wide">
                    <div class="report-sheet-header">
                        <div>
                            <div class="report-sheet-title">Reporty</div>
                            <div class="report-sheet-subtitle">Vyber ulozeny nebo sdileny report.</div>
                        </div>
                        <div class="report-sheet-logo">CX.TECH</div>
                    </div>
                    <div class="report-sheet-toolbar">
                        <button class="btn-small" onclick="showReportFilters()">Vytvorit report</button>
                    </div>
                    <div class="report-sheet-meta">
                        <div class="report-meta-item"><span>Ulozene</span><div>${saved.length}</div></div>
                        <div class="report-meta-item"><span>Sdilene</span><div>${shared.length}</div></div>
                    </div>
                    <div class="report-list">
                        <div class="report-list-group">
                            <div class="report-list-title">Ulozene reporty</div>
                            ${buildCards(saved, 'local')}
                        </div>
                        <div class="report-list-group">
                            <div class="report-list-title">Sdilene reporty</div>
                            ${buildCards(shared, 'shared')}
                        </div>
                    </div>
                </div>
            `;
        }

        function openReportPreset(source, id) {
            const presets = source === 'shared' ? sharedReportPresets : getSavedReportPresets();
            const preset = presets.find(item => item.id === id);
            if (!preset) return;
            reportHasLoaded = true;
            reportFiltersVisible = false;
            applyReportFilters(preset.filters || {}, true);
        }

        function ensureSelectOption(select, value, label) {
            if (!select || !value) return;
            const exists = Array.from(select.options).some(option => option.value === value);
            if (!exists) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = label || value;
                select.appendChild(option);
            }
        }

        function applyReportFilters(filters, shouldLoad) {
            if (!filters) return;
            if (shouldLoad !== false) {
                reportFiltersVisible = false;
            }
            buildReportClientOptions();
            const clientSelect = document.getElementById('reportClientFilter');
            const techSelect = document.getElementById('reportTechnicianFilter');
            const presetSelect = document.getElementById('reportRangePreset');
            const startInput = document.getElementById('reportStartDate');
            const endInput = document.getElementById('reportEndDate');

            if (clientSelect && filters.clientId) clientSelect.value = filters.clientId;
            if (techSelect && filters.technician) {
                ensureSelectOption(techSelect, filters.technician, filters.technician);
                techSelect.value = filters.technician;
            }
            if (presetSelect && filters.rangePreset) presetSelect.value = filters.rangePreset;

            if (filters.rangePreset && filters.rangePreset !== 'custom') {
                applyReportRangePreset(filters.rangePreset, true);
            } else {
                toggleReportDateInputs(true);
                if (startInput && filters.startDate) startInput.value = filters.startDate;
                if (endInput && filters.endDate) endInput.value = filters.endDate;
            }

            if (shouldLoad !== false) {
                loadReportEntries();
            } else {
                reportHasLoaded = false;
                renderReportLanding();
            }
        }

        function getReportShareCollection() {
            if (!window.db || !window.auth || !auth.currentUser) return null;
            return db.collection('reportShares');
        }

        async function loadSharedReportPresets(force) {
            if (reportSharedLoaded && !force) return;
            const collectionRef = getReportShareCollection();
            if (!collectionRef) return;
            reportSharedLoaded = true;
            try {
                const snapshot = await collectionRef.where('visibility', '==', 'internal').get();
                sharedReportPresets = snapshot.docs.map(doc => {
                    const data = doc.data() || {};
                    return {
                        id: doc.id,
                        name: data.name || 'Report',
                        filters: data.filters || {},
                        updatedAtMs: data.updatedAtMs || 0
                    };
                }).sort((a, b) => (b.updatedAtMs || 0) - (a.updatedAtMs || 0));
                buildSharedReportOptions();
                if (!reportHasLoaded) {
                    renderReportLanding();
                }
            } catch (err) {
                console.warn('Load shared report presets failed:', err);
                reportSharedLoaded = false;
            }
        }

        async function createReportShare(filters, name, visibility) {
            const collectionRef = getReportShareCollection();
            if (!collectionRef) {
                alert('Nejprve se prihlaste.');
                return null;
            }
            const docRef = collectionRef.doc();
            const payload = {
                name: name || 'Report',
                filters: filters || {},
                visibility: visibility || 'link',
                createdAtMs: Date.now(),
                updatedAtMs: Date.now(),
                createdBy: auth.currentUser?.email || auth.currentUser?.uid || '',
                createdByUid: auth.currentUser?.uid || ''
            };
            if (window.firebase?.firestore?.FieldValue) {
                payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                payload.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
            }
            await docRef.set(payload);
            return docRef.id;
        }

        function buildReportShareLink(shareId) {
            const url = new URL(window.location.href);
            url.searchParams.set('reportShare', shareId);
            return url.toString();
        }

        function openReportShareModal() {
            const modal = document.getElementById('reportShareModal');
            if (modal) modal.classList.add('active');
        }

        function closeReportShareModal() {
            const modal = document.getElementById('reportShareModal');
            if (modal) modal.classList.remove('active');
        }

        async function handleReportShareOption(type) {
            try {
                if (type === 'link') {
                    await createReportShareLink();
                } else if (type === 'internal') {
                    await shareReportInternally();
                }
            } finally {
                closeReportShareModal();
            }
        }

        async function createReportShareLink() {
            ensureReportFilterDefaults();
            const filters = getReportFilters();
            const nameInput = document.getElementById('reportPresetName');
            const name = (nameInput?.value || '').trim() || buildReportPresetName(filters);
            try {
                const shareId = await createReportShare(filters, name, 'link');
                if (!shareId) return;
                const link = buildReportShareLink(shareId);
                const linkInput = document.getElementById('reportShareLink');
                if (linkInput) {
                    linkInput.value = link;
                }
                if (navigator.clipboard?.writeText) {
                    try {
                        await navigator.clipboard.writeText(link);
                        alert('Odkaz zkopirovan.');
                    } catch (err) {
                        alert('Odkaz pripraven.');
                    }
                } else {
                    alert('Odkaz pripraven.');
                }
            } catch (err) {
                console.warn('Share link failed:', err);
                alert('Sdileni selhalo.');
            }
        }

        async function shareReportInternally() {
            ensureReportFilterDefaults();
            const filters = getReportFilters();
            const nameInput = document.getElementById('reportPresetName');
            const name = (nameInput?.value || '').trim() || buildReportPresetName(filters);
            try {
                const shareId = await createReportShare(filters, name, 'internal');
                if (!shareId) return;
                await loadSharedReportPresets(true);
                const sharedSelect = document.getElementById('reportSharedSelect');
                if (sharedSelect) sharedSelect.value = shareId;
            } catch (err) {
                console.warn('Share internally failed:', err);
                alert('Sdileni selhalo.');
            }
        }

        async function applyReportShareFromUrl() {
            if (!pendingReportShareId) return;
            const shareId = pendingReportShareId;
            if (!window.db || !window.auth || !auth.currentUser) return;
            if (!canViewReports()) return;
            try {
                const collectionRef = getReportShareCollection();
                if (!collectionRef) return;
                const snap = await collectionRef.doc(shareId).get();
                if (!snap.exists) {
                    pendingReportShareId = null;
                    return;
                }
                const data = snap.data() || {};
                if (window.switchView) {
                    switchView('reports');
                }
                applyReportFilters(data.filters || {});
                const linkInput = document.getElementById('reportShareLink');
                if (linkInput) linkInput.value = buildReportShareLink(shareId);
                pendingReportShareId = null;
            } catch (err) {
                console.warn('Apply report share failed:', err);
            }
        }

        function getReportRangeLabel(filters) {
            switch (filters.rangePreset) {
                case 'all':
                    return 'Vsechno';
                case 'previous-month':
                    return 'Predchozi mesic';
                case 'year':
                    return 'Aktualni rok';
                case 'custom':
                    return `${filters.startDate || '-'} - ${filters.endDate || '-'}`;
                default:
                    return 'Soucasny mesic';
            }
        }

        function buildReportPresetName(filters) {
            const clientLabel = filters.clientId === 'all'
                ? 'Vsechny klienty'
                : (clients.find(c => c.id === filters.clientId)?.name || filters.clientId);
            const techLabel = filters.technician === 'all' ? 'Vsechni technici' : filters.technician;
            const rangeLabel = getReportRangeLabel(filters);
            return `${clientLabel} | ${rangeLabel} | ${techLabel}`;
        }

        async function saveReportPreset() {
            const nameInput = document.getElementById('reportPresetName');
            ensureReportFilterDefaults();
            const filters = getReportFilters();
            const name = (nameInput?.value || '').trim();
            const presets = getSavedReportPresets();
            const presetName = name || buildReportPresetName(filters);
            const preset = {
                id: `preset-${Date.now()}`,
                name: presetName,
                filters
            };
            presets.unshift(preset);
            saveReportPresets(presets.slice(0, 30));
            if (nameInput) nameInput.value = '';
            buildReportPresetOptions();
            if (!reportHasLoaded) {
                renderReportLanding();
            }
            await saveReportPresetToCloud(preset);
        }

        function applyReportPreset() {
            const select = document.getElementById('reportPresetSelect');
            if (!select || !select.value) return;
            const presets = getSavedReportPresets();
            const preset = presets.find(item => item.id === select.value);
            if (!preset) return;
            applyReportFilters(preset.filters || {});
        }

        function applySharedReportPreset() {
            const select = document.getElementById('reportSharedSelect');
            if (!select || !select.value) return;
            const preset = sharedReportPresets.find(item => item.id === select.value);
            if (!preset) return;
            applyReportFilters(preset.filters || {});
        }

        function getFilteredReportEntries() {
            const filters = getReportFilters();
            let entries = [...reportEntries];
            if (filters.clientId && filters.clientId !== 'all') {
                entries = entries.filter(entry => entry.clientId === filters.clientId);
            }
            if (filters.technician && filters.technician !== 'all') {
                entries = entries.filter(entry => (entry.userEmail || entry.userId) === filters.technician);
            }
            if (filters.startDate) {
                entries = entries.filter(entry => entry.date >= filters.startDate);
            }
            if (filters.endDate) {
                entries = entries.filter(entry => entry.date <= filters.endDate);
            }
            return entries;
        }

        function renderTimeReportTable() {
            const container = document.getElementById('timeReportTable');
            if (!container) return;

            const filters = getReportFilters();
            const entries = getFilteredReportEntries();
            const reportTitleInput = document.getElementById('reportPresetName');
            const reportTitle = (reportTitleInput?.value || '').trim() || buildReportPresetName(filters);
            const creator = auth?.currentUser?.displayName || auth?.currentUser?.email || auth?.currentUser?.uid || 'System';
            const clientLabel = filters.clientId === 'all'
                ? 'Vsechny klienty'
                : (clients.find(c => c.id === filters.clientId)?.name || filters.clientId || 'Klient');
            const techLabel = filters.technician === 'all' ? 'Vsechni technici' : (filters.technician || 'Vsechni technici');
            const rangeLabel = getReportRangeLabel(filters);
            const creatorSuffix = clientLabel && clientLabel !== 'Vsechny klienty' ? ` (${clientLabel})` : '';
            const totalHours = entries.reduce((sum, entry) => sum + (parseFloat(entry.hours) || 0), 0);
            const totalHoursLabel = Number.isFinite(totalHours)
                ? (Math.round(totalHours * 100) / 100).toString()
                : '0';
            const canDelete = canManageTimeEntries();

            const headerCells = [
                '<th>Datum</th>',
                '<th>Polozka</th>',
                '<th>Klient</th>',
                '<th>Hodin</th>',
                '<th>Technik</th>',
                '<th>Popis</th>'
            ];
            if (canDelete) headerCells.push('<th>Akce</th>');
            const headerCols = headerCells.join('');

            const rows = entries.map(entry => {
                const clientName = entry.clientName || (clients.find(c => c.id === entry.clientId)?.name) || '-';
                const activity = entry.category || entry.activity || '-';
                const hoursValue = parseFloat(entry.hours);
                const hoursLabel = Number.isFinite(hoursValue)
                    ? (Math.round(hoursValue * 100) / 100).toString()
                    : '0';
                const deleteCell = canDelete
                    ? `<td><button class="delete-btn" onclick="deleteReportEntry('${entry.id}', '${entry.clientId || ''}')">Smazat</button></td>`
                    : '';
                return `
                    <tr>
                        <td>${entry.date || '-'}</td>
                        <td>${activity}</td>
                        <td>${clientName}</td>
                        <td>${hoursLabel}</td>
                        <td>${entry.userEmail || entry.userId || '-'}</td>
                        <td>${entry.description || '-'}</td>
                        ${deleteCell}
                    </tr>
                `;
            }).join('');

            const tableHtml = entries.length
                ? `
                    <table class="time-table">
                        <thead><tr>${headerCols}</tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                `
                : '<div class="empty-state"><p>Zadne vykazane hodiny.</p></div>';

            container.innerHTML = `
                <div class="report-sheet report-sheet-wide">
                    <div class="report-sheet-header">
                        <div>
                            <div class="report-sheet-title">${reportTitle} <span class="report-live">live</span></div>
                            <div class="report-sheet-subtitle">Vytvoril ${creator}${creatorSuffix}</div>
                        </div>
                        <div class="report-sheet-logo">CX.TECH</div>
                    </div>
                    <div class="report-sheet-toolbar">
                        <button class="btn-small" onclick="showReportList()">Zpet na seznam</button>
                    </div>
                    <div class="report-sheet-meta">
                        <div class="report-meta-item"><span>Klient</span><div>${clientLabel}</div></div>
                        <div class="report-meta-item"><span>Uzivatel</span><div>${techLabel}</div></div>
                        <div class="report-meta-item"><span>Obdobi</span><div>${rangeLabel}</div></div>
                        <div class="report-meta-item"><span>Polozky</span><div>${entries.length}</div></div>
                    </div>
                    <div class="report-sheet-totals">
                        <div>Celkem hodin: ${totalHoursLabel} h</div>
                        <div>Report pripraven</div>
                    </div>
                    ${tableHtml}
                </div>
            `;
        }

        async function saveTimeEntryRange() {
            if (!canManageTimeEntries()) {
                alert('Nemate opravneni zapisovat hodiny');
                return;
            }
            const user = requireAuth();
            const clientSelect = document.getElementById('timeEntryClient');
            const activityInput = document.getElementById('timeEntryActivity');
            const startInput = document.getElementById('timeEntryStart');
            const endInput = document.getElementById('timeEntryEnd');
            const hoursInput = document.getElementById('timeEntryHours');
            const descInput = document.getElementById('timeEntryDesc');
            const clientId = clientSelect ? clientSelect.value : currentClientId;
            const activity = activityInput ? activityInput.value.trim() : '';
            const start = startInput ? startInput.value : '';
            const end = endInput ? endInput.value : '';
            const hours = hoursInput ? parseFloat(hoursInput.value) : 0;
            const description = descInput ? descInput.value.trim() : '';

            if (!clientId) {
                alert('Vyberte klienta');
                return;
            }
            if (!start || !end || !hours) {
                alert('Vyplnte rozsah a hodiny');
                return;
            }

            const startDate = parseDateKey(start);
            const endDate = parseDateKey(end);
            if (!startDate || !endDate) {
                alert('Neplatny rozsah dat');
                return;
            }

            const min = startDate <= endDate ? startDate : endDate;
            const max = startDate <= endDate ? endDate : startDate;
            const days = Math.floor((max - min) / (1000 * 60 * 60 * 24)) + 1;

            const selection = getTimeSelectionRange();
            let startHour = null;
            let endHour = null;
            if (selection) {
                const block = Math.max(1, Math.ceil(hours));
                startHour = selection.startHour;
                endHour = Math.min(TIME_GRID_END, startHour + block - 1);
            }

            const batch = db.batch();
            for (let i = 0; i < days; i++) {
                const day = new Date(min);
                day.setDate(min.getDate() + i);
                const dateKey = formatDateKey(day);
                const docRef = db.collection('clients')
                    .doc(clientId)
                    .collection('timeEntries')
                    .doc();
                batch.set(docRef, {
                    date: dateKey,
                    hours,
                    description,
                    category: activity,
                    startHour,
                    endHour,
                    userId: user.uid,
                    userEmail: user.email || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            try {
                await batch.commit();
                closeTimeEntryModal();
                timeSelectionStart = { date: start, hour: startHour !== null ? startHour : TIME_GRID_START };
                timeSelectionEnd = { date: end, hour: endHour !== null ? endHour : TIME_GRID_START };
                timeSelectionActive = true;
                if (clientId === currentClientId) {
                    loadTimeEntriesForWeek();
                } else {
                    alert('Zapis ulozen. Pro zobrazeni prepnout na vybraneho klienta.');
                }
            } catch (err) {
                console.error('Time entry save failed:', err);
                alert('Chyba pri ukladani hodin: ' + err.message);
            }
        }

        async function deleteTimeEntry(entryId) {
            if (!canManageTimeEntries()) return;
            if (!currentClientId) return;
            try {
                await db.collection('clients')
                    .doc(currentClientId)
                    .collection('timeEntries')
                    .doc(entryId)
                    .delete();
                loadTimeEntriesForWeek();
            } catch (err) {
                console.error('Time entry delete failed:', err);
                alert('Chyba pri mazani: ' + err.message);
            }
        }

        async function deleteReportEntry(entryId, clientId) {
            if (!canManageTimeEntries()) return;
            const targetClientId = clientId || currentClientId;
            if (!targetClientId) return;
            try {
                await db.collection('clients')
                    .doc(targetClientId)
                    .collection('timeEntries')
                    .doc(entryId)
                    .delete();
                loadReportEntries();
            } catch (err) {
                console.error('Report entry delete failed:', err);
                alert('Chyba pri mazani: ' + err.message);
            }
        }

        function exportTimeReport() {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            const entries = [...timeEntries];
            const weekLabel = document.getElementById('timeCalendarTitle')?.textContent || '';
            const tableRows = entries.map(entry => `
                <tr>
                    <td>${entry.date || '-'}</td>
                    <td>${entry.hours || 0}</td>
                    <td>${entry.userEmail || entry.userId || '-'}</td>
                    <td>${entry.category || '-'}</td>
                    <td>${entry.description || '-'}</td>
                </tr>
            `).join('');

            const reportHtml = `
                <h1>Vykaz hodin - ${weekLabel}</h1>
                <p>Klient: ${clients.find(c => c.id === currentClientId)?.name || '-'}</p>
                <table>
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Hodiny</th>
                            <th>Uzivatel</th>
                            <th>Cinnost</th>
                            <th>Popis</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows || '<tr><td colspan="6">Zadne zaznamy</td></tr>'}
                    </tbody>
                </table>
            `;

            const printWindow = window.open('', '_blank', 'width=900,height=700');
            if (!printWindow) {
                alert('Pro export povolte vyskakovaci okna.');
                return;
            }
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Vykaz hodin</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 24px; color: #111; }
                            h1 { margin-bottom: 8px; }
                            table { width: 100%; border-collapse: collapse; margin-top: 16px; }
                            th, td { border: 1px solid #ccc; padding: 8px; font-size: 12px; text-align: left; }
                            th { background: #f1f1f1; }
                        </style>
                    </head>
                    <body>${reportHtml}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        function buildAdminReportHtml(entries, filters) {
            const clientLabel = filters.clientId === 'all'
                ? 'Vsechny'
                : (clients.find(c => c.id === filters.clientId)?.name || filters.clientId);
            const techLabel = filters.technician === 'all' ? 'Vsechni' : filters.technician;
            const periodLabel = `${filters.startDate || '-'} - ${filters.endDate || '-'}`;

            const tableRows = entries.map(entry => `
                <tr>
                    <td>${entry.date || '-'}</td>
                    <td>${entry.clientName || (clients.find(c => c.id === entry.clientId)?.name) || '-'}</td>
                    <td>${entry.hours || 0}</td>
                    <td>${entry.userEmail || entry.userId || '-'}</td>
                    <td>${entry.category || '-'}</td>
                    <td>${entry.description || '-'}</td>
                </tr>
            `).join('');

            return `
                <h1>Live reporty</h1>
                <p>Obdobi: ${periodLabel}</p>
                <p>Klient: ${clientLabel}</p>
                <p>Technik: ${techLabel}</p>
                <table>
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Klient</th>
                            <th>Hodiny</th>
                            <th>Technik</th>
                            <th>Cinnost</th>
                            <th>Popis</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows || '<tr><td colspan="6">Zadne zaznamy</td></tr>'}
                    </tbody>
                </table>
            `;
        }

        function openReportPrintWindow(reportHtml) {
            const printWindow = window.open('', '_blank', 'width=900,height=700');
            if (!printWindow) {
                alert('Pro export povolte vyskakovaci okna.');
                return;
            }
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Live reporty</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 24px; color: #111; }
                            h1 { margin-bottom: 8px; }
                            table { width: 100%; border-collapse: collapse; margin-top: 16px; }
                            th, td { border: 1px solid #ccc; padding: 8px; font-size: 12px; text-align: left; }
                            th { background: #f1f1f1; }
                        </style>
                    </head>
                    <body>${reportHtml}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        async function exportAdminReport() {
            if (!canViewReports()) {
                alert('Nemate opravneni zobrazit reporty');
                return;
            }
            ensureReportFilterDefaults();
            const filters = getReportFilters();
            const entries = getFilteredReportEntries();
            openReportPrintWindow(buildAdminReportHtml(entries, filters));
        }

        async function exportAllClientsReport() {
            if (!canViewReports()) {
                alert('Nemate opravneni zobrazit reporty');
                return;
            }
            ensureReportFilterDefaults();
            const filters = { ...getReportFilters(), clientId: 'all' };
            try {
                const entries = await fetchReportEntries(filters);
                openReportPrintWindow(buildAdminReportHtml(entries, filters));
            } catch (err) {
                console.warn('Export all clients failed:', err);
                alert('Export selhal.');
            }
        }
        
        // Update statistics
        function updateStats() {
            document.getElementById('totalDevices').textContent = devices.length;
            document.getElementById('totalRacks').textContent = racks.length;
            
            const totalUnits = racks.reduce((sum, rack) => sum + rack.units, 0);
            const usedUnits = devices.reduce((sum, device) => sum + device.height, 0);
            
            document.getElementById('usedUnits').textContent = usedUnits;
            document.getElementById('freeUnits').textContent = totalUnits - usedUnits;
        }
        
        // Modal functions
        function openRackModal() {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            if (!canManageRacks()) {
                alert('Nemate opravneni spravovat racky');
                return;
            }
            document.getElementById('rackModal').classList.add('active');
        }
        
        function closeRackModal() {
            document.getElementById('rackModal').classList.remove('active');
            clearRackForm();
        }
        
        function openDeviceModal() {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            if (!canManageDevices()) {
                alert('Nemate opravneni spravovat zarizeni');
                return;
            }
            if (racks.length === 0) {
                alert('Nejprve vytvorte rack');
                return;
            }

            const select = document.getElementById('deviceRack');
            select.innerHTML = racks.map(rack => 
                `<option value="${rack.id}">${rack.name}</option>`
            ).join('');

            renderDeviceTypeOptions();
            document.getElementById('deviceModal').classList.add('active');
        }
        
        function closeDeviceModal() {
            document.getElementById('deviceModal').classList.remove('active');
            clearDeviceForm();
        }
        
        // Add rack
        function addRack() {
            if (!canManageRacks()) {
                alert('Nemate opravneni spravovat racky');
                return;
            }
            const name = document.getElementById('rackName').value;
            const units = parseInt(document.getElementById('rackUnits').value);
            const location = document.getElementById('rackLocation').value;
            
            if (!name || !units) {
                alert('Vyplte vechny povinn daje');
                return;
            }
            
            const rack = {
                id: Date.now().toString(),
                name,
                units,
                location
            };
            
            racks.push(rack);
            saveData();
            render();
            closeRackModal();
        }
        
        // Add device
        function addDevice() {
            if (!canManageDevices()) {
                alert('Nemate opravneni spravovat zarizeni');
                return;
            }
            const name = document.getElementById('deviceName').value;
            const type = document.getElementById('deviceType').value;
            const rack = document.getElementById('deviceRack').value;
            const position = parseInt(document.getElementById('devicePosition').value);
            const height = parseInt(document.getElementById('deviceHeight').value);
            const ip = document.getElementById('deviceIP').value;
            const model = document.getElementById('deviceModel').value;
            const serial = document.getElementById('deviceSerial').value;
            const ports = parseInt(document.getElementById('devicePorts').value) || 24;
            
            if (!name || !rack || !position) {
                alert('Vyplte vechny povinn daje');
                return;
            }
            
            // Check if position is available
            const rackObj = racks.find(r => r.id === rack);
            if (position + height - 1 > rackObj.units) {
                alert('Zazen se nevejde do racku');
                return;
            }
            
            const existingDevices = devices.filter(d => d.rack === rack);
            for (let device of existingDevices) {
                if ((position >= device.position && position < device.position + device.height) ||
                    (position + height > device.position && position + height <= device.position + device.height)) {
                    alert('Pozice je ji obsazena');
                    return;
                }
            }
            
            const device = {
                id: Date.now().toString(),
                name,
                type,
                rack,
                position,
                height,
                ip,
                model,
                serial,
                ports
            };
            
            devices.push(device);
            saveData();
            render();
            closeDeviceModal();
        }
        
        // Delete device
        function deleteDevice(id) {
            if (!canManageDevices()) {
                alert('Nemate opravneni spravovat zarizeni');
                return;
            }
            if (confirm('Opravdu chcete smazat toto zazen?')) {
                devices = devices.filter(d => d.id !== id);
                connections = connections.filter(c => c.fromDevice !== id && c.toDevice !== id);
                saveData();
                render();
            }
        }
        
        // Clear forms
        function clearRackForm() {
            document.getElementById('rackName').value = '';
            document.getElementById('rackUnits').value = '42';
            document.getElementById('rackLocation').value = '';
        }
        
        function clearDeviceForm() {
            document.getElementById('deviceName').value = '';
            document.getElementById('deviceType').value = moduleTypes.length ? moduleTypes[0].id : '';
            document.getElementById('devicePosition').value = '';
            document.getElementById('deviceHeight').value = '1';
            document.getElementById('deviceIP').value = '';
            document.getElementById('deviceModel').value = '';
            document.getElementById('deviceSerial').value = '';
            document.getElementById('devicePorts').value = '24';
        }
        
        // Clear all data
        function clearAllRacks() {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            if (!canDeleteRacks()) {
                alert('Nemate opravneni mazat racky');
                return;
            }

            const client = clients.find(c => c.id === currentClientId);
            if (confirm(`Opravdu chcete smazat vsechna data klienta "${client.name}"? Tato akce je nevratna.`)) {
                racks = [];
                devices = [];
                connections = [];
                saveData();
                render();
            }
        }
        
        // Export data
        function exportData() {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            
            const client = clients.find(c => c.id === currentClientId);
            const data = {
                client: client,
                racks,
                devices,
                connections,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rack-manager-${client.name.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Import data
        function importData(event) {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta pro import dat');
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.racks && data.devices) {
                        const client = clients.find(c => c.id === currentClientId);
                        if (confirm(`Import pepe vechna stvajc data klienta "${client.name}". Pokraovat?`)) {
                            racks = data.racks || [];
                            devices = data.devices || [];
                            connections = data.connections || [];
                            saveData();
                            render();
                            alert('Data spn importovna');
                        }
                    } else {
                        alert('Neplatn formt souboru');
                    }
                } catch (err) {
                    alert('Chyba pi importu: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
        
        // ==========================================
        // Firestore Data Functions
        // ==========================================
        
        // Save to Firestore
        function saveToFirebase() {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            
            const client = clients.find(c => c.id === currentClientId);
            if (!client) return;
            
            const dataToSave = {
                client: client,
                racks: racks,
                devices: devices,
                connections: connections,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAtMs: Date.now(),
                savedBy: auth && auth.currentUser ? auth.currentUser.email : 'anonymous'
            };
            
            const clientRef = db.collection('clients').doc(currentClientId);
            
            clientRef.set(dataToSave, { merge: true })
                .then(() => {
                    console.log(' Data saved to Firestore');
                    alert('Data uspesne ulozena do Firestore!');
                    saveData();
                    localStorage.setItem('cxtech_lastUpdate_' + currentClientId, String(Date.now()));
                })
                .catch((error) => {
                    console.error(' Firestore save error:', error);
                    alert('Chyba pri ukladani do Firestore: ' + error.message);
                });
        }
        
        // Load from Firestore
        function loadFromFirebase() {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            
            const clientRef = db.collection('clients').doc(currentClientId);
            
            clientRef.get()
                .then((doc) => {
                    if (!doc.exists) {
                        alert('Pro tohoto klienta nejsou ve Firestore zadna data');
                        return;
                    }

                    const data = doc.data() || {};
                    
                    if (data.racks) racks = data.racks;
                    if (data.devices) devices = data.devices;
                    if (data.connections) connections = data.connections;
                    
                    saveData();
                    render();
                    localStorage.setItem('cxtech_lastUpdate_' + currentClientId, String(Date.now()));
                    
                    console.log(' Data loaded from Firestore');
                    alert('Data nactena z Firestore!');
                })
                .catch((error) => {
                    console.error(' Firestore load error:', error);
                    alert('Chyba pri nacitani z Firestore: ' + error.message);
                });
        }
        
        // Firestore sync is intentionally disabled (manual save/load only)
        function setupRealtimeSync() {
            return;
        }
        
        // Add Firebase status indicator to UI
        function addFirebaseStatusIndicator() {
            const header = document.querySelector('.topbar');
            if (header && !document.getElementById('firebaseStatus')) {
                const statusDiv = document.createElement('div');
                statusDiv.id = 'firebaseStatus';
                statusDiv.style.cssText = 'font-size: 0.85rem; font-weight: 600; color: #b0b0b0;';
                statusDiv.innerHTML = 'Connecting...';
                header.appendChild(statusDiv);
            }
        }
        
        // Call on init
        addFirebaseStatusIndicator();
        window.addEventListener('load', init);
    </script>
   <!-- Firebase Auth + Firestore -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script>
  var auth;
  var db;

  // Load Firebase config from /api/config (Vercel env)
  async function loadFirebaseConfig() {
    var res = await fetch('/api/config');
    if (!res.ok) {
      throw new Error('Firebase config load failed');
    }
    return await res.json();
  }

  loadFirebaseConfig().then(function(firebaseConfig) {
    firebase.initializeApp(firebaseConfig);
    console.log('Firebase initialized for CX.TECH Rack Manager');

    auth = firebase.auth();
    db = firebase.firestore();
    window.auth = auth;
    window.db = db;

    function isLocalHost() {
      return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    }

    function updateLocalAdminUI(enabled) {
      var statusEl = document.getElementById('authStatus');
      var overlay = document.getElementById('authOverlay');
      if (enabled) {
        if (statusEl) statusEl.textContent = 'Local admin';
        if (overlay) overlay.classList.add('hidden');
        document.body.classList.remove('auth-locked');
        if (window.setCurrentRole) {
          window.setCurrentRole('admin');
        } else {
          setCurrentRole('admin');
        }
        if (window.switchView) {
          switchView('dashboard');
        }
      }
    }

    function enableLocalAdmin() {
      if (!isLocalHost()) return;
      localStorage.setItem('localAdmin', 'true');
      updateLocalAdminUI(true);
    }

    function isLocalAdminActive() {
      return isLocalHost() && localStorage.getItem('localAdmin') === 'true';
    }

    if (isLocalHost() && localStorage.getItem('localAdmin') === null) {
      localStorage.setItem('localAdmin', 'true');
    }

    var localAdminBtn = document.getElementById('localAdminBtn');
    if (localAdminBtn && isLocalHost()) {
      localAdminBtn.style.display = 'inline-block';
    }

    var statusElem = document.getElementById('firebaseStatus');
    if (statusElem) {
      statusElem.innerHTML = 'Ready';
      statusElem.style.color = '#4ade80';
    }

    // --- UI pro prihlaseni ---
    function updateAuthUI(user) {
      var statusEl = document.getElementById('authStatus');
      var loginBtn = document.getElementById('loginBtn');
      var logoutBtn = document.getElementById('logoutBtn');
      var overlay = document.getElementById('authOverlay');

      if (!statusEl || !loginBtn || !logoutBtn) return;

      if (!user && isLocalAdminActive()) {
        updateLocalAdminUI(true);
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'none';
        if (window.applyRolePermissions) {
          window.applyRolePermissions();
        }
        return;
      }

      if (user) {
        statusEl.textContent = 'Prihlasen: ' + (user.email || user.uid);
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        if (overlay) overlay.classList.add('hidden');
        document.body.classList.remove('auth-locked');
        if (window.switchView) {
          switchView('dashboard');
        }
        if (window.reportHasLoaded !== undefined) {
          reportHasLoaded = false;
        }
        if (window.reportFiltersVisible !== undefined) {
          reportFiltersVisible = false;
        }
        if (window.loadReportPresetsFromCloud) {
          loadReportPresetsFromCloud(true);
        }
        if (window.loadSharedReportPresets) {
          loadSharedReportPresets(true);
        }
        if (window.applyReportShareFromUrl) {
          applyReportShareFromUrl();
        }
      } else {
        statusEl.textContent = 'Neprihlasen';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        if (overlay) overlay.classList.remove('hidden');
        document.body.classList.add('auth-locked');
        if (window.reportPresetsLoaded !== undefined) {
          reportPresetsLoaded = false;
        }
        if (window.reportHasLoaded !== undefined) {
          reportHasLoaded = false;
        }
        if (window.reportFiltersVisible !== undefined) {
          reportFiltersVisible = false;
        }
        if (window.reportSharedLoaded !== undefined) {
          reportSharedLoaded = false;
          sharedReportPresets = [];
          buildSharedReportOptions();
        }
      }
      if (window.applyRolePermissions) {
        window.applyRolePermissions();
      }
    }

    function loginWithGoogle() {
      var provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(function (error) {
        console.error('Auth error:', error);
        alert('Chyba pri prihlaseni: ' + error.message);
      });
    }

    function sendMagicLink() {
      var input = document.getElementById('emailLoginInput');
      var email = input ? input.value.trim() : '';
      if (!email || !email.includes('@')) {
        alert('Zadejte platny email');
        return;
      }
      var actionCodeSettings = {
        url: window.location.origin + window.location.pathname,
        handleCodeInApp: true
      };
      auth.sendSignInLinkToEmail(email, actionCodeSettings)
        .then(function() {
          window.localStorage.setItem('emailForSignIn', email);
          if (input) input.value = '';
          alert('Magic link byl odeslan na e-mail');
        })
        .catch(function(err) {
          console.error('Magic link error:', err);
          alert('Chyba pri odeslani magic linku: ' + err.message);
        });
    }

    if (auth.isSignInWithEmailLink(window.location.href)) {
      var email = window.localStorage.getItem('emailForSignIn');
      if (!email) {
        email = window.prompt('Zadejte email pro dokon?en? p?ihl??en?');
      }
      auth.signInWithEmailLink(email, window.location.href)
        .then(function() {
          window.localStorage.removeItem('emailForSignIn');
          window.history.replaceState({}, document.title, window.location.pathname);
        })
        .catch(function(err) {
          console.error('Email link sign-in error:', err);
          alert('Chyba pri prihlaseni: ' + err.message);
        });
    }

    function logout() {
      auth.signOut().catch(function (error) {
        console.error('Sign-out error:', error);
        alert('Chyba pri odhlaseni: ' + error.message);
      });
    }

    auth.onAuthStateChanged(function (user) {
      updateAuthUI(user);
      if (window.onAuthRoleChanged) {
        window.onAuthRoleChanged(user);
      }
    });

    function requireAuth() {
      var user = auth.currentUser;
      if (!user) {
        alert('Nejprve se prihlaste.');
        throw new Error('NOT_AUTHENTICATED');
      }
      return user;
    }

    window.loginWithGoogle = loginWithGoogle;
    window.sendMagicLink = sendMagicLink;
    window.logout = logout;
    window.requireAuth = requireAuth;
    window.enableLocalAdmin = enableLocalAdmin;
  }).catch(function(err) {
    console.error('Firebase config error:', err);
    alert('Firebase config error: ' + err.message);
  });

  // --- Firestore doc, kde budeme drzet data ---
  var GLOBAL_PATH = "rackManager/global";

  //  Ulozit vsechna data z localStorage do Firestore
  async function saveToCloud() {
    try {
      var user = requireAuth();

      var clients = JSON.parse(localStorage.getItem('rackManagerClients') || '[]');
      var clientData = JSON.parse(localStorage.getItem('rackManagerClientData') || '{}');
      var lastClientId = localStorage.getItem('rackManagerLastClient') || null;

      var payload = {
        clients: clients,
        clientData: clientData,
        lastClientId: lastClientId,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAtMs: Date.now(),
        updatedBy: user.email || user.uid
      };

      await db.doc(GLOBAL_PATH).set(payload, { merge: true });
      alert(" Data byla ulozena do Firestore");
    } catch (err) {
      if (err.message === "NOT_AUTHENTICATED") return;
      console.error("Chyba pi ukldn:", err);
      alert(" Chyba pri ukladani do cloudu: " + err.message);
    }
  }

  //  Nacist vsechna data z Firestore do localStorage
  async function loadFromCloud() {
    try {
      requireAuth();

      var snap = await db.doc(GLOBAL_PATH).get();
      if (!snap.exists) {
        alert(" V cloudu zatim nejsou zadna data");
        return;
      }

      var data = snap.data() || {};
      var clients = data.clients || [];
      var clientData = data.clientData || {};
      var lastClientId = data.lastClientId || null;

      localStorage.setItem('rackManagerClients', JSON.stringify(clients));
      localStorage.setItem('rackManagerClientData', JSON.stringify(clientData));
      if (lastClientId) {
        localStorage.setItem('rackManagerLastClient', lastClientId);
      } else {
        localStorage.removeItem('rackManagerLastClient');
      }

      // perenderovat UI podle novch dat
      if (typeof init === "function") {
        init();
      }

      alert(" Data byla nactena z Firestore");
    } catch (err) {
      if (err.message === "NOT_AUTHENTICATED") return;
      console.error("Chyba pi natn:", err);
      alert(" Chyba pri nacitani z cloudu: " + err.message);
    }
  }
</script>
</body>
</html>
