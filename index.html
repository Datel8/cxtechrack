<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CX.TECH Rack Manager Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* CX.TECH Brand Colors */
            --cx-orange: #f89a55;
            --cx-black: #000000;
            --cx-white: #ffffff;
            
            /* Application colors based on CX.TECH brand */
            --bg-primary: #0b1220;
            --bg-secondary: #101826;
            --bg-tertiary: #162133;
            --accent-primary: #f89a55;
            --accent-secondary: #ff7a35;
            --accent-tertiary: #ffaa75;
            --text-primary: #f5f7fb;
            --text-secondary: #9aa7bd;
            --border-color: #263247;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
            --info: #60a5fa;
            
            /* Legacy color mappings for compatibility */
            --accent-cyan: var(--accent-primary);
            --accent-magenta: var(--accent-secondary);
            --accent-yellow: var(--accent-tertiary);
            --rack-bg: #0f172a;
            --rack-border: rgba(248, 154, 85, 0.18);
            --sidebar-bg: #0b1220;
            --panel-surface: #121a2b;
            --panel-surface-2: #162235;
            --shadow-soft: 0 18px 45px rgba(5, 8, 16, 0.45);
        }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body.auth-locked .app-shell {
            pointer-events: none;
            user-select: none;
            filter: blur(2px);
            opacity: 0.6;
        }
        
        /* Animated background with CX.TECH orange accents */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, var(--cx-orange) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, var(--cx-orange) 0%, transparent 40%),
                radial-gradient(circle at 40% 20%, var(--cx-orange) 0%, transparent 45%);
            opacity: 0.04;
            z-index: -1;
            animation: backgroundPulse 20s ease-in-out infinite;
        }
        
        @keyframes backgroundPulse {
            0%, 100% { opacity: 0.03; }
            50% { opacity: 0.06; }
        }
        
        /* MSP layout */
        .app-shell {
            display: grid;
            grid-template-columns: 320px 1fr;
            min-height: 100vh;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            background: linear-gradient(180deg, #0f172a, #0b1220 80%);
            border-right: 1px solid rgba(255, 255, 255, 0.06);
            padding: 0.9rem 1.05rem;
            min-height: 100vh;
            height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            overflow: hidden;
        }

        .sidebar-brand {
            margin-bottom: 0.7rem;
            background: transparent;
            border: none;
            padding: 0;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }

        .sidebar-brand:focus-visible {
            outline: 2px solid rgba(248, 154, 85, 0.6);
            outline-offset: 4px;
            border-radius: 12px;
        }

        .brand-title {
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .brand-title .cx,
        .brand-title .tech {
            color: var(--cx-white);
        }

        .brand-title .dot {
            color: var(--cx-orange);
        }

        .brand-subtitle {
            margin-top: 0.35rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .sidebar-scroll {
            display: grid;
            gap: 0;
            overflow-y: auto;
            padding-right: 0.4rem;
            margin-right: -0.4rem;
            flex: 1;
            align-content: start;
        }

        .sidebar-section {
            margin-bottom: 0;
            padding: 0;
        }

        .sidebar-section + .sidebar-section {
            border-top: none;
            padding-top: 0;
        }

        .sidebar-section-title {
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: rgba(248, 154, 85, 0.85);
            margin-bottom: 0;
            font-weight: 600;
            position: relative;
            padding: 0.35rem 0.55rem;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px;
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease;
        }

        .sidebar-section-title:hover {
            background: rgba(14, 22, 38, 0.45);
            border-color: rgba(255, 255, 255, 0.08);
        }

        .sidebar-section-title::before {
            display: none;
        }

        .sidebar-section-title:focus-visible {
            outline: 2px solid rgba(248, 154, 85, 0.4);
            outline-offset: 3px;
            border-radius: 8px;
        }

        .sidebar-section-toggle {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.18);
            transition: background 0.2s ease, box-shadow 0.2s ease;
        }

        .sidebar-section-label {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .sidebar-section-icon {
            width: 18px;
            height: 18px;
            display: inline-block;
            color: rgba(248, 154, 85, 0.85);
        }

        .sidebar-section-body {
            display: grid;
            gap: 0.2rem;
        }

        .sidebar-section.collapsed .sidebar-section-body {
            display: none;
        }

        .sidebar-section:not(.collapsed) .sidebar-section-body {
            margin-top: 0.35rem;
        }

        .sidebar-section.collapsed .sidebar-section-title {
            background: rgba(10, 16, 28, 0.35);
            border-color: rgba(255, 255, 255, 0.06);
        }

        .sidebar-section:not(.collapsed) .sidebar-section-toggle {
            background: rgba(248, 154, 85, 0.9);
            box-shadow: 0 0 0 3px rgba(248, 154, 85, 0.2);
        }

        .section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .sidebar-nav {
            display: grid;
            gap: 0.35rem;
        }

        .sidebar-nav-nested {
            gap: 0.35rem;
        }

        .nav-btn {
            text-align: left;
            width: 100%;
            padding: 0.65rem 0.95rem;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(14, 22, 38, 0.75);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .nav-btn-nested {
            padding-left: 1.8rem;
            font-size: 0.92rem;
            position: relative;
        }

        .nav-btn-nested::before {
            display: none;
        }

        .nav-btn.active {
            border-color: var(--cx-orange);
            box-shadow: 0 0 0 1px rgba(248, 154, 85, 0.4);
            background: linear-gradient(135deg, rgba(248, 154, 85, 0.22), rgba(14, 22, 38, 0.9));
        }

        .nav-btn:hover:not(.active) {
            transform: translateX(6px);
            border-color: rgba(248, 154, 85, 0.5);
        }

        .sidebar-subsection {
            margin-top: 0.45rem;
            padding-top: 0.45rem;
            border-top: 1px dashed rgba(255, 255, 255, 0.08);
        }

        .sidebar-subtitle {
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: rgba(255, 255, 255, 0.55);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .sidebar-actions {
            display: grid;
            gap: 0.4rem;
        }

        .sidebar-action-btn {
            text-align: left;
            width: 100%;
            padding: 0.6rem 0.85rem;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(14, 22, 38, 0.8);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sidebar-action-btn:hover:not(:disabled) {
            border-color: rgba(248, 154, 85, 0.45);
            transform: translateX(4px);
        }

        .sidebar-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .sidebar-module-list {
            display: grid;
            gap: 0.35rem;
        }

        .sidebar-module {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.45rem 0.7rem;
            border-radius: 10px;
            border: 1px dashed rgba(255, 255, 255, 0.15);
            color: var(--text-secondary);
            font-size: 0.8rem;
            background: rgba(14, 22, 38, 0.6);
        }

        .sidebar-module-tag {
            font-size: 0.65rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: rgba(248, 154, 85, 0.8);
        }

        .main-content {
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            height: 100vh;
            min-height: 0;
            overflow: hidden;
        }

        .main-scroll {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding-right: 0.5rem;
            margin-right: -0.5rem;
            display: grid;
            gap: 1.5rem;
        }

        .topbar {
            background: linear-gradient(120deg, #101826, #0b1220);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
            flex-wrap: wrap;
            box-shadow: var(--shadow-soft);
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .topbar::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 40%;
            height: 100%;
            background: radial-gradient(circle at right, rgba(248, 154, 85, 0.2), transparent 70%);
            opacity: 0.7;
        }

        .topbar-compact {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            margin-bottom: 1rem;
            justify-content: flex-end;
        }

        .topbar-compact::after {
            display: none;
        }

        .topbar-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .topbar-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.35rem;
        }

        .topbar-user {
            position: relative;
            margin-left: auto;
            z-index: 2;
        }

        .user-menu-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: 1px solid rgba(248, 154, 85, 0.4);
            background: linear-gradient(140deg, rgba(20, 30, 52, 0.95), rgba(10, 16, 28, 0.92));
            color: var(--text-primary);
            display: grid;
            place-items: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 8px 18px rgba(6, 10, 18, 0.45);
        }

        .user-menu-btn:hover {
            transform: translateY(-1px);
            border-color: rgba(248, 154, 85, 0.7);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
        }

        .user-menu-avatar {
            font-weight: 700;
            font-size: 0.85rem;
            letter-spacing: 0.1em;
        }

        .user-menu-logout {
            position: absolute;
            right: -4px;
            bottom: -4px;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: none;
            background: var(--cx-orange);
            color: #111;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.35);
        }

        .user-menu-panel {
            position: absolute;
            top: calc(100% + 0.85rem);
            right: 0;
            min-width: 220px;
            padding: 1rem;
            border-radius: 14px;
            border: 1px solid rgba(248, 154, 85, 0.35);
            background: linear-gradient(160deg, rgba(18, 28, 48, 0.98), rgba(11, 18, 32, 0.98));
            box-shadow: 0 16px 40px rgba(3, 6, 12, 0.45);
            display: none;
            gap: 0.75rem;
        }

        .user-menu-panel.active {
            display: grid;
        }

        .user-menu-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .user-menu-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.45rem 0.6rem;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(12, 12, 12, 0.7);
            font-size: 0.75rem;
        }

        .user-menu-actions {
            display: grid;
            gap: 0.5rem;
        }

        .user-menu-panel .btn,
        .user-menu-panel .btn-small,
        .user-menu-panel .btn-secondary {
            width: 100%;
            padding: 0.55rem 0.9rem;
            font-size: 0.8rem;
        }

        .topbar-actions {
            display: grid;
            gap: 0.75rem;
            z-index: 1;
            padding: 0.9rem 1rem;
            border-radius: 16px;
            border: 1px solid rgba(248, 154, 85, 0.35);
            background: linear-gradient(160deg, rgba(18, 18, 18, 0.95), rgba(10, 10, 10, 0.9));
            min-width: 260px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-soft);
        }

        .topbar-actions::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 80% 20%, rgba(248, 154, 85, 0.2), transparent 55%);
            opacity: 0.7;
        }

        .topbar-actions > * {
            position: relative;
            z-index: 1;
        }

        .topbar-menu-title {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.24em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .session-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0.6rem;
            border-radius: 999px;
            border: 1px solid var(--border-color);
            background: rgba(8, 8, 8, 0.7);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .topbar-actions .auth-status {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: var(--text-secondary);
        }

        .topbar-menu-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
        }

        .topbar-actions .btn,
        .topbar-actions .btn-small,
        .topbar-actions .btn-secondary {
            width: 100%;
            padding: 0.6rem 0.95rem;
            font-size: 0.85rem;
        }

        .auth-status {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
        }

        .auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(8, 8, 8, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-card {
            background: var(--panel-surface-2);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            padding: 2rem;
            width: min(420px, 90vw);
            box-shadow: var(--shadow-soft);
            text-align: left;
        }

        .auth-card h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .auth-card p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .auth-stack {
            display: grid;
            gap: 0.75rem;
        }

        .auth-hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .role-manager-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .role-manager-table th,
        .role-manager-table td {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
        }

        .role-manager-table th {
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
        }

        .role-select {
            width: 100%;
            padding: 0.4rem 0.6rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
        }

        .role-note {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .role-invite-form {
            display: grid;
            grid-template-columns: 1fr 160px 140px;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .role-invite-form input {
            width: 100%;
            padding: 0.5rem 0.6rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
        }

        .role-invite-list {
            margin-top: 1rem;
        }

        .m365-note {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }

        .m365-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.75rem;
        }

        .m365-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        @media (max-width: 1100px) {
            .app-shell {
                grid-template-columns: 1fr;
                height: auto;
                overflow: visible;
            }

            .sidebar {
                position: relative;
                height: auto;
            }

            .main-content {
                padding: 1.5rem;
                height: auto;
                overflow: visible;
            }

            .main-scroll {
                overflow: visible;
                padding-right: 0;
                margin-right: 0;
            }

            .dashboard-shell {
                grid-template-columns: 1fr;
            }

            .dashboard-hero-card {
                grid-template-columns: 1fr;
                min-height: auto;
            }
        }

        @media (max-width: 700px) {
            .sidebar {
                padding: 1.5rem 1rem;
            }

            .topbar {
                padding: 1rem 1.25rem;
            }

            .topbar-actions {
                width: 100%;
            }

            .dashboard-section-head {
                padding: 1rem 1.1rem;
            }

            .dashboard-section-body {
                padding: 0 1.1rem 1.1rem;
            }

            .dashboard-hero-card {
                padding: 1.5rem;
            }

            .module-expansion-grid {
                grid-template-columns: 1fr;
            }

            .report-actions {
                align-items: stretch;
            }

            .report-actions .btn-small {
                width: 100%;
            }
        }
        
        .control-section {
            margin-bottom: 2rem;
        }
        
        .control-section h3 {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-weight: 500;
        }
        
        .btn {
            width: 100%;
            padding: 0.85rem 1.1rem;
            background: linear-gradient(135deg, var(--cx-orange), #ff6a25);
            color: var(--cx-white);
            border: none;
            border-radius: 12px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            line-height: 1.2;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: none;
            letter-spacing: 0.02em;
            margin-bottom: 0.5rem;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(248, 154, 85, 0.25);
            background: linear-gradient(135deg, #ff6a25, #ff915a);
        }
        
        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled,
        .btn-small:disabled,
        .delete-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: rgba(248, 154, 85, 0.08);
            border: 1px solid rgba(248, 154, 85, 0.55);
            color: var(--cx-orange);
        }
        
        .btn-secondary:hover {
            background: rgba(248, 154, 85, 0.16);
            border-color: rgba(248, 154, 85, 0.75);
            box-shadow: 0 6px 18px rgba(248, 154, 85, 0.2);
        }
        
        /* Form elements */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-family: 'IBM Plex Mono', monospace;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
        }
        
        /* Rack visualization */
        .rack-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-color);
        }
        
        .rack-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .rack-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .rack-stats {
            display: flex;
            gap: 2rem;
        }

        .time-filter {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.6rem;
            border-radius: 999px;
            border: 1px solid rgba(248, 154, 85, 0.35);
            background: rgba(14, 22, 38, 0.6);
            color: var(--text-secondary);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
        }

        .time-filter select {
            background: rgba(12, 18, 32, 0.9);
            border: none;
            color: var(--text-primary);
            font-size: 0.75rem;
            font-family: 'IBM Plex Mono', monospace;
            padding: 0.1rem 0.2rem;
        }

        .time-filter select option {
            background: #0f172a;
            color: var(--text-primary);
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--accent-cyan);
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .rack-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        .rack {
            background: var(--rack-bg);
            border: 2px solid var(--rack-border);
            border-radius: 8px;
            padding: 1rem;
            position: relative;
            transition: all 0.3s;
        }
        
        .rack:hover {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
            transform: translateY(-4px);
        }
        
        .rack-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--accent-cyan);
        }
        
        .rack-units {
            display: flex;
            flex-direction: column-reverse;
            gap: 2px;
            background: #000;
            padding: 4px;
            border-radius: 4px;
        }
        
        .rack-unit {
            height: 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            position: relative;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.625rem;
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
        }
        
        .rack-unit.occupied {
            cursor: pointer;
            background: var(--device-gradient, var(--bg-tertiary));
            border-color: var(--device-color, var(--border-color));
            color: var(--device-text, var(--text-primary));
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.4rem;
            padding: 0 0.5rem;
            text-align: left;
        }
        
        
        .rack-unit.occupied:hover {
            transform: scaleX(1.05);
            z-index: 10;
            box-shadow: 0 0 20px currentColor;
        }

        .rack-unit-content {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 0.4rem;
            min-width: 0;
            flex: 1;
        }

        .rack-unit-name {
            font-weight: 600;
            font-size: 0.65rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        .rack-unit-ports {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.55rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .ports-count {
            font-family: 'IBM Plex Mono', monospace;
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.35);
            padding: 0.1rem 0.35rem;
            border-radius: 999px;
            color: var(--device-text, #ffffff);
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.4);
        }

        .ports-dots {
            display: inline-flex;
            gap: 2px;
        }

        .ports-dot {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            background: var(--device-text, rgba(255, 255, 255, 0.85));
            border: 1px solid rgba(0, 0, 0, 0.2);
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.35);
            opacity: 0.85;
        }

        .ports-overflow {
            font-size: 0.55rem;
            color: var(--device-text, rgba(255, 255, 255, 0.85));
        }
        
        /* Device info tooltip */
        .device-tooltip {
            position: fixed;
            background: linear-gradient(145deg, rgba(28, 28, 28, 0.96), rgba(12, 12, 12, 0.96));
            border: 1px solid rgba(248, 154, 85, 0.45);
            border-radius: 12px;
            padding: 1rem 1.1rem;
            z-index: 6000;
            min-width: 260px;
            max-width: 320px;
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
            display: none;
            animation: tooltipFadeIn 0.2s ease-out;
            pointer-events: none;
            backdrop-filter: blur(10px);
        }
        
        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .device-tooltip.active {
            display: block;
        }
        
        .tooltip-header {
            font-weight: 700;
            margin-bottom: 0.6rem;
            color: var(--accent-primary);
            font-family: 'IBM Plex Mono', monospace;
            letter-spacing: 0.03em;
        }
        
        .tooltip-detail {
            font-size: 0.78rem;
            color: var(--text-secondary);
            margin-bottom: 0.35rem;
            font-family: 'IBM Plex Mono', monospace;
        }
        
        /* Device list */
        .device-list {
            margin-top: 2rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-color);
        }
        
        .device-list h3 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }
        
        .device-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .device-table th {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 2px solid var(--border-color);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
        }
        
        .device-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
        }
        
        .device-table tr:hover {
            background: var(--bg-tertiary);
        }
        
        .device-type-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            background: var(--badge-bg, rgba(248, 154, 85, 0.15));
            color: var(--badge-color, var(--text-primary));
            border: 1px solid var(--badge-border, transparent);
        }
        
        .delete-btn {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s;
        }
        
        .delete-btn:hover {
            background: var(--danger);
            color: var(--text-primary);
        }

        /* Module management */
        .module-list {
            display: grid;
            gap: 0.75rem;
        }

        .module-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .module-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
        }

        .module-color {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .module-id {
            color: var(--text-secondary);
        }

        /* MSP modules */
        .msp-modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .msp-module-card {
            background: var(--panel-surface-2);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-height: 160px;
            box-shadow: 0 20px 35px rgba(0, 0, 0, 0.25);
            transition: transform 0.25s ease, border-color 0.25s ease;
        }

        .msp-module-card:hover {
            transform: translateY(-4px);
            border-color: rgba(248, 154, 85, 0.6);
        }

        .msp-module-title {
            font-size: 1.05rem;
            font-weight: 600;
        }

        .msp-module-meta {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-secondary);
        }

        .msp-module-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .msp-module-status {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--cx-orange);
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .overview-card {
            background: linear-gradient(135deg, rgba(248, 154, 85, 0.15), rgba(20, 20, 20, 0.9));
            border: 1px solid rgba(248, 154, 85, 0.4);
            border-radius: 14px;
            padding: 1.25rem;
            cursor: pointer;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }

        .overview-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
        }

        .overview-card-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: var(--text-secondary);
        }

        .overview-card-value {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 0.35rem;
        }

        .overview-card-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .overview-section {
            margin-top: 2rem;
        }

        .overview-section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .overview-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .overview-client-meta {
            display: grid;
            gap: 0.25rem;
        }

        .overview-client-logo {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            border: 1px solid rgba(248, 154, 85, 0.35);
            background: rgba(15, 15, 15, 0.6);
            display: grid;
            place-items: center;
            color: var(--cx-orange);
            font-weight: 700;
            letter-spacing: 0.1em;
            font-size: 0.75rem;
        }

        .overview-client-logo img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        
        .overview-client-pricing {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        .overview-client-logo-wrap {
            display: grid;
            justify-items: end;
            gap: 0.4rem;
        }

        .overview-logo-btn {
            font-size: 0.65rem;
            padding: 0.35rem 0.7rem;
        }

        .dashboard-view {
            display: block;
            background: transparent;
            border: none;
            padding: 0;
        }

        .dashboard-shell {
            display: grid;
            grid-template-columns: minmax(0, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .dashboard-hero-card {
            background: linear-gradient(140deg, rgba(248, 154, 85, 0.2), rgba(12, 18, 32, 0.95));
            border: 1px solid rgba(248, 154, 85, 0.28);
            border-radius: 24px;
            padding: 2rem;
            position: relative;
            overflow: hidden;
            min-height: 320px;
            display: grid;
            grid-template-columns: minmax(0, 1.15fr) minmax(0, 0.85fr);
            gap: 1.5rem;
            box-shadow: var(--shadow-soft);
        }

        .dashboard-hero-card::after {
            display: none;
        }

        .dashboard-hero-content {
            position: relative;
            z-index: 1;
            display: grid;
            gap: 0.75rem;
        }

        .dashboard-hero-kicker {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.28em;
            color: var(--text-secondary);
        }

        .dashboard-hero-title {
            font-size: 2rem;
            font-weight: 700;
        }

        .dashboard-hero-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
            max-width: 560px;
        }

        .dashboard-hero-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .dashboard-hours-chart {
            display: none;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .dashboard-hours-title {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.22em;
            color: var(--text-secondary);
        }

        .dashboard-hours-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(10px, 1fr));
            gap: 0.35rem;
            align-items: end;
            height: 140px;
        }

        .dashboard-hours-bar {
            display: grid;
            grid-template-rows: 1fr auto;
            align-items: end;
            gap: 0.2rem;
        }

        .dashboard-hours-fill {
            display: block;
            width: 100%;
            border-radius: 8px;
            background: linear-gradient(180deg, #ffbf7f, var(--cx-orange));
            min-height: 6px;
            box-shadow: 0 0 10px rgba(248, 154, 85, 0.35);
        }

        .dashboard-hours-fill.is-empty {
            background: rgba(255, 255, 255, 0.08);
            box-shadow: none;
        }

        .dashboard-hours-label {
            font-size: 0.6rem;
            text-align: center;
            color: var(--text-secondary);
            min-height: 0.7rem;
        }

        .erp-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
        }

        .erp-summary-card {
            background: rgba(14, 22, 38, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 18px;
            padding: 1rem;
            display: grid;
            gap: 0.6rem;
        }

        .erp-summary-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--text-secondary);
        }

        .erp-summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .erp-summary-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .erp-summary-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 0.4rem;
        }

        .erp-summary-list li {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .erp-summary-list strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .erp-employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
        }

        .erp-employee-card {
            background: rgba(14, 22, 38, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 18px;
            padding: 1rem;
            display: grid;
            gap: 0.7rem;
        }

        .erp-employee-head {
            display: flex;
            align-items: center;
            gap: 0.7rem;
        }

        .erp-employee-avatar {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(248, 154, 85, 0.3), rgba(248, 154, 85, 0.05));
            border: 1px solid rgba(248, 154, 85, 0.35);
            display: grid;
            place-items: center;
            color: var(--cx-orange);
            font-weight: 700;
        }

        .erp-employee-name {
            font-size: 1rem;
            font-weight: 600;
        }

        .erp-employee-role {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .erp-employee-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
        }

        .erp-employee-tag {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 999px;
            padding: 0.2rem 0.5rem;
            color: var(--text-secondary);
        }

        .erp-employee-tag.active {
            border-color: rgba(248, 154, 85, 0.45);
            color: var(--cx-orange);
        }

        .dashboard-metric {
            background: rgba(8, 8, 8, 0.6);
            border: 1px solid rgba(248, 154, 85, 0.35);
            border-radius: 14px;
            padding: 0.85rem 1rem;
        }

        .dashboard-metric-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.22em;
            color: var(--text-secondary);
        }

        .dashboard-metric-value {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 0.45rem;
            color: var(--cx-orange);
        }

        .dashboard-time-panel {
            position: relative;
            z-index: 1;
            background: rgba(8, 8, 8, 0.6);
            border: 1px solid rgba(248, 154, 85, 0.35);
            border-radius: 18px;
            padding: 1.25rem;
            display: grid;
            gap: 0.85rem;
            align-content: start;
        }

        .dashboard-time-title {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.22em;
            color: var(--text-secondary);
        }

        .dashboard-time-total {
            font-size: 2rem;
            font-weight: 700;
            color: var(--cx-orange);
        }

        .dashboard-time-progress {
            height: 10px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            overflow: hidden;
        }

        .dashboard-time-progress span {
            display: block;
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--cx-orange), #ff6a25);
        }

        .dashboard-time-remaining {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .dashboard-time-filter {
            display: grid;
            gap: 0.35rem;
        }

        .dashboard-time-filter label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: var(--text-secondary);
        }

        .dashboard-time-filter select {
            background: rgba(12, 12, 12, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            color: var(--text-primary);
            padding: 0.45rem 0.6rem;
            font-size: 0.85rem;
            font-family: 'Space Grotesk', sans-serif;
        }

        .dashboard-category-list {
            display: grid;
            gap: 0.45rem;
        }

        .dashboard-category-row {
            display: flex;
            justify-content: space-between;
            gap: 0.75rem;
            font-size: 0.85rem;
        }

        .dashboard-category-label {
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.7rem;
        }

        .dashboard-category-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .dashboard-time-divider {
            height: 1px;
            background: rgba(248, 154, 85, 0.25);
        }

        .dashboard-time-subtitle {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--text-secondary);
        }

        .dashboard-tech-list {
            display: grid;
            gap: 0.55rem;
        }

        .dashboard-tech-row {
            display: flex;
            justify-content: space-between;
            gap: 0.75rem;
            font-size: 0.85rem;
        }

        .dashboard-tech-name {
            color: var(--text-primary);
            font-weight: 600;
        }

        .dashboard-tech-hours {
            color: var(--cx-orange);
            font-weight: 600;
        }

        .dashboard-tech-bar {
            height: 6px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            overflow: hidden;
        }

        .dashboard-tech-bar span {
            display: block;
            height: 100%;
            background: rgba(248, 154, 85, 0.7);
        }

        .dashboard-body {
            display: grid;
            gap: 0.7rem;
        }

        .dashboard-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 0;
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }

        .dashboard-section[open] {
            margin-bottom: 0.6rem;
        }

        .dashboard-section-alt {
            background: linear-gradient(160deg, rgba(248, 154, 85, 0.16), rgba(12, 18, 32, 0.95));
            border-color: rgba(248, 154, 85, 0.25);
        }

        .dashboard-section-head {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 0;
            padding: 1.1rem 1.5rem;
            cursor: pointer;
            list-style: none;
            background: rgba(10, 10, 10, 0.45);
        }

        .dashboard-section-head:focus-visible {
            outline: 2px solid rgba(248, 154, 85, 0.4);
            outline-offset: 2px;
            border-radius: 14px;
        }

        .dashboard-section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: var(--text-secondary);
        }

        .dashboard-section-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.35rem;
        }

        .dashboard-section-head::-webkit-details-marker {
            display: none;
        }

        .dashboard-section-head::marker {
            content: '';
        }

        .dashboard-section-toggle {
            font-size: 1rem;
            color: var(--text-secondary);
            transition: transform 0.2s ease, color 0.2s ease;
        }

        .dashboard-section[open] .dashboard-section-toggle {
            transform: rotate(180deg);
            color: var(--cx-orange);
        }

        .dashboard-section[open] .dashboard-section-head {
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .dashboard-section-body {
            padding: 0 1.5rem 1.5rem;
        }

        .dashboard-view .overview-grid {
            margin-top: 0.5rem;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        }

        .dashboard-view .overview-card {
            background: linear-gradient(140deg, rgba(14, 22, 38, 0.95), rgba(18, 28, 48, 0.9));
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }

        .dashboard-view .overview-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(248, 154, 85, 0.2), transparent 60%);
            opacity: 0.9;
        }

        .dashboard-view .overview-card > * {
            position: relative;
            z-index: 1;
        }

        .dashboard-view .overview-card-title {
            font-size: 0.75rem;
        }

        .dashboard-view .overview-card-value {
            font-size: 2.2rem;
        }

        .dashboard-view .msp-modules-grid {
            margin-top: 0;
        }

        .dashboard-view .msp-module-card {
            background: linear-gradient(160deg, rgba(18, 18, 18, 0.95), rgba(10, 10, 10, 0.9));
            border: 1px solid rgba(248, 154, 85, 0.25);
        }

        .dashboard-view .msp-module-card:hover {
            border-color: rgba(248, 154, 85, 0.6);
        }

        .module-expansion {
            margin-top: 1rem;
            display: grid;
            gap: 0.6rem;
        }

        .module-expansion-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--text-secondary);
        }

        .module-expansion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
        }

        .module-expansion-tile {
            border: 1px dashed rgba(248, 154, 85, 0.35);
            border-radius: 14px;
            padding: 0.9rem;
            background: rgba(14, 22, 38, 0.75);
            display: grid;
            gap: 0.35rem;
        }

        .module-expansion-icon {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            background: rgba(248, 154, 85, 0.2);
            color: var(--cx-orange);
            display: grid;
            place-items: center;
            font-weight: 700;
        }

        .module-expansion-label {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .module-expansion-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .dashboard-grid {
            margin-top: 0.5rem;
        }

        .report-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .report-field {
            display: grid;
            gap: 0.25rem;
            min-width: 150px;
        }

        .report-field label {
            font-size: 0.7rem;
            text-transform: none;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .report-filters select,
        .report-filters input {
            padding: 0.4rem 0.6rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
        }

        .report-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            justify-content: space-between;
            margin-top: 1rem;
        }


        .report-actions-right {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .reports-layout {
            display: grid;
            grid-template-columns: minmax(260px, 320px) minmax(0, 1fr);
            gap: 1.75rem;
            align-items: start;
        }

        .reports-layout.reports-layout-single {
            grid-template-columns: 1fr;
        }

        .report-filter-panel {
            display: grid;
            gap: 1rem;
        }

        .reports-layout-single .report-filter-panel {
            width: 100%;
            max-width: 760px;
            margin: 0 auto;
        }

        .report-filter-card {
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 16px;
            padding: 1.25rem;
            color: #1c1c1c;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.06);
        }

        .report-filter-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: #6f6a63;
            margin-bottom: 0.85rem;
            font-weight: 600;
        }

        .report-filter-card-full {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .report-filter-section {
            display: grid;
            gap: 0.85rem;
        }

        .report-filter-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: #6f6a63;
            font-weight: 600;
        }

        .report-filter-divider {
            height: 1px;
            background: #eee5da;
        }

        .report-filter-card-full .report-actions {
            margin-top: auto;
        }

        .report-form-grid {
            display: grid;
            gap: 0.85rem;
        }

        .report-form-row {
            display: grid;
            gap: 0.35rem;
        }

        .report-share-row {
            display: grid;
            grid-template-columns: auto minmax(0, 1fr);
            gap: 0.75rem;
            align-items: center;
        }

        .report-share-actions {
            display: grid;
            gap: 0.75rem;
        }

        .report-share-note {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .report-form-row label {
            font-size: 0.7rem;
            color: #7a756e;
            letter-spacing: 0.08em;
        }

        .report-action-row {
            display: grid;
            gap: 0.5rem;
        }

        .report-display {
            min-height: 420px;
            display: flex;
            justify-content: flex-start;
            align-items: stretch;
            width: 100%;
        }

        .report-sheet {
            background: #ffffff;
            border-radius: 18px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            padding: 2rem;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.08);
            color: #1c1c1c;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        .report-grid-stack {
            display: grid;
            gap: 1rem;
            width: 100%;
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.25rem;
            width: 100%;
        }

        .report-grid .report-sheet {
            max-width: none;
            margin: 0;
        }

        .report-sheet-compact {
            padding: 1.5rem;
        }

        .report-sheet-compact .report-sheet-title {
            font-size: 1.2rem;
        }

        .report-sheet-compact .report-sheet-meta {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .report-sheet-wide {
            max-width: none;
            padding: 2.5rem;
            margin: 0;
        }

        .report-sheet-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1.5rem;
        }

        .report-sheet-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .report-live {
            display: inline-flex;
            align-items: center;
            padding: 0.1rem 0.5rem;
            border-radius: 999px;
            background: rgba(34, 197, 94, 0.12);
            color: #1f7a44;
            font-size: 0.7rem;
            margin-left: 0.4rem;
        }

        .report-sheet-subtitle {
            margin-top: 0.3rem;
            color: #7a756e;
            font-size: 0.85rem;
        }

        .report-sheet-logo {
            font-weight: 700;
            letter-spacing: 0.08em;
            color: #f89a55;
            font-size: 1rem;
        }

        .report-sheet-toolbar {
            display: flex;
            justify-content: flex-end;
            margin: 1rem 0 0.75rem;
        }

        .report-sheet-meta {
            display: grid;
            gap: 0.5rem;
            margin: 1.5rem 0 1.25rem;
            color: #4f4a45;
        }

        .report-meta-item {
            display: grid;
            grid-template-columns: 140px minmax(0, 1fr);
            gap: 0.75rem;
            align-items: center;
            font-size: 0.85rem;
        }

        .report-meta-item span {
            color: #7a756e;
        }

        .report-sheet-totals {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #eee5da;
            border-bottom: 1px solid #eee5da;
            padding: 0.75rem 0;
            margin-bottom: 0.75rem;
            font-size: 0.85rem;
            color: #4f4a45;
        }

        #reportsView .time-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            color: #1c1c1c;
        }

        #reportsView .time-table th,
        #reportsView .time-table td {
            padding: 0.65rem 0.75rem;
            border-bottom: 1px solid #eee5da;
            text-align: left;
        }

        #reportsView .time-table th {
            background: #f7f4ef;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            font-size: 0.6rem;
            color: #7a756e;
        }

        #reportsView .time-table tr:last-child td {
            border-bottom: none;
        }

        #reportsView .empty-state {
            background: transparent;
            border: 1px dashed #e1d8cd;
            color: #7a756e;
        }

        #reportsView #timeReportTable {
            width: 100%;
        }

        .report-list {
            display: grid;
            gap: 0.9rem;
        }

        .report-list-group {
            padding: 0;
            background: transparent;
            border: none;
        }

        .report-list-group + .report-list-group {
            border-top: 1px solid var(--border-color);
            padding-top: 1.25rem;
            margin-top: 0.35rem;
        }

        .report-list-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .report-list-grid {
            display: grid;
            gap: 0;
        }

        .report-list-card {
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--border-color);
            border-radius: 0;
            padding: 0.9rem 0;
            text-align: left;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .report-list-card:hover {
            border-color: rgba(248, 154, 85, 0.5);
            transform: none;
        }

        .report-list-name {
            font-weight: 600;
            font-size: 1.05rem;
            line-height: 1.4;
        }

        .report-list-meta {
            margin-top: 0.45rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: none;
            letter-spacing: 0.06em;
            line-height: 1.5;
        }

        .report-sheet .report-list-title {
            color: #6f6a63;
        }

        .report-sheet .report-list-group + .report-list-group {
            border-top: 1px solid #eee5da;
        }

        .report-sheet .report-list-card {
            color: #1c1c1c;
            border-bottom: 1px solid #eee5da;
        }

        .report-sheet .report-list-meta {
            color: #7a756e;
        }

        .report-sheet-wide .report-sheet-meta {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem 1.5rem;
            margin: 1.75rem 0 1.5rem;
        }

        .report-sheet-wide .report-list {
            gap: 1.15rem;
        }

        .report-sheet-wide .report-list-card {
            padding: 1.05rem 0;
        }

        #reportsView {
            background: #f4f2ee;
            border: none;
            padding: 1.5rem;
            border-radius: 18px;
            color: #1c1c1c;
        }

        #reportsView .time-panel {
            background: transparent;
            border: none;
            padding: 0;
        }

        #reportsView .report-actions {
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
            margin-top: 1.25rem;
        }

        #reportsView .report-filters {
            display: grid;
            gap: 0.75rem;
        }

        #reportsView .report-field label {
            text-transform: none;
            letter-spacing: 0.08em;
        }

        #reportsView .report-field {
            min-width: 0;
        }

        #reportsView .report-filters select,
        #reportsView .report-filters input,
        #reportsView .report-form-row input,
        #reportsView .report-form-row select {
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            color: #1c1c1c;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.9rem;
            padding: 0.6rem 0.7rem;
        }

        #reportsView .report-actions {
            flex-direction: column;
            align-items: stretch;
            border-top: none;
            padding-top: 0;
            margin-top: 1rem;
        }

        #teamsView {
            background: #f7f7f9;
            border: none;
            padding: 1.25rem;
            border-radius: 20px;
            color: #1c1c1c;
        }

        #teamsView .rack-header {
            margin-bottom: 1rem;
            background: #ffffff;
            border: 1px solid #e6e7eb;
            border-radius: 16px;
            padding: 1rem 1.4rem;
            gap: 1rem;
            flex-wrap: wrap;
            box-shadow: 0 8px 18px rgba(17, 24, 39, 0.05);
        }

        .teams-subtitle {
            margin-top: 0.25rem;
            font-size: 0.9rem;
            color: #6b7280;
            max-width: 560px;
        }

        .teams-header {
            background: #ffffff;
            border: 1px solid #e6e7eb;
            border-radius: 18px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 1rem;
        }

        .teams-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
            align-items: center;
        }

        .teams-status {
            margin-top: 0.75rem;
            font-size: 0.85rem;
            color: #6b7280;
        }

        .teams-status.error {
            color: #b2542d;
        }

        .teams-layout {
            display: grid;
            grid-template-columns: 280px minmax(0, 1fr);
            gap: 0.9rem;
            align-items: stretch;
            width: 100%;
        }

        .teams-panel {
            background: #ffffff;
            border: 1px solid #e6e7eb;
            border-radius: 14px;
            padding: 1rem;
            min-height: 200px;
            box-shadow: none;
        }

        .teams-sidebar {
            background: #f3f4f6;
        }

        .teams-thread-panel {
            background: #ffffff;
        }

        .teams-tabs {
            display: flex;
            gap: 0.4rem;
            margin-bottom: 0.75rem;
            background: #eef0f3;
            padding: 0.25rem;
            border-radius: 14px;
            border: 1px solid #e6e7eb;
        }

        .teams-tab {
            flex: 1 1 0;
            border: none;
            background: transparent;
            color: #6b7280;
            border-radius: 12px;
            padding: 0.45rem 0.8rem;
            font-size: 0.75rem;
            text-transform: none;
            letter-spacing: 0.02em;
            font-weight: 600;
            cursor: pointer;
        }

        .teams-tab.active {
            background: #ffffff;
            color: #1f1d1b;
            box-shadow: 0 8px 18px rgba(17, 24, 39, 0.06);
        }

        .teams-search {
            margin-bottom: 0.75rem;
        }

        .teams-search input {
            width: 100%;
            border-radius: 12px;
            border: 1px solid #e6e7eb;
            padding: 0.55rem 0.75rem;
            font-size: 0.85rem;
            background: #ffffff;
            font-family: 'Space Grotesk', sans-serif;
        }

        .teams-list-title {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: #9aa0a6;
            margin: 0.75rem 0 0.5rem;
        }

        .teams-section-manager {
            display: flex;
            gap: 0.4rem;
            align-items: center;
            margin-bottom: 0.6rem;
            background: #eef0f3;
            border-radius: 12px;
            padding: 0.45rem;
            border: 1px solid #e6e7eb;
        }

        .teams-section-input {
            flex: 1 1 auto;
            border: 1px solid #e1e4ea;
            border-radius: 10px;
            padding: 0.35rem 0.6rem;
            font-size: 0.8rem;
            font-family: 'Space Grotesk', sans-serif;
            background: #ffffff;
        }

        .teams-section-add {
            white-space: nowrap;
        }

        .teams-section-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            color: #6b7280;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.14em;
        }

        .teams-section-title {
            font-weight: 600;
        }

        .teams-section-count {
            margin-left: 0.4rem;
            background: #fde7d6;
            color: #8b4b2b;
            border-radius: 999px;
            padding: 0.05rem 0.45rem;
            font-size: 0.6rem;
            letter-spacing: 0.08em;
        }

        .teams-section-remove {
            background: transparent;
            border: 1px solid #e6e7eb;
            color: #9aa0a6;
            border-radius: 999px;
            font-size: 0.65rem;
            padding: 0.1rem 0.45rem;
            cursor: pointer;
        }

        .teams-section-select {
            margin-top: 0.4rem;
            width: 100%;
            border: 1px solid #e6e7eb;
            border-radius: 8px;
            padding: 0.25rem 0.4rem;
            font-size: 0.7rem;
            font-family: 'Space Grotesk', sans-serif;
            color: #6b7280;
            background: #ffffff;
        }

        .teams-section-empty {
            font-size: 0.75rem;
            color: #9aa0a6;
            margin-bottom: 0.4rem;
        }

        .teams-chat-group {
            border: none;
            border-radius: 0;
            padding: 0;
            background: transparent;
            margin-bottom: 0.9rem;
        }

        .teams-chat-group-body {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .teams-item {
            border: none;
            border-radius: 12px;
            padding: 0.55rem 0.55rem;
            cursor: pointer;
            background: transparent;
            color: #1c1c1c;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            transition: background 0.15s ease, border-color 0.15s ease;
        }

        .teams-item:hover {
            background: #f0f4fb;
        }

        .teams-item.active {
            background: #eaf1ff;
        }

        .teams-item-row {
            display: flex;
            gap: 0.65rem;
            align-items: flex-start;
        }

        .teams-item-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: #ffffff;
            flex-shrink: 0;
        }

        .teams-item-content {
            flex: 1 1 auto;
            min-width: 0;
        }

        .teams-item-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .teams-item-title {
            font-size: 0.88rem;
            font-weight: 600;
            color: #1f1d1b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .teams-item-time {
            font-size: 0.7rem;
            color: #9aa0a6;
            flex-shrink: 0;
        }

        .teams-item-subtitle {
            margin-top: 0.2rem;
            font-size: 0.72rem;
            color: #6b7280;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .teams-item small {
            font-size: 0.72rem;
            color: #8b857d;
        }

        .teams-team-tree {
            gap: 0.4rem;
        }

        .teams-team-item {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .teams-team-row {
            border: none;
            background: transparent;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            text-align: left;
            padding: 0.45rem 0.45rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            color: #1f2937;
        }

        .teams-team-row:hover {
            background: #f0f4fb;
        }

        .teams-team-row.active {
            background: #eaf1ff;
        }

        .teams-team-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: #e7eef7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
            color: #3b82f6;
            flex-shrink: 0;
        }

        .teams-team-name {
            font-weight: 600;
        }

        .teams-channel-list {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-left: 2.2rem;
            padding-left: 0.3rem;
            border-left: 1px solid #e6e7eb;
        }

        .teams-channel-item {
            border: none;
            background: transparent;
            text-align: left;
            font-size: 0.78rem;
            color: #4b5563;
            padding: 0.35rem 0.45rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .teams-channel-item:hover {
            background: #f0f4fb;
        }

        .teams-channel-item.active {
            background: #eaf1ff;
            color: #1f2937;
            font-weight: 600;
        }

        .teams-channel-hash {
            color: #9aa0a6;
            font-weight: 700;
        }

        .teams-item .teams-section-select {
            display: none;
        }

        .teams-item:hover .teams-section-select,
        .teams-item:focus-within .teams-section-select,
        .teams-item.active .teams-section-select {
            display: block;
        }

        .teams-list {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            max-height: 64vh;
            overflow: auto;
            padding-right: 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .teams-list::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .teams-thread-panel {
            display: flex;
            flex-direction: column;
            gap: 0;
            min-height: 760px;
            background: #ffffff;
            padding: 0;
            overflow: hidden;
        }

        .teams-thread-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            border-bottom: 1px solid #e6e7eb;
            padding: 1rem 1.5rem;
            background: #ffffff;
        }

        .teams-thread-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .teams-thread-title {
            font-weight: 600;
            font-size: 1.05rem;
        }

        .teams-thread-meta {
            font-size: 0.8rem;
            color: #9aa0a6;
            margin-top: 0.15rem;
        }

        .teams-thread-tabs {
            display: flex;
            gap: 1rem;
            margin-top: 0.6rem;
            align-items: center;
        }

        .teams-thread-tab {
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0 0 0.35rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .teams-thread-tab.active {
            color: #1f2937;
            border-bottom-color: #3b82f6;
        }

        .teams-thread {
            flex: 1 1 auto;
            overflow: auto;
            display: flex;
            flex-direction: column;
            gap: 0.9rem;
            padding: 1.25rem 1.5rem;
            background: #f9fafb;
            border-bottom: 1px solid #e6e7eb;
        }

        .teams-inline-preview {
            border-bottom: 1px solid #e6e7eb;
            background: #ffffff;
        }

        .teams-message-row {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            position: relative;
        }

        .teams-message-row.me {
            justify-content: flex-end;
            flex-direction: row-reverse;
        }

        .teams-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: #ffffff;
        }

        .teams-message-bubble {
            background: #ffffff;
            border: 1px solid #e6e7eb;
            border-radius: 16px;
            padding: 0.8rem 1rem;
            max-width: 75%;
            position: relative;
            box-shadow: 0 6px 12px rgba(15, 23, 42, 0.04);
        }

        .teams-message-bubble.me {
            background: #fff1e6;
            border-color: #f3c4a4;
        }

        .teams-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: #9aa0a6;
            margin-bottom: 0.35rem;
            gap: 0.5rem;
        }

        .teams-message-author {
            font-weight: 600;
        }

        .teams-message-time {
            font-size: 0.7rem;
            color: #9aa0a6;
        }

        .teams-message-body {
            font-size: 0.88rem;
            color: #1c1c1c;
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .teams-attachments {
            margin-top: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .teams-attachment {
            border: 1px solid #edd8c7;
            background: #fff7f0;
            color: #b2542d;
            padding: 0.35rem 0.6rem;
            border-radius: 999px;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .teams-composer {
            border-top: 1px solid #e6e7eb;
            padding: 1rem 1.5rem;
            display: flex;
            gap: 0.75rem;
            background: #f1f3f6;
        }

        .teams-composer input {
            flex: 1 1 auto;
            border: 1px solid #e6e7eb;
            border-radius: 16px;
            padding: 0.85rem 1rem;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.9rem;
            background: #ffffff;
        }

        .teams-message-actions {
            display: none;
            gap: 0.4rem;
            margin-top: 0.35rem;
            justify-content: flex-end;
        }

        .teams-message-row:hover .teams-message-actions {
            display: flex;
        }

        .teams-message-bubble.me .teams-message-actions {
            justify-content: flex-start;
        }

        .teams-action-btn {
            border: none;
            background: #eef0f3;
            padding: 0.25rem 0.4rem;
            cursor: pointer;
            font-size: 0.9rem;
            border-radius: 8px;
        }

        .teams-emoji-picker {
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 0.5rem;
            display: flex;
            gap: 0.3rem;
            padding: 0.4rem;
            background: #ffffff;
            border: 1px solid #e6e7eb;
            border-radius: 12px;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
            z-index: 10;
        }

        .teams-message-bubble.me .teams-emoji-picker {
            right: auto;
            left: 0;
        }

        .teams-emoji-picker button {
            border: none;
            background: transparent;
            font-size: 1rem;
            cursor: pointer;
        }

        .teams-reactions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            margin-top: 0.5rem;
        }

        .teams-reaction {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            border-radius: 999px;
            border: 1px solid #e6e7eb;
            background: #f1f3f6;
            padding: 0.15rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .teams-reaction.active {
            border-color: #f3c4a4;
            background: #fff1e6;
        }

        .teams-reply-preview {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            border-top: 1px solid #e6e7eb;
            border-bottom: 1px solid #e6e7eb;
            background: #f1f3f6;
        }

        .teams-reply-text {
            flex: 1 1 auto;
        }

        .teams-reply-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #9aa0a6;
        }

        .teams-reply-author {
            font-weight: 600;
            color: #b45309;
            font-size: 0.85rem;
        }

        .teams-reply-snippet {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.15rem;
        }

        .teams-message-reply {
            font-size: 0.75rem;
            color: #b45309;
            background: #fff4e6;
            border-radius: 10px;
            padding: 0.35rem 0.5rem;
            margin-bottom: 0.5rem;
        }

        .teams-reply-close {
            border: none;
            background: transparent;
            font-size: 0.9rem;
            cursor: pointer;
            color: #9aa0a6;
        }

        .teams-preview-title {
            font-weight: 600;
            font-size: 0.85rem;
            padding: 0.9rem 1.5rem;
            border-bottom: 1px solid #e6e7eb;
            color: #6b7280;
        }

        .teams-preview-empty {
            font-size: 0.8rem;
            color: #6b7280;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.8rem;
            padding: 1.6rem 1.4rem;
            text-align: center;
        }

        .teams-preview-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: #eef0f3;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .teams-preview-icon svg {
            width: 28px;
            height: 28px;
        }

        .teams-preview-frame {
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e6e7eb;
            margin: 1rem 1.5rem;
        }

        .teams-preview-frame iframe {
            width: 100%;
            height: 360px;
            border: 0;
            background: #ffffff;
        }

        .teams-preview-actions {
            padding: 0 1.5rem 1rem;
        }

        .teams-empty {
            font-size: 0.85rem;
            color: #6b7280;
            text-align: center;
            padding: 1rem;
        }

        @media (max-width: 1200px) {
            .teams-layout {
                grid-template-columns: 1fr;
            }

            .teams-thread-panel {
                min-height: auto;
            }
        }

        @media (max-width: 1100px) {
            .reports-layout {
                grid-template-columns: 1fr;
            }

            .report-sheet {
                padding: 1.5rem;
            }

            .report-sheet-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .report-meta-item {
                grid-template-columns: 1fr;
            }
        }

        .device-list,
        .connections-container {
            display: none !important;
        }

        .report-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            flex: 1 1 auto;
        }

        .report-presets input,
        .report-presets select {
            padding: 0.4rem 0.6rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
        }

        .report-share-link {
            min-width: 240px;
            flex: 1 1 240px;
        }

        .topology-group {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid var(--border-color);
        }

        .topology-group-grid {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            backdrop-filter: blur(10px);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border: 2px solid var(--accent-cyan);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-header h2 {
            font-size: 1.5rem;
            color: var(--accent-cyan);
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .modal-close:hover {
            color: var(--accent-cyan);
        }
        
        /* Connections view */
        .connections-container {
            margin-top: 2rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-color);
        }
        
        .connection-item {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }
        
        .connection-item:hover {
            transform: translateX(10px);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }
        
        .connection-from, .connection-to {
            font-family: 'IBM Plex Mono', monospace;
        }

        .connection-arrow {
            margin: 0 1rem;
            color: var(--accent-cyan);
            font-size: 1.5rem;
        }

        .connection-path-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.35rem;
        }

        .connection-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
        }

        /* Time tracking */
        .time-tracking {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-color);
        }

        .time-layout {
            display: grid;
            grid-template-columns: minmax(320px, 1.2fr) minmax(320px, 1fr);
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        @media (max-width: 1100px) {
            .time-layout {
                grid-template-columns: 1fr;
            }
        }

        .time-panel {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .calendar-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .time-week-header,
        .time-week-grid {
            display: grid;
            grid-template-columns: 70px repeat(7, 1fr);
            gap: 0;
        }

        .time-week-header {
            margin-bottom: 0.4rem;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            overflow: hidden;
        }

        .time-header-cell {
            background: var(--panel-surface);
            border: 1px solid var(--border-color);
            border-radius: 0;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-secondary);
        }

        .time-header-cell.day-odd {
            background: var(--panel-surface-2);
        }

        .time-header-cell:last-child {
            border-right: 0;
        }

        .time-week-header > :nth-child(8n) {
            border-right: 0;
        }

        .time-header-cell strong {
            display: block;
            font-size: 0.75rem;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            margin-top: 0.15rem;
            text-transform: none;
        }

        .time-header-cell span {
            display: block;
            font-size: 0.65rem;
            color: var(--accent-primary);
            margin-top: 0.1rem;
            font-family: 'IBM Plex Mono', monospace;
        }

        .time-week-grid {
            grid-auto-rows: 28px;
            user-select: none;
            max-height: 560px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            overflow: auto;
        }

        .time-hour-cell {
            background: var(--panel-surface-2);
            border: 1px solid var(--border-color);
            border-radius: 0;
            padding: 0.35rem 0.5rem;
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
            text-align: right;
        }

        .time-slot {
            background: var(--panel-surface);
            border: 1px solid var(--border-color);
            border-radius: 0;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .time-slot.day-odd {
            background: rgba(255, 255, 255, 0.03);
        }

        .time-slot:hover {
            border-color: rgba(248, 154, 85, 0.6);
        }

        .time-slot.in-range {
            background: rgba(248, 154, 85, 0.15);
            border-color: rgba(248, 154, 85, 0.65);
        }

        .time-slot.range-start,
        .time-slot.range-end {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 1px rgba(248, 154, 85, 0.35);
        }

        .time-slot.today {
            border-color: rgba(248, 154, 85, 0.9);
        }

        .time-slot.has-entry::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 0;
            background: var(--entry-color, rgba(248, 154, 85, 0.25));
            border: 0;
            opacity: 0.85;
        }

        .time-slot.has-entry {
            border-color: transparent;
        }

        .time-slot-label {
            position: absolute;
            top: 4px;
            left: 6px;
            right: 6px;
            font-size: 0.6rem;
            color: var(--text-primary);
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            pointer-events: none;
            z-index: 1;
        }

        .time-slot.is-entry-start::after {
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
        }

        .time-slot.is-entry-end::after {
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
        }

        .time-week-grid > :nth-child(8n) {
            border-right: 0;
        }

        .time-week-grid > :nth-last-child(-n + 8) {
            border-bottom: 0;
        }

        .time-client-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .time-client-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            padding: 0.45rem 0.6rem;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--panel-surface);
            font-size: 0.75rem;
        }

        .time-client-card strong {
            font-size: 0.8rem;
        }

        .time-client-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--client-color, var(--accent-primary));
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.2);
            flex: 0 0 auto;
        }

        .time-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.6rem;
            border-radius: 999px;
            border: 1px solid rgba(248, 154, 85, 0.35);
            background: rgba(14, 22, 38, 0.6);
            color: var(--text-secondary);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
        }

        .time-toggle input {
            accent-color: var(--accent-primary);
        }

        .time-activity-manager {
            margin-top: 1rem;
        }

        .time-activity-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .time-activity-form input {
            flex: 1;
            padding: 0.5rem 0.6rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
        }

        .time-activity-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.6rem;
        }

        .time-activity-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.5rem;
            border-radius: 999px;
            background: rgba(248, 154, 85, 0.15);
            color: var(--text-primary);
            font-size: 0.7rem;
            border: 1px solid rgba(248, 154, 85, 0.4);
        }

        .time-activity-chip button {
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
        }

        .time-preset-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.5rem;
        }

        .time-preset-btn {
            border: 1px solid rgba(248, 154, 85, 0.5);
            background: rgba(248, 154, 85, 0.12);
            color: var(--text-primary);
            border-radius: 999px;
            padding: 0.2rem 0.6rem;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .time-preset-btn:hover {
            border-color: rgba(248, 154, 85, 0.85);
        }

        .time-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .summary-card {
            background: var(--panel-surface);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 0.75rem;
        }

        .summary-value {
            font-size: 1.2rem;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--accent-primary);
        }

        .summary-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .time-form {
            display: grid;
            gap: 0.75rem;
        }

        .time-form .btn {
            margin-bottom: 0;
        }

        .time-report-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .time-report-header select {
            padding: 0.4rem 0.6rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
        }

        .time-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.75rem;
            font-size: 0.8rem;
        }

        .time-table th,
        .time-table td {
            padding: 0.5rem 0.6rem;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
            font-family: 'IBM Plex Mono', monospace;
        }

        .time-table th {
            text-transform: uppercase;
            font-size: 0.65rem;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
        }
        
        
        /* Client selector */
        .client-selector-container {
            display: grid;
            gap: 0.75rem;
            align-items: center;
            margin: 0 0 1rem;
            padding: 0;
            background: transparent;
            border-radius: 0;
            border: none;
        }
        
        .client-selector {
            width: 100%;
            max-width: none;
            padding: 0.75rem;
            background: var(--panel-surface-2);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .client-selector:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(248, 154, 85, 0.35);
            border-color: rgba(248, 154, 85, 0.6);
        }
        
        .btn-small {
            padding: 0.65rem 0.95rem;
            background: linear-gradient(135deg, var(--cx-orange), #ff6a25);
            color: #101010;
            border: none;
            border-radius: 10px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            line-height: 1.2;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 22px rgba(248, 154, 85, 0.25);
        }

        .btn-small.btn-secondary {
            background: rgba(248, 154, 85, 0.08);
            border: 1px solid rgba(248, 154, 85, 0.55);
            color: var(--cx-orange);
        }

        .btn-small.btn-secondary:hover {
            background: rgba(248, 154, 85, 0.16);
            border-color: rgba(248, 154, 85, 0.75);
            box-shadow: 0 6px 18px rgba(248, 154, 85, 0.2);
        }
        
        /* Client info panel */
        .client-info {
            background: linear-gradient(135deg, rgba(16, 24, 40, 0.95), rgba(12, 18, 32, 0.9));
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .client-edit-btn {
            margin-top: 0.6rem;
        }
        
        .client-info h4 {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--cx-orange);
            margin-bottom: 0.5rem;
        }
        
        .client-info-detail {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            font-family: 'IBM Plex Mono', monospace;
        }
        
        .client-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: linear-gradient(135deg, var(--cx-orange), #ff6a25);
            color: #0b0b0b;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 0.5rem;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .no-client-warning {
            background: rgba(255, 170, 0, 0.1);
            border: 2px dashed var(--warning);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            color: var(--warning);
            margin: 2rem 0;
        }
        
        .client-list {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .client-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            padding-right: 7rem;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .client-card:hover {
            border-color: var(--accent-cyan);
            transform: translateX(5px);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }
        
        .client-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .client-card-name {
            font-weight: 600;
            color: var(--accent-cyan);
            font-family: 'IBM Plex Mono', monospace;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .client-card-stats {
            display: flex;
            gap: 1.5rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            align-items: center;
            flex-wrap: wrap;
        }
        
        
        .client-card-pricing {
            margin-top: 0.4rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .client-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .clients-view {
            display: grid;
            grid-template-columns: minmax(240px, 320px) minmax(0, 1fr);
            gap: 1.5rem;
            min-height: 0;
        }

        .clients-list-panel {
            background: var(--panel-surface);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            padding: 1.25rem;
            display: grid;
            grid-template-rows: auto auto 1fr;
            gap: 1rem;
            min-height: 0;
        }

        .clients-list-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .clients-list-head h2 {
            margin: 0;
            font-size: 1.2rem;
        }

        .clients-list-count {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: var(--text-secondary);
            margin-top: 0.2rem;
        }

        .clients-search input {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--panel-surface-2);
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
        }

        .clients-search input:focus {
            outline: none;
            border-color: rgba(248, 154, 85, 0.6);
            box-shadow: 0 0 0 2px rgba(248, 154, 85, 0.15);
        }

        .client-list {
            overflow-y: auto;
            padding-right: 0.35rem;
            margin-right: -0.35rem;
        }

        .client-card.is-active {
            border-color: rgba(248, 154, 85, 0.6);
            box-shadow: 0 0 0 1px rgba(248, 154, 85, 0.2);
        }

        .client-detail-panel {
            background: var(--panel-surface);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-height: 0;
            overflow: hidden;
        }

        .client-detail-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1.5rem;
        }

        .client-detail-title {
            font-size: 1.6rem;
            font-weight: 600;
        }

        .client-detail-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.35rem;
        }

        .client-detail-actions {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
        }

        .client-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
        }

        .client-detail-card {
            background: var(--panel-surface-2);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 1rem;
            display: grid;
            gap: 0.6rem;
        }

        .client-detail-card h3 {
            margin: 0;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-secondary);
        }

        .client-detail-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            font-size: 0.9rem;
        }

        .client-detail-row span {
            color: var(--text-secondary);
        }

        .client-detail-row strong {
            font-weight: 600;
        }

        .client-detail-notes {
            display: block;
            color: var(--text-secondary);
            line-height: 1.5;
            white-space: pre-line;
        }

        .client-color-chip {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--client-color, #f89a55);
            display: inline-block;
            margin-right: 0.4rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .client-detail-chart {
            background: var(--panel-surface-2);
            border: 1px dashed rgba(255, 255, 255, 0.18);
            border-radius: 16px;
            padding: 1.25rem;
        }

        .client-detail-chart-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }

        .client-detail-chart-placeholder {
            height: 160px;
            border-radius: 12px;
            background: linear-gradient(120deg, rgba(248, 154, 85, 0.12), rgba(255, 255, 255, 0.04));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .client-form-panel {
            background: var(--panel-surface-2);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            padding: 1.5rem;
            display: grid;
            gap: 1.5rem;
            overflow-y: auto;
        }

        .client-form-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
        }

        .client-form-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .client-form-subtitle {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .client-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.25rem;
        }

        .client-form-section {
            background: rgba(10, 16, 28, 0.65);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            padding: 1rem;
            display: grid;
            gap: 0.75rem;
        }

        .client-form-section-wide {
            grid-column: 1 / -1;
        }

        .client-form-section h3 {
            margin: 0;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-secondary);
        }

        .client-form-fields .form-group {
            margin-bottom: 0.75rem;
        }

        .client-form-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        @media (max-width: 1100px) {
            .clients-view {
                grid-template-columns: 1fr;
            }
        }
        
        .btn-icon {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            height: 30px;
            min-width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0 0.35rem;
        }
        
        .btn-icon:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }
        
        .btn-icon.danger:hover {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Network Visualization */
        .view-toggle {
            display: none;
        }
        
        .view-toggle-btn {
            text-align: left;
            width: 100%;
            padding: 0.75rem 0.9rem;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--panel-surface);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        
        .view-toggle-btn.active {
            border-color: var(--cx-orange);
            box-shadow: 0 0 0 1px rgba(248, 154, 85, 0.4);
            background: linear-gradient(135deg, rgba(248, 154, 85, 0.25), rgba(20, 20, 20, 0.8));
        }
        
        .view-toggle-btn:hover:not(.active) {
            transform: translateX(6px);
            border-color: rgba(248, 154, 85, 0.5);
        }
        
        /* Network Map Container */
        .network-map {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
            min-height: 500px;
            position: relative;
            overflow: hidden;
        }
        
        #networkCanvas {
            width: 100%;
            height: 500px;
            cursor: grab;
        }
        
        #networkCanvas:active {
            cursor: grabbing;
        }
        
        /* Port Management */
        .port-details-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .port-details-overlay.active {
            display: flex;
            animation: fadeIn 0.3s;
        }
        
        .port-details-container {
            background: var(--bg-secondary);
            border: 2px solid var(--accent-cyan);
            border-radius: 12px;
            padding: 2rem;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }
        
        .port-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .port-details-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-cyan);
            font-family: 'IBM Plex Mono', monospace;
        }
        
        .port-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .port-hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }

        .port-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .port-filter-input {
            flex: 1 1 200px;
            padding: 0.5rem 0.6rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
        }

        .port-device-select {
            min-width: 220px;
            padding: 0.5rem 0.6rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
        }

        .port-filter-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .port-filter-toggle input {
            accent-color: var(--accent-primary);
        }
        
        .port-item {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .port-item:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        .port-item.pending {
            border-color: var(--warning);
            box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.35);
        }

        .port-item.connected {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 255, 136, 0.05));
        }
        
        .port-item.connected::after {
            content: '';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .port-item.trunk {
            border-color: var(--accent-magenta);
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.1), rgba(255, 0, 255, 0.05));
        }
        
        .port-item.uplink {
            border-color: var(--accent-cyan);
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(0, 255, 255, 0.05));
        }

        .port-item.conflict {
            border-color: var(--danger);
            box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.35);
        }
        
        .port-item.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .port-number {
            font-size: 0.75rem;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-primary);
        }
        
        .port-label {
            font-size: 0.625rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Connection Lines */
        .connection-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-magenta));
            transform-origin: left center;
            pointer-events: none;
            z-index: 1;
            opacity: 0.6;
            animation: flowAnimation 3s linear infinite;
        }
        
        @keyframes flowAnimation {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 100% 50%;
            }
        }
        
        .connection-line.active {
            opacity: 1;
            box-shadow: 0 0 10px var(--accent-cyan);
        }
        
        /* Port configuration modal */
        .port-config-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .port-config-form .form-group {
            margin-bottom: 0;
        }
        
        .port-config-form .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        /* VLAN tags */
        .vlan-tag {
            display: inline-block;
            padding: 0.125rem 0.375rem;
            background: rgba(255, 255, 0, 0.2);
            color: var(--accent-yellow);
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 600;
            margin-right: 0.25rem;
        }
        
        /* Connection path visualization */
        .connection-path {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 1rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
        }
        
        .connection-path-device {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
            color: var(--bg-primary);
            border-radius: 6px;
            font-weight: 600;
        }
        
        .connection-path-arrow {
            margin: 0 1rem;
            color: var(--accent-cyan);
        }
        
        .connection-path-port {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }
        
        /* Network stats */
        .network-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .network-stat-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }
        
        .network-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .network-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 0.25rem;
        }

        /* Helpdesk view */
        #helpdeskView {
            background: #f8f7f4;
            border: none;
            padding: 1.25rem;
            border-radius: 20px;
            color: #1c1c1c;
        }

        #helpdeskView .rack-header {
            margin-bottom: 1rem;
            background: #ffffff;
            border: 1px solid #e6e7eb;
            border-radius: 16px;
            padding: 1rem 1.4rem;
            gap: 1rem;
            flex-wrap: wrap;
            box-shadow: 0 8px 18px rgba(17, 24, 39, 0.05);
        }

        .helpdesk-subtitle {
            margin-top: 0.25rem;
            font-size: 0.9rem;
            color: #6b7280;
            max-width: 560px;
        }

        .helpdesk-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
            align-items: center;
        }

        .helpdesk-layout {
            display: grid;
            grid-template-columns: 260px minmax(0, 1fr) 360px;
            gap: 0.9rem;
            align-items: start;
            width: 100%;
        }

        .helpdesk-panel {
            background: #ffffff;
            border: 1px solid #e6e7eb;
            border-radius: 14px;
            padding: 1rem;
            min-height: 200px;
        }

        .helpdesk-panel-title {
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: #6b7280;
            margin-bottom: 0.6rem;
            font-weight: 600;
        }

        .helpdesk-panel-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 0.85rem 0;
        }

        .helpdesk-queue-list {
            display: grid;
            gap: 0.45rem;
        }

        .helpdesk-queue-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            padding: 0.55rem 0.75rem;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            background: #f3f4f6;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #1f2937;
        }

        .helpdesk-queue-item:hover {
            border-color: rgba(248, 154, 85, 0.5);
        }

        .helpdesk-queue-item.active {
            border-color: rgba(248, 154, 85, 0.9);
            background: #fff7ed;
            color: #b45309;
        }

        .helpdesk-queue-count {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 700;
            color: inherit;
        }

        .helpdesk-filter-group {
            display: grid;
            gap: 0.35rem;
            margin-bottom: 0.65rem;
        }

        .helpdesk-filter-group label {
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #6b7280;
        }

        .helpdesk-filter-group select,
        .helpdesk-filter-group input,
        .helpdesk-filter-group textarea {
            width: 100%;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            color: #1f2937;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.85rem;
            padding: 0.55rem 0.65rem;
        }

        .helpdesk-integration-list {
            display: grid;
            gap: 0.5rem;
        }

        .helpdesk-integration-card {
            border: 1px dashed #d1d5db;
            border-radius: 12px;
            padding: 0.6rem 0.75rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #6b7280;
            background: #f8fafc;
        }

        .helpdesk-panel-note {
            margin-top: 0.65rem;
            font-size: 0.78rem;
            color: #6b7280;
            line-height: 1.5;
        }

        .helpdesk-list-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .helpdesk-list-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .helpdesk-list-actions select {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.8rem;
            padding: 0.4rem 0.6rem;
            font-family: 'Space Grotesk', sans-serif;
        }

        .helpdesk-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.6rem;
            margin-bottom: 0.75rem;
        }

        .helpdesk-metric {
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 0.65rem 0.75rem;
            background: #f8fafc;
        }

        .helpdesk-metric-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #111827;
        }

        .helpdesk-metric-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .helpdesk-ticket-list {
            display: grid;
            gap: 0.65rem;
        }

        .helpdesk-ticket-card {
            border: 1px solid #e5e7eb;
            border-radius: 14px;
            padding: 0.75rem 0.85rem;
            background: #ffffff;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .helpdesk-ticket-card:hover {
            border-color: rgba(248, 154, 85, 0.5);
        }

        .helpdesk-ticket-card.active {
            border-color: rgba(248, 154, 85, 0.9);
            box-shadow: 0 12px 18px rgba(248, 154, 85, 0.15);
        }

        .helpdesk-ticket-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.3rem;
            color: #111827;
        }

        .helpdesk-ticket-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.45rem;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .helpdesk-ticket-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            margin-top: 0.45rem;
        }

        .helpdesk-tag {
            font-size: 0.65rem;
            padding: 0.15rem 0.45rem;
            border-radius: 999px;
            background: #f3f4f6;
            color: #4b5563;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .helpdesk-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.2rem 0.5rem;
            border-radius: 999px;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 700;
        }

        .helpdesk-badge.status-open {
            background: rgba(59, 130, 246, 0.15);
            color: #1d4ed8;
        }

        .helpdesk-badge.status-progress {
            background: rgba(14, 165, 233, 0.15);
            color: #0369a1;
        }

        .helpdesk-badge.status-waiting {
            background: rgba(249, 115, 22, 0.15);
            color: #c2410c;
        }

        .helpdesk-badge.status-resolved {
            background: rgba(34, 197, 94, 0.15);
            color: #15803d;
        }

        .helpdesk-badge.status-closed {
            background: rgba(100, 116, 139, 0.2);
            color: #475569;
        }

        .helpdesk-badge.priority-low {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
        }

        .helpdesk-badge.priority-medium {
            background: rgba(59, 130, 246, 0.15);
            color: #1d4ed8;
        }

        .helpdesk-badge.priority-high {
            background: rgba(249, 115, 22, 0.15);
            color: #c2410c;
        }

        .helpdesk-badge.priority-urgent {
            background: rgba(239, 68, 68, 0.15);
            color: #b91c1c;
        }

        .helpdesk-detail-body {
            display: grid;
            gap: 0.85rem;
        }

        .helpdesk-detail-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #111827;
        }

        .helpdesk-detail-subtitle {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #6b7280;
        }

        .helpdesk-detail-meta {
            display: grid;
            gap: 0.35rem;
            font-size: 0.85rem;
            color: #4b5563;
        }

        .helpdesk-detail-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .helpdesk-detail-section {
            border-top: 1px solid #e5e7eb;
            padding-top: 0.75rem;
        }

        .helpdesk-detail-section p {
            font-size: 0.85rem;
            color: #4b5563;
            line-height: 1.6;
        }

        .helpdesk-external-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: #4b5563;
        }

        .helpdesk-external-row span {
            font-weight: 600;
        }

        .helpdesk-empty {
            border: 1px dashed #e5e7eb;
            border-radius: 14px;
            padding: 1.5rem;
            text-align: center;
            color: #6b7280;
            background: #f9fafb;
        }

        @media (max-width: 1200px) {
            .helpdesk-layout {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        @media (max-width: 720px) {
            #helpdeskView {
                padding: 1rem;
            }

            #helpdeskView .rack-header {
                padding: 0.85rem 1rem;
            }
        }

        /* Computers view */
        #computersView {
            background: #f7f7f9;
            border: none;
            padding: 1.25rem;
            border-radius: 20px;
            color: #1c1c1c;
        }

        #computersView .rack-header {
            margin-bottom: 1rem;
            background: #ffffff;
            border: 1px solid #e6e7eb;
            border-radius: 16px;
            padding: 1rem 1.4rem;
            gap: 1rem;
            flex-wrap: wrap;
            box-shadow: 0 8px 18px rgba(17, 24, 39, 0.05);
        }

        .computers-subtitle {
            margin-top: 0.25rem;
            font-size: 0.9rem;
            color: #6b7280;
            max-width: 560px;
        }

        .computers-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
            align-items: center;
        }

        .computers-sync {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .computers-layout {
            display: grid;
            grid-template-columns: 260px minmax(0, 1fr);
            gap: 0.9rem;
            align-items: start;
            width: 100%;
        }

        .computers-panel {
            background: #ffffff;
            border: 1px solid #e6e7eb;
            border-radius: 14px;
            padding: 1rem;
            min-height: 200px;
        }

        .computers-panel-title {
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: #6b7280;
            margin-bottom: 0.6rem;
            font-weight: 600;
        }

        .computers-filter-group {
            display: grid;
            gap: 0.35rem;
            margin-bottom: 0.65rem;
        }

        .computers-filter-group label {
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #6b7280;
        }

        .computers-filter-group select,
        .computers-filter-group input {
            width: 100%;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            color: #1f2937;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.85rem;
            padding: 0.55rem 0.65rem;
        }

        .computers-list-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .computers-list-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .computers-list-actions select {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.8rem;
            padding: 0.4rem 0.6rem;
            font-family: 'Space Grotesk', sans-serif;
        }

        .computers-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.6rem;
            margin-bottom: 0.75rem;
        }

        .computers-metric {
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 0.65rem 0.75rem;
            background: #f8fafc;
        }

        .computers-metric-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #111827;
        }

        .computers-metric-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .computers-list {
            display: grid;
            gap: 0.65rem;
        }

        .computer-card {
            border: 1px solid #e5e7eb;
            border-radius: 14px;
            padding: 0.75rem 0.85rem;
            background: #ffffff;
        }

        .computer-card-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 0.35rem;
        }

        .computer-name {
            font-weight: 600;
            font-size: 1rem;
            color: #111827;
        }

        .computer-client {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .computer-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.45rem;
            font-size: 0.75rem;
            color: #6b7280;
            line-height: 1.4;
        }

        .computer-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.45rem;
        }

        .computer-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.2rem 0.5rem;
            border-radius: 999px;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 700;
        }

        .computer-badge.type-server {
            background: rgba(59, 130, 246, 0.15);
            color: #1d4ed8;
        }

        .computer-badge.type-pc {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
        }

        .computer-badge.type-other {
            background: rgba(107, 114, 128, 0.2);
            color: #4b5563;
        }

        .computer-badge.status-online {
            background: rgba(34, 197, 94, 0.15);
            color: #15803d;
        }

        .computer-badge.status-offline {
            background: rgba(239, 68, 68, 0.15);
            color: #b91c1c;
        }

        .computer-badge.status-unknown {
            background: rgba(148, 163, 184, 0.2);
            color: #64748b;
        }

        .computers-empty {
            border: 1px dashed #e5e7eb;
            border-radius: 14px;
            padding: 1.5rem;
            text-align: center;
            color: #6b7280;
            background: #f9fafb;
        }

        @media (max-width: 1100px) {
            .computers-layout {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        @media (max-width: 720px) {
            #computersView {
                padding: 1rem;
            }

            #computersView .rack-header {
                padding: 0.85rem 1rem;
            }
        }
    </style>
</head>


<body class="auth-locked">
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-card">
            <h2>Prihlaseni</h2>
            <p>Pro pristup do MSP konzole se prihlaste pres Google nebo Microsoft ucet.</p>
            <div class="auth-stack">
                <button class="btn" onclick="loginWithGoogle()">Prihlasit pres Google</button>
                <button class="btn btn-secondary" id="loginMicrosoftOverlayBtn" onclick="loginWithMicrosoft()">Prihlasit pres Microsoft 365</button>
                <input type="email" id="emailLoginInput" placeholder="email@firma.cz">
                <button class="btn btn-secondary" onclick="sendMagicLink()">Poslat magic link</button>
                <div class="auth-hint">Magic link prijde na e-mail.</div>
                <button class="btn btn-secondary" id="localAdminBtn" onclick="enableLocalAdmin()" style="display: none;">Lokalni admin</button>
            </div>
        </div>
    </div>
    <div class="app-shell">
            <aside class="sidebar">
        <button class="sidebar-brand" type="button" onclick="switchView('dashboard')">
            <div class="brand-title"><span class="cx">CX</span><span class="dot">.</span><span class="tech">TECH</span></div>
            <div class="brand-subtitle">Rack Manager - MSP Console</div>
        </button>

        <div class="sidebar-scroll">
            <div class="sidebar-section" data-section="client">
                <button class="sidebar-section-title" type="button" onclick="toggleSidebarSection(this)">
                    <span class="sidebar-section-label">
                        <svg class="sidebar-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <circle cx="12" cy="8" r="4"></circle>
                            <path d="M4 20c2.5-4 13.5-4 16 0"></path>
                        </svg>
                        <span>Klient</span>
                    </span>
                    <span class="sidebar-section-toggle" aria-hidden="true"></span>
                </button>
                <div class="sidebar-section-body">
                    <div class="client-selector-container">
                        <select id="clientSelector" class="client-selector" onchange="switchClient()">
                            <option value="">-- Vyberte klienta --</option>
                        </select>
                        <button class="btn-small" data-client-form-trigger="true" onclick="openClientModal()">+ Novy klient</button>
                        <button class="btn-small btn-secondary" type="button" onclick="openClientManagerModal()">Seznam klientu</button>
                    </div>
                    <div class="client-info" id="clientInfo" style="display: none;">
                        <h4>Aktivni klient</h4>
                        <div class="client-info-detail" id="clientName"></div>
                        <div class="client-info-detail" id="userRole"></div>
                        <div class="client-info-detail" id="clientContact"></div>
                        <div class="client-info-detail" id="clientLocation"></div>
                        <div class="client-info-detail" id="clientPricing"></div>
                        <div style="margin-top: 0.5rem;">
                            <span class="client-badge" id="clientType"></span>
                        </div>
                        <button class="btn-small client-edit-btn" data-client-form-trigger="true" type="button" onclick="openClientModal(currentClientId)">Upravit klienta</button>
                    </div>
                </div>
            </div>

            <div class="sidebar-section" data-section="network">
                <button class="sidebar-section-title" type="button" onclick="toggleSidebarSection(this)">
                    <span class="sidebar-section-label">
                        <svg class="sidebar-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <circle cx="6" cy="12" r="2"></circle>
                            <circle cx="18" cy="6" r="2"></circle>
                            <circle cx="18" cy="18" r="2"></circle>
                            <path d="M8 12h8"></path>
                            <path d="M16 7l-4 3"></path>
                            <path d="M16 17l-4-3"></path>
                        </svg>
                        <span>Sit</span>
                    </span>
                    <span class="sidebar-section-toggle" aria-hidden="true"></span>
                </button>
                <div class="sidebar-section-body">
                    <div class="sidebar-nav sidebar-nav-nested">
                        <button class="view-toggle-btn nav-btn nav-btn-nested active" data-view="racks" onclick="switchView('racks', this)">Racky</button>
                        <button class="view-toggle-btn nav-btn nav-btn-nested" data-view="network" onclick="switchView('network', this)">Sitova mapa</button>
                        <button class="view-toggle-btn nav-btn nav-btn-nested" data-view="topology" onclick="switchView('topology', this)">Topologie</button>
                        <button class="view-toggle-btn nav-btn nav-btn-nested" data-view="overview" onclick="switchView('overview', this)">Prehled klienta</button>
                    </div>
                    <div class="sidebar-subsection">
                        <div class="sidebar-subtitle">Sprava site</div>
                        <div class="sidebar-actions">
                            <button class="sidebar-action-btn" onclick="openRackModal()" id="addRackBtn" disabled>Novy rack</button>
                            <button class="sidebar-action-btn" onclick="clearAllRacks()" id="clearRacksBtn" disabled>Vymazat racky</button>
                            <button class="sidebar-action-btn" onclick="openDeviceModal()" id="addDeviceBtn" disabled>Nove zarizeni</button>
                            <button class="sidebar-action-btn" onclick="openConnectionModal()" id="addConnectionBtn" disabled>Nove propojeni</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-section" data-section="computers">
                <button class="sidebar-section-title" type="button" onclick="toggleSidebarSection(this)">
                    <span class="sidebar-section-label">
                        <svg class="sidebar-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <rect x="3" y="4" width="18" height="12" rx="2"></rect>
                            <path d="M7 20h10"></path>
                            <path d="M9 16v4"></path>
                            <path d="M15 16v4"></path>
                        </svg>
                        <span>Pocitace</span>
                    </span>
                    <span class="sidebar-section-toggle" aria-hidden="true"></span>
                </button>
                <div class="sidebar-section-body">
                    <div class="sidebar-nav">
                        <button class="view-toggle-btn nav-btn" data-view="computers" onclick="switchView('computers', this)">Pocitace</button>
                    </div>
                </div>
            </div>

            <div class="sidebar-section" data-section="time">
                <button class="sidebar-section-title" type="button" onclick="toggleSidebarSection(this)">
                    <span class="sidebar-section-label">
                        <svg class="sidebar-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <circle cx="12" cy="12" r="8"></circle>
                            <path d="M12 8v5l3 2"></path>
                        </svg>
                        <span>Vykazovani</span>
                    </span>
                    <span class="sidebar-section-toggle" aria-hidden="true"></span>
                </button>
                <div class="sidebar-section-body">
                    <div class="sidebar-nav">
                        <button class="view-toggle-btn nav-btn" data-view="time" onclick="switchView('time', this)">Vykazovani</button>
                    </div>
                </div>
            </div>

            <div class="sidebar-section" data-section="reports">
                <button class="sidebar-section-title" type="button" onclick="toggleSidebarSection(this)">
                    <span class="sidebar-section-label">
                        <svg class="sidebar-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <rect x="6" y="4" width="12" height="16" rx="2"></rect>
                            <path d="M9 8h6"></path>
                            <path d="M9 12h6"></path>
                            <path d="M9 16h4"></path>
                        </svg>
                        <span>Reporty</span>
                    </span>
                    <span class="sidebar-section-toggle" aria-hidden="true"></span>
                </button>
                <div class="sidebar-section-body">
                    <div class="sidebar-nav">
                        <button class="view-toggle-btn nav-btn" data-view="reports" onclick="switchView('reports', this)">Reporty</button>
                    </div>
                </div>
            </div>

            <div class="sidebar-section collapsed" data-section="helpdesk">
                <button class="sidebar-section-title" type="button" onclick="toggleSidebarSection(this)">
                    <span class="sidebar-section-label">
                        <svg class="sidebar-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M3 13V6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v7"></path>
                            <path d="M3 13h5l2 3h4l2-3h5"></path>
                        </svg>
                        <span>Helpdesk</span>
                    </span>
                    <span class="sidebar-section-toggle" aria-hidden="true"></span>
                </button>
                <div class="sidebar-section-body">
                    <div class="sidebar-nav">
                        <button class="view-toggle-btn nav-btn" data-view="helpdesk" onclick="switchView('helpdesk', this)">Helpdesk</button>
                    </div>
                </div>
            </div>

            <div class="sidebar-section collapsed" data-section="teams">
                <button class="sidebar-section-title" type="button" onclick="toggleSidebarSection(this)">
                    <span class="sidebar-section-label">
                        <svg class="sidebar-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"></path>
                        </svg>
                        <span>Teams</span>
                    </span>
                    <span class="sidebar-section-toggle" aria-hidden="true"></span>
                </button>
                <div class="sidebar-section-body">
                    <div class="sidebar-nav">
                        <button class="view-toggle-btn nav-btn" data-view="teams" onclick="switchView('teams', this)">Teams hub</button>
                    </div>
                </div>
            </div>

            <div class="sidebar-section collapsed" data-section="admin">
                <button class="sidebar-section-title" type="button" onclick="toggleSidebarSection(this)">
                    <span class="sidebar-section-label">
                        <svg class="sidebar-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M12 3l7 4v5c0 5-3.5 9-7 11-3.5-2-7-6-7-11V7l7-4z"></path>
                            <path d="M12 7v6"></path>
                        </svg>
                        <span>Admin</span>
                    </span>
                    <span class="sidebar-section-toggle" aria-hidden="true"></span>
                </button>
                <div class="sidebar-section-body">
                    <div class="sidebar-actions">
                        <button class="sidebar-action-btn" onclick="openClientManagerModal()">Sprava klientu</button>
                        <button class="sidebar-action-btn" id="userManagerBtn" onclick="openRoleManagerModal()">Sprava uzivatelu</button>
                        <button class="sidebar-action-btn" id="roleManagerBtn" onclick="openRoleManagerModal()">Sprava roli</button>
                        <button class="sidebar-action-btn" id="m365ManagerBtn" onclick="openM365Modal()">M365 nastaveni</button>
                        <button class="sidebar-action-btn" onclick="openModuleModal()">Kategorie zarizeni</button>
                    </div>
                </div>
            </div>

            <div class="sidebar-section collapsed" data-section="modules">
                <button class="sidebar-section-title" type="button" onclick="toggleSidebarSection(this)">
                    <span class="sidebar-section-label">
                        <svg class="sidebar-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <rect x="4" y="4" width="6" height="6" rx="1"></rect>
                            <rect x="14" y="4" width="6" height="6" rx="1"></rect>
                            <rect x="4" y="14" width="6" height="6" rx="1"></rect>
                            <rect x="14" y="14" width="6" height="6" rx="1"></rect>
                        </svg>
                        <span>Moduly</span>
                    </span>
                    <span class="sidebar-section-toggle" aria-hidden="true"></span>
                </button>
                <div class="sidebar-section-body">
                    <div class="sidebar-module-list">
                        <div class="sidebar-module"><span>Monitoring</span><span class="sidebar-module-tag">soon</span></div>
                        <div class="sidebar-module"><span>Automatizace</span><span class="sidebar-module-tag">soon</span></div>
                        <div class="sidebar-module"><span>SLA a finance</span><span class="sidebar-module-tag">soon</span></div>
                    </div>
                </div>
            </div>

            <div class="sidebar-section collapsed" data-section="stats">
                <button class="sidebar-section-title" type="button" onclick="toggleSidebarSection(this)">
                    <span class="sidebar-section-label">
                        <svg class="sidebar-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M5 19V10"></path>
                            <path d="M12 19V5"></path>
                            <path d="M19 19v-7"></path>
                        </svg>
                        <span>Statistiky</span>
                    </span>
                    <span class="sidebar-section-toggle" aria-hidden="true"></span>
                </button>
                <div class="sidebar-section-body">
                    <div class="stat">
                        <div class="stat-value" id="totalDevices">0</div>
                        <div class="stat-label">Celkem zarizeni</div>
                    </div>
                    <div class="stat" style="margin-top: 1rem;">
                        <div class="stat-value" id="totalRacks">0</div>
                        <div class="stat-label">Celkem racku</div>
                    </div>
                </div>
            </div>
        </div>
    </aside>

        <main class="main-content">
            <div class="topbar topbar-compact">
                <div class="topbar-user">
                    <button class="user-menu-btn" id="userMenuBtn" onclick="toggleUserMenu()" aria-label="Uzivatelske nastaveni" type="button">
                        <span class="user-menu-avatar" id="userMenuAvatar">NA</span>
                        <span class="user-menu-logout" id="userMenuLogout" onclick="logout(); closeUserMenu(); event.stopPropagation();" title="Odhlasit" aria-label="Odhlasit"></span>
                    </button>
                    <div class="user-menu-panel" id="userMenuPanel">
                        <div class="user-menu-title">Ucet</div>
                        <div class="user-menu-status">
                            <span class="status-dot" aria-hidden="true"></span>
                            <div id="authStatus" class="auth-status">Neprihlasen</div>
                        </div>
                        <div class="user-menu-actions">
                            <button class="btn-small" id="loginBtn" onclick="loginWithGoogle(); closeUserMenu()">Prihlasit</button>
                            <button class="btn-small btn-secondary" id="loginMicrosoftBtn" onclick="loginWithMicrosoft(); closeUserMenu()">Microsoft 365</button>
                            <button class="btn btn-secondary" id="logoutBtn" onclick="logout(); closeUserMenu()" style="display: none;">Odhlasit</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="main-scroll">
            <div id="dashboardView" class="rack-container dashboard-view" style="display: none;">
                <div class="dashboard-shell">
                    <section class="dashboard-hero-card">
                        <div class="dashboard-hero-content">
                            <div class="dashboard-hero-kicker" id="dashboardHeroKicker">CX.TECH MSP</div>
                            <h2 class="dashboard-hero-title" id="dashboardHeroTitle">Operations Canvas</h2>
                            <p class="dashboard-hero-subtitle" id="dashboardHeroSubtitle">Prehled vykazu, kapacit a pracovniho nasazeni napric klienty.</p>
                            <div class="dashboard-hero-metrics" id="dashboardHeroMetrics">
                                <div class="dashboard-metric">
                                    <div class="dashboard-metric-label">Role</div>
                                    <div class="dashboard-metric-value" id="dashboardRole">-</div>
                                </div>
                                <div class="dashboard-metric">
                                    <div class="dashboard-metric-label">Aktivni klient</div>
                                    <div class="dashboard-metric-value" id="dashboardClient">-</div>
                                </div>
                                <div class="dashboard-metric">
                                    <div class="dashboard-metric-label">Typ klienta</div>
                                    <div class="dashboard-metric-value" id="dashboardType">-</div>
                                </div>
                            </div>
                            <div class="dashboard-hours-chart" id="dashboardHoursChart">
                                <div class="dashboard-hours-title">Hodiny po dnech</div>
                                <div class="dashboard-hours-grid" id="dashboardHoursGrid"></div>
                            </div>
                        </div>
                        <div class="dashboard-time-panel">
                            <div class="dashboard-time-title">Vykazovani za mesic</div>
                            <div class="dashboard-time-filter" id="dashboardTechFilter">
                                <label for="dashboardTechSelect">Technik</label>
                                <select id="dashboardTechSelect" onchange="loadDashboardTimeOverview()"></select>
                            </div>
                            <div class="dashboard-time-total" id="dashboardMonthTotal">-</div>
                            <div class="dashboard-time-progress">
                                <span id="dashboardMonthProgress"></span>
                            </div>
                            <div class="dashboard-time-remaining" id="dashboardMonthRemaining">Zbyva do HPP: - h</div>
                            <div class="dashboard-category-list" id="dashboardCategoryList"></div>
                            <div class="dashboard-time-divider"></div>
                            <div class="dashboard-time-subtitle" id="dashboardTechTitle">Technici</div>
                            <div class="dashboard-tech-list" id="dashboardTechHours"></div>
                        </div>
                    </section>
                </div>

                <div class="dashboard-body">
                    <details class="dashboard-section">
                        <summary class="dashboard-section-head">
                            <div>
                                <div class="dashboard-section-title">ERP cockpit</div>
                                <div class="dashboard-section-subtitle">Zjednoduseny prehled pro finance, lidi a provoz.</div>
                            </div>
                            <span class="dashboard-section-toggle">v</span>
                        </summary>
                        <div class="dashboard-section-body">
                        <div class="erp-summary-grid">
                            <div class="erp-summary-card">
                                <div class="erp-summary-title">Fakturace</div>
                                <div class="erp-summary-value">Pripraveno</div>
                                <div class="erp-summary-meta">Napojeni na faktury, smlouvy a SLA.</div>
                                <ul class="erp-summary-list">
                                    <li><span>Navrhy faktur</span><strong>0</strong></li>
                                    <li><span>Pripraveno k vystaveni</span><strong>0</strong></li>
                                    <li><span>Neuhrazene</span><strong>0</strong></li>
                                </ul>
                            </div>
                            <div class="erp-summary-card">
                                <div class="erp-summary-title">Lide</div>
                                <div class="erp-summary-value">Karty zamestnancu</div>
                                <div class="erp-summary-meta">Rychly prehled kapacit a roli.</div>
                                <ul class="erp-summary-list">
                                    <li><span>Aktivni technici</span><strong>0</strong></li>
                                    <li><span>HPP tento mesic</span><strong>160 h</strong></li>
                                    <li><span>Dovolena / absence</span><strong>0 h</strong></li>
                                </ul>
                            </div>
                            <div class="erp-summary-card">
                                <div class="erp-summary-title">Provoz</div>
                                <div class="erp-summary-value">Operations</div>
                                <div class="erp-summary-meta">Projekty, vykazy a SLA na jednom miste.</div>
                                <ul class="erp-summary-list">
                                    <li><span>Aktivni klienti</span><strong>0</strong></li>
                                    <li><span>Rozpracovane tikety</span><strong>0</strong></li>
                                    <li><span>Servisni okna</span><strong>0</strong></li>
                                </ul>
                            </div>
                        </div>
                        </div>
                    </details>

                    <details class="dashboard-section">
                        <summary class="dashboard-section-head">
                            <div>
                                <div class="dashboard-section-title">Karty zamestnancu</div>
                                <div class="dashboard-section-subtitle">Pripraveno pro dochazku, role a kapacity.</div>
                            </div>
                            <span class="dashboard-section-toggle">v</span>
                        </summary>
                        <div class="dashboard-section-body">
                        <div class="erp-employee-grid">
                            <div class="erp-employee-card">
                                <div class="erp-employee-head">
                                    <div class="erp-employee-avatar">OH</div>
                                    <div>
                                        <div class="erp-employee-name">Ondrej H.</div>
                                        <div class="erp-employee-role">Admin / MSP</div>
                                    </div>
                                </div>
                                <div class="erp-employee-tags">
                                    <span class="erp-employee-tag active">Aktivni</span>
                                    <span class="erp-employee-tag">HPP</span>
                                    <span class="erp-employee-tag">Lead</span>
                                </div>
                            </div>
                            <div class="erp-employee-card">
                                <div class="erp-employee-head">
                                    <div class="erp-employee-avatar">JB</div>
                                    <div>
                                        <div class="erp-employee-name">Jan B.</div>
                                        <div class="erp-employee-role">Technik / Site</div>
                                    </div>
                                </div>
                                <div class="erp-employee-tags">
                                    <span class="erp-employee-tag active">Aktivni</span>
                                    <span class="erp-employee-tag">HPP</span>
                                    <span class="erp-employee-tag">L1</span>
                                </div>
                            </div>
                            <div class="erp-employee-card">
                                <div class="erp-employee-head">
                                    <div class="erp-employee-avatar">MS</div>
                                    <div>
                                        <div class="erp-employee-name">Michaela S.</div>
                                        <div class="erp-employee-role">Servis / Projekty</div>
                                    </div>
                                </div>
                                <div class="erp-employee-tags">
                                    <span class="erp-employee-tag active">Aktivni</span>
                                    <span class="erp-employee-tag">HPP</span>
                                    <span class="erp-employee-tag">L2</span>
                                </div>
                            </div>
                            <div class="erp-employee-card">
                                <div class="erp-employee-head">
                                    <div class="erp-employee-avatar">VP</div>
                                    <div>
                                        <div class="erp-employee-name">Vaclav P.</div>
                                        <div class="erp-employee-role">Finance / HR</div>
                                    </div>
                                </div>
                                <div class="erp-employee-tags">
                                    <span class="erp-employee-tag">Plan</span>
                                    <span class="erp-employee-tag">HR</span>
                                    <span class="erp-employee-tag">Finance</span>
                                </div>
                            </div>
                        </div>
                        </div>
                    </details>

                    <details class="dashboard-section">
                        <summary class="dashboard-section-head">
                            <div>
                                <div class="dashboard-section-title">Operacni prehled</div>
                                <div class="dashboard-section-subtitle">Rychle prechody do klientu, racku a site.</div>
                            </div>
                            <span class="dashboard-section-toggle">v</span>
                        </summary>
                        <div class="dashboard-section-body">
                        <div id="dashboardGrid" class="overview-grid dashboard-grid"></div>
                        </div>
                    </details>

                    <details class="dashboard-section dashboard-section-alt">
                        <summary class="dashboard-section-head">
                            <div>
                                <div class="dashboard-section-title">Moduly a integrace</div>
                                <div class="dashboard-section-subtitle">Priprava na fakturaci, dochazku a HR.</div>
                            </div>
                            <span class="dashboard-section-toggle">v</span>
                        </summary>
                        <div class="dashboard-section-body">
                        <div id="dashboardModulesGrid" class="msp-modules-grid"></div>
                        <div class="module-expansion">
                            <div class="module-expansion-title">Priprava na expanzi</div>
                            <div class="module-expansion-grid">
                                <div class="module-expansion-tile">
                                    <div class="module-expansion-icon">+</div>
                                    <div class="module-expansion-label">Fakturace</div>
                                    <div class="module-expansion-desc">Vystavovani faktur a kontrola cashflow.</div>
                                </div>
                                <div class="module-expansion-tile">
                                    <div class="module-expansion-icon">+</div>
                                    <div class="module-expansion-label">Dochazka</div>
                                    <div class="module-expansion-desc">Prehled vykazu, absenci a kapacit.</div>
                                </div>
                                <div class="module-expansion-tile">
                                    <div class="module-expansion-icon">+</div>
                                    <div class="module-expansion-label">HR karty</div>
                                    <div class="module-expansion-desc">Uchovani smluv a kompetenci.</div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </details>
                </div>
            </div>

            <div id="clientsView" class="clients-view" style="display: none;">
                <aside class="clients-list-panel">
                    <div class="clients-list-head">
                        <div>
                            <h2>Klienti</h2>
                            <div class="clients-list-count" id="clientsCount">0 klientu</div>
                        </div>
                        <button class="btn-small" data-client-form-trigger="true" onclick="openClientModal()">+ Pridat klienta</button>
                    </div>
                    <div class="clients-search">
                        <input type="text" id="clientSearch" placeholder="Hledat klienta..." onkeyup="searchClients()">
                    </div>
                    <div id="clientList" class="client-list"></div>
                </aside>
                <section class="client-detail-panel">
                    <div id="clientDetailEmpty" class="empty-state">
                        <p>Vyber klienta ze seznamu.</p>
                    </div>
                    <div id="clientDetailContent" style="display: none;">
                        <div class="client-detail-header">
                            <div>
                                <div class="client-detail-title" id="clientDetailName">-</div>
                                <div class="client-detail-meta" id="clientDetailMeta">-</div>
                            </div>
                            <div class="client-detail-actions">
                                <button class="btn-small" data-client-form-trigger="true" onclick="openClientModal(currentClientId)">Upravit</button>
                                <button class="btn-small btn-secondary" onclick="switchView('overview')">Prehled klienta</button>
                            </div>
                        </div>
                        <div class="client-detail-grid">
                            <div class="client-detail-card">
                                <h3>Zakladni informace</h3>
                                <div class="client-detail-row"><span>Typ</span><strong id="clientDetailType">-</strong></div>
                                <div class="client-detail-row"><span>ICO</span><strong id="clientDetailIco">-</strong></div>
                                <div class="client-detail-row"><span>Barva</span><strong id="clientDetailColor">-</strong></div>
                            </div>
                            <div class="client-detail-card">
                                <h3>Kontakt</h3>
                                <div class="client-detail-row"><span>Kontaktni osoba</span><strong id="clientDetailContact">-</strong></div>
                                <div class="client-detail-row"><span>E-mail</span><strong id="clientDetailEmail">-</strong></div>
                                <div class="client-detail-row"><span>Telefon</span><strong id="clientDetailPhone">-</strong></div>
                            </div>
                            <div class="client-detail-card">
                                <h3>Adresa</h3>
                                <div class="client-detail-row"><span>Adresa</span><strong id="clientDetailAddress">-</strong></div>
                            </div>
                            <div class="client-detail-card">
                                <h3>Pricing</h3>
                                <div class="client-detail-row"><span>Nastaveni</span><strong id="clientDetailPricing">-</strong></div>
                            </div>
                            <div class="client-detail-card">
                                <h3>Infrastruktura</h3>
                                <div class="client-detail-row"><span>Racky</span><strong id="clientDetailRacks">0</strong></div>
                                <div class="client-detail-row"><span>Zarizeni</span><strong id="clientDetailDevices">0</strong></div>
                                <div class="client-detail-row"><span>Propojeni</span><strong id="clientDetailConnections">0</strong></div>
                            </div>
                            <div class="client-detail-card">
                                <h3>Poznamky</h3>
                                <div class="client-detail-row client-detail-notes" id="clientDetailNotes">-</div>
                            </div>
                        </div>
                        <div class="client-detail-chart">
                            <div class="client-detail-chart-title">Vykazy a kapacity</div>
                            <div class="client-detail-chart-placeholder">Graf bude doplnen.</div>
                        </div>
                    </div>

                    <div id="clientFormPanel" class="client-form-panel" style="display: none;">
                        <div class="client-form-header">
                            <div>
                                <div class="client-form-title" id="clientFormTitle">Novy klient</div>
                                <div class="client-form-subtitle" id="clientFormSubtitle">Vypln zakladni a financni udaje klienta.</div>
                            </div>
                            <button class="btn-small btn-secondary" type="button" onclick="closeClientModal()">Zavrit</button>
                        </div>
                        <input type="hidden" id="clientEditId">
                        <div class="client-form-grid">
                            <div class="client-form-section">
                                <h3>Zakladni informace</h3>
                                <div class="client-form-fields">
                                    <div class="form-group">
                                        <label>Nazev klienta *</label>
                                        <input type="text" id="newClientName" placeholder="napr. Firma ABC s.r.o.">
                                    </div>
                                    <div class="form-group">
                                        <label>E-mail</label>
                                        <input type="email" id="newClientEmail" placeholder="napr. info@firma.cz">
                                    </div>
                                    <div class="form-group">
                                        <label>ICO</label>
                                        <input type="text" id="newClientICO" placeholder="napr. 12345678">
                                    </div>
                                    <div class="form-group">
                                        <label>Typ klienta</label>
                                        <select id="newClientType">
                                            <option value="standard">Standard</option>
                                            <option value="premium">Premium</option>
                                            <option value="enterprise">Enterprise</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Barva klienta</label>
                                        <input type="color" id="newClientColor" value="#f89a55">
                                    </div>
                                </div>
                            </div>
                            <div class="client-form-section">
                                <h3>Kontaktni informace</h3>
                                <div class="client-form-fields">
                                    <div class="form-group">
                                        <label>Kontaktni osoba</label>
                                        <input type="text" id="newClientContact" placeholder="napr. Jan Novak">
                                    </div>
                                    <div class="form-group">
                                        <label>Telefon</label>
                                        <input type="tel" id="newClientPhone" placeholder="napr. +420 123 456 789">
                                    </div>
                                    <div class="form-group">
                                        <label>Adresa</label>
                                        <input type="text" id="newClientAddress" placeholder="napr. Vaclavske namesti 1, Praha">
                                    </div>
                                    <div class="form-group">
                                        <label>Poznamky</label>
                                        <textarea id="newClientNotes" rows="4"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="client-form-section client-form-section-wide">
                                <h3>Pricing</h3>
                                <div class="client-form-fields">
                                    <div class="form-group">
                                        <label>Pricing rezim</label>
                                        <select id="newClientPricingMode" onchange="updatePricingFields()">
                                            <option value="retainer-hours">Pausal s hodinami + nad pausal sazba</option>
                                            <option value="retainer-hourly">Pausal + hodinovka</option>
                                            <option value="retainer-unlimited">Pausal s neomezenymi hodinami</option>
                                        </select>
                                    </div>
                                    <div class="form-group" id="pricingRetainerAmountGroup">
                                        <label>Pausal (Kc / mesic)</label>
                                        <input type="number" id="newClientRetainerAmount" placeholder="napr. 25000" min="0" step="1">
                                    </div>
                                    <div class="form-group" id="pricingRetainerHoursGroup">
                                        <label>Hodiny v pausalu</label>
                                        <input type="number" id="newClientRetainerHours" placeholder="napr. 20" min="0" step="0.5">
                                    </div>
                                    <div class="form-group" id="pricingHourlyRateGroup">
                                        <label>Hodinova sazba (Kc)</label>
                                        <input type="number" id="newClientHourlyRate" placeholder="napr. 1200" min="0" step="1">
                                    </div>
                                    <div class="form-group" id="pricingOverageRateGroup">
                                        <label>Sazba nad pausal (Kc)</label>
                                        <input type="number" id="newClientOverageRate" placeholder="napr. 1500" min="0" step="1">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="client-form-actions">
                            <button class="btn" id="clientSubmitBtn" onclick="addClient()">Ulozit klienta</button>
                            <button class="btn btn-secondary" type="button" onclick="closeClientModal()">Zahodit</button>
                        </div>
                    </div>
                </section>
            </div>

            <div id="overviewView" class="rack-container" style="display: none;">
                <div class="rack-header">
                    <h2>Prehled klienta</h2>
                    <div class="rack-stats">
                        <div class="overview-header">
                            <div class="overview-client-meta">
                                <div class="stat-value" id="overviewClientName">-</div>
                                <div class="stat-label">Aktivni klient</div>
                                <div class="overview-client-pricing" id="overviewClientPricing">-</div>

                            </div>
                            <div class="overview-client-logo-wrap">
                                <div class="overview-client-logo" id="overviewClientLogo">LOGO</div>
                                <button class="btn-small overview-logo-btn" type="button" onclick="triggerClientLogoUpload()">Nahrat logo</button>
                                <button class="btn-small btn-secondary overview-logo-btn" type="button" onclick="clearClientLogo()">Odebrat logo</button>
                                <input type="file" id="clientLogoInput" accept="image/*" onchange="handleClientLogoUpload(event)" style="display: none;">
                            </div>
                        </div>
                    </div>
                </div>
                <p class="msp-module-desc">Kliknete na karty pro rychly prechod do detailu racku, zarizeni nebo site.</p>
                <div id="overviewGrid" class="overview-grid"></div>

                <div class="overview-section">
                    <div class="overview-section-title">MSP sluzby</div>
                    <div id="mspModulesGrid" class="msp-modules-grid"></div>
                </div>
            </div>
            
            <div id="racksView" class="rack-container">
                <div class="rack-header">
                    <h2>Racky</h2>
                    <div class="rack-stats">
                        <div class="stat">
                            <div class="stat-value" id="usedUnits">0</div>
                            <div class="stat-label">Obsazeno U</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="freeUnits">0</div>
                            <div class="stat-label">Volno U</div>
                        </div>
                    </div>
                </div>
                <div id="rackGrid" class="rack-grid">
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <p>Zatm nemte dn racky.<br>Kliknte na "Pidat rack" pro vytvoen prvnho racku.</p>
                    </div>
                </div>
            </div>
            
            <div id="networkView" class="network-map" style="display: none;">
                <div class="rack-header">
                    <h2>Sov mapa</h2>
                    <div class="rack-stats">
                        <button class="btn-small" onclick="resetNetworkView()"> Reset View</button>
                        <button class="btn-small" onclick="exportNetworkDiagram()"> Export SVG</button>
                    </div>
                </div>
                <div class="network-stats">
                    <div class="network-stat-card">
                        <div class="network-stat-value" id="totalConnections">0</div>
                        <div class="network-stat-label">Propojen</div>
                    </div>
                    <div class="network-stat-card">
                        <div class="network-stat-value" id="totalPorts">0</div>
                        <div class="network-stat-label">Port celkem</div>
                    </div>
                    <div class="network-stat-card">
                        <div class="network-stat-value" id="usedPorts">0</div>
                        <div class="network-stat-label">Obsazeno</div>
                    </div>
                    <div class="network-stat-card">
                        <div class="network-stat-value" id="trunkPorts">0</div>
                        <div class="network-stat-label">Trunk port</div>
                    </div>
                </div>
                <canvas id="networkCanvas"></canvas>
            </div>

            <div id="timeView" class="time-tracking" style="display: none;">
                <div class="rack-header">
                    <h2>Vykazovani hodin</h2>
                    <div class="rack-stats">
                        <div class="time-filter" id="timeTechnicianFilterWrap">
                            <label for="timeTechnicianFilter">Technik</label>
                            <select id="timeTechnicianFilter" onchange="updateTimeTechnicianFilter()"></select>
                        </div>
                        <label class="time-toggle">
                            <input type="checkbox" id="timeAllClientsToggle" onchange="toggleTimeAllClients()">
                            <span>Vsechny klienty</span>
                        </label>
                        <button class="btn-small" onclick="exportTimeReport()">Export PDF</button>
                    </div>
                </div>
                <div class="time-layout">
                    <div class="time-panel">
                        <div class="calendar-header">
                            <button class="btn-small" onclick="shiftTimeWeek(-1)"></button>
                            <div class="calendar-title" id="timeCalendarTitle">-</div>
                            <button class="btn-small" onclick="shiftTimeWeek(1)"></button>
                        </div>
                        <div class="time-week-header" id="timeWeekHeader"></div>
                        <div class="time-week-grid" id="timeWeekGrid"></div>
                    </div>
                    <div class="time-panel">
                        <div class="time-summary" id="timeSummary"></div>
                        <div class="time-client-summary" id="timeClientSummary"></div>
                        <button class="btn" id="addTimeEntryBtn" onclick="openTimeEntryModal()">Novy zapis</button>
                        <div class="role-note" style="margin-top: 0.75rem;">Tip: oznac si rozsah v kalendari tahem mysi.</div>
                        <div class="time-activity-manager">
                            <div class="section-title">Preddefinovane cinnosti</div>
                            <div class="time-activity-form">
                                <input type="text" id="timeActivityInput" placeholder="Nova cinnost">
                                <button class="btn-small" onclick="addTimeActivity()">Pridat</button>
                            </div>
                            <div id="timeActivityList" class="time-activity-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="reportsView" class="time-tracking" style="display: none;">
                <div class="rack-header teams-header">
                    <h2>Live reporty</h2>
                </div>
                <div id="reportsAccessNote" class="empty-state" style="display: none;">
                    <p>Reporty jsou dostupne jen pro administratory.</p>
                </div>
                <div class="reports-layout">
                    <aside class="report-filter-panel">
                        <div class="report-filter-card report-filter-card-full">
                            <div class="report-filter-title">Vytvorit report</div>
                            <div class="report-form-grid">
                                <div class="report-form-row">
                                    <label for="reportPresetName">Nazev</label>
                                    <input type="text" id="reportPresetName" placeholder="Administrativa CXTech">
                                </div>
                                <div class="report-form-row">
                                    <label for="reportShareLink">Sdileni</label>
                                    <div class="report-share-row">
                                        <button class="btn-small" onclick="openReportShareModal()">Sdilet report</button>
                                        <input type="text" id="reportShareLink" class="report-share-link" placeholder="Permanentni odkaz" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="report-filter-divider"></div>
                            <div class="report-filter-section">
                                <div class="report-filter-section-title">Filtry</div>
                                <div class="report-filters">
                                    <div class="report-field">
                                        <label for="reportRangePreset">Casovy interval</label>
                                        <select id="reportRangePreset" onchange="onReportRangePresetChange()">
                                            <option value="all">Vsechno</option>
                                            <option value="current-month">Soucasny mesic</option>
                                            <option value="previous-month">Predchozi mesic</option>
                                            <option value="year">Aktualni rok</option>
                                            <option value="custom">Vlastni rozsah</option>
                                        </select>
                                    </div>
                                    <div class="report-field">
                                        <label for="reportClientFilter">Zakaznici</label>
                                        <select id="reportClientFilter" multiple size="6" onchange="onReportFilterChange()"></select>
                                    </div>
                                    <div class="report-field">
                                        <label for="reportTechnicianFilter">Uzivatele</label>
                                        <select id="reportTechnicianFilter" multiple size="6" onchange="onReportFilterChange()"></select>
                                    </div>
                                    <div class="report-field">
                                        <label for="reportStartDate">Od</label>
                                        <input type="date" id="reportStartDate" onchange="onReportDateChange()">
                                    </div>
                                    <div class="report-field">
                                        <label for="reportEndDate">Do</label>
                                        <input type="date" id="reportEndDate" onchange="onReportDateChange()">
                                    </div>
                                </div>
                            </div>
                            <div class="report-actions">
                                <button class="btn-small" onclick="createReportFromBuilder()">Vytvorit report</button>
                                <button class="btn-small" onclick="showReportList()">Zpet na seznam</button>
                            </div>
                        </div>
                    </aside>
                    <section class="report-display">
                        <div id="timeReportTable"></div>
                    </section>
                </div>
            </div>

            <div id="computersView" class="computers-view" style="display: none;">
                <div class="rack-header">
                    <div>
                        <h2>Pocitace</h2>
                        <div class="computers-subtitle">Prehled PC a serveru z Atera inventare.</div>
                    </div>
                    <div class="computers-actions">
                        <button class="btn-small" onclick="refreshComputersView()">Obnovit</button>
                        <div class="computers-sync" id="computersSyncStatus">Sync: -</div>
                    </div>
                </div>
                <div class="computers-layout">
                    <aside class="computers-panel">
                        <div class="computers-panel-title">Filtry</div>
                        <div class="computers-filter-group">
                            <label for="computersClientFilter">Klient</label>
                            <select id="computersClientFilter" onchange="updateComputersFilters()"></select>
                        </div>
                        <div class="computers-filter-group">
                            <label for="computersTypeFilter">Typ</label>
                            <select id="computersTypeFilter" onchange="updateComputersFilters()"></select>
                        </div>
                        <div class="computers-filter-group">
                            <label for="computersStatusFilter">Status</label>
                            <select id="computersStatusFilter" onchange="updateComputersFilters()"></select>
                        </div>
                        <div class="computers-filter-group">
                            <label for="computersSearch">Hledat</label>
                            <input type="text" id="computersSearch" placeholder="Nazev, OS, IP, uzivatel" oninput="updateComputersFilters()">
                        </div>
                    </aside>
                    <section class="computers-panel">
                        <div class="computers-list-head">
                            <div class="computers-list-title">Zarizeni</div>
                            <div class="computers-list-actions">
                                <select id="computersSort" onchange="updateComputersFilters()"></select>
                            </div>
                        </div>
                        <div id="computersMetrics" class="computers-metrics"></div>
                        <div id="computersList" class="computers-list"></div>
                    </section>
                </div>
            </div>

            <div id="helpdeskView" class="helpdesk-view" style="display: none;">
                <div class="rack-header">
                    <div>
                        <h2>Helpdesk</h2>
                        <div class="helpdesk-subtitle">Centralni fronta pozadavku, stavy SLA a priprava na budouci integrace.</div>
                    </div>
                    <div class="helpdesk-actions">
                        <button class="btn-small" id="helpdeskNewTicketBtn" onclick="openHelpdeskTicketModal()">+ Novy tiket</button>
                        <button class="btn-small btn-secondary" onclick="renderHelpdeskView()">Obnovit</button>
                    </div>
                </div>
                <div class="helpdesk-layout">
                    <aside class="helpdesk-panel helpdesk-filters">
                        <div class="helpdesk-panel-title">Fronty</div>
                        <div id="helpdeskQueueList" class="helpdesk-queue-list"></div>
                        <div class="helpdesk-panel-divider"></div>
                        <div class="helpdesk-panel-title">Filtry</div>
                        <div class="helpdesk-filter-group">
                            <label for="helpdeskClientFilter">Klient</label>
                            <select id="helpdeskClientFilter" onchange="updateHelpdeskFilters()"></select>
                        </div>
                        <div class="helpdesk-filter-group">
                            <label for="helpdeskStatusFilter">Status</label>
                            <select id="helpdeskStatusFilter" onchange="updateHelpdeskFilters()"></select>
                        </div>
                        <div class="helpdesk-filter-group">
                            <label for="helpdeskPriorityFilter">Priorita</label>
                            <select id="helpdeskPriorityFilter" onchange="updateHelpdeskFilters()"></select>
                        </div>
                        <div class="helpdesk-filter-group">
                            <label for="helpdeskAssigneeFilter">Prirazeni</label>
                            <select id="helpdeskAssigneeFilter" onchange="updateHelpdeskFilters()"></select>
                        </div>
                        <div class="helpdesk-filter-group">
                            <label for="helpdeskSearch">Hledat</label>
                            <input type="text" id="helpdeskSearch" placeholder="ID, titulek, popis" oninput="updateHelpdeskFilters()">
                        </div>
                        <div class="helpdesk-panel-divider"></div>
                        <div class="helpdesk-panel-title">Integrace (priprava)</div>
                        <div class="helpdesk-integration-list">
                            <div class="helpdesk-integration-card">Teams</div>
                            <div class="helpdesk-integration-card">ClickUp</div>
                            <div class="helpdesk-integration-card">Jine kanaly</div>
                        </div>
                        <div class="helpdesk-panel-note">
                            Pripraveno pro obousmerny sync pres API a webhooky. Tiket ma pole External ID a Provider pro budouci napojeni.
                        </div>
                    </aside>

                    <section class="helpdesk-panel helpdesk-list">
                        <div class="helpdesk-list-head">
                            <div class="helpdesk-list-title">Tikety</div>
                            <div class="helpdesk-list-actions">
                                <select id="helpdeskSort" onchange="updateHelpdeskFilters()"></select>
                            </div>
                        </div>
                        <div class="helpdesk-metrics" id="helpdeskMetrics"></div>
                        <div id="helpdeskList" class="helpdesk-ticket-list"></div>
                    </section>

                    <section class="helpdesk-panel helpdesk-detail">
                        <div id="helpdeskDetail" class="helpdesk-detail-body"></div>
                    </section>
                </div>
            </div>

            <div id="teamsView" class="teams-view" style="display: none;">
                <div class="rack-header">
                    <div>
                        <h2>Teams hub</h2>
                        <div class="teams-subtitle">Channely a chaty z Microsoft 365, vcetne posilani zprav a nahledu souboru.</div>
                    </div>
                    <div class="teams-actions">
                        <button class="btn-small btn-secondary" onclick="loginWithMicrosoft({ forceConsent: true, includeTeams: true })">Obnovit souhlas</button>
                        <button class="btn-small btn-secondary" onclick="openTeamsChatModal()">Novy chat</button>
                        <button class="btn-small btn-secondary" onclick="openTeamsChannelModal()">Novy kanal</button>
                        <button class="btn-small" onclick="refreshTeamsData(true)">Obnovit</button>
                    </div>
                </div>
                <div id="teamsStatus" class="teams-status"></div>
                <div id="teamsAccessNote" class="empty-state" style="display: none;">
                    <p>Pro Teams je nutne prihlaseni pres Microsoft 365 a spravne scopes.</p>
                    <button class="btn-small" onclick="loginWithMicrosoft()">Prihlasit pres Microsoft 365</button>
                </div>
                <div class="teams-layout" id="teamsLayout">
                    <aside class="teams-panel teams-sidebar">
                        <div class="teams-tabs">
                            <button class="teams-tab active" data-tab="chats" onclick="switchTeamsTab('chats')">Chaty</button>
                            <button class="teams-tab" data-tab="channels" onclick="switchTeamsTab('channels')">Kanaly</button>
                        </div>
                        <div class="teams-search">
                            <input type="text" id="teamsChatSearch" placeholder="Hledat v chatech..." oninput="setTeamsSearchQuery(this.value)">
                        </div>
                        <div id="teamsChatsWrap">
                            <div class="teams-list-title">Chaty</div>
                            <div class="teams-section-manager">
                                <input type="text" id="teamsSectionInput" class="teams-section-input" placeholder="Nova sekce...">
                                <button class="btn-small teams-section-add" onclick="addTeamsSection()">Pridat</button>
                            </div>
                            <div id="teamsChatList" class="teams-list"></div>
                        </div>
                        <div id="teamsChannelsWrap" style="display: none;">
                            <div class="teams-list-title">Tymy a kanaly</div>
                            <div id="teamsTeamList" class="teams-list teams-team-tree"></div>
                        </div>
                    </aside>
                    <section class="teams-panel teams-thread-panel">
                        <div class="teams-thread-header">
                            <div>
                                <div class="teams-thread-title" id="teamsThreadTitle">Vyber chat nebo kanal</div>
                                <div class="teams-thread-meta" id="teamsThreadMeta">-</div>
                                <div class="teams-thread-tabs" id="teamsThreadTabs" style="display: none;">
                                    <button class="teams-thread-tab active" data-tab="posts" onclick="setTeamsThreadTab('posts')">Prispevky</button>
                                    <button class="teams-thread-tab" data-tab="files" onclick="setTeamsThreadTab('files')">Soubory</button>
                                </div>
                            </div>
                            <div class="teams-thread-actions">
                                <button class="btn-small" onclick="refreshTeamsMessages()">Obnovit</button>
                            </div>
                        </div>
                        <div class="teams-thread" id="teamsThreadMessages"></div>
                        <div class="teams-inline-preview">
                            <div class="teams-preview-title">Nahled souboru</div>
                            <div id="teamsPreviewEmpty" class="teams-preview-empty">
                                <div class="teams-preview-icon">
                                    <svg class="teams-preview-svg" viewBox="0 0 24 24" fill="none" stroke="#8b857d" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <path d="M6 3h7l5 5v13a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z"></path>
                                        <path d="M13 3v6h6"></path>
                                        <path d="M8 13h8"></path>
                                        <path d="M8 17h8"></path>
                                    </svg>
                                </div>
                                <div>Vyber soubor z konverzace.</div>
                                <button class="btn-small btn-secondary" type="button" disabled>Nahrat soubor</button>
                            </div>
                            <div id="teamsPreviewFrameWrap" class="teams-preview-frame" style="display: none;">
                                <iframe id="teamsPreviewFrame" title="Teams file preview"></iframe>
                            </div>
                            <div class="teams-preview-actions">
                                <button class="btn-small btn-secondary" id="teamsPreviewOpenBtn" onclick="openTeamsPreviewInNewTab()" style="display: none;">Otevrit v novem okne</button>
                            </div>
                        </div>
                        <div class="teams-reply-preview" id="teamsReplyPreview" style="display: none;">
                            <div class="teams-reply-text">
                                <div class="teams-reply-label">Odpovidate na</div>
                                <div class="teams-reply-author" id="teamsReplyAuthor">-</div>
                                <div class="teams-reply-snippet" id="teamsReplySnippet">-</div>
                            </div>
                            <button class="teams-reply-close" type="button" onclick="clearTeamsReply()">x</button>
                        </div>
                        <div class="teams-composer">
                            <input type="text" id="teamsMessageInput" placeholder="Napis zpravu..." onkeydown="if(event.key==='Enter'){sendTeamsMessage();}">
                            <button class="btn" id="teamsSendBtn" onclick="sendTeamsMessage()">Odeslat</button>
                        </div>
                    </section>
                </div>
            </div>
            
            <div id="topologyView" style="display: none;">
                <!-- Topology view will be dynamically generated -->
            </div>
            
            <div class="device-list" id="deviceListContainer" style="display: none;">
                <h3>Seznam zazen</h3>
                <table class="device-table">
                    <thead>
                        <tr>
                            <th>Nzev</th>
                            <th>Typ</th>
                            <th>Rack</th>
                            <th>Pozice</th>
                            <th>IP adresa</th>
                            <th>Model</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody id="deviceTableBody">
                    </tbody>
                </table>
            </div>
            
            <div class="connections-container" id="connectionsContainer" style="display: none;">
                <h3>Propojen</h3>
                <div id="connectionsList">
                </div>
            </div>
            </div>
        </main>
    </div>

    <!-- Port Details Overlay -->
    <div id="portDetailsOverlay" class="port-details-overlay">
        <div class="port-details-container">
            <div class="port-details-header">
                <h2 class="port-details-title" id="portDetailsTitle">Port Management</h2>
                <button class="modal-close" onclick="closePortDetails()"></button>
            </div>
            <div id="portDetailsContent">
                <!-- Port details will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Helpdesk Ticket Modal -->
    <div id="helpdeskTicketModal" class="modal">
        <div class="modal-content" style="max-width: 640px;">
            <div class="modal-header">
                <h2 id="helpdeskModalTitle">Novy tiket</h2>
                <button class="modal-close" onclick="closeHelpdeskTicketModal()">x</button>
            </div>
            <div class="time-form">
                <input type="hidden" id="helpdeskTicketId">
                <div class="form-group">
                    <label>Titulek</label>
                    <input type="text" id="helpdeskTicketTitle" placeholder="Napriklad: VPN nefunguje">
                </div>
                <div class="form-group">
                    <label>Klient</label>
                    <select id="helpdeskTicketClient"></select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="helpdeskTicketStatus"></select>
                </div>
                <div class="form-group">
                    <label>Priorita</label>
                    <select id="helpdeskTicketPriority"></select>
                </div>
                <div class="form-group">
                    <label>Prirazeno</label>
                    <input type="text" id="helpdeskTicketAssignee" placeholder="Napriklad: JB" list="helpdeskAssigneeOptions">
                    <datalist id="helpdeskAssigneeOptions"></datalist>
                </div>
                <div class="form-group">
                    <label>Termin</label>
                    <input type="date" id="helpdeskTicketDue">
                </div>
                <div class="form-group">
                    <label>Zdroj</label>
                    <select id="helpdeskTicketSource"></select>
                </div>
                <div class="form-group">
                    <label>Tagy</label>
                    <input type="text" id="helpdeskTicketTags" placeholder="monitoring, sla, urgent">
                </div>
                <div class="form-group">
                    <label>Popis</label>
                    <textarea id="helpdeskTicketDesc" rows="4" placeholder="Shrnuti pozadavku"></textarea>
                </div>
                <div class="client-form-actions">
                    <button class="btn" onclick="saveHelpdeskTicket()">Ulozit tiket</button>
                    <button class="btn btn-secondary" type="button" onclick="closeHelpdeskTicketModal()">Zahodit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Time Entry Modal -->
    <div id="timeEntryModal" class="modal">
        <div class="modal-content" style="max-width: 560px;">
            <div class="modal-header">
                <h2>Novy zapis hodin</h2>
                <button class="modal-close" onclick="closeTimeEntryModal()"></button>
            </div>
            <div class="time-form">
                <div class="form-group">
                    <label>Klient</label>
                    <select id="timeEntryClient" onchange="onTimeEntryClientChange()"></select>
                </div>
                <div class="form-group">
                    <label>Tiket</label>
                    <select id="timeEntryTicket"></select>
                </div>
                <div class="form-group">
                    <label>Kategorie</label>
                    <select id="timeEntryCategory">
                        <option value="client">Klientske hodiny</option>
                        <option value="internal">Interni</option>
                        <option value="leave">Dovolena</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cinnost</label>
                    <input type="text" id="timeEntryActivity" list="timeActivityOptions" placeholder="Nap. Monitoring">
                    <datalist id="timeActivityOptions"></datalist>
                </div>
                <div class="form-group">
                    <label>Od</label>
                    <input type="date" id="timeEntryStart" onchange="updateTimeEntrySummary()">
                </div>
                <div class="form-group">
                    <label>Do</label>
                    <input type="date" id="timeEntryEnd" onchange="updateTimeEntrySummary()">
                </div>
                <div class="form-group">
                    <label>Hodiny na den</label>
                    <input type="number" id="timeEntryHours" min="0" step="0.25" placeholder="napr. 1.5" oninput="updateTimeEntrySummary()">
                    <div class="time-preset-group">
                        <button class="time-preset-btn" type="button" onclick="setTimePreset(0.5)">0.5h</button>
                        <button class="time-preset-btn" type="button" onclick="setTimePreset(1)">1h</button>
                        <button class="time-preset-btn" type="button" onclick="setTimePreset(2)">2h</button>
                        <button class="time-preset-btn" type="button" onclick="setTimePreset(4)">4h</button>
                        <button class="time-preset-btn" type="button" onclick="setTimePreset(8)">8h</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Popis</label>
                    <input type="text" id="timeEntryDesc" placeholder="Co se delalo">
                </div>
                <div class="role-note" id="timeEntrySummary"></div>
                <button class="btn" onclick="saveTimeEntryRange()">Ulozit</button>
            </div>
        </div>
    </div>

    <!-- Report Share Modal -->
    <div id="reportShareModal" class="modal">
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-header">
                <h2>Sdilet report</h2>
                <button class="modal-close" onclick="closeReportShareModal()">-</button>
            </div>
            <div class="report-share-note">Vyberte zpusob sdileni pro aktualni filtry.</div>
            <div class="report-share-actions" style="margin-top: 1rem;">
                <button class="btn" onclick="handleReportShareOption('link')">Permanentni odkaz</button>
                <button class="btn-secondary" onclick="handleReportShareOption('internal')">Sdilet interne</button>
            </div>
        </div>
    </div>
    
    <!-- Connection Modal -->
    <div id="connectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nov propojen</h2>
                <button class="modal-close" onclick="closeConnectionModal()"></button>
            </div>
            <div class="form-group">
                <label>Z zazen</label>
                <select id="connFromDevice" onchange="updateFromPorts()"></select>
            </div>
            <div class="form-group">
                <label>Z portu</label>
                <select id="connFromPort"></select>
            </div>
            <div class="form-group">
                <label>Do zazen</label>
                <select id="connToDevice" onchange="updateToPorts()"></select>
            </div>
            <div class="form-group">
                <label>Do portu</label>
                <select id="connToPort"></select>
            </div>
            <div class="form-group">
                <label>Typ spojen</label>
                <select id="connType">
                    <option value="access">Access</option>
                    <option value="trunk">Trunk</option>
                    <option value="uplink">Uplink</option>
                    <option value="crossover">Crossover</option>
                </select>
            </div>
            <div class="form-group">
                <label>VLAN (rkou oddlen pro trunk)</label>
                <input type="text" id="connVlans" placeholder="nap. 10,20,30">
            </div>
            <div class="form-group">
                <label>Rychlost</label>
                <select id="connSpeed">
                    <option value="10">10 Mbps</option>
                    <option value="100">100 Mbps</option>
                    <option value="1000" selected>1 Gbps</option>
                    <option value="10000">10 Gbps</option>
                    <option value="25000">25 Gbps</option>
                    <option value="40000">40 Gbps</option>
                    <option value="100000">100 Gbps</option>
                </select>
            </div>
            <div class="form-group">
                <label>Popis</label>
                <input type="text" id="connDescription" placeholder="nap. Uplink to core switch">
            </div>
            <button class="btn" onclick="addConnection()">Vytvoit propojen</button>
        </div>
    </div>
    
        <!-- Role Manager Modal -->
    <div id="roleManagerModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Sprava roli</h2>
                <button class="modal-close" onclick="closeRoleManagerModal()">X</button>
            </div>
            <div class="role-note">Role jsou nacitane z Firestore cesty clients/{id}/users.</div>
            <div class="role-invite-form">
                <input type="email" id="roleInviteEmail" placeholder="email@firma.cz">
                <select id="roleInviteRole" class="role-select">
                    <option value="admin">Admin</option>
                    <option value="technician">Technik</option>
                    <option value="readonly">Read-only</option>
                    <option value="auditor">Auditor</option>
                </select>
                <button class="btn btn-secondary" onclick="addRoleInvite()">Pozvat</button>
            </div>
            <div id="roleManagerList"></div>
        </div>
    </div>

    <!-- M365 Modal -->
    <div id="m365Modal" class="modal">
        <div class="modal-content" style="max-width: 720px;">
            <div class="modal-header">
                <h2>Microsoft 365</h2>
                <button class="modal-close" onclick="closeM365Modal()">X</button>
            </div>
            <div class="m365-note">Nastavte udaje pro prihlaseni a integraci Microsoft 365.<br>Pro OAuth je nutne mit zapnuty provider microsoft.com ve Firebase.<br>Pro Teams doporucene scopes: Chat.ReadWrite Chat.Create ChannelMessage.Read.All ChannelMessage.Send Team.ReadBasic.All Channel.ReadBasic.All Channel.Create User.Read.All Files.Read.All Sites.Read.All.</div>
            <div class="m365-grid">
                <div class="form-group">
                    <label>Povolit prihlaseni pres M365</label>
                    <select id="m365EnableLogin" class="role-select">
                        <option value="1">Ano</option>
                        <option value="0">Ne</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tenant ID</label>
                    <input type="text" id="m365TenantId" placeholder="napr. xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                </div>
                <div class="form-group">
                    <label>Client ID (Application ID)</label>
                    <input type="text" id="m365ClientId" placeholder="napr. xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                </div>
                <div class="form-group">
                    <label>Client Secret</label>
                    <input type="password" id="m365ClientSecret" placeholder="ulozte jen na bezpecnem backendu">
                </div>
                <div class="form-group">
                    <label>Redirect URI</label>
                    <input type="text" id="m365RedirectUri" placeholder="napr. https://app.example.com/">
                </div>
                <div class="form-group" style="display: flex; align-items: flex-end;">
                    <button class="btn-small btn-secondary" type="button" onclick="useCurrentRedirectUri()">Pouzit aktualni domenu</button>
                </div>
                <div class="form-group">
                    <label>Scopes (oddeleno mezerou)</label>
                    <input type="text" id="m365Scopes" placeholder="openid profile email offline_access User.Read">
                </div>
                <div class="form-group">
                    <label>Povolene domeny (oddeleno carkou)</label>
                    <input type="text" id="m365AllowedDomains" placeholder="cxtech.cz, example.com">
                </div>
            </div>
            <div class="m365-actions">
                <button class="btn btn-secondary" onclick="clearM365Config()">Vymazat</button>
                <button class="btn" onclick="saveM365Config()">Ulozit nastaveni</button>
            </div>
        </div>
    </div>

    <!-- Teams Chat Modal -->
    <div id="teamsChatModal" class="modal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-header">
                <h2>Novy chat</h2>
                <button class="modal-close" onclick="closeTeamsChatModal()">X</button>
            </div>
            <div class="form-group">
                <label>Nazev / tema</label>
                <input type="text" id="teamsChatTopic" placeholder="napr. Projekt Alpha">
            </div>
            <div class="form-group">
                <label>Ucastnici (emaily, oddelene carkou)</label>
                <input type="text" id="teamsChatMembers" placeholder="user1@cxtech.cz, user2@cxtech.cz">
            </div>
            <div class="role-note">Pri vytvoreni se automaticky prida aktualni uzivatel.</div>
            <button class="btn" onclick="createTeamsChat()">Vytvorit chat</button>
        </div>
    </div>

    <!-- Teams Channel Modal -->
    <div id="teamsChannelModal" class="modal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-header">
                <h2>Novy kanal</h2>
                <button class="modal-close" onclick="closeTeamsChannelModal()">X</button>
            </div>
            <div class="form-group">
                <label>Team</label>
                <select id="teamsChannelTeamSelect"></select>
            </div>
            <div class="form-group">
                <label>Nazev kanalu</label>
                <input type="text" id="teamsChannelName" placeholder="napr. Support">
            </div>
            <div class="form-group">
                <label>Popis</label>
                <input type="text" id="teamsChannelDescription" placeholder="Volitelny popis kanalu">
            </div>
            <div class="form-group">
                <label>Typ pristupu</label>
                <select id="teamsChannelMembership">
                    <option value="standard">Standard</option>
                    <option value="private">Private</option>
                </select>
            </div>
            <button class="btn" onclick="createTeamsChannel()">Vytvorit kanal</button>
        </div>
    </div>

    <!-- Rack Modal -->
    <div id="rackModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nov rack</h2>
                <button class="modal-close" onclick="closeRackModal()"></button>
            </div>
            <div class="form-group">
                <label>Nzev racku</label>
                <input type="text" id="rackName" placeholder="nap. RACK-01">
            </div>
            <div class="form-group">
                <label>Poet U (vka)</label>
                <input type="number" id="rackUnits" value="42" min="1" max="50">
            </div>
            <div class="form-group">
                <label>Umstn</label>
                <input type="text" id="rackLocation" placeholder="nap. Serverovna A">
            </div>
            <button class="btn" onclick="addRack()">Vytvoit rack</button>
        </div>
    </div>
    
    <!-- Device Modal -->
    <div id="deviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nov zazen</h2>
                <button class="modal-close" onclick="closeDeviceModal()"></button>
            </div>
            <div class="form-group">
                <label>Nzev zazen</label>
                <input type="text" id="deviceName" placeholder="nap. SW-CORE-01">
            </div>
            <div class="form-group">
                <label>Typ zazen</label>
                <select id="deviceType"></select>
                <div style="margin-top: 0.5rem; text-align: right;">
                    <button class="btn-small" onclick="openModuleModal()">Sprava kategorii</button>
                </div>
            </div>
            <div class="form-group">
                <label>Rack</label>
                <select id="deviceRack"></select>
            </div>
            <div class="form-group">
                <label>Pozice U (od spodu)</label>
                <input type="number" id="devicePosition" min="1" placeholder="nap. 10">
            </div>
            <div class="form-group">
                <label>Vka (poet U)</label>
                <input type="number" id="deviceHeight" value="1" min="1" max="10">
            </div>
            <div class="form-group">
                <label>IP adresa</label>
                <input type="text" id="deviceIP" placeholder="nap. 192.168.1.1">
            </div>
            <div class="form-group">
                <label>Model</label>
                <input type="text" id="deviceModel" placeholder="nap. Cisco Catalyst 2960">
            </div>
            <div class="form-group">
                <label>Sriov slo</label>
                <input type="text" id="deviceSerial" placeholder="nap. ABC123456">
            </div>
            <div class="form-group">
                <label>Poet port</label>
                <input type="number" id="devicePorts" value="24" min="1" max="48" placeholder="nap. 24">
            </div>
    <button class="btn" onclick="addDevice()">Pidat zazen</button>
        </div>
    </div>

    <!-- Module Modal -->
    <div id="moduleModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Kategorie zarizeni</h2>
                <button class="modal-close" onclick="closeModuleModal()">X</button>
            </div>
            <div class="form-group">
                <label>Nazev kategorie</label>
                <input type="text" id="moduleName" placeholder="napr. Firewall">
            </div>
            <div class="form-group">
                <label>ID kategorie (volitelne)</label>
                <input type="text" id="moduleId" placeholder="napr. firewall">
            </div>
            <div class="form-group">
                <label>Kategorie</label>
                <select id="moduleGroup">
                    <option value="Network">Network</option>
                    <option value="Compute">Compute</option>
                    <option value="Storage">Storage</option>
                    <option value="Security">Security</option>
                    <option value="Cabling">Cabling</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Barva</label>
                <input type="color" id="moduleColor" value="#00ff88">
            </div>
            <button class="btn" onclick="addModuleType()">Pridat kategorii</button>

            <div style="margin-top: 1.5rem;">
                <h3 style="margin-bottom: 0.75rem; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary);">Seznam kategorii</h3>
                <div id="moduleList" class="module-list"></div>
            </div>
        </div>
    </div>

    <!-- Device Tooltip -->
    <div id="deviceTooltip" class="device-tooltip">
        <div class="tooltip-header" id="tooltipName"></div>
        <div class="tooltip-detail" id="tooltipType"></div>
        <div class="tooltip-detail" id="tooltipPosition"></div>
        <div class="tooltip-detail" id="tooltipIP"></div>
        <div class="tooltip-detail" id="tooltipModel"></div>
        <div class="tooltip-detail" id="tooltipPorts"></div>
        <div class="tooltip-detail" id="tooltipSerial"></div>
    </div>
    
    <script>
        // Data storage - now with multi-tenant support
        let clients = [];
        let currentClientId = null;
        let clientData = {}; // Will store data per client
        
        // Current client's data
        let racks = [];
        let devices = [];
        let connections = [];
        let timeEntries = [];
        let reportEntries = [];
        let reportPresetsLoaded = false;
        let reportSharedLoaded = false;
        let sharedReportPresets = [];
        let pendingReportShareId = null;
        let reportHasLoaded = false;
        let reportFiltersVisible = false;
        let currentView = 'racks';
        let timeViewWeekStart = new Date();
        let timeSelectionStart = null;
        let timeSelectionEnd = null;
        let isTimeSelecting = false;
        let timeSelectionActive = false;
        let timeViewAllClients = false;
        let timeTechnicianFilter = 'all';
        let timeEntryDefaults = { clientId: null, ticketId: null };
        let teamsState = {
            tab: 'chats',
            threadTab: 'posts',
            chats: [],
            teams: [],
            channelsByTeam: {},
            chatMembersById: {},
            customSections: [],
            chatSectionMap: {},
            sectionsLoaded: false,
            graphUser: null,
            senderColors: {},
            searchQuery: '',
            messageReactions: {},
            activeEmojiPicker: null,
            replyToMessage: null,
            localMessages: [],
            messageReplies: {},
            selectedChatId: null,
            selectedTeamId: null,
            selectedChannelId: null,
            messages: [],
            previewUrl: '',
            previewName: '',
            lastLoadedAt: 0,
            loading: false
        };
        let helpdeskTickets = [];
        let helpdeskSelectedId = null;
        let helpdeskAssignees = [];
        let helpdeskAssigneesClientId = null;
        let helpdeskFilters = {
            queue: 'open',
            status: 'all',
            priority: 'all',
            clientId: 'all',
            assignee: 'all',
            search: '',
            sort: 'updated-desc'
        };
        let ateraAssets = [];
        let ateraAssetsLastSync = 0;
        let ateraAssetsLoading = false;
        let computersFilters = {
            clientId: 'all',
            type: 'all',
            status: 'all',
            search: '',
            sort: 'name-asc'
        };
        const HELP_DESK_STATUSES = [
            { id: 'open', label: 'Otevreno', tone: 'open' },
            { id: 'in-progress', label: 'V reseni', tone: 'progress' },
            { id: 'waiting', label: 'Ceka na klienta', tone: 'waiting' },
            { id: 'resolved', label: 'Vyreseno', tone: 'resolved' },
            { id: 'closed', label: 'Uzavreno', tone: 'closed' }
        ];
        const COMPUTER_TYPES = [
            { id: 'pc', label: 'PC' },
            { id: 'server', label: 'Server' },
            { id: 'other', label: 'Ostatni' }
        ];
        const COMPUTER_STATUSES = [
            { id: 'online', label: 'Online' },
            { id: 'offline', label: 'Offline' },
            { id: 'unknown', label: 'Nezname' }
        ];
        const HELP_DESK_PRIORITIES = [
            { id: 'low', label: 'Nizka', tone: 'low' },
            { id: 'medium', label: 'Stredni', tone: 'medium' },
            { id: 'high', label: 'Vysoka', tone: 'high' },
            { id: 'urgent', label: 'Kriticka', tone: 'urgent' }
        ];
        const HELP_DESK_SOURCES = [
            { id: 'manual', label: 'Manual' },
            { id: 'email', label: 'Email' },
            { id: 'phone', label: 'Telefon' },
            { id: 'teams', label: 'Teams' },
            { id: 'clickup', label: 'ClickUp' }
        ];
        const HELP_DESK_QUEUES = [
            { id: 'open', label: 'Otevrene', match: ticket => !['resolved', 'closed'].includes(ticket.status) },
            { id: 'waiting', label: 'Ceka na klienta', match: ticket => ticket.status === 'waiting' },
            { id: 'due-soon', label: 'Blizi se termin', match: ticket => isHelpdeskDueSoon(ticket) },
            { id: 'overdue', label: 'Po terminu', match: ticket => isHelpdeskOverdue(ticket) },
            { id: 'all', label: 'Vse', match: () => true }
        ];
        let externalSyncTimer = null;
        const EXTERNAL_SYNC_INTERVAL = 10 * 60 * 1000;
        let cloudSaveTimer = null;
        try {
            pendingReportShareId = new URLSearchParams(window.location.search).get('reportShare');
        } catch (err) {
            pendingReportShareId = null;
        }

        // Module types
        const DEFAULT_MODULE_TYPES = [
            { id: 'fortigate', label: 'Fortigate', color: '#f8fafc', gradient: ['#f8fafc', '#e2e8f0'], text: '#111827', group: 'Security' },
            { id: 'zyxel', label: 'Zyxel', color: '#5b1e2d', gradient: ['#5b1e2d', '#7a2438'], text: '#ffffff', group: 'Network' },
            { id: 'router', label: 'Ubiquity router', color: '#2563eb', gradient: ['#3b82f6', '#1d4ed8'], text: '#ffffff', group: 'Network' },
            { id: 'switch', label: 'Switch', color: '#6b7280', gradient: ['#6b7280', '#4b5563'], text: '#ffffff', group: 'Network' },
            { id: 'ap', label: 'Access point', color: '#f1f5f9', gradient: ['#f1f5f9', '#e2e8f0'], text: '#111827', group: 'Wireless' },
            { id: 'server', label: 'Server', color: '#fbbf24', gradient: ['#fbbf24', '#f59e0b'], text: '#111827', group: 'Compute' },
            { id: 'patch', label: 'Patch panel', color: '#00ff88', gradient: ['#00ff88', '#00cc66'], text: '#000000', group: 'Cabling' }
        ];
        let moduleTypes = [];
        let customModuleTypes = [];

        const ROLE_PERMISSIONS = {
            admin: {
                deleteRacks: true,
                editTopology: true,
                viewSensitive: true,
                manageRacks: true,
                manageDevices: true,
                manageCategories: true,
                manageRoles: true,
                manageHelpdesk: true,
                manageTime: true,
                viewTimeAll: true
            },
            technician: {
                deleteRacks: false,
                editTopology: true,
                viewSensitive: true,
                manageRacks: true,
                manageDevices: true,
                manageCategories: false,
                manageRoles: false,
                manageHelpdesk: true,
                manageTime: true,
                viewTimeAll: false
            },
            readonly: {
                deleteRacks: false,
                editTopology: false,
                viewSensitive: false,
                manageRacks: false,
                manageDevices: false,
                manageCategories: false,
                manageRoles: false,
                manageHelpdesk: false,
                manageTime: false,
                viewTimeAll: false
            },
            auditor: {
                deleteRacks: false,
                editTopology: false,
                viewSensitive: true,
                manageRacks: false,
                manageDevices: false,
                manageCategories: false,
                manageRoles: false,
                manageHelpdesk: false,
                manageTime: false,
                viewTimeAll: true
            }
        };

        const ROLE_LABELS = {
            admin: 'Admin',
            technician: 'Technik',
            readonly: 'Read-only',
            auditor: 'Auditor'
        };

        const BOOTSTRAP_ADMINS = [
            'ondrej.hriadel@cxtech.cz'
        ];

        let currentUserRole = 'readonly';

        const mspModules = [
            {
                id: 'config-backup',
                name: 'Zaloha konfiguraci',
                category: 'Backup',
                status: 'planned',
                description: 'Automaticke ukladani konfiguraci sitovych zarizeni.'
            },
            {
                id: 'compliance-audit',
                name: 'Kontrola konfiguraci',
                category: 'Security',
                status: 'planned',
                description: 'Kontrola odchylek od standardu a schvalenych sablon.'
            },
            {
                id: 'patch-management',
                name: 'Patch management',
                category: 'Maintenance',
                status: 'planned',
                description: 'Planovani a evidovani aktualizaci firmware a OS.'
            }
        ];

        const DEFAULT_TIME_ACTIVITIES = [
            'Monitoring',
            'Support',
            'Implementace',
            'Incident',
            'Maintenance',
            'Backup',
            'Audit',
            'Dokumentace'
        ];

        const TIME_GRID_START = 0;
        const TIME_GRID_END = 23;
        const HPP_MONTHLY_TARGET = 160;
        const CLIENT_COLOR_PALETTE = [
            '#f89a55',
            '#60a5fa',
            '#34d399',
            '#f472b6',
            '#facc15',
            '#a78bfa',
            '#22d3ee',
            '#fb7185'
        ];

        let timeActivities = [];

        function getClientColor(clientId) {
            if (!clientId) return CLIENT_COLOR_PALETTE[0];
            const client = clients.find((item) => item.id === clientId);
            if (client && client.color) return client.color;
            const index = clients.findIndex((item) => item.id === clientId);
            const safeIndex = index >= 0 ? index : 0;
            return CLIENT_COLOR_PALETTE[safeIndex % CLIENT_COLOR_PALETTE.length];
        }

        function getClientLabel(clientId) {
            if (!clientId) return 'Neprirazeny klient';
            const client = clients.find((item) => item.id === clientId);
            return client ? client.name : 'Neprirazeny klient';
        }

        function getFilteredTimeEntries() {
            let entries = [...timeEntries];
            if (timeTechnicianFilter && timeTechnicianFilter !== 'all') {
                entries = entries.filter((entry) => (entry.userEmail || entry.userId) === timeTechnicianFilter);
            }
            return entries;
        }

        function getRolePermissions(role) {
            return ROLE_PERMISSIONS[role] || ROLE_PERMISSIONS.readonly;
        }

        function canViewSensitive() {
            return getRolePermissions(currentUserRole).viewSensitive;
        }

        function getSensitiveValue(value) {
            return canViewSensitive() ? value : 'Skryto';
        }

        function canEditTopology() {
            return getRolePermissions(currentUserRole).editTopology;
        }

        function canManageRacks() {
            return getRolePermissions(currentUserRole).manageRacks;
        }

        function canManageDevices() {
            return getRolePermissions(currentUserRole).manageDevices;
        }

        function canManageCategories() {
            return getRolePermissions(currentUserRole).manageCategories;
        }

        function canManageRoles() {
            return getRolePermissions(currentUserRole).manageRoles;
        }

        function canDeleteRacks() {
            return getRolePermissions(currentUserRole).deleteRacks;
        }

        function canManageTimeEntries() {
            return getRolePermissions(currentUserRole).manageTime;
        }

        function canManageHelpdesk() {
            return getRolePermissions(currentUserRole).manageHelpdesk;
        }

        function canViewAllTimeEntries() {
            return getRolePermissions(currentUserRole).viewTimeAll;
        }

        function canViewReports() {
            return currentUserRole === 'admin';
        }

        function updateRoleLabel() {
            const roleLabel = document.getElementById('userRole');
            if (roleLabel) {
                const label = ROLE_LABELS[currentUserRole] || ROLE_LABELS.readonly;
                roleLabel.textContent = `Role: ${label}`;
            }
        }

        function normalizeEmailKey(email) {
            return (email || '').trim().toLowerCase().replace(/\./g, '_');
        }

        function formatAuthProviderLabel(providerId) {
            if (providerId === 'google.com') return 'Google';
            if (providerId === 'microsoft.com') return 'Microsoft 365';
            if (providerId === 'password') return 'Magic link';
            return providerId || '-';
        }

        function applyRolePermissions() {
            const addRackBtn = document.getElementById('addRackBtn');
            const clearRacksBtn = document.getElementById('clearRacksBtn');
            const addDeviceBtn = document.getElementById('addDeviceBtn');
            const addConnectionBtn = document.getElementById('addConnectionBtn');
            const moduleButtons = document.querySelectorAll('[onclick="openModuleModal()"]');
            const roleManagerBtn = document.getElementById('roleManagerBtn');
            const userManagerBtn = document.getElementById('userManagerBtn');
            const m365ManagerBtn = document.getElementById('m365ManagerBtn');
            const addTimeEntryBtn = document.getElementById('addTimeEntryBtn');
            const helpdeskNewTicketBtn = document.getElementById('helpdeskNewTicketBtn');
            const reportsNavBtn = document.querySelector('.view-toggle-btn[data-view="reports"]');
            const dashboardReportsBtn = document.getElementById('dashboardReportsBtn');
            const timeAllToggle = document.getElementById('timeAllClientsToggle');

            moduleButtons.forEach((button) => {
                button.disabled = !canManageCategories();
            });
            if (roleManagerBtn) {
                roleManagerBtn.disabled = !canManageRoles();
            }
            if (userManagerBtn) {
                userManagerBtn.disabled = !canManageRoles();
            }
            if (m365ManagerBtn) {
                m365ManagerBtn.disabled = !canManageRoles();
            }
            if (reportsNavBtn) {
                reportsNavBtn.style.display = canViewReports() ? 'block' : 'none';
            }
            if (dashboardReportsBtn) {
                dashboardReportsBtn.style.display = canViewReports() ? 'inline-flex' : 'none';
            }
            if (!canViewReports() && currentView === 'reports') {
                switchView('dashboard');
            }

            if (timeAllToggle) {
                const canViewAll = canViewAllTimeEntries();
                timeAllToggle.disabled = !canViewAll;
                if (!canViewAll && timeViewAllClients) {
                    timeViewAllClients = false;
                    timeAllToggle.checked = false;
                    localStorage.setItem('rackManagerTimeAllClients', '0');
                }
            }

            if (helpdeskNewTicketBtn) {
                helpdeskNewTicketBtn.disabled = !canManageHelpdesk();
            }

            if (!currentClientId) {
                disableControls();
                return;
            }

            if (addRackBtn) addRackBtn.disabled = !canManageRacks();
            if (clearRacksBtn) clearRacksBtn.disabled = !canDeleteRacks();
            if (addDeviceBtn) addDeviceBtn.disabled = !canManageDevices();
            if (addConnectionBtn) addConnectionBtn.disabled = !canEditTopology();
            if (addTimeEntryBtn) addTimeEntryBtn.disabled = !canManageTimeEntries();
        }

        function setCurrentRole(role) {
            currentUserRole = ROLE_PERMISSIONS[role] ? role : 'readonly';
            updateRoleLabel();
            applyRolePermissions();
            applyTimeDefaultsForRole();
            renderDashboard();
        }

        async function fetchUserRole() {
            if (!currentClientId || !window.auth || !window.db || !auth.currentUser) {
                setCurrentRole('readonly');
                return;
            }

            try {
                const uid = auth.currentUser.uid;
                const email = (auth.currentUser.email || '').toLowerCase();
                const isBootstrapAdmin = BOOTSTRAP_ADMINS.includes(email);
                const clientDoc = db.collection('clients').doc(currentClientId);
                const usersRef = clientDoc.collection('users');
                const userRef = usersRef.doc(uid);

                const [userSnap, usersSnap] = await Promise.all([
                    userRef.get(),
                    usersRef.limit(1).get()
                ]);

                const existing = userSnap.exists ? userSnap.data() : {};
                let role = existing && existing.role ? existing.role : 'technician';

                if (usersSnap.empty) {
                    role = 'admin';
                }

                if ((!existing || !existing.role) && auth.currentUser.email) {
                    const emailKey = normalizeEmailKey(auth.currentUser.email);
                    const inviteSnap = await clientDoc.collection('roleInvites').doc(emailKey).get();
                    if (inviteSnap.exists) {
                        const invite = inviteSnap.data();
                        if (invite && invite.role) {
                            role = invite.role;
                        }
                    }
                }

                if (isBootstrapAdmin) {
                    role = 'admin';
                }

                const providerData = auth.currentUser.providerData || [];
                const providerIds = providerData.map((item) => item.providerId).filter(Boolean);
                const preferredProvider = providerIds.includes('microsoft.com')
                    ? 'microsoft.com'
                    : providerIds.includes('google.com')
                        ? 'google.com'
                        : providerIds[0];
                const primaryProvider = preferredProvider || auth.currentUser.providerId || '';
                const providerLabel = formatAuthProviderLabel(primaryProvider);

                await userRef.set({
                    role: role,
                    email: auth.currentUser.email || '',
                    name: auth.currentUser.displayName || '',
                    providerId: primaryProvider,
                    providerLabel: providerLabel,
                    providers: providerIds,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                setCurrentRole(role);
            } catch (err) {
                console.warn('Role fetch failed:', err);
                setCurrentRole('readonly');
            }
        }

        window.onAuthRoleChanged = function (user) {
            if (user && currentClientId) {
                fetchUserRole();
                initTimeTracking();
            } else {
                setCurrentRole('readonly');
            }
        };

        async function openRoleManagerModal() {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            if (!canManageRoles()) {
                alert('Nemate opravneni spravovat role');
                return;
            }
            await loadRoleManagerList();
            document.getElementById('roleManagerModal').classList.add('active');
        }

        function closeRoleManagerModal() {
            document.getElementById('roleManagerModal').classList.remove('active');
        }

        function getM365Config() {
            const defaults = {
                enabled: true,
                tenantId: '',
                clientId: '',
                clientSecret: '',
                redirectUri: '',
                scopes: 'openid profile email offline_access User.Read',
                allowedDomains: ['cxtech.cz']
            };
            try {
                const stored = JSON.parse(localStorage.getItem('rackManagerM365Config') || '{}');
                return { ...defaults, ...(stored || {}) };
            } catch (err) {
                return { ...defaults };
            }
        }

        function setM365Config(config) {
            localStorage.setItem('rackManagerM365Config', JSON.stringify(config || {}));
            scheduleCloudSave();
        }

        function populateM365Form() {
            const config = getM365Config();
            const enableSelect = document.getElementById('m365EnableLogin');
            const tenantInput = document.getElementById('m365TenantId');
            const clientInput = document.getElementById('m365ClientId');
            const secretInput = document.getElementById('m365ClientSecret');
            const redirectInput = document.getElementById('m365RedirectUri');
            const scopesInput = document.getElementById('m365Scopes');
            const allowedDomainsInput = document.getElementById('m365AllowedDomains');
            const defaultRedirect = window.location.origin + window.location.pathname;

            if (enableSelect) enableSelect.value = config.enabled ? '1' : '0';
            if (tenantInput) tenantInput.value = config.tenantId || '';
            if (clientInput) clientInput.value = config.clientId || '';
            if (secretInput) secretInput.value = config.clientSecret || '';
            if (redirectInput) redirectInput.value = config.redirectUri || defaultRedirect;
            if (scopesInput) scopesInput.value = config.scopes || '';
            if (allowedDomainsInput) {
                allowedDomainsInput.value = (config.allowedDomains || []).join(', ');
            }
        }

        function openM365Modal() {
            if (!canManageRoles()) {
                alert('Nemate opravneni spravovat nastaveni');
                return;
            }
            const modal = document.getElementById('m365Modal');
            if (!modal) return;
            populateM365Form();
            modal.classList.add('active');
        }

        function closeM365Modal() {
            const modal = document.getElementById('m365Modal');
            if (modal) modal.classList.remove('active');
        }

        function saveM365Config() {
            const enableSelect = document.getElementById('m365EnableLogin');
            const tenantInput = document.getElementById('m365TenantId');
            const clientInput = document.getElementById('m365ClientId');
            const secretInput = document.getElementById('m365ClientSecret');
            const redirectInput = document.getElementById('m365RedirectUri');
            const scopesInput = document.getElementById('m365Scopes');
            const allowedDomainsInput = document.getElementById('m365AllowedDomains');

            const config = {
                enabled: enableSelect ? enableSelect.value === '1' : true,
                tenantId: tenantInput ? tenantInput.value.trim() : '',
                clientId: clientInput ? clientInput.value.trim() : '',
                clientSecret: secretInput ? secretInput.value.trim() : '',
                redirectUri: redirectInput ? redirectInput.value.trim() : '',
                scopes: scopesInput ? scopesInput.value.trim() : '',
                allowedDomains: normalizeDomainList(allowedDomainsInput ? allowedDomainsInput.value : '')
            };

            if (config.tenantId && !isGuid(config.tenantId)) {
                alert('Tenant ID ma neplatny format.');
                return;
            }

            if (!config.redirectUri) {
                config.redirectUri = window.location.origin + window.location.pathname;
            }

            setM365Config(config);
            if (window.updateAuthUI && window.auth) {
                window.updateAuthUI(window.auth.currentUser);
            }
            closeM365Modal();
        }

        function clearM365Config() {
            localStorage.removeItem('rackManagerM365Config');
            scheduleCloudSave();
            populateM365Form();
            if (window.updateAuthUI && window.auth) {
                window.updateAuthUI(window.auth.currentUser);
            }
        }

        function useCurrentRedirectUri() {
            const input = document.getElementById('m365RedirectUri');
            if (!input) return;
            input.value = window.location.origin + window.location.pathname;
        }

        function isGuid(value) {
            return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(value || '');
        }

        function normalizeDomain(value) {
            return (value || '').trim().toLowerCase().replace(/^@/, '');
        }

        function normalizeDomainList(value) {
            return (value || '')
                .split(/[\s,;]+/)
                .map(normalizeDomain)
                .filter(Boolean)
                .filter((item, index, arr) => arr.indexOf(item) === index);
        }

        function getAllowedDomains() {
            const config = getM365Config();
            return Array.isArray(config.allowedDomains)
                ? config.allowedDomains.map(normalizeDomain).filter(Boolean)
                : [];
        }

        function isDomainAllowed(email) {
            const domains = getAllowedDomains();
            if (!domains.length) return true;
            const parts = (email || '').toLowerCase().split('@');
            const domain = parts.length > 1 ? parts[1] : '';
            if (!domain) return false;
            return domains.includes(domain);
        }

        async function loadRoleManagerList() {
            if (!window.db || !currentClientId) return;
            try {
                const clientDoc = db.collection('clients').doc(currentClientId);
                const [usersSnap, invitesSnap] = await Promise.all([
                    clientDoc.collection('users').get(),
                    clientDoc.collection('roleInvites').get()
                ]);

                const users = {};
                usersSnap.forEach((doc) => {
                    users[doc.id] = doc.data();
                });

                const invites = {};
                invitesSnap.forEach((doc) => {
                    invites[doc.id] = doc.data();
                });

                renderRoleManagerList(users, invites);
            } catch (err) {
                console.warn('Role list load failed:', err);
            }
        }

        async function addRoleInvite() {
            if (!canManageRoles()) {
                alert('Nemate opravneni spravovat role');
                return;
            }
            if (!window.db || !currentClientId) return;

            const emailInput = document.getElementById('roleInviteEmail');
            const roleSelect = document.getElementById('roleInviteRole');
            const email = emailInput ? emailInput.value.trim().toLowerCase() : '';
            const role = roleSelect ? roleSelect.value : 'technician';

            if (!email || !email.includes('@')) {
                alert('Zadejte platny email');
                return;
            }

            const safeRole = ROLE_PERMISSIONS[role] ? role : 'readonly';
            const emailKey = normalizeEmailKey(email);

            try {
                await db.collection('clients')
                    .doc(currentClientId)
                    .collection('roleInvites')
                    .doc(emailKey)
                    .set({
                        email: email,
                        role: safeRole,
                        invitedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                if (emailInput) emailInput.value = '';
                await loadRoleManagerList();
            } catch (err) {
                console.warn('Role invite failed:', err);
            }
        }

        async function removeRoleInvite(emailKey) {
            if (!canManageRoles()) {
                alert('Nemate opravneni spravovat role');
                return;
            }
            if (!window.db || !currentClientId) return;
            try {
                await db.collection('clients')
                    .doc(currentClientId)
                    .collection('roleInvites')
                    .doc(emailKey)
                    .delete();
                await loadRoleManagerList();
            } catch (err) {
                console.warn('Role invite remove failed:', err);
            }
        }

        function renderRoleManagerList(users, invites) {
            const container = document.getElementById('roleManagerList');
            if (!container) return;
            const entries = Object.entries(users || {});
            const inviteEntries = Object.entries(invites || {});

            const roleOptions = Object.keys(ROLE_LABELS)
                .map((role) => `<option value="${role}">${ROLE_LABELS[role]}</option>`)
                .join('');

            const userRows = entries.map(([uid, user]) => {
                const email = user.email || uid;
                const name = user.name || '';
                const providerId = user.providerId || (user.providers && user.providers[0]) || '';
                const providerLabel = user.providerLabel || formatAuthProviderLabel(providerId);
                return `
                    <tr>
                        <td>${name || '-'}</td>
                        <td>${email}</td>
                        <td>${providerLabel}</td>
                        <td>
                            <select class="role-select" onchange="updateUserRole('${uid}', this.value)">
                                ${roleOptions}
                            </select>
                        </td>
                    </tr>
                `;
            });

            const inviteRows = inviteEntries.map(([emailKey, invite]) => {
                return `
                    <tr>
                        <td>${invite.email || emailKey}</td>
                        <td>${ROLE_LABELS[invite.role] || invite.role || 'Read-only'}</td>
                        <td>
                            <button class="delete-btn" onclick="removeRoleInvite('${emailKey}')">Odebrat</button>
                        </td>
                    </tr>
                `;
            });

            const userTable = entries.length
                ? `
                    <table class="role-manager-table">
                        <thead>
                            <tr>
                                <th>Uzivatel</th>
                                <th>Email / UID</th>
                                <th>Prihlaseni</th>
                                <th>Role</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${userRows.join('')}
                        </tbody>
                    </table>
                `
                : '<div class="empty-state"><p>Zadni uzivatele</p></div>';

            const inviteTable = inviteEntries.length
                ? `
                    <div class="role-invite-list">
                        <div class="role-note">Pozvanky</div>
                        <table class="role-manager-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Akce</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${inviteRows.join('')}
                            </tbody>
                        </table>
                    </div>
                `
                : '';

            container.innerHTML = userTable + inviteTable;

            entries.forEach(([uid, user], index) => {
                const select = container.querySelectorAll('.role-select')[index];
                if (select) {
                    select.value = user.role || 'readonly';
                }
            });
        }

        async function updateUserRole(uid, role) {
            if (!canManageRoles()) {
                alert('Nemate opravneni spravovat role');
                return;
            }
            if (!window.db || !currentClientId) return;
            try {
                const safeRole = ROLE_PERMISSIONS[role] ? role : 'readonly';
                await db.collection('clients')
                    .doc(currentClientId)
                    .collection('users')
                    .doc(uid)
                    .set({
                        role: safeRole,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                if (auth && auth.currentUser && uid === auth.currentUser.uid) {
                    setCurrentRole(safeRole);
                }
            } catch (err) {
                console.warn('Role update failed:', err);
            }
        }

        function renderMspModules(targetId) {
            const grid = document.getElementById(targetId || 'mspModulesGrid');
            if (!grid) return;

            const cards = mspModules.map((module) => {
                const statusLabel = module.status === 'active' ? 'Active' : 'Planned';
                return `
                    <div class="msp-module-card">
                        <div class="msp-module-meta">${module.category}</div>
                        <div class="msp-module-title">${module.name}</div>
                        <div class="msp-module-desc">${module.description}</div>
                        <div class="msp-module-status">${statusLabel}</div>
                    </div>
                `;
            });

            grid.innerHTML = cards.join('');
        }

        function buildPricingSummary(client) {
            if (!client) return '-';
            const mode = client.pricingMode || 'retainer-hours';
            const retainerAmount = Number(client.retainerAmount) || 0;
            const retainerHours = Number(client.retainerHours) || 0;
            const hourlyRate = Number(client.hourlyRate) || 0;
            const overageRate = Number(client.overageRate) || 0;

            if (mode === 'retainer-hourly') {
                const amount = retainerAmount ? `${retainerAmount} Kc` : '-';
                const rate = hourlyRate ? `${hourlyRate} Kc/h` : '-';
                return `Pausal ${amount} + ${rate}`;
            }
            if (mode === 'retainer-unlimited') {
                const amount = retainerAmount ? `${retainerAmount} Kc` : '-';
                return `Pausal ${amount}, neomezeno`;
            }
            const amount = retainerAmount ? `${retainerAmount} Kc` : '-';
            const hours = retainerHours ? `${retainerHours} h` : '- h';
            const over = overageRate ? `${overageRate} Kc/h` : '-';
            return `Pausal ${amount} / ${hours}, nad ${over}`;
        }

        function renderClientOverview() {
            const grid = document.getElementById('overviewGrid');
            const name = document.getElementById('overviewClientName');
            const logo = document.getElementById('overviewClientLogo');
            const pricingEl = document.getElementById('overviewClientPricing');
            if (!grid) return;

            const client = clients.find((c) => c.id === currentClientId);
            if (name) {
                name.textContent = client ? client.name : '-';
            }
            if (pricingEl) {
                pricingEl.textContent = client ? buildPricingSummary(client) : '-';
            }
            if (logo) {
                const logoUrl = client ? (client.logoUrl || client.logo) : '';
                if (logoUrl) {
                    const safeName = client?.name || 'Klient';
                    logo.innerHTML = `<img src="${logoUrl}" alt="Logo ${safeName}">`;
                } else {
                    const parts = (client?.name || '').trim().split(/\s+/).filter(Boolean);
                    const initials = parts.slice(0, 2).map((part) => part[0]).join('').toUpperCase();
                    logo.textContent = initials || 'LOGO';
                }
            }

            const totalUnits = racks.reduce((sum, rack) => sum + rack.units, 0);
            const usedUnits = devices.reduce((sum, device) => sum + device.height, 0);
            const freeUnits = Math.max(totalUnits - usedUnits, 0);
            const types = moduleTypes.length ? moduleTypes : DEFAULT_MODULE_TYPES;
            const typeCounts = types.map((type) => ({
                id: type.id,
                label: type.label || getModuleTypeLabel(type.id),
                count: devices.filter((device) => device.type === type.id).length
            }));
            const keepIds = ['switch', 'ap'];
            const deviceTypeCards = typeCounts
                .filter((item) => item.count > 0 || keepIds.includes(item.id))
                .map((item) => ({
                    title: item.label,
                    value: item.count,
                    desc: 'Zarizeni dle typu',
                    view: 'racks'
                }));

            const cards = [
                {
                    title: 'Racky',
                    value: racks.length,
                    desc: 'Sprava fyzickych racku',
                    view: 'racks'
                },
                {
                    title: 'Zarizeni',
                    value: devices.length,
                    desc: 'Aktivni inventar zarizeni',
                    view: 'racks'
                },
                {
                    title: 'Propojeni',
                    value: connections.length,
                    desc: 'Topologie a linky',
                    view: 'network'
                },
                {
                    title: 'Volne U',
                    value: freeUnits,
                    desc: 'Kapacita pro rozsireni',
                    view: 'racks'
                },
                ...deviceTypeCards,
                {
                    title: 'Hodiny tento mesic',
                    value: '-',
                    valueId: 'overviewMonthHours',
                    desc: 'Vykazano za aktualni mesic',
                    view: 'time'
                }
            ];

            grid.innerHTML = cards.map((card) => `
                <div class="overview-card" onclick="switchView('${card.view}')">
                    <div class="overview-card-title">${card.title}</div>
                    <div class="overview-card-value"${card.valueId ? ` id="${card.valueId}"` : ''}>${card.value}</div>
                    <div class="overview-card-desc">${card.desc}</div>
                </div>
            `).join('');

            renderMspModules();
            loadOverviewMonthHours();
        }

        function triggerClientLogoUpload() {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            const input = document.getElementById('clientLogoInput');
            if (!input) return;
            input.value = '';
            input.click();
        }

        function handleClientLogoUpload(event) {
            const input = event && event.target ? event.target : null;
            const file = input && input.files ? input.files[0] : null;
            if (!file) return;
            if (!file.type || !file.type.startsWith('image/')) {
                alert('Vyberte obrazek (PNG/JPG/SVG).');
                return;
            }
            const maxBytes = 400 * 1024;
            if (file.size > maxBytes) {
                alert('Logo je prilis velke. Max 400 KB.');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(loadEvent) {
                const dataUrl = loadEvent && loadEvent.target ? loadEvent.target.result : '';
                const client = clients.find((item) => item.id === currentClientId);
                if (!client || !dataUrl) return;
                client.logoUrl = dataUrl;
                client.logoUpdatedAt = new Date().toISOString();
                saveData();
                renderClientOverview();
                updateClientInfo();
            };
            reader.readAsDataURL(file);
        }

        function clearClientLogo() {
            const client = clients.find((item) => item.id === currentClientId);
            if (!client) return;
            delete client.logoUrl;
            delete client.logo;
            saveData();
            renderClientOverview();
            updateClientInfo();
        }

        async function loadOverviewMonthHours() {
            const valueEl = document.getElementById('overviewMonthHours');
            if (!valueEl) return;
            if (!currentClientId || !window.db || !window.auth || !auth.currentUser) {
                valueEl.textContent = '-';
                return;
            }
            const now = new Date();
            const start = formatDateKey(new Date(now.getFullYear(), now.getMonth(), 1));
            const end = formatDateKey(now);
            try {
                const snapshot = await db.collection('clients')
                    .doc(currentClientId)
                    .collection('timeEntries')
                    .where('date', '>=', start)
                    .where('date', '<=', end)
                    .get();
                const total = snapshot.docs.reduce((sum, doc) => sum + (parseFloat(doc.data().hours) || 0), 0);
                valueEl.textContent = `${total} h`;
            } catch (err) {
                console.warn('Overview month hours load failed:', err);
                valueEl.textContent = '-';
            }
        }

        function getClientSnapshot(clientId) {
            if (clientId === currentClientId) {
                return {
                    racks: racks || [],
                    devices: devices || [],
                    connections: connections || []
                };
            }
            const data = clientData[clientId] || {};
            return {
                racks: data.racks || [],
                devices: data.devices || [],
                connections: data.connections || []
            };
        }

        function getAggregateStats() {
            const totals = {
                clients: clients.length,
                racks: 0,
                devices: 0,
                connections: 0
            };

            clients.forEach((client) => {
                const snapshot = getClientSnapshot(client.id);
                totals.racks += snapshot.racks.length;
                totals.devices += snapshot.devices.length;
                totals.connections += snapshot.connections.length;
            });

            return totals;
        }

        function renderDashboard() {
            const grid = document.getElementById('dashboardGrid');
            const roleEl = document.getElementById('dashboardRole');
            const clientEl = document.getElementById('dashboardClient');
            if (!grid) return;

            const totals = getAggregateStats();
            const client = clients.find((c) => c.id === currentClientId);
            const roleLabel = ROLE_LABELS[currentUserRole] || ROLE_LABELS.readonly;

            if (roleEl) roleEl.textContent = roleLabel;
            if (clientEl) clientEl.textContent = client ? client.name : 'Nezvoleno';

            const cards = [
                {
                    title: 'Klienti',
                    value: totals.clients,
                    desc: 'Prehled spravovanych klientu',
                    action: "openClientManagerModal()"
                },
                {
                    title: 'Racky',
                    value: totals.racks,
                    desc: 'Celkem racku napric klienty',
                    action: currentClientId ? "switchView('racks')" : "openClientManagerModal()"
                },
                {
                    title: 'Zarizeni',
                    value: totals.devices,
                    desc: 'Inventar zarizeni',
                    action: currentClientId ? "switchView('racks')" : "openClientManagerModal()"
                },
                {
                    title: 'Propojeni',
                    value: totals.connections,
                    desc: 'Topologie a linky',
                    action: currentClientId ? "switchView('network')" : "openClientManagerModal()"
                }
            ];

            grid.innerHTML = cards.map((card) => `
                <div class="overview-card" onclick="${card.action}">
                    <div class="overview-card-title">${card.title}</div>
                    <div class="overview-card-value">${card.value}</div>
                    <div class="overview-card-desc">${card.desc}</div>
                </div>
            `).join('');

            renderMspModules('dashboardModulesGrid');
            loadDashboardTimeOverview();
            updateDashboardHeroForRole();
            applyRolePermissions();
        }

        function updateDashboardHeroForRole() {
            const showChartOnly = true;
            const kicker = document.getElementById('dashboardHeroKicker');
            const title = document.getElementById('dashboardHeroTitle');
            const subtitle = document.getElementById('dashboardHeroSubtitle');
            const metrics = document.getElementById('dashboardHeroMetrics');
            const chart = document.getElementById('dashboardHoursChart');

            if (kicker) kicker.style.display = showChartOnly ? 'none' : '';
            if (title) title.style.display = showChartOnly ? 'none' : '';
            if (subtitle) subtitle.style.display = showChartOnly ? 'none' : '';
            if (metrics) metrics.style.display = showChartOnly ? 'none' : 'grid';
            if (chart) chart.style.display = showChartOnly ? 'grid' : 'none';
        }

        function getEntryTechKey(entry) {
            return entry.userEmail || entry.userId || 'Neprirazeno';
        }

        function renderDashboardDailyChart(entries, startKey, endKey) {
            const chart = document.getElementById('dashboardHoursChart');
            const grid = document.getElementById('dashboardHoursGrid');
            if (!chart || !grid) return;

            const startDate = parseDateKey(startKey);
            const endDate = parseDateKey(endKey);
            if (!startDate || !endDate) {
                grid.innerHTML = '';
                return;
            }

            const totalsByDay = {};
            (entries || []).forEach((entry) => {
                if (!entry.date) return;
                const hours = parseFloat(entry.hours) || 0;
                totalsByDay[entry.date] = (totalsByDay[entry.date] || 0) + hours;
            });

            const days = [];
            const cursor = new Date(startDate);
            while (cursor <= endDate) {
                const key = formatDateKey(cursor);
                days.push({ key, day: cursor.getDate() });
                cursor.setDate(cursor.getDate() + 1);
            }

            const maxHours = Math.max(0, ...days.map((day) => totalsByDay[day.key] || 0));
            const labelStep = days.length > 20 ? 5 : days.length > 12 ? 3 : 1;

            grid.innerHTML = days.map((day, index) => {
                const hours = totalsByDay[day.key] || 0;
                const height = maxHours ? Math.max(6, Math.round((hours / maxHours) * 100)) : 6;
                const showLabel = day.day === 1 || index === days.length - 1 || day.day % labelStep === 0;
                const hoursLabel = Math.round(hours * 10) / 10;
                return `
                    <div class="dashboard-hours-bar" title="${day.key}: ${hoursLabel} h">
                        <span class="dashboard-hours-fill${hours ? '' : ' is-empty'}" style="height: ${height}%;"></span>
                        <span class="dashboard-hours-label">${showLabel ? day.day : ''}</span>
                    </div>
                `;
            }).join('');
        }

        function resolveTimeEntryCategory(entry) {
            const direct = (entry.categoryType || '').toString().toLowerCase();
            if (direct === 'client' || direct === 'internal' || direct === 'leave') {
                return direct;
            }
            const raw = `${entry.category || ''} ${entry.activity || ''} ${entry.description || ''}`.toLowerCase();
            if (raw.includes('dovol')) return 'leave';
            if (raw.includes('intern')) return 'internal';
            return 'client';
        }

        function buildDashboardTechFilter(entries, selectedValue) {
            const select = document.getElementById('dashboardTechSelect');
            if (!select) return 'all';
            const techMap = new Map();
            entries.forEach((entry) => {
                const key = getEntryTechKey(entry);
                if (!techMap.has(key)) {
                    techMap.set(key, entry.userEmail || entry.userId || 'Neprirazeno');
                }
            });
            const options = ['<option value="all">Vsechni technici</option>'];
            techMap.forEach((label, key) => {
                options.push(`<option value="${key}">${label}</option>`);
            });
            select.innerHTML = options.join('');
            const nextValue = selectedValue && (selectedValue === 'all' || techMap.has(selectedValue))
                ? selectedValue
                : 'all';
            select.value = nextValue;
            return nextValue;
        }

        function buildDashboardCategoryList(totals) {
            const items = [
                { key: 'client', label: 'Klientske hodiny' },
                { key: 'internal', label: 'Interni' },
                { key: 'leave', label: 'Dovolena' }
            ];
            return items.map((item) => {
                const value = Math.round((totals[item.key] || 0) * 10) / 10;
                return `
                    <div class="dashboard-category-row">
                        <span class="dashboard-category-label">${item.label}</span>
                        <span class="dashboard-category-value">${value} h</span>
                    </div>
                `;
            }).join('');
        }

        async function loadDashboardTimeOverview() {
            const totalEl = document.getElementById('dashboardMonthTotal');
            const remainingEl = document.getElementById('dashboardMonthRemaining');
            const progressEl = document.getElementById('dashboardMonthProgress');
            const listEl = document.getElementById('dashboardTechHours');
            const filterWrap = document.getElementById('dashboardTechFilter');
            const filterSelect = document.getElementById('dashboardTechSelect');
            const categoryList = document.getElementById('dashboardCategoryList');
            const titleEl = document.getElementById('dashboardTechTitle');
            if (!totalEl || !remainingEl || !progressEl || !listEl) return;

            const isAdminView = canViewAllTimeEntries();
            if (filterWrap) {
                filterWrap.style.display = isAdminView ? 'grid' : 'none';
            }
            if (titleEl) {
                titleEl.textContent = isAdminView ? 'Technici' : 'Moje hodiny';
            }

            totalEl.textContent = '-';
            remainingEl.textContent = `Zbyva do HPP: - h`;
            progressEl.style.width = '0%';
            listEl.innerHTML = '<div class="dashboard-tech-row"><span class="dashboard-tech-name">Zadne vykazy</span><span class="dashboard-tech-hours">-</span></div>';
            if (categoryList) {
                categoryList.innerHTML = buildDashboardCategoryList({ client: 0, internal: 0, leave: 0 });
            }

            const now = new Date();
            const start = formatDateKey(new Date(now.getFullYear(), now.getMonth(), 1));
            const end = formatDateKey(now);

            if (!currentClientId || !window.db || !window.auth || !auth.currentUser) {
                renderDashboardDailyChart([], start, end);
                if (filterSelect) {
                    filterSelect.innerHTML = '<option value="all">Vsechni technici</option>';
                }
                return;
            }

            try {
                let ref = db.collection('clients')
                    .doc(currentClientId)
                    .collection('timeEntries')
                    .where('date', '>=', start)
                    .where('date', '<=', end);
                if (!isAdminView) {
                    ref = ref.where('userId', '==', auth.currentUser.uid);
                }
                const snapshot = await ref.get();

                const entries = snapshot.docs.map((doc) => ({
                    id: doc.id,
                    ...doc.data()
                }));
                let selectedTech = 'all';
                if (isAdminView) {
                    selectedTech = buildDashboardTechFilter(entries, filterSelect ? filterSelect.value : 'all');
                }
                if (titleEl) {
                    titleEl.textContent = isAdminView
                        ? (selectedTech !== 'all' ? 'Vybrany technik' : 'Technici')
                        : 'Moje hodiny';
                }

                const filteredEntries = isAdminView && selectedTech !== 'all'
                    ? entries.filter((entry) => getEntryTechKey(entry) === selectedTech)
                    : entries;

                const totalsByTech = {};
                const categoryTotals = { client: 0, internal: 0, leave: 0 };
                let totalHours = 0;
                filteredEntries.forEach((entry) => {
                    const hours = parseFloat(entry.hours) || 0;
                    totalHours += hours;
                    const tech = getEntryTechKey(entry);
                    totalsByTech[tech] = (totalsByTech[tech] || 0) + hours;
                    const categoryKey = resolveTimeEntryCategory(entry);
                    categoryTotals[categoryKey] = (categoryTotals[categoryKey] || 0) + hours;
                });
                renderDashboardDailyChart(filteredEntries, start, end);

                const roundedTotal = Math.round(totalHours * 10) / 10;
                totalEl.textContent = `${roundedTotal} h`;
                const remaining = Math.max(HPP_MONTHLY_TARGET - totalHours, 0);
                const roundedRemaining = Math.round(remaining * 10) / 10;
                remainingEl.textContent = `Zbyva do HPP: ${roundedRemaining} h z ${HPP_MONTHLY_TARGET} h`;
                const progress = HPP_MONTHLY_TARGET ? Math.min((totalHours / HPP_MONTHLY_TARGET) * 100, 100) : 0;
                progressEl.style.width = `${Math.round(progress)}%`;
                if (categoryList) {
                    categoryList.innerHTML = buildDashboardCategoryList(categoryTotals);
                }

                const rows = Object.entries(totalsByTech)
                    .sort((a, b) => b[1] - a[1]);
                if (!rows.length) {
                    listEl.innerHTML = '<div class="dashboard-tech-row"><span class="dashboard-tech-name">Zadne vykazy</span><span class="dashboard-tech-hours">-</span></div>';
                    return;
                }

                const maxList = 5;
                const visibleRows = rows.slice(0, maxList);
                const overflow = rows.length - visibleRows.length;
                const listHtml = visibleRows.map(([name, hours]) => {
                    const rounded = Math.round(hours * 10) / 10;
                    const width = totalHours ? Math.max(6, Math.round((hours / totalHours) * 100)) : 0;
                    return `
                        <div>
                            <div class="dashboard-tech-row">
                                <span class="dashboard-tech-name">${name}</span>
                                <span class="dashboard-tech-hours">${rounded} h</span>
                            </div>
                            <div class="dashboard-tech-bar"><span style="width: ${width}%"></span></div>
                        </div>
                    `;
                }).join('');
                listEl.innerHTML = listHtml + (overflow > 0
                    ? `<div class="dashboard-tech-row"><span class="dashboard-tech-name">+${overflow} dalsich</span><span class="dashboard-tech-hours"></span></div>`
                    : '');
            } catch (err) {
                console.warn('Dashboard time overview failed:', err);
                totalEl.textContent = '-';
                remainingEl.textContent = `Zbyva do HPP: - h`;
                progressEl.style.width = '0%';
                listEl.innerHTML = '<div class="dashboard-tech-row"><span class="dashboard-tech-name">Nacitani selhalo</span><span class="dashboard-tech-hours">-</span></div>';
            }
        }

        function mergeExternalClients(source, externalClients) {
            const cleaned = (externalClients || [])
                .filter((client) => client && client.id && client.name)
                .map((client) => ({
                    ...client,
                    source: source,
                    type: client.type || source
                }));

            const preserved = clients.filter((client) => client.source !== source);
            clients = [...preserved, ...cleaned].sort((a, b) =>
                a.name.localeCompare(b.name, 'cs', { sensitivity: 'base' })
            );
        }

        async function syncZabbixClients(options = {}) {
            try {
                const response = await fetch('/api/zabbix-hostgroups');
                if (!response.ok) {
                    if (!options.silent) {
                        console.warn('Zabbix sync failed:', response.status);
                    }
                    return;
                }
                const data = await response.json();
                if (!data || !Array.isArray(data.groups)) return;

                const zabbixClients = data.groups.map((group) => ({
                    id: `zbx-${group.id}`,
                    name: group.name,
                    type: 'zabbix',
                    source: 'zabbix',
                    createdAt: new Date().toISOString()
                }));

                mergeExternalClients('zabbix', zabbixClients);
            } catch (err) {
                if (!options.silent) {
                    console.warn('Zabbix sync failed:', err);
                }
            }
        }

        async function syncAteraClients(options = {}) {
            try {
                const response = await fetch('/api/atera-customers');
                if (!response.ok) {
                    if (!options.silent) {
                        console.warn('Atera sync failed:', response.status);
                    }
                    return;
                }
                const data = await response.json();
                const items = Array.isArray(data.customers)
                    ? data.customers
                    : Array.isArray(data.items)
                        ? data.items
                        : [];
                if (!items.length) return;

                const ateraClients = items.map((item) => {
                    const rawId = item.id || item.customerId || item.customerID || item.CompanyID || item.companyId || item.companyID || item.CustomerID;
                    const name = item.name || item.customerName || item.CustomerName || item.CompanyName || item.companyName || item.displayName;
                    if (!rawId || !name) return null;
                    return {
                        id: `atera-${rawId}`,
                        externalId: String(rawId),
                        name: name,
                        type: 'atera',
                        source: 'atera',
                        createdAt: new Date().toISOString()
                    };
                }).filter(Boolean);

                mergeExternalClients('atera', ateraClients);
            } catch (err) {
                if (!options.silent) {
                    console.warn('Atera sync failed:', err);
                }
            }
        }

        async function syncExternalClients(options = {}) {
            await syncZabbixClients(options);
            await syncAteraClients(options);
            if (!options.skipRender) {
                updateClientSelector();
                updateClientInfo();
                render();
            }
        }

        function parseAteraDate(value) {
            if (!value) return null;
            const date = new Date(value);
            if (!Number.isNaN(date.getTime())) return date;
            return null;
        }

        function getAteraAssetType(asset) {
            const typeValue = (asset.deviceType || asset.typeLabel || '').toString().toLowerCase();
            const osValue = (asset.os || '').toString().toLowerCase();
            if (typeValue.includes('server') || osValue.includes('server')) return 'server';
            if (typeValue.includes('workstation') || typeValue.includes('desktop') || typeValue.includes('laptop') || typeValue.includes('pc')) return 'pc';
            if (osValue.includes('windows') || osValue.includes('mac') || osValue.includes('linux')) return 'pc';
            return 'other';
        }

        function getAteraAssetStatus(asset) {
            const raw = asset.status;
            if (typeof raw === 'boolean') return raw ? 'online' : 'offline';
            if (typeof raw === 'number') return raw === 1 ? 'online' : raw === 0 ? 'offline' : 'unknown';
            if (typeof raw === 'string') {
                const value = raw.toLowerCase();
                if (value.includes('online') || value === 'up') return 'online';
                if (value.includes('offline') || value === 'down') return 'offline';
            }
            if (asset.lastSeenAt) {
                const diff = Date.now() - asset.lastSeenAt.getTime();
                if (diff <= 6 * 60 * 60 * 1000) return 'online';
                if (diff > 6 * 60 * 60 * 1000) return 'offline';
            }
            return 'unknown';
        }

        function getComputersTypeLabel(typeId) {
            const entry = COMPUTER_TYPES.find(item => item.id === typeId);
            return entry ? entry.label : typeId;
        }

        function getComputersStatusLabel(statusId) {
            const entry = COMPUTER_STATUSES.find(item => item.id === statusId);
            return entry ? entry.label : statusId;
        }

        function normalizeAteraAsset(item) {
            if (!item) return null;
            const rawId = item.AgentId || item.AgentID || item.agentId || item.agentID || item.id || item.ID;
            const name = item.MachineName || item.machineName || item.DeviceName || item.deviceName || item.ComputerName || item.computerName || item.name || item.Name;
            if (!rawId || !name) return null;

            const clientId = item.CustomerID || item.CustomerId || item.customerId || item.customerID || item.CompanyId || item.CompanyID || item.companyId || item.companyID;
            const clientName = item.CustomerName || item.customerName || item.CompanyName || item.companyName || item.ClientName || item.clientName;
            const os = item.OS || item.os || item.Os || item.operatingSystem || item.OperatingSystem;
            const ip = item.IPAddress || item.ipAddress || item.IpAddress || item.ip || item.IP;
            const user = item.UserName || item.userName || item.LoggedInUser || item.loggedInUser || item.LastLoggedInUser;
            const status = item.AgentStatus || item.agentStatus || item.Status || item.status || item.OnlineStatus || item.onlineStatus || item.IsOnline || item.isOnline || item.Online;
            const lastSeenRaw = item.LastSeen || item.lastSeen || item.LastSeenTime || item.lastSeenTime || item.LastSeenAt || item.lastSeenAt;
            const lastSeenAt = parseAteraDate(lastSeenRaw);
            const deviceType = item.DeviceType || item.deviceType || item.DeviceTypeDescription || item.deviceTypeDescription || item.AgentType;

            return {
                id: `atera-agent-${rawId}`,
                externalId: String(rawId),
                name,
                clientId: clientId ? `atera-${clientId}` : '',
                clientName: clientName || '',
                os: os || '',
                ip: ip || '',
                user: user || '',
                status,
                lastSeenAt,
                lastSeenRaw: lastSeenRaw || '',
                deviceType: deviceType || ''
            };
        }

        async function syncAteraAssets(options = {}) {
            if (ateraAssetsLoading) return;
            const now = Date.now();
            if (!options.force && ateraAssetsLastSync && now - ateraAssetsLastSync < 2 * 60 * 1000) {
                if (!options.skipRender && currentView === 'computers') {
                    renderComputersView();
                }
                return;
            }
            ateraAssetsLoading = true;
            try {
                const response = await fetch('/api/atera-agents');
                if (!response.ok) {
                    if (!options.silent) {
                        console.warn('Atera assets sync failed:', response.status);
                    }
                    return;
                }
                const data = await response.json();
                const items = Array.isArray(data.agents)
                    ? data.agents
                    : Array.isArray(data.items)
                        ? data.items
                        : Array.isArray(data.data)
                            ? data.data
                            : Array.isArray(data)
                                ? data
                                : [];
                ateraAssets = items.map(normalizeAteraAsset).filter(Boolean);
                ateraAssetsLastSync = Date.now();
            } catch (err) {
                if (!options.silent) {
                    console.warn('Atera assets sync failed:', err);
                }
            } finally {
                ateraAssetsLoading = false;
                if (!options.skipRender && currentView === 'computers') {
                    renderComputersView();
                }
            }
        }

        async function syncExternalAssets(options = {}) {
            await syncAteraAssets(options);
        }

        function scheduleExternalClientSync() {
            if (externalSyncTimer) return;
            externalSyncTimer = setInterval(() => {
                if (document.hidden) return;
                syncExternalClients({ silent: true });
                syncExternalAssets({ silent: true });
            }, EXTERNAL_SYNC_INTERVAL);
        }

        function refreshComputersView() {
            syncAteraAssets({ force: true });
        }

        function getComputersClientOptions() {
            const map = new Map();
            clients.filter(client => client.source === 'atera').forEach(client => {
                map.set(client.id, client.name);
            });
            ateraAssets.forEach(asset => {
                if (!asset.clientId) return;
                if (!map.has(asset.clientId)) {
                    map.set(asset.clientId, asset.clientName || asset.clientId);
                }
            });
            return Array.from(map.entries()).map(([id, name]) => ({ id, name }));
        }

        function buildComputersFiltersUI() {
            const clientSelect = document.getElementById('computersClientFilter');
            if (clientSelect) {
                const options = [
                    { id: 'all', label: 'Vsechny' },
                    ...getComputersClientOptions().map(item => ({ id: item.id, label: item.name }))
                ];
                clientSelect.innerHTML = options.map(option =>
                    `<option value="${escapeHtml(option.id)}">${escapeHtml(option.label)}</option>`
                ).join('');
                clientSelect.value = options.some(option => option.id === computersFilters.clientId)
                    ? computersFilters.clientId
                    : 'all';
            }

            const typeSelect = document.getElementById('computersTypeFilter');
            if (typeSelect) {
                const options = [{ id: 'all', label: 'Vse' }, ...COMPUTER_TYPES];
                typeSelect.innerHTML = options.map(option =>
                    `<option value="${option.id}">${escapeHtml(option.label)}</option>`
                ).join('');
                typeSelect.value = options.some(option => option.id === computersFilters.type)
                    ? computersFilters.type
                    : 'all';
            }

            const statusSelect = document.getElementById('computersStatusFilter');
            if (statusSelect) {
                const options = [{ id: 'all', label: 'Vse' }, ...COMPUTER_STATUSES];
                statusSelect.innerHTML = options.map(option =>
                    `<option value="${option.id}">${escapeHtml(option.label)}</option>`
                ).join('');
                statusSelect.value = options.some(option => option.id === computersFilters.status)
                    ? computersFilters.status
                    : 'all';
            }

            const searchInput = document.getElementById('computersSearch');
            if (searchInput) {
                searchInput.value = computersFilters.search || '';
            }

            const sortSelect = document.getElementById('computersSort');
            if (sortSelect) {
                const options = [
                    { id: 'name-asc', label: 'Nazev' },
                    { id: 'client-asc', label: 'Klient' },
                    { id: 'lastseen-desc', label: 'Posledni kontakt' },
                    { id: 'status-asc', label: 'Status' }
                ];
                sortSelect.innerHTML = options.map(option =>
                    `<option value="${option.id}">${escapeHtml(option.label)}</option>`
                ).join('');
                sortSelect.value = options.some(option => option.id === computersFilters.sort)
                    ? computersFilters.sort
                    : 'name-asc';
            }
        }

        function updateComputersFilters() {
            const clientSelect = document.getElementById('computersClientFilter');
            const typeSelect = document.getElementById('computersTypeFilter');
            const statusSelect = document.getElementById('computersStatusFilter');
            const searchInput = document.getElementById('computersSearch');
            const sortSelect = document.getElementById('computersSort');

            computersFilters.clientId = clientSelect ? clientSelect.value : 'all';
            computersFilters.type = typeSelect ? typeSelect.value : 'all';
            computersFilters.status = statusSelect ? statusSelect.value : 'all';
            computersFilters.search = searchInput ? (searchInput.value || '').trim() : '';
            computersFilters.sort = sortSelect ? sortSelect.value : 'name-asc';

            renderComputersView();
        }

        function getFilteredComputers() {
            let list = [...ateraAssets];
            if (computersFilters.clientId !== 'all') {
                list = list.filter(asset => asset.clientId === computersFilters.clientId);
            }
            if (computersFilters.type !== 'all') {
                list = list.filter(asset => getAteraAssetType(asset) === computersFilters.type);
            }
            if (computersFilters.status !== 'all') {
                list = list.filter(asset => getAteraAssetStatus(asset) === computersFilters.status);
            }
            if (computersFilters.search) {
                const term = computersFilters.search.toLowerCase();
                list = list.filter(asset => {
                    return [
                        asset.name,
                        asset.os,
                        asset.ip,
                        asset.user,
                        asset.clientName,
                        asset.externalId
                    ].some(value => (value || '').toLowerCase().includes(term));
                });
            }

            switch (computersFilters.sort) {
                case 'client-asc':
                    list.sort((a, b) => (a.clientName || '').localeCompare(b.clientName || '', 'cs', { sensitivity: 'base' }));
                    break;
                case 'lastseen-desc':
                    list.sort((a, b) => {
                        const aValue = a.lastSeenAt ? a.lastSeenAt.getTime() : 0;
                        const bValue = b.lastSeenAt ? b.lastSeenAt.getTime() : 0;
                        return bValue - aValue;
                    });
                    break;
                case 'status-asc':
                    list.sort((a, b) => getAteraAssetStatus(a).localeCompare(getAteraAssetStatus(b)));
                    break;
                default:
                    list.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'cs', { sensitivity: 'base' }));
                    break;
            }

            return list;
        }

        function formatComputersLastSeen(asset) {
            if (!asset || !asset.lastSeenAt) return '-';
            return asset.lastSeenAt.toISOString().slice(0, 16).replace('T', ' ');
        }

        function renderComputersMetrics(list) {
            const metricsEl = document.getElementById('computersMetrics');
            if (!metricsEl) return;
            const pcCount = list.filter(asset => getAteraAssetType(asset) === 'pc').length;
            const serverCount = list.filter(asset => getAteraAssetType(asset) === 'server').length;
            const onlineCount = list.filter(asset => getAteraAssetStatus(asset) === 'online').length;
            const offlineCount = list.filter(asset => getAteraAssetStatus(asset) === 'offline').length;
            metricsEl.innerHTML = `
                <div class="computers-metric">
                    <div class="computers-metric-value">${list.length}</div>
                    <div class="computers-metric-label">Celkem</div>
                </div>
                <div class="computers-metric">
                    <div class="computers-metric-value">${pcCount}</div>
                    <div class="computers-metric-label">PC</div>
                </div>
                <div class="computers-metric">
                    <div class="computers-metric-value">${serverCount}</div>
                    <div class="computers-metric-label">Server</div>
                </div>
                <div class="computers-metric">
                    <div class="computers-metric-value">${onlineCount}</div>
                    <div class="computers-metric-label">Online</div>
                </div>
                <div class="computers-metric">
                    <div class="computers-metric-value">${offlineCount}</div>
                    <div class="computers-metric-label">Offline</div>
                </div>
            `;
        }

        function renderComputersList(list) {
            const listEl = document.getElementById('computersList');
            if (!listEl) return;
            if (!list.length) {
                listEl.innerHTML = '<div class="computers-empty">Zatim nejsou zadna zarizeni z Atera.</div>';
                return;
            }

            listEl.innerHTML = list.map(asset => {
                const type = getAteraAssetType(asset);
                const status = getAteraAssetStatus(asset);
                const typeLabel = getComputersTypeLabel(type);
                const statusLabel = getComputersStatusLabel(status);
                const clientName = getHelpdeskClientName(asset.clientId, asset.clientName || '-');
                const meta = [
                    asset.os ? `OS: ${asset.os}` : null,
                    asset.ip ? `IP: ${asset.ip}` : null,
                    asset.user ? `Uzivatel: ${asset.user}` : null,
                    `Posledni kontakt: ${formatComputersLastSeen(asset)}`
                ].filter(Boolean).join(' | ');
                return `
                    <div class="computer-card">
                        <div class="computer-card-head">
                            <div>
                                <div class="computer-name">${escapeHtml(asset.name || '-')}</div>
                                <div class="computer-client">${escapeHtml(clientName)}</div>
                            </div>
                        </div>
                        <div class="computer-meta">${escapeHtml(meta)}</div>
                        <div class="computer-badges">
                            <span class="computer-badge type-${type}">${escapeHtml(typeLabel)}</span>
                            <span class="computer-badge status-${status}">${escapeHtml(statusLabel)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderComputersView() {
            const view = document.getElementById('computersView');
            if (!view) return;
            const statusEl = document.getElementById('computersSyncStatus');
            if (!ateraAssets.length && !ateraAssetsLoading) {
                syncAteraAssets({ silent: true });
            }
            buildComputersFiltersUI();
            const list = getFilteredComputers();
            renderComputersMetrics(list);
            renderComputersList(list);
            if (statusEl) {
                const label = ateraAssetsLastSync ? new Date(ateraAssetsLastSync).toISOString().slice(0, 16).replace('T', ' ') : '-';
                statusEl.textContent = ateraAssetsLoading ? 'Sync: nacitam...' : `Sync: ${label}`;
            }
        }

        function normalizeModuleId(value) {
            if (!value) return '';
            return value
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }

        function hexToRgb(hex) {
            if (!hex) return null;
            let clean = hex.replace('#', '').trim();
            if (clean.length === 3) {
                clean = clean.split('').map((c) => c + c).join('');
            }
            if (clean.length !== 6) return null;
            const num = parseInt(clean, 16);
            if (Number.isNaN(num)) return null;
            return {
                r: (num >> 16) & 255,
                g: (num >> 8) & 255,
                b: num & 255
            };
        }

        function hexToRgba(hex, alpha) {
            const rgb = hexToRgb(hex);
            if (!rgb) return `rgba(248, 154, 85, ${alpha})`;
            return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`;
        }

        function darkenColor(hex, percent) {
            const rgb = hexToRgb(hex);
            if (!rgb) return '#64748b';
            const factor = Math.max(0, Math.min(1, 1 - percent / 100));
            const r = Math.round(rgb.r * factor);
            const g = Math.round(rgb.g * factor);
            const b = Math.round(rgb.b * factor);
            return `rgb(${r}, ${g}, ${b})`;
        }

        function getContrastColor(hex) {
            const rgb = hexToRgb(hex);
            if (!rgb) return '#000000';
            const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
            return brightness > 160 ? '#000000' : '#ffffff';
        }

        function loadModuleTypes() {
            const saved = localStorage.getItem('rackManagerModuleTypes');
            customModuleTypes = saved ? JSON.parse(saved) : [];
            const merged = [...DEFAULT_MODULE_TYPES, ...customModuleTypes];
            const seen = new Set();
            moduleTypes = merged.filter((type) => {
                if (!type || !type.id || seen.has(type.id)) return false;
                seen.add(type.id);
                return true;
            });
        }

        function saveModuleTypes() {
            localStorage.setItem('rackManagerModuleTypes', JSON.stringify(customModuleTypes));
        }

        function getModuleType(typeId) {
            return moduleTypes.find((type) => type.id === typeId) || null;
        }

        function getModuleTypeLabel(typeId) {
            const type = getModuleType(typeId);
            return type ? type.label : typeId;
        }

        function getModuleTypeColors(typeId) {
            const type = getModuleType(typeId);
            const base = type && type.color ? type.color : '#94a3b8';
            const gradient = type && type.gradient ? type.gradient : [base, darkenColor(base, 30)];
            const text = type && type.text ? type.text : getContrastColor(base);
            const label = type && type.label ? type.label : typeId;
            const group = type && type.group ? type.group : 'Other';
            return { base, gradient, text, label, group };
        }

        function getModuleStyleVars(typeId) {
            const colors = getModuleTypeColors(typeId);
            return `--device-color: ${colors.base}; --device-gradient: linear-gradient(90deg, ${colors.gradient[0]}, ${colors.gradient[1]}); --device-text: ${colors.text};`;
        }

        function getModuleBadgeVars(typeId) {
            const colors = getModuleTypeColors(typeId);
            return `--badge-bg: ${hexToRgba(colors.base, 0.2)}; --badge-border: ${hexToRgba(colors.base, 0.5)}; --badge-color: ${colors.base};`;
        }

        function renderDeviceTypeOptions(selectedId) {
            const select = document.getElementById('deviceType');
            if (!select) return;
            const current = selectedId || select.value;
            if (!moduleTypes.length) {
                select.innerHTML = '<option value="">Zadne kategorie</option>';
                return;
            }
            select.innerHTML = moduleTypes.map((type) => {
                return `<option value="${type.id}">${type.label}</option>`;
            }).join('');
            const fallback = moduleTypes[0].id;
            select.value = moduleTypes.some((type) => type.id === current) ? current : fallback;
        }

        function renderModuleList() {
            const list = document.getElementById('moduleList');
            if (!list) return;
            const customIds = new Set(customModuleTypes.map((type) => type.id));
            const items = moduleTypes.map((type) => {
                const colors = getModuleTypeColors(type.id);
                const isCustom = customIds.has(type.id);
                const action = isCustom
                    ? `<button class="delete-btn" onclick="deleteModuleType('${type.id}')">Smazat</button>`
                    : `<span class="module-id">system</span>`;
                return `
                    <div class="module-item">
                        <div class="module-meta">
                            <span class="module-color" style="background: ${colors.base};"></span>
                            <span>${type.label}</span>
                            <span class="module-id">${type.id}</span>
                            <span class="module-id">${type.group || 'Other'}</span>
                        </div>
                        ${action}
                    </div>
                `;
            });
            list.innerHTML = items.join('') || '<div class="empty-state"><p>Zadne kategorie</p></div>';
        }

        function clearModuleForm() {
            document.getElementById('moduleName').value = '';
            document.getElementById('moduleId').value = '';
            document.getElementById('moduleGroup').value = 'Network';
            document.getElementById('moduleColor').value = '#00ff88';
        }

        function openModuleModal() {
            if (!canManageCategories()) {
                alert('Nemate opravneni spravovat kategorie');
                return;
            }
            loadModuleTypes();
            renderModuleList();
            renderDeviceTypeOptions();
            document.getElementById('moduleModal').classList.add('active');
        }

        function closeModuleModal() {
            document.getElementById('moduleModal').classList.remove('active');
            clearModuleForm();
        }

        function addModuleType() {
            if (!canManageCategories()) {
                alert('Nemate opravneni spravovat kategorie');
                return;
            }
            const name = document.getElementById('moduleName').value.trim();
            const rawId = document.getElementById('moduleId').value.trim();
            const group = document.getElementById('moduleGroup').value;
            const color = document.getElementById('moduleColor').value || '#00ff88';

            if (!name) {
                alert('Nazev kategorie je povinny');
                return;
            }

            const id = normalizeModuleId(rawId || name);
            if (!id) {
                alert('ID kategorie je neplatne');
                return;
            }

            if (moduleTypes.some((type) => type.id === id)) {
                alert('Kategorie s timto ID uz existuje');
                return;
            }

            customModuleTypes.push({
                id,
                label: name,
                color,
                gradient: [color, darkenColor(color, 30)],
                text: getContrastColor(color),
                group
            });

            saveModuleTypes();
            loadModuleTypes();
            renderDeviceTypeOptions(id);
            renderModuleList();
            clearModuleForm();
        }

        function deleteModuleType(id) {
            if (!canManageCategories()) {
                alert('Nemate opravneni spravovat kategorie');
                return;
            }
            const inUse = devices.some((device) => device.type === id);
            if (inUse && !confirm('Kategorie je pouzita v zarizenich. Pokracovat?')) {
                return;
            }
            customModuleTypes = customModuleTypes.filter((type) => type.id !== id);
            saveModuleTypes();
            loadModuleTypes();
            renderDeviceTypeOptions();
            renderModuleList();
        }
        
        // Initialize from localStorage
        async function init() {
            // Load clients
            const savedClients = localStorage.getItem('rackManagerClients');
            if (savedClients) {
                clients = JSON.parse(savedClients);
            }
            
            // Load all client data
            const savedClientData = localStorage.getItem('rackManagerClientData');
            if (savedClientData) {
                clientData = JSON.parse(savedClientData);
            }

            loadHelpdeskTickets();
            
            // Check if there was a previously selected client
            const lastClientId = localStorage.getItem('rackManagerLastClient');
            if (lastClientId && clients.find(c => c.id === lastClientId)) {
                currentClientId = lastClientId;
                loadClientData(currentClientId);
            }
            
            loadModuleTypes();
            renderDeviceTypeOptions();
            await syncExternalClients({ skipRender: true });
            await syncExternalAssets({ skipRender: true });
            updateClientSelector();
            restoreSidebarSections();
            restoreTimeAllClientsToggle();
            render();
            fetchUserRole();
            setupClientModalCloseHandlers();
            scheduleExternalClientSync();
        }
        
        // Save data to localStorage
        function saveData() {
            // Save current client's data
            if (currentClientId) {
                clientData[currentClientId] = {
                    racks,
                    devices,
                    connections
                };
            }
            
            localStorage.setItem('rackManagerClients', JSON.stringify(clients));
            localStorage.setItem('rackManagerClientData', JSON.stringify(clientData));
            if (currentClientId) {
                localStorage.setItem('rackManagerLastClient', currentClientId);
            }

            scheduleCloudSave();
        }
        
        // Load data for specific client
        function loadClientData(clientId) {
            if (clientData[clientId]) {
                racks = clientData[clientId].racks || [];
                devices = clientData[clientId].devices || [];
                connections = clientData[clientId].connections || [];
            } else {
                racks = [];
                devices = [];
                connections = [];
            }
        }
        
        // Switch client
        function switchClient(options = {}) {
            const selector = document.getElementById('clientSelector');
            const clientId = selector.value;
            
            if (!clientId) {
                currentClientId = null;
                racks = [];
                devices = [];
                connections = [];
                document.getElementById('clientInfo').style.display = 'none';
                disableControls();
                render();
                return;
            } else {
                currentClientId = clientId;
                loadClientData(clientId);
                updateClientInfo();
                enableControls();
            }
            render();
            fetchUserRole();
            initTimeTracking();
            if (!options.skipView) {
                switchView(options.view || 'overview');
            }
        }
        
        // Update client selector
        function updateClientSelector() {
            const selector = document.getElementById('clientSelector');
            selector.innerHTML = '<option value="">-- Vyberte klienta --</option>' + 
                clients.map(client => 
                    `<option value="${client.id}" ${client.id === currentClientId ? 'selected' : ''}>${client.name}</option>`
                ).join('');
        }
        
        // Update client info panel
        function updateClientInfo() {
            const client = clients.find(c => c.id === currentClientId);
            const dashboardContact = document.getElementById('dashboardContact');
            const dashboardLocation = document.getElementById('dashboardLocation');
            const dashboardType = document.getElementById('dashboardType');
            const dashboardIco = document.getElementById('dashboardIco');
            const dashboardLogo = document.getElementById('dashboardLogoPrimary');
            const pricingInfo = document.getElementById('clientPricing');
            if (client) {
                document.getElementById('clientInfo').style.display = 'block';
                document.getElementById('clientName').textContent = client.name + (client.ico ? ` (ICO: ${client.ico})` : '');
                updateRoleLabel();
                document.getElementById('clientContact').textContent = client.contact ? `Kontakt: ${client.contact}` : '';
                document.getElementById('clientLocation').textContent = client.address ? `Adresa: ${client.address}` : '';
                document.getElementById('clientType').textContent = client.type.toUpperCase();
                if (pricingInfo) pricingInfo.textContent = `Pricing: ${buildPricingSummary(client)}`;
                if (dashboardContact) dashboardContact.textContent = client.contact || 'Neuvedeno';
                if (dashboardLocation) dashboardLocation.textContent = client.address || 'Neuvedeno';
                if (dashboardType) dashboardType.textContent = client.type ? client.type.toUpperCase() : '-';
                if (dashboardIco) dashboardIco.textContent = client.ico || 'Neuvedeno';
                if (dashboardLogo) {
                    const parts = (client.name || '').trim().split(/\s+/).filter(Boolean);
                    const initials = parts.slice(0, 2).map(part => part[0]).join('').toUpperCase();
                    dashboardLogo.textContent = initials || 'LOGO';
                }
            } else {
                document.getElementById('clientInfo').style.display = 'none';
                if (dashboardContact) dashboardContact.textContent = '-';
                if (dashboardLocation) dashboardLocation.textContent = '-';
                if (dashboardType) dashboardType.textContent = '-';
                if (dashboardIco) dashboardIco.textContent = '-';
                if (dashboardLogo) dashboardLogo.textContent = 'LOGO';
                if (pricingInfo) pricingInfo.textContent = '';
            }
        }
        
        // Enable/disable controls
        function enableControls() {
            applyRolePermissions();
        }
        
        function disableControls() {
            document.getElementById('addRackBtn').disabled = true;
            document.getElementById('clearRacksBtn').disabled = true;
            document.getElementById('addDeviceBtn').disabled = true;
            document.getElementById('addConnectionBtn').disabled = true;
        }
        
        // View switching
        function switchView(view, button) {
            if (view === 'reports' && !canViewReports()) {
                alert('Nemate opravneni zobrazit reporty');
                view = 'dashboard';
            }
            currentView = view;
            // Update toggle buttons
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeButton = button || document.querySelector(`.view-toggle-btn[data-view="${view}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Hide all views
            document.getElementById('racksView').style.display = 'none';
            document.getElementById('networkView').style.display = 'none';
            document.getElementById('topologyView').style.display = 'none';
            document.getElementById('overviewView').style.display = 'none';
            document.getElementById('timeView').style.display = 'none';
            document.getElementById('reportsView').style.display = 'none';
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('clientsView').style.display = 'none';
            document.getElementById('computersView').style.display = 'none';
            document.getElementById('helpdeskView').style.display = 'none';
            document.getElementById('teamsView').style.display = 'none';
            
            // Show selected view
            switch(view) {
                case 'dashboard':
                    document.getElementById('dashboardView').style.display = 'block';
                    renderDashboard();
                    break;
                case 'clients':
                    document.getElementById('clientsView').style.display = 'grid';
                    renderClientDetailsPanel();
                    break;
                case 'racks':
                    document.getElementById('racksView').style.display = 'block';
                    break;
                case 'network':
                    document.getElementById('networkView').style.display = 'block';
                    initNetworkVisualization();
                    break;
                case 'topology':
                    document.getElementById('topologyView').style.display = 'block';
                    renderTopologyView();
                    break;
                case 'overview':
                    document.getElementById('overviewView').style.display = 'block';
                    renderClientOverview();
                    break;
                case 'time':
                    document.getElementById('timeView').style.display = 'block';
                    if (currentClientId) {
                        loadTimeEntriesForWeek();
                    } else {
                        renderTimeTracking();
                    }
                    break;
                case 'reports':
                    document.getElementById('reportsView').style.display = 'block';
                    reportHasLoaded = false;
                    reportFiltersVisible = false;
                    renderReportsView();
                    break;
                case 'computers':
                    document.getElementById('computersView').style.display = 'block';
                    renderComputersView();
                    break;
                case 'helpdesk':
                    document.getElementById('helpdeskView').style.display = 'block';
                    renderHelpdeskView();
                    break;
                case 'teams':
                    document.getElementById('teamsView').style.display = 'block';
                    renderTeamsView();
                    break;
            }
        }

        // Helpdesk
        function loadHelpdeskTickets() {
            try {
                const stored = JSON.parse(localStorage.getItem('rackManagerHelpdeskTickets') || '[]');
                helpdeskTickets = Array.isArray(stored) ? stored : [];
            } catch (err) {
                helpdeskTickets = [];
            }
        }

        function saveHelpdeskTickets() {
            localStorage.setItem('rackManagerHelpdeskTickets', JSON.stringify(helpdeskTickets));
            scheduleCloudSave();
        }

        function getHelpdeskAssigneeFallback() {
            const fallback = [];
            helpdeskTickets.forEach(ticket => {
                const name = (ticket.assignee || '').trim();
                if (name) {
                    fallback.push({ value: name });
                }
            });
            if (window.auth && auth.currentUser) {
                const name = (auth.currentUser.displayName || '').trim();
                const email = (auth.currentUser.email || '').trim();
                const value = name || email;
                if (value) {
                    fallback.push({ value, name, email });
                }
            }
            return fallback;
        }

        function buildHelpdeskAssigneeOptions(entries) {
            const list = Array.isArray(entries) ? entries : [];
            const nameCounts = list.reduce((acc, item) => {
                const key = (item.name || '').trim().toLowerCase();
                if (key) {
                    acc[key] = (acc[key] || 0) + 1;
                }
                return acc;
            }, {});
            const options = list.map(item => {
                const name = (item.name || '').trim();
                const email = (item.email || '').trim();
                let value = (item.value || '').trim();
                if (!value) {
                    if (name) {
                        const duplicate = nameCounts[name.toLowerCase()] > 1;
                        value = duplicate && email ? `${name} (${email})` : name;
                    } else if (email) {
                        value = email;
                    }
                }
                return {
                    value,
                    label: name && email ? email : ''
                };
            }).filter(option => option.value);

            const seen = new Set();
            return options.filter(option => {
                const key = option.value.toLowerCase();
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        async function loadHelpdeskAssignees(force) {
            if (helpdeskAssigneesClientId === currentClientId && helpdeskAssignees.length && !force) {
                return helpdeskAssignees;
            }
            if (!currentClientId || !window.db || !window.auth || !auth.currentUser) {
                helpdeskAssignees = buildHelpdeskAssigneeOptions(getHelpdeskAssigneeFallback());
                helpdeskAssigneesClientId = currentClientId || null;
                return helpdeskAssignees;
            }
            try {
                const clientDoc = db.collection('clients').doc(currentClientId);
                const usersSnap = await clientDoc.collection('users').get();
                const entries = [];
                usersSnap.forEach(doc => {
                    const data = doc.data() || {};
                    const name = (data.name || '').trim();
                    const email = (data.email || '').trim();
                    const value = name || email || doc.id;
                    if (value) {
                        entries.push({ name, email, value });
                    }
                });
                helpdeskAssignees = buildHelpdeskAssigneeOptions(entries.concat(getHelpdeskAssigneeFallback()));
                helpdeskAssigneesClientId = currentClientId;
            } catch (err) {
                helpdeskAssignees = buildHelpdeskAssigneeOptions(getHelpdeskAssigneeFallback());
            }
            return helpdeskAssignees;
        }

        function renderHelpdeskAssigneeOptions() {
            const listEl = document.getElementById('helpdeskAssigneeOptions');
            if (!listEl) return;
            const options = helpdeskAssignees.length
                ? helpdeskAssignees
                : buildHelpdeskAssigneeOptions(getHelpdeskAssigneeFallback());
            listEl.innerHTML = options.map(option => {
                const labelAttr = option.label ? ` label="${escapeHtml(option.label)}"` : '';
                return `<option value="${escapeHtml(option.value)}"${labelAttr}></option>`;
            }).join('');
        }

        function createHelpdeskTicketId() {
            const stamp = Date.now().toString(36).toUpperCase();
            const rand = Math.random().toString(36).slice(2, 6).toUpperCase();
            return `HD-${stamp}-${rand}`;
        }

        function getHelpdeskStatus(status) {
            return HELP_DESK_STATUSES.find(item => item.id === status) || { id: status || 'open', label: status || 'Otevreno', tone: 'open' };
        }

        function getHelpdeskPriority(priority) {
            return HELP_DESK_PRIORITIES.find(item => item.id === priority) || { id: priority || 'medium', label: priority || 'Stredni', tone: 'medium' };
        }

        function getHelpdeskSource(source) {
            return HELP_DESK_SOURCES.find(item => item.id === source) || { id: source || 'manual', label: source || 'Manual' };
        }

        function formatHelpdeskDate(value) {
            if (!value) return '-';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '-';
            return date.toISOString().slice(0, 10);
        }

        function getHelpdeskClientName(clientId, fallbackName) {
            if (!clientId) return fallbackName || '-';
            const client = clients.find(item => item.id === clientId);
            return (client && client.name) ? client.name : (fallbackName || '-');
        }

        function isHelpdeskDueSoon(ticket) {
            if (!ticket || !ticket.dueAt || ['resolved', 'closed'].includes(ticket.status)) return false;
            const due = new Date(ticket.dueAt);
            if (Number.isNaN(due.getTime())) return false;
            const now = new Date();
            const dueDay = new Date(due.getFullYear(), due.getMonth(), due.getDate()).getTime();
            const nowDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const diffDays = Math.round((dueDay - nowDay) / 86400000);
            return diffDays >= 0 && diffDays <= 2;
        }

        function isHelpdeskOverdue(ticket) {
            if (!ticket || !ticket.dueAt || ['resolved', 'closed'].includes(ticket.status)) return false;
            const due = new Date(ticket.dueAt);
            if (Number.isNaN(due.getTime())) return false;
            const now = new Date();
            const dueDay = new Date(due.getFullYear(), due.getMonth(), due.getDate()).getTime();
            const nowDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            return dueDay < nowDay;
        }

        function hasLocalTimeEntryForTicket(ticketId, clientId) {
            if (!ticketId) return false;
            return timeEntries.some(entry => entry.ticketId === ticketId && (!clientId || entry.clientId === clientId));
        }

        async function hasTimeEntryForTicket(ticketId, clientId) {
            if (!ticketId) return false;
            if (hasLocalTimeEntryForTicket(ticketId, clientId)) return true;
            if (!clientId || !window.db || !window.auth || !auth.currentUser) return false;
            try {
                const snapshot = await db.collection('clients')
                    .doc(clientId)
                    .collection('timeEntries')
                    .where('ticketId', '==', ticketId)
                    .limit(1)
                    .get();
                return !snapshot.empty;
            } catch (err) {
                return false;
            }
        }

        async function ensureHelpdeskTimeLogged(ticket) {
            if (!ticket || !ticket.id) return false;
            const clientId = ticket.clientId || currentClientId;
            if (!clientId) {
                alert('Tiket nema prirazeneho klienta. Nejprve ho doplnte a pak vykazujte hodiny.');
                return false;
            }
            const hasEntry = await hasTimeEntryForTicket(ticket.id, clientId);
            if (hasEntry) return true;
            alert('Tiket nelze uzavrit bez vykazanych hodin. Oteviram zapis.');
            openTimeEntryModal({ clientId, ticketId: ticket.id });
            return false;
        }

        function setHelpdeskQueue(queueId) {
            helpdeskFilters.queue = queueId;
            renderHelpdeskView();
        }

        function updateHelpdeskFilters() {
            const clientSelect = document.getElementById('helpdeskClientFilter');
            const statusSelect = document.getElementById('helpdeskStatusFilter');
            const prioritySelect = document.getElementById('helpdeskPriorityFilter');
            const assigneeSelect = document.getElementById('helpdeskAssigneeFilter');
            const searchInput = document.getElementById('helpdeskSearch');
            const sortSelect = document.getElementById('helpdeskSort');

            helpdeskFilters.clientId = clientSelect ? clientSelect.value : 'all';
            helpdeskFilters.status = statusSelect ? statusSelect.value : 'all';
            helpdeskFilters.priority = prioritySelect ? prioritySelect.value : 'all';
            helpdeskFilters.assignee = assigneeSelect ? assigneeSelect.value : 'all';
            helpdeskFilters.search = searchInput ? (searchInput.value || '').trim() : '';
            helpdeskFilters.sort = sortSelect ? sortSelect.value : helpdeskFilters.sort;

            renderHelpdeskView();
        }

        function renderHelpdeskFiltersUI() {
            const clientSelect = document.getElementById('helpdeskClientFilter');
            if (clientSelect) {
                const clientOptions = clients.map(client => ({
                    value: client.id,
                    label: client.name
                }));
                const options = [
                    { value: 'all', label: 'Vsechny' },
                    ...clientOptions
                ];
                clientSelect.innerHTML = options.map(option =>
                    `<option value="${option.value}">${escapeHtml(option.label)}</option>`
                ).join('');
                clientSelect.value = options.some(option => option.value === helpdeskFilters.clientId)
                    ? helpdeskFilters.clientId
                    : 'all';
            }

            const statusSelect = document.getElementById('helpdeskStatusFilter');
            if (statusSelect) {
                const options = [{ id: 'all', label: 'Vse' }, ...HELP_DESK_STATUSES];
                statusSelect.innerHTML = options.map(option =>
                    `<option value="${option.id}">${escapeHtml(option.label)}</option>`
                ).join('');
                statusSelect.value = options.some(option => option.id === helpdeskFilters.status)
                    ? helpdeskFilters.status
                    : 'all';
            }

            const prioritySelect = document.getElementById('helpdeskPriorityFilter');
            if (prioritySelect) {
                const options = [{ id: 'all', label: 'Vse' }, ...HELP_DESK_PRIORITIES];
                prioritySelect.innerHTML = options.map(option =>
                    `<option value="${option.id}">${escapeHtml(option.label)}</option>`
                ).join('');
                prioritySelect.value = options.some(option => option.id === helpdeskFilters.priority)
                    ? helpdeskFilters.priority
                    : 'all';
            }

            const assigneeSelect = document.getElementById('helpdeskAssigneeFilter');
            if (assigneeSelect) {
                const ticketAssignees = helpdeskTickets
                    .map(ticket => (ticket.assignee || '').trim())
                    .filter(Boolean);
                const knownAssignees = helpdeskAssignees.map(item => item.value).filter(Boolean);
                const assignees = Array.from(new Set([...knownAssignees, ...ticketAssignees])).sort();
                const options = [
                    { value: 'all', label: 'Vse' },
                    { value: 'unassigned', label: 'Neprirazeno' },
                    ...assignees.map(name => ({ value: name, label: name }))
                ];
                assigneeSelect.innerHTML = options.map(option =>
                    `<option value="${escapeHtml(option.value)}">${escapeHtml(option.label)}</option>`
                ).join('');
                assigneeSelect.value = options.some(option => option.value === helpdeskFilters.assignee)
                    ? helpdeskFilters.assignee
                    : 'all';
            }

            const searchInput = document.getElementById('helpdeskSearch');
            if (searchInput) {
                searchInput.value = helpdeskFilters.search || '';
            }

            const sortSelect = document.getElementById('helpdeskSort');
            if (sortSelect) {
                const options = [
                    { value: 'updated-desc', label: 'Posledni zmena' },
                    { value: 'created-desc', label: 'Nejnovejsi' },
                    { value: 'due-asc', label: 'Nejblizsi termin' },
                    { value: 'priority-desc', label: 'Priorita' }
                ];
                sortSelect.innerHTML = options.map(option =>
                    `<option value="${option.value}">${escapeHtml(option.label)}</option>`
                ).join('');
                sortSelect.value = options.some(option => option.value === helpdeskFilters.sort)
                    ? helpdeskFilters.sort
                    : 'updated-desc';
            }
        }

        function renderHelpdeskQueues() {
            const queueList = document.getElementById('helpdeskQueueList');
            if (!queueList) return;
            const active = HELP_DESK_QUEUES.some(queue => queue.id === helpdeskFilters.queue)
                ? helpdeskFilters.queue
                : 'open';
            helpdeskFilters.queue = active;
            queueList.innerHTML = HELP_DESK_QUEUES.map(queue => {
                const count = helpdeskTickets.filter(ticket => queue.match(ticket)).length;
                const isActive = queue.id === active ? 'active' : '';
                return `
                    <button class="helpdesk-queue-item ${isActive}" type="button" onclick="setHelpdeskQueue('${queue.id}')">
                        <span>${escapeHtml(queue.label)}</span>
                        <span class="helpdesk-queue-count">${count}</span>
                    </button>
                `;
            }).join('');
        }

        function renderHelpdeskMetrics() {
            const metricsEl = document.getElementById('helpdeskMetrics');
            if (!metricsEl) return;
            const openCount = helpdeskTickets.filter(ticket => !['resolved', 'closed'].includes(ticket.status)).length;
            const waitingCount = helpdeskTickets.filter(ticket => ticket.status === 'waiting').length;
            const dueSoonCount = helpdeskTickets.filter(ticket => isHelpdeskDueSoon(ticket)).length;
            const overdueCount = helpdeskTickets.filter(ticket => isHelpdeskOverdue(ticket)).length;
            metricsEl.innerHTML = `
                <div class="helpdesk-metric">
                    <div class="helpdesk-metric-value">${openCount}</div>
                    <div class="helpdesk-metric-label">Otevrene</div>
                </div>
                <div class="helpdesk-metric">
                    <div class="helpdesk-metric-value">${waitingCount}</div>
                    <div class="helpdesk-metric-label">Ceka na klienta</div>
                </div>
                <div class="helpdesk-metric">
                    <div class="helpdesk-metric-value">${dueSoonCount}</div>
                    <div class="helpdesk-metric-label">Blizi se</div>
                </div>
                <div class="helpdesk-metric">
                    <div class="helpdesk-metric-value">${overdueCount}</div>
                    <div class="helpdesk-metric-label">Po terminu</div>
                </div>
            `;
        }

        function getHelpdeskFilteredTickets() {
            let list = [...helpdeskTickets];
            const queue = HELP_DESK_QUEUES.find(item => item.id === helpdeskFilters.queue);
            if (queue) {
                list = list.filter(ticket => queue.match(ticket));
            }
            if (helpdeskFilters.status !== 'all') {
                list = list.filter(ticket => ticket.status === helpdeskFilters.status);
            }
            if (helpdeskFilters.priority !== 'all') {
                list = list.filter(ticket => ticket.priority === helpdeskFilters.priority);
            }
            if (helpdeskFilters.clientId !== 'all') {
                list = list.filter(ticket => ticket.clientId === helpdeskFilters.clientId);
            }
            if (helpdeskFilters.assignee === 'unassigned') {
                list = list.filter(ticket => !ticket.assignee);
            } else if (helpdeskFilters.assignee !== 'all') {
                list = list.filter(ticket => ticket.assignee === helpdeskFilters.assignee);
            }
            if (helpdeskFilters.search) {
                const term = helpdeskFilters.search.toLowerCase();
                list = list.filter(ticket => {
                    const tags = Array.isArray(ticket.tags) ? ticket.tags.join(' ') : '';
                    return [
                        ticket.id,
                        ticket.title,
                        ticket.description,
                        ticket.clientName,
                        ticket.assignee,
                        tags
                    ].some(value => (value || '').toLowerCase().includes(term));
                });
            }

            switch (helpdeskFilters.sort) {
                case 'created-desc':
                    list.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    break;
                case 'due-asc':
                    list.sort((a, b) => {
                        const aDue = a.dueAt ? new Date(a.dueAt).getTime() : Number.MAX_SAFE_INTEGER;
                        const bDue = b.dueAt ? new Date(b.dueAt).getTime() : Number.MAX_SAFE_INTEGER;
                        return aDue - bDue;
                    });
                    break;
                case 'priority-desc':
                    const rank = { urgent: 0, high: 1, medium: 2, low: 3 };
                    list.sort((a, b) => (rank[a.priority] ?? 9) - (rank[b.priority] ?? 9));
                    break;
                default:
                    list.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
                    break;
            }

            return list;
        }

        function renderHelpdeskList(list) {
            const listEl = document.getElementById('helpdeskList');
            if (!listEl) return;
            if (!list.length) {
                listEl.innerHTML = '<div class="helpdesk-empty">Zatim nejsou zadne tikety.</div>';
                return;
            }

            listEl.innerHTML = list.map(ticket => {
                const status = getHelpdeskStatus(ticket.status);
                const priority = getHelpdeskPriority(ticket.priority);
                const source = getHelpdeskSource(ticket.source);
                const clientName = getHelpdeskClientName(ticket.clientId, ticket.clientName);
                const dueLabel = ticket.dueAt ? `Termin: ${formatHelpdeskDate(ticket.dueAt)}` : 'Termin: -';
                const assignee = ticket.assignee ? ticket.assignee : 'Neprirazeno';
                const isActive = ticket.id === helpdeskSelectedId ? 'active' : '';
                const tags = Array.isArray(ticket.tags) && ticket.tags.length
                    ? ticket.tags.map(tag => `<span class="helpdesk-tag">${escapeHtml(tag)}</span>`).join('')
                    : '';
                return `
                    <div class="helpdesk-ticket-card ${isActive}" onclick="selectHelpdeskTicket('${ticket.id}')">
                        <div class="helpdesk-ticket-title">${escapeHtml(ticket.title || 'Bez nazvu')}</div>
                        <div class="helpdesk-ticket-meta">
                            <span>${escapeHtml(ticket.id || '-')}</span>
                            <span>${escapeHtml(clientName)}</span>
                            <span>${escapeHtml(assignee)}</span>
                            <span>${escapeHtml(dueLabel)}</span>
                        </div>
                        <div class="helpdesk-ticket-meta">
                            <span class="helpdesk-badge status-${status.tone}">${escapeHtml(status.label)}</span>
                            <span class="helpdesk-badge priority-${priority.tone}">${escapeHtml(priority.label)}</span>
                            <span>${escapeHtml(source.label)}</span>
                        </div>
                        ${tags ? `<div class="helpdesk-ticket-tags">${tags}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderHelpdeskDetail(ticketId) {
            const detailEl = document.getElementById('helpdeskDetail');
            if (!detailEl) return;
            if (!ticketId) {
                detailEl.innerHTML = '<div class="helpdesk-empty">Vyber tiket ze seznamu.</div>';
                return;
            }

            const ticket = helpdeskTickets.find(item => item.id === ticketId);
            if (!ticket) {
                detailEl.innerHTML = '<div class="helpdesk-empty">Tiket nebyl nalezen.</div>';
                return;
            }

            const status = getHelpdeskStatus(ticket.status);
            const priority = getHelpdeskPriority(ticket.priority);
            const source = getHelpdeskSource(ticket.source);
            const clientName = getHelpdeskClientName(ticket.clientId, ticket.clientName);
            const description = ticket.description ? escapeHtml(ticket.description).replace(/\n/g, '<br>') : 'Bez popisu.';
            const tags = Array.isArray(ticket.tags) && ticket.tags.length
                ? ticket.tags.map(tag => `<span class="helpdesk-tag">${escapeHtml(tag)}</span>`).join('')
                : '<span class="helpdesk-tag">bez tagu</span>';
            const external = ticket.external || {};
            const provider = external.provider || '-';
            const externalId = external.externalId || '-';
            const lastSync = external.lastSyncAt ? formatHelpdeskDate(external.lastSyncAt) : '-';
            const canEdit = canManageHelpdesk();
            const actionButtons = [];

            if (canEdit) {
                actionButtons.push(`<button class="btn-small btn-secondary" onclick="openHelpdeskTicketModal('${ticket.id}')">Upravit</button>`);
                if (['resolved', 'closed'].includes(ticket.status)) {
                    actionButtons.push(`<button class="btn-small" onclick="updateHelpdeskTicketStatus('${ticket.id}', 'open')">Znovu otevrit</button>`);
                } else {
                    actionButtons.push(`<button class="btn-small" onclick="updateHelpdeskTicketStatus('${ticket.id}', 'in-progress')">V reseni</button>`);
                    actionButtons.push(`<button class="btn-small" onclick="updateHelpdeskTicketStatus('${ticket.id}', 'waiting')">Ceka na klienta</button>`);
                    actionButtons.push(`<button class="btn-small" onclick="updateHelpdeskTicketStatus('${ticket.id}', 'resolved')">Vyresit</button>`);
                    actionButtons.push(`<button class="btn-small btn-secondary" onclick="updateHelpdeskTicketStatus('${ticket.id}', 'closed')">Uzavrit</button>`);
                }
            }

            detailEl.innerHTML = `
                <div>
                    <div class="helpdesk-detail-subtitle">${escapeHtml(ticket.id || '-')}</div>
                    <div class="helpdesk-detail-title">${escapeHtml(ticket.title || 'Bez nazvu')}</div>
                    <div class="helpdesk-ticket-meta">
                        <span class="helpdesk-badge status-${status.tone}">${escapeHtml(status.label)}</span>
                        <span class="helpdesk-badge priority-${priority.tone}">${escapeHtml(priority.label)}</span>
                    </div>
                </div>
                ${actionButtons.length ? `<div class="helpdesk-detail-actions">${actionButtons.join('')}</div>` : ''}
                <div class="helpdesk-detail-meta">
                    <div><strong>Klient:</strong> ${escapeHtml(clientName)}</div>
                    <div><strong>Prirazeno:</strong> ${escapeHtml(ticket.assignee || 'Neprirazeno')}</div>
                    <div><strong>Termin:</strong> ${escapeHtml(ticket.dueAt ? formatHelpdeskDate(ticket.dueAt) : '-')}</div>
                    <div><strong>Zdroj:</strong> ${escapeHtml(source.label)}</div>
                    <div><strong>Vytvoreno:</strong> ${escapeHtml(ticket.createdAt ? formatHelpdeskDate(ticket.createdAt) : '-')}</div>
                    <div><strong>Aktualizace:</strong> ${escapeHtml(ticket.updatedAt ? formatHelpdeskDate(ticket.updatedAt) : '-')}</div>
                </div>
                <div class="helpdesk-detail-section">
                    <div class="helpdesk-detail-subtitle">Popis</div>
                    <p>${description}</p>
                </div>
                <div class="helpdesk-detail-section">
                    <div class="helpdesk-detail-subtitle">Tagy</div>
                    <div class="helpdesk-ticket-tags">${tags}</div>
                </div>
                <div class="helpdesk-detail-section">
                    <div class="helpdesk-detail-subtitle">Integrace</div>
                    <div class="helpdesk-external-row"><span>Provider:</span> ${escapeHtml(provider)}</div>
                    <div class="helpdesk-external-row"><span>External ID:</span> ${escapeHtml(externalId)}</div>
                    <div class="helpdesk-external-row"><span>Posledni sync:</span> ${escapeHtml(lastSync)}</div>
                    <div class="helpdesk-panel-note">Pripraveno pro Teams/ClickUp sync pres webhooky a API.</div>
                </div>
            `;
        }

        function selectHelpdeskTicket(ticketId) {
            helpdeskSelectedId = ticketId;
            renderHelpdeskView();
        }

        function renderHelpdeskView() {
            const view = document.getElementById('helpdeskView');
            if (!view) return;
            loadHelpdeskAssignees().then(() => {
                renderHelpdeskAssigneeOptions();
                renderHelpdeskFiltersUI();
            });
            renderHelpdeskQueues();
            renderHelpdeskFiltersUI();
            renderHelpdeskMetrics();
            const filtered = getHelpdeskFilteredTickets();
            if (!helpdeskSelectedId && filtered.length) {
                helpdeskSelectedId = filtered[0].id;
            }
            if (helpdeskSelectedId && !filtered.find(ticket => ticket.id === helpdeskSelectedId)) {
                helpdeskSelectedId = filtered.length ? filtered[0].id : null;
            }
            renderHelpdeskList(filtered);
            renderHelpdeskDetail(helpdeskSelectedId);
        }

        function renderHelpdeskTicketFormOptions() {
            const clientSelect = document.getElementById('helpdeskTicketClient');
            if (clientSelect) {
                const options = [
                    { value: '', label: 'Neprirazeno' },
                    ...clients.map(client => ({ value: client.id, label: client.name }))
                ];
                clientSelect.innerHTML = options.map(option =>
                    `<option value="${option.value}">${escapeHtml(option.label)}</option>`
                ).join('');
            }

            const statusSelect = document.getElementById('helpdeskTicketStatus');
            if (statusSelect) {
                statusSelect.innerHTML = HELP_DESK_STATUSES.map(option =>
                    `<option value="${option.id}">${escapeHtml(option.label)}</option>`
                ).join('');
            }

            const prioritySelect = document.getElementById('helpdeskTicketPriority');
            if (prioritySelect) {
                prioritySelect.innerHTML = HELP_DESK_PRIORITIES.map(option =>
                    `<option value="${option.id}">${escapeHtml(option.label)}</option>`
                ).join('');
            }

            const sourceSelect = document.getElementById('helpdeskTicketSource');
            if (sourceSelect) {
                sourceSelect.innerHTML = HELP_DESK_SOURCES.map(option =>
                    `<option value="${option.id}">${escapeHtml(option.label)}</option>`
                ).join('');
            }
        }

        async function openHelpdeskTicketModal(ticketId) {
            if (!canManageHelpdesk()) {
                alert('Nemate opravneni spravovat helpdesk');
                return;
            }
            const modal = document.getElementById('helpdeskTicketModal');
            const modalTitle = document.getElementById('helpdeskModalTitle');
            const idInput = document.getElementById('helpdeskTicketId');
            const titleInput = document.getElementById('helpdeskTicketTitle');
            const descInput = document.getElementById('helpdeskTicketDesc');
            const clientSelect = document.getElementById('helpdeskTicketClient');
            const statusSelect = document.getElementById('helpdeskTicketStatus');
            const prioritySelect = document.getElementById('helpdeskTicketPriority');
            const assigneeInput = document.getElementById('helpdeskTicketAssignee');
            const dueInput = document.getElementById('helpdeskTicketDue');
            const sourceSelect = document.getElementById('helpdeskTicketSource');
            const tagsInput = document.getElementById('helpdeskTicketTags');

            renderHelpdeskTicketFormOptions();
            await loadHelpdeskAssignees();
            renderHelpdeskAssigneeOptions();

            const ticket = ticketId ? helpdeskTickets.find(item => item.id === ticketId) : null;
            if (ticket) {
                if (modalTitle) modalTitle.textContent = 'Upravit tiket';
                if (idInput) idInput.value = ticket.id;
                if (titleInput) titleInput.value = ticket.title || '';
                if (descInput) descInput.value = ticket.description || '';
                if (clientSelect) clientSelect.value = ticket.clientId || '';
                if (statusSelect) statusSelect.value = ticket.status || 'open';
                if (prioritySelect) prioritySelect.value = ticket.priority || 'medium';
                if (assigneeInput) assigneeInput.value = ticket.assignee || '';
                if (dueInput) dueInput.value = ticket.dueAt ? formatHelpdeskDate(ticket.dueAt) : '';
                if (sourceSelect) sourceSelect.value = ticket.source || 'manual';
                if (tagsInput) tagsInput.value = Array.isArray(ticket.tags) ? ticket.tags.join(', ') : '';
            } else {
                if (modalTitle) modalTitle.textContent = 'Novy tiket';
                if (idInput) idInput.value = '';
                if (titleInput) titleInput.value = '';
                if (descInput) descInput.value = '';
                if (clientSelect) clientSelect.value = currentClientId || '';
                if (statusSelect) statusSelect.value = 'open';
                if (prioritySelect) prioritySelect.value = 'medium';
                if (assigneeInput) assigneeInput.value = '';
                if (dueInput) dueInput.value = '';
                if (sourceSelect) sourceSelect.value = 'manual';
                if (tagsInput) tagsInput.value = '';
            }

            if (modal) modal.classList.add('active');
        }

        function closeHelpdeskTicketModal() {
            const modal = document.getElementById('helpdeskTicketModal');
            if (modal) modal.classList.remove('active');
        }

        function saveHelpdeskTicket() {
            if (!canManageHelpdesk()) {
                alert('Nemate opravneni spravovat helpdesk');
                return;
            }
            const idInput = document.getElementById('helpdeskTicketId');
            const titleInput = document.getElementById('helpdeskTicketTitle');
            const descInput = document.getElementById('helpdeskTicketDesc');
            const clientSelect = document.getElementById('helpdeskTicketClient');
            const statusSelect = document.getElementById('helpdeskTicketStatus');
            const prioritySelect = document.getElementById('helpdeskTicketPriority');
            const assigneeInput = document.getElementById('helpdeskTicketAssignee');
            const dueInput = document.getElementById('helpdeskTicketDue');
            const sourceSelect = document.getElementById('helpdeskTicketSource');
            const tagsInput = document.getElementById('helpdeskTicketTags');

            const title = titleInput ? titleInput.value.trim() : '';
            if (!title) {
                alert('Titulek tiketu je povinny');
                return;
            }

            const now = Date.now();
            const ticketId = idInput && idInput.value ? idInput.value : createHelpdeskTicketId();
            const clientId = clientSelect ? clientSelect.value : '';
            const clientName = getHelpdeskClientName(clientId);
            const tags = tagsInput
                ? tagsInput.value.split(',').map(tag => tag.trim()).filter(Boolean)
                : [];

            const existingIndex = helpdeskTickets.findIndex(ticket => ticket.id === ticketId);
            const baseTicket = existingIndex >= 0 ? helpdeskTickets[existingIndex] : null;
            const ticketData = {
                id: ticketId,
                title,
                description: descInput ? descInput.value.trim() : '',
                clientId: clientId || '',
                clientName: clientName,
                status: statusSelect ? statusSelect.value : 'open',
                priority: prioritySelect ? prioritySelect.value : 'medium',
                assignee: assigneeInput ? assigneeInput.value.trim() : '',
                dueAt: dueInput && dueInput.value ? dueInput.value : '',
                source: sourceSelect ? sourceSelect.value : 'manual',
                tags,
                createdAt: baseTicket ? baseTicket.createdAt : now,
                updatedAt: now,
                resolvedAt: baseTicket ? baseTicket.resolvedAt : null,
                external: baseTicket ? baseTicket.external : {
                    provider: '',
                    externalId: '',
                    externalUrl: '',
                    lastSyncAt: null,
                    status: 'unlinked'
                }
            };

            if (existingIndex >= 0) {
                helpdeskTickets[existingIndex] = ticketData;
            } else {
                helpdeskTickets.push(ticketData);
            }

            saveHelpdeskTickets();
            helpdeskSelectedId = ticketId;
            closeHelpdeskTicketModal();
            renderHelpdeskView();
        }

        async function updateHelpdeskTicketStatus(ticketId, status) {
            if (!canManageHelpdesk()) {
                alert('Nemate opravneni spravovat helpdesk');
                return;
            }
            const ticket = helpdeskTickets.find(item => item.id === ticketId);
            if (!ticket) return;
            if (['resolved', 'closed'].includes(status)) {
                const canClose = await ensureHelpdeskTimeLogged(ticket);
                if (!canClose) return;
            }
            ticket.status = status;
            ticket.updatedAt = Date.now();
            if (['resolved', 'closed'].includes(status)) {
                ticket.resolvedAt = ticket.resolvedAt || ticket.updatedAt;
            } else {
                ticket.resolvedAt = null;
            }
            saveHelpdeskTickets();
            renderHelpdeskView();
        }

        // Teams integration
        function getM365AccessToken() {
            return sessionStorage.getItem('rackManagerM365AccessToken') || '';
        }

        function setM365AccessToken(token) {
            if (!token) {
                clearM365AccessToken();
                return;
            }
            sessionStorage.setItem('rackManagerM365AccessToken', token);
            sessionStorage.setItem('rackManagerM365AccessTokenAt', String(Date.now()));
        }

        function clearM365AccessToken() {
            sessionStorage.removeItem('rackManagerM365AccessToken');
            sessionStorage.removeItem('rackManagerM365AccessTokenAt');
        }

        function setTeamsStatus(message, isError) {
            var statusEl = document.getElementById('teamsStatus');
            if (!statusEl) return;
            statusEl.textContent = message || '';
            if (isError) {
                statusEl.classList.add('error');
            } else {
                statusEl.classList.remove('error');
            }
        }

        function renderTeamsView() {
            var accessNote = document.getElementById('teamsAccessNote');
            var layout = document.getElementById('teamsLayout');
            var hasUser = window.auth && auth.currentUser;
            var token = getM365AccessToken();
            var hasToken = token && token.length > 20;

            if (!hasUser) {
                if (accessNote) accessNote.style.display = 'block';
                if (layout) layout.style.display = 'none';
                setTeamsStatus('Prihlaste se pro pristup k Teams.', true);
                return;
            }

            if (!hasToken) {
                if (accessNote) accessNote.style.display = 'block';
                if (layout) layout.style.display = 'none';
                setTeamsStatus('Chybi M365 pristupovy token. Prihlaste se pres Microsoft 365.', true);
                return;
            }

            if (accessNote) accessNote.style.display = 'none';
            if (layout) layout.style.display = 'grid';
            setTeamsStatus('');
            if (!teamsState.sectionsLoaded) {
                loadTeamsSectionState();
            }
            switchTeamsTab(teamsState.tab);
            renderTeamsReplyPreview();
            if (!teamsState.lastLoadedAt || Date.now() - teamsState.lastLoadedAt > 60000) {
                loadTeamsData({ force: true });
            }
        }

        function loadTeamsSectionState() {
            try {
                teamsState.customSections = JSON.parse(localStorage.getItem('rackManagerTeamsSections') || '[]') || [];
            } catch (err) {
                teamsState.customSections = [];
            }
            try {
                teamsState.chatSectionMap = JSON.parse(localStorage.getItem('rackManagerTeamsChatSections') || '{}') || {};
            } catch (err) {
                teamsState.chatSectionMap = {};
            }
            teamsState.sectionsLoaded = true;
        }

        function saveTeamsSectionState() {
            localStorage.setItem('rackManagerTeamsSections', JSON.stringify(teamsState.customSections || []));
            localStorage.setItem('rackManagerTeamsChatSections', JSON.stringify(teamsState.chatSectionMap || {}));
        }

        function addTeamsSection() {
            var input = document.getElementById('teamsSectionInput');
            if (!input) return;
            var name = (input.value || '').trim();
            if (!name) return;
            if (!teamsState.customSections.includes(name)) {
                teamsState.customSections.push(name);
                saveTeamsSectionState();
                renderTeamsChatList();
            }
            input.value = '';
        }

        function removeTeamsSection(name) {
            teamsState.customSections = teamsState.customSections.filter(function(item) { return item !== name; });
            Object.keys(teamsState.chatSectionMap || {}).forEach(function(chatId) {
                if (teamsState.chatSectionMap[chatId] === name) {
                    delete teamsState.chatSectionMap[chatId];
                }
            });
            saveTeamsSectionState();
            renderTeamsChatList();
        }

        function setChatSection(chatId, sectionName) {
            if (!chatId) return;
            if (!sectionName) {
                delete teamsState.chatSectionMap[chatId];
            } else {
                teamsState.chatSectionMap[chatId] = sectionName;
            }
            saveTeamsSectionState();
            renderTeamsChatList();
        }

        function getChatSection(chatId) {
            return teamsState.chatSectionMap && teamsState.chatSectionMap[chatId]
                ? teamsState.chatSectionMap[chatId]
                : '';
        }

        function stripGraphTop(path) {
            if (!path || path.indexOf('?') === -1) return path;
            var parts = path.split('?');
            var base = parts[0];
            var params = new URLSearchParams(parts.slice(1).join('?'));
            params.delete('$top');
            var query = params.toString();
            return query ? base + '?' + query : base;
        }

        function stripGraphOrderBy(path) {
            if (!path || path.indexOf('?') === -1) return path;
            var parts = path.split('?');
            var base = parts[0];
            var params = new URLSearchParams(parts.slice(1).join('?'));
            params.delete('$orderby');
            var query = params.toString();
            return query ? base + '?' + query : base;
        }

        function stripGraphExpandAttachments(path) {
            if (!path || path.indexOf('?') === -1) return path;
            var parts = path.split('?');
            var base = parts[0];
            var params = new URLSearchParams(parts.slice(1).join('?'));
            var expand = params.get('$expand');
            if (!expand) return path;
            if (expand.indexOf('attachments') === -1) return path;
            var cleaned = expand
                .split(',')
                .map(function(item) { return item.trim(); })
                .filter(function(item) { return item && item !== 'attachments'; })
                .join(',');
            if (cleaned) {
                params.set('$expand', cleaned);
            } else {
                params.delete('$expand');
            }
            var query = params.toString();
            return query ? base + '?' + query : base;
        }

        async function graphRequest(path, options) {
            var token = getM365AccessToken();
            if (!token) {
                throw new Error('M365 token missing.');
            }
            var config = options || {};
            var retry = config.retry || { top: true, orderby: true, expandAttachments: true };
            var response = await fetch('https://graph.microsoft.com/v1.0' + path, {
                method: config.method || 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: config.body || null
            });
            if (response.status === 204) {
                return {};
            }
            var text = await response.text();
            var data = {};
            try {
                data = text ? JSON.parse(text) : {};
            } catch (err) {
                data = { raw: text };
            }
            if (!response.ok) {
                var message = data && data.error && data.error.message ? data.error.message : response.statusText;
                var error = new Error(message || 'Graph error');
                error.status = response.status;
                error.code = data && data.error && data.error.code ? data.error.code : response.status;
                if (retry.top && path.indexOf('$top') !== -1 && message && message.indexOf('Query option') !== -1 && message.indexOf('Top') !== -1) {
                    return graphRequest(stripGraphTop(path), Object.assign({}, config, { retry: Object.assign({}, retry, { top: false }) }));
                }
                if (retry.orderby && path.indexOf('$orderby') !== -1 && message && message.indexOf('order by') !== -1) {
                    return graphRequest(stripGraphOrderBy(path), Object.assign({}, config, { retry: Object.assign({}, retry, { orderby: false }) }));
                }
                if (retry.expandAttachments && path.indexOf('$expand') !== -1 && message && message.indexOf('expand') !== -1 && message.indexOf('attachments') !== -1) {
                    return graphRequest(stripGraphExpandAttachments(path), Object.assign({}, config, { retry: Object.assign({}, retry, { expandAttachments: false }) }));
                }
                throw error;
            }
            return data;
        }

        function handleTeamsError(err) {
            if (!err) return;
            var message = err.message || 'Graph error';
            if (err.status === 401 || err.code === 'InvalidAuthenticationToken') {
                message = 'Token pro Teams expiroval. Prihlaste se znovu.';
            }
            if (err.status === 403) {
                message = 'Chybi scopes pro Teams. Zkontrolujte M365 nastaveni.';
            }
            setTeamsStatus(message, true);
        }

        function switchTeamsTab(tab) {
            teamsState.tab = tab === 'channels' ? 'channels' : 'chats';
            var chatWrap = document.getElementById('teamsChatsWrap');
            var channelWrap = document.getElementById('teamsChannelsWrap');
            if (chatWrap) chatWrap.style.display = teamsState.tab === 'chats' ? 'block' : 'none';
            if (channelWrap) channelWrap.style.display = teamsState.tab === 'channels' ? 'block' : 'none';
            document.querySelectorAll('.teams-tab').forEach(function(btn) {
                var isActive = btn.getAttribute('data-tab') === teamsState.tab;
                btn.classList.toggle('active', isActive);
            });
            renderTeamsLists();
            if (teamsState.tab === 'channels') {
                if (teamsState.teams.length === 0) {
                    loadTeamsData({ force: false });
                } else if (!teamsState.selectedTeamId && teamsState.teams[0]) {
                    selectTeamsTeam(teamsState.teams[0].id);
                } else {
                    renderTeamsMessages();
                }
            } else if (teamsState.tab === 'chats' && teamsState.chats.length) {
                if (!teamsState.selectedChatId) {
                    selectTeamsChat(teamsState.chats[0].id);
                } else {
                    renderTeamsMessages();
                }
            }
        }

        async function loadTeamsData(options) {
            if (!ensureTeamsAccess()) return;
            var force = options && options.force;
            if (!force && teamsState.loading) return;
            teamsState.loading = true;
            setTeamsStatus('Nacitam Teams data...', false);
            try {
                var results = await Promise.all([
                    graphRequest('/me/chats?$top=40'),
                    graphRequest('/me/joinedTeams?$top=50'),
                    graphRequest('/me').catch(function() { return null; })
                ]);
                teamsState.chats = results[0] && results[0].value ? results[0].value : [];
                teamsState.teams = results[1] && results[1].value ? results[1].value : [];
                teamsState.graphUser = results[2] || teamsState.graphUser;
                teamsState.lastLoadedAt = Date.now();
                renderTeamsLists();
                if (teamsState.tab === 'chats' && teamsState.chats.length) {
                    if (!teamsState.selectedChatId) {
                        selectTeamsChat(teamsState.chats[0].id);
                    }
                }
                if (teamsState.tab === 'channels' && teamsState.teams.length) {
                    if (!teamsState.selectedTeamId) {
                        selectTeamsTeam(teamsState.teams[0].id);
                    }
                }
                setTeamsStatus('Teams data pripraveny.', false);
            } catch (err) {
                handleTeamsError(err);
            } finally {
                teamsState.loading = false;
            }
        }

        function refreshTeamsData(force) {
            return loadTeamsData({ force: !!force });
        }

        function ensureTeamsAccess() {
            var hasUser = window.auth && auth.currentUser;
            if (!hasUser) {
                setTeamsStatus('Prihlaste se pro pristup k Teams.', true);
                return false;
            }
            if (!getM365AccessToken()) {
                setTeamsStatus('Chybi M365 pristupovy token. Prihlaste se pres Microsoft 365.', true);
                return false;
            }
            return true;
        }

        function renderTeamsLists() {
            renderTeamsChatList();
            renderTeamsTeamList();
        }

        function renderTeamsChatList() {
            var list = document.getElementById('teamsChatList');
            if (!list) return;
            list.innerHTML = '';
            if (teamsState.tab !== 'chats') return;
            if (!teamsState.chats.length) {
                list.innerHTML = '<div class="teams-empty">Zadne chaty.</div>';
                return;
            }
            var assignedMap = teamsState.chatSectionMap || {};
            var customSections = teamsState.customSections || [];
            var assignedSections = {};
            customSections.forEach(function(section) {
                assignedSections[section] = [];
            });

            var unassigned = [];
            var filteredChats = filterTeamsChats(teamsState.chats);
            filteredChats.forEach(function(chat) {
                var section = assignedMap[chat.id];
                if (section && assignedSections[section]) {
                    assignedSections[section].push(chat);
                } else {
                    unassigned.push(chat);
                }
            });

            if (customSections.length) {
                customSections.forEach(function(section) {
                    var items = assignedSections[section] || [];
                    var body = appendChatGroup(list, section, items.length, function() {
                        removeTeamsSection(section);
                    });
                    if (!items.length) {
                        appendSectionEmpty(body, 'Zatim bez chatu.');
                    } else {
                        items.forEach(function(chat) {
                            body.appendChild(buildTeamsChatItem(chat));
                        });
                    }
                });
            }

            var groupChats = unassigned.filter(function(chat) { return chat.chatType !== 'oneOnOne'; });
            var oneOnOneChats = unassigned.filter(function(chat) { return chat.chatType === 'oneOnOne'; });

            var groupBody = appendChatGroup(list, 'Hromadne chaty', groupChats.length);
            if (!groupChats.length) {
                appendSectionEmpty(groupBody, 'Zadne hromadne chaty.');
            } else {
                groupChats.forEach(function(chat) {
                    groupBody.appendChild(buildTeamsChatItem(chat));
                });
            }

            var oneBody = appendChatGroup(list, '1v1 chaty', oneOnOneChats.length);
            if (!oneOnOneChats.length) {
                appendSectionEmpty(oneBody, 'Zadne 1v1 chaty.');
            } else {
                oneOnOneChats.forEach(function(chat) {
                    oneBody.appendChild(buildTeamsChatItem(chat));
                });
            }
        }

        function filterTeamsChats(chats) {
            var query = (teamsState.searchQuery || '').trim().toLowerCase();
            if (!query) return chats;
            return chats.filter(function(chat) {
                var label = getChatDisplayName(chat).toLowerCase();
                return label.indexOf(query) !== -1;
            });
        }

        function appendChatGroup(container, title, count, onRemove) {
            var group = document.createElement('div');
            group.className = 'teams-chat-group';
            var head = buildTeamsChatSection(title, count, onRemove);
            group.appendChild(head);
            var body = document.createElement('div');
            body.className = 'teams-chat-group-body';
            group.appendChild(body);
            container.appendChild(group);
            return body;
        }

        function buildTeamsChatSection(title, count, onRemove) {
            var head = document.createElement('div');
            head.className = 'teams-section-head';
            var label = document.createElement('div');
            label.className = 'teams-section-title';
            var titleSpan = document.createElement('span');
            titleSpan.textContent = title;
            label.appendChild(titleSpan);
            if (typeof count === 'number') {
                var countEl = document.createElement('span');
                countEl.className = 'teams-section-count';
                countEl.textContent = String(count);
                label.appendChild(countEl);
            }
            head.appendChild(label);
            if (onRemove) {
                var removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'teams-section-remove';
                removeBtn.textContent = 'Smazat';
                removeBtn.addEventListener('click', function(event) {
                    event.stopPropagation();
                    onRemove();
                });
                head.appendChild(removeBtn);
            }
            return head;
        }

        function appendSectionEmpty(container, text) {
            var empty = document.createElement('div');
            empty.className = 'teams-section-empty';
            empty.textContent = text;
            container.appendChild(empty);
        }

        function buildTeamsChatItem(chat) {
            var item = document.createElement('div');
            item.className = 'teams-item' + (chat.id === teamsState.selectedChatId ? ' active' : '');
            item.tabIndex = 0;
            var label = getChatDisplayName(chat) || (chat.chatType === 'oneOnOne' ? '1:1 chat' : 'Group chat');
            var row = document.createElement('div');
            row.className = 'teams-item-row';
            var avatar = document.createElement('div');
            avatar.className = 'teams-item-avatar';
            avatar.textContent = getTeamsInitials(label);
            avatar.style.background = getTeamsAvatarColor(label);
            row.appendChild(avatar);
            var content = document.createElement('div');
            content.className = 'teams-item-content';
            var titleRow = document.createElement('div');
            titleRow.className = 'teams-item-title-row';
            var title = document.createElement('div');
            title.className = 'teams-item-title';
            title.textContent = label;
            titleRow.appendChild(title);
            var dateTag = formatTeamsDateShort(chat.lastUpdatedDateTime);
            if (dateTag) {
                var timeTag = document.createElement('div');
                timeTag.className = 'teams-item-time';
                timeTag.textContent = dateTag;
                titleRow.appendChild(timeTag);
            }
            content.appendChild(titleRow);
            var subtitle = document.createElement('div');
            subtitle.className = 'teams-item-subtitle';
            var preview = '';
            if (chat.lastMessagePreview && chat.lastMessagePreview.body && chat.lastMessagePreview.body.content) {
                preview = stripTeamsHtml(chat.lastMessagePreview.body.content || '').trim();
            }
            if (preview.length > 90) {
                preview = preview.slice(0, 90) + '...';
            }
            var typeLabel = chat.chatType === 'oneOnOne' ? '1v1' : 'Skupina';
            subtitle.textContent = preview ? (typeLabel + '  ' + preview) : typeLabel;
            content.appendChild(subtitle);
            row.appendChild(content);
            item.appendChild(row);

            if (teamsState.customSections && teamsState.customSections.length) {
                var select = document.createElement('select');
                select.className = 'teams-section-select';
                var optNone = document.createElement('option');
                optNone.value = '';
                optNone.textContent = 'Bez sekce';
                select.appendChild(optNone);
                teamsState.customSections.forEach(function(section) {
                    var opt = document.createElement('option');
                    opt.value = section;
                    opt.textContent = section;
                    select.appendChild(opt);
                });
                select.value = getChatSection(chat.id);
                select.addEventListener('click', function(event) {
                    event.stopPropagation();
                });
                select.addEventListener('change', function(event) {
                    event.stopPropagation();
                    setChatSection(chat.id, select.value);
                });
                item.appendChild(select);
            }

            item.addEventListener('click', function() {
                selectTeamsChat(chat.id);
            });
            item.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    selectTeamsChat(chat.id);
                }
            });
            return item;
        }

        function setTeamsSearchQuery(value) {
            teamsState.searchQuery = value || '';
            renderTeamsChatList();
        }

        function formatTeamsDateShort(value) {
            if (!value) return '';
            var date = new Date(value);
            if (Number.isNaN(date.getTime())) return '';
            return date.toLocaleDateString();
        }

        function getTeamsCurrentUserId() {
            return teamsState.graphUser && teamsState.graphUser.id ? teamsState.graphUser.id : '';
        }

        function getTeamsCurrentUserName() {
            if (teamsState.graphUser) {
                return teamsState.graphUser.displayName || teamsState.graphUser.userPrincipalName || '';
            }
            return auth && auth.currentUser ? (auth.currentUser.displayName || auth.currentUser.email || '') : '';
        }

        function isTeamsMessageFromCurrentUser(message) {
            if (!message) return false;
            var senderId = message.from && message.from.user ? message.from.user.id : '';
            var currentId = getTeamsCurrentUserId();
            if (senderId && currentId && senderId === currentId) {
                return true;
            }
            var senderName = message.from && message.from.user ? message.from.user.displayName : '';
            var currentName = getTeamsCurrentUserName();
            if (senderName && currentName && senderName === currentName) {
                return true;
            }
            return false;
        }

        function getTeamsSenderColor(message) {
            var id = '';
            if (message && message.from && message.from.user) {
                id = message.from.user.id || message.from.user.displayName || '';
            }
            if (!id) return '#c9bfb4';
            if (teamsState.senderColors && teamsState.senderColors[id]) {
                return teamsState.senderColors[id];
            }
            var palette = ['#f0b58f', '#94c5f8', '#f3d17a', '#9fd6b5', '#c7a7f5', '#f5a9b8'];
            var hash = 0;
            for (var i = 0; i < id.length; i += 1) {
                hash = (hash << 5) - hash + id.charCodeAt(i);
                hash |= 0;
            }
            var color = palette[Math.abs(hash) % palette.length];
            teamsState.senderColors = teamsState.senderColors || {};
            teamsState.senderColors[id] = color;
            return color;
        }

        function getTeamsInitials(name) {
            if (!name) return '?';
            var parts = name.trim().split(/\s+/).filter(Boolean);
            var initials = parts.slice(0, 2).map(function(part) { return part[0]; }).join('');
            return initials.toUpperCase() || '?';
        }

        function getTeamsAvatarColor(name) {
            var colors = ['#f2994a', '#f6b26b', '#6fcf97', '#56ccf2', '#bb6bd9', '#eb5757'];
            var sum = 0;
            for (var i = 0; i < name.length; i += 1) {
                sum += name.charCodeAt(i);
            }
            return colors[sum % colors.length];
        }

        function renderTeamsTeamList() {
            var list = document.getElementById('teamsTeamList');
            if (!list) return;
            list.innerHTML = '';
            if (teamsState.tab !== 'channels') return;
            if (!teamsState.teams.length) {
                list.innerHTML = '<div class="teams-empty">Zadne teamy.</div>';
                return;
            }
            teamsState.teams.forEach(function(team) {
                var wrapper = document.createElement('div');
                wrapper.className = 'teams-team-item';
                var row = document.createElement('button');
                row.type = 'button';
                row.className = 'teams-team-row' + (team.id === teamsState.selectedTeamId ? ' active' : '');
                var icon = document.createElement('span');
                icon.className = 'teams-team-icon';
                icon.textContent = getTeamsInitials(team.displayName || 'T');
                var name = document.createElement('span');
                name.className = 'teams-team-name';
                name.textContent = team.displayName || 'Team';
                row.appendChild(icon);
                row.appendChild(name);
                row.addEventListener('click', function() {
                    selectTeamsTeam(team.id);
                });
                wrapper.appendChild(row);

                if (team.id === teamsState.selectedTeamId) {
                    var channelsWrap = document.createElement('div');
                    channelsWrap.className = 'teams-channel-list';
                    var channels = teamsState.channelsByTeam && teamsState.channelsByTeam[team.id] ? teamsState.channelsByTeam[team.id] : [];
                    if (!channels.length) {
                        var empty = document.createElement('div');
                        empty.className = 'teams-section-empty';
                        empty.textContent = 'Nacitam kanaly...';
                        channelsWrap.appendChild(empty);
                    } else {
                        channels.forEach(function(channel) {
                            var channelBtn = document.createElement('button');
                            channelBtn.type = 'button';
                            channelBtn.className = 'teams-channel-item' + (channel.id === teamsState.selectedChannelId ? ' active' : '');
                            var hash = document.createElement('span');
                            hash.className = 'teams-channel-hash';
                            hash.textContent = '#';
                            var label = document.createElement('span');
                            label.textContent = channel.displayName || 'Kanal';
                            channelBtn.appendChild(hash);
                            channelBtn.appendChild(label);
                            channelBtn.addEventListener('click', function(event) {
                                event.stopPropagation();
                                selectTeamsChannel(channel.id);
                            });
                            channelsWrap.appendChild(channelBtn);
                        });
                    }
                    wrapper.appendChild(channelsWrap);
                }

                list.appendChild(wrapper);
            });
        }

        function renderTeamsChannelList() {
            renderTeamsTeamList();
        }

        function setTeamsThreadHeader(title, meta) {
            var titleEl = document.getElementById('teamsThreadTitle');
            var metaEl = document.getElementById('teamsThreadMeta');
            if (titleEl) titleEl.textContent = title || 'Vyber chat nebo kanal';
            if (metaEl) metaEl.textContent = meta || '-';
            updateTeamsThreadTabs();
        }

        function setTeamsThreadTab(tab) {
            teamsState.threadTab = tab || 'posts';
            updateTeamsThreadTabs();
        }

        function updateTeamsThreadTabs() {
            var tabs = document.getElementById('teamsThreadTabs');
            if (!tabs) return;
            var show = teamsState.tab === 'channels' && !!teamsState.selectedChannelId;
            tabs.style.display = show ? 'flex' : 'none';
            var active = teamsState.threadTab || 'posts';
            var buttons = tabs.querySelectorAll('.teams-thread-tab');
            buttons.forEach(function(btn) {
                btn.classList.toggle('active', btn.dataset.tab === active);
            });
        }

        function selectTeamsChat(chatId) {
            teamsState.selectedChatId = chatId;
            clearTeamsPreview();
            teamsState.activeEmojiPicker = null;
            clearTeamsReply();
            var chat = teamsState.chats.find(function(item) { return item.id === chatId; });
            var label = chat ? getChatDisplayName(chat) : '';
            setTeamsThreadHeader(label || 'Chat', chat && chat.chatType ? chat.chatType : '');
            renderTeamsChatList();
            loadTeamsMessages();
            if (chat) {
                loadChatMembers(chat.id);
            }
        }

        async function selectTeamsTeam(teamId) {
            teamsState.selectedTeamId = teamId;
            teamsState.selectedChannelId = null;
            clearTeamsPreview();
            renderTeamsTeamList();
            setTeamsThreadHeader('Vyber kanal', '');
            await loadTeamsChannels(teamId);
        }

        function selectTeamsChannel(channelId) {
            teamsState.selectedChannelId = channelId;
            clearTeamsPreview();
            teamsState.activeEmojiPicker = null;
            clearTeamsReply();
            var team = teamsState.teams.find(function(item) { return item.id === teamsState.selectedTeamId; });
            var channels = teamsState.channelsByTeam[teamsState.selectedTeamId] || [];
            var channel = channels.find(function(item) { return item.id === channelId; });
            setTeamsThreadHeader(channel && channel.displayName ? channel.displayName : 'Channel', team && team.displayName ? team.displayName : '');
            renderTeamsTeamList();
            loadTeamsMessages();
        }

        async function loadTeamsChannels(teamId) {
            if (!teamId) return;
            if (teamsState.channelsByTeam[teamId]) {
                renderTeamsTeamList();
                if (!teamsState.selectedChannelId && teamsState.channelsByTeam[teamId][0]) {
                    selectTeamsChannel(teamsState.channelsByTeam[teamId][0].id);
                }
                return;
            }
            setTeamsStatus('Nacitam kanaly...', false);
            try {
                var data = await graphRequest('/teams/' + teamId + '/channels?$top=50');
                teamsState.channelsByTeam[teamId] = data.value || [];
                renderTeamsTeamList();
                if (!teamsState.selectedChannelId && teamsState.channelsByTeam[teamId][0]) {
                    selectTeamsChannel(teamsState.channelsByTeam[teamId][0].id);
                }
                setTeamsStatus('Kanaly pripraveny.', false);
            } catch (err) {
                handleTeamsError(err);
            }
        }

        function refreshTeamsMessages() {
            return loadTeamsMessages();
        }

        async function loadTeamsMessages() {
            if (!ensureTeamsAccess()) return;
            var path = '';
            if (teamsState.tab === 'chats') {
                if (!teamsState.selectedChatId) {
                    setTeamsThreadHeader('Vyber chat nebo kanal', '');
                    return;
                }
                path = '/chats/' + teamsState.selectedChatId + '/messages';
            } else {
                if (!teamsState.selectedTeamId || !teamsState.selectedChannelId) {
                    setTeamsThreadHeader('Vyber kanal', '');
                    return;
                }
                path = '/teams/' + teamsState.selectedTeamId + '/channels/' + teamsState.selectedChannelId + '/messages';
            }
            setTeamsStatus('Nacitam zpravy...', false);
            try {
                var data = await graphRequest(path);
            teamsState.messages = (data.value || []).map(function(item) {
                item._attachmentsLoaded = false;
                return item;
            });
            teamsState.localMessages = [];
            teamsState.messages.sort(function(a, b) {
                return new Date(a.createdDateTime || 0) - new Date(b.createdDateTime || 0);
            });
                renderTeamsMessages();
                setTeamsStatus('Zpravy pripraveny.', false);
            } catch (err) {
                handleTeamsError(err);
            }
        }

        function renderTeamsMessages() {
            var container = document.getElementById('teamsThreadMessages');
            if (!container) return;
            container.innerHTML = '';
            var allMessages = mergeTeamsMessages();
            if (!allMessages.length) {
                container.innerHTML = '<div class="teams-empty">Zadne zpravy.</div>';
                return;
            }
            allMessages.forEach(function(message) {
                var isMine = isTeamsMessageFromCurrentUser(message);
                var row = document.createElement('div');
                row.className = 'teams-message-row' + (isMine ? ' me' : '');
                var bubble = document.createElement('div');
                bubble.className = 'teams-message-bubble' + (isMine ? ' me' : '');
                bubble.style.borderLeft = '4px solid ' + getTeamsSenderColor(message);
                bubble.style.position = 'relative';

                var header = document.createElement('div');
                header.className = 'teams-message-header';
                var author = message.from && message.from.user ? message.from.user.displayName : 'Unknown';
                var time = formatTeamsDate(message.createdDateTime);
                var authorEl = document.createElement('div');
                authorEl.className = 'teams-message-author';
                authorEl.textContent = author;
                var timeEl = document.createElement('div');
                timeEl.className = 'teams-message-time';
                timeEl.textContent = time;
                header.appendChild(authorEl);
                header.appendChild(timeEl);

                var replyData = getTeamsMessageReply(message.id);
                if (replyData) {
                    var replyWrap = document.createElement('div');
                    replyWrap.className = 'teams-message-reply';
                    replyWrap.textContent = replyData.author + ': ' + (replyData.content || 'Prazdna zprava');
                    bubble.appendChild(replyWrap);
                }

                var body = document.createElement('div');
                body.className = 'teams-message-body';
                body.textContent = buildTeamsMessageText(message);

                bubble.appendChild(header);
                bubble.appendChild(body);

                var actions = document.createElement('div');
                actions.className = 'teams-message-actions';
                var reactBtn = document.createElement('button');
                reactBtn.type = 'button';
                reactBtn.className = 'teams-action-btn';
                reactBtn.textContent = '';
                reactBtn.title = 'Reagovat';
                reactBtn.addEventListener('click', function(event) {
                    event.stopPropagation();
                    toggleTeamsEmojiPicker(message.id);
                });
                var replyBtn = document.createElement('button');
                replyBtn.type = 'button';
                replyBtn.className = 'teams-action-btn';
                replyBtn.textContent = '';
                replyBtn.title = 'Odpovedet';
                replyBtn.addEventListener('click', function(event) {
                    event.stopPropagation();
                    setTeamsReply(message);
                });
                actions.appendChild(reactBtn);
                actions.appendChild(replyBtn);
                bubble.appendChild(actions);

                if (teamsState.activeEmojiPicker === message.id) {
                    var picker = document.createElement('div');
                    picker.className = 'teams-emoji-picker';
                    getTeamsQuickEmojis().forEach(function(emoji) {
                        var emojiBtn = document.createElement('button');
                        emojiBtn.type = 'button';
                        emojiBtn.textContent = emoji;
                        emojiBtn.addEventListener('click', function(event) {
                            event.stopPropagation();
                            handleTeamsReaction(message.id, emoji);
                        });
                        picker.appendChild(emojiBtn);
                    });
                    bubble.appendChild(picker);
                }

                var attachments = message.attachments || [];
                if (attachments.length) {
                    var attWrap = document.createElement('div');
                    attWrap.className = 'teams-attachments';
                    attachments.forEach(function(att) {
                        var btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'teams-attachment';
                        btn.textContent = att.name || 'Attachment';
                        btn.addEventListener('click', function() {
                            openTeamsPreviewFromAttachment(att);
                        });
                        attWrap.appendChild(btn);
                    });
                    bubble.appendChild(attWrap);
                } else if (messageHasAttachmentHint(message)) {
                    var loadWrap = document.createElement('div');
                    loadWrap.className = 'teams-attachments';
                    if (message._attachmentsLoaded) {
                        var empty = document.createElement('div');
                        empty.className = 'teams-section-empty';
                        empty.textContent = 'Zadne soubory.';
                        loadWrap.appendChild(empty);
                    } else {
                        var loadBtn = document.createElement('button');
                        loadBtn.type = 'button';
                        loadBtn.className = 'teams-attachment';
                        loadBtn.textContent = 'Nacist soubory';
                        loadBtn.addEventListener('click', function(event) {
                            event.stopPropagation();
                            loadTeamsAttachmentsForMessage(message);
                        });
                        loadWrap.appendChild(loadBtn);
                    }
                    bubble.appendChild(loadWrap);
                }

                var reactions = getTeamsMessageReactions(message.id);
                if (reactions.length) {
                    var reactionsWrap = document.createElement('div');
                    reactionsWrap.className = 'teams-reactions';
                    reactions.forEach(function(reaction) {
                        var reactionBtn = document.createElement('button');
                        reactionBtn.type = 'button';
                        reactionBtn.className = 'teams-reaction' + (reaction.reacted ? ' active' : '');
                        reactionBtn.textContent = reaction.emoji + ' ' + reaction.count;
                        reactionBtn.addEventListener('click', function(event) {
                            event.stopPropagation();
                            handleTeamsReaction(message.id, reaction.emoji);
                        });
                        reactionsWrap.appendChild(reactionBtn);
                    });
                    bubble.appendChild(reactionsWrap);
                }

                var avatar = document.createElement('div');
                avatar.className = 'teams-avatar';
                avatar.style.background = getTeamsSenderColor(message);
                avatar.textContent = getTeamsInitials(author);

                if (isMine) {
                    row.appendChild(bubble);
                    row.appendChild(avatar);
                } else {
                    row.appendChild(avatar);
                    row.appendChild(bubble);
                }
                container.appendChild(row);
            });
        }

        function mergeTeamsMessages() {
            var base = teamsState.messages || [];
            var locals = teamsState.localMessages || [];
            if (!locals.length) return base;
            var merged = base.slice();
            locals.forEach(function(local) {
                var exists = base.some(function(msg) {
                    var author = msg.from && msg.from.user ? msg.from.user.displayName : '';
                    var content = buildTeamsMessageText(msg);
                    if (!author || !content) return false;
                    return author === local.author && content === local.content;
                });
                if (!exists) merged.push(local);
            });
            return merged;
        }

        function getTeamsQuickEmojis() {
            return ['', '', '', '', '', '', '', ''];
        }

        function getTeamsMessageReactions(messageId) {
            return teamsState.messageReactions && teamsState.messageReactions[messageId]
                ? teamsState.messageReactions[messageId]
                : [];
        }

        function handleTeamsReaction(messageId, emoji) {
            var reactions = getTeamsMessageReactions(messageId);
            var existing = reactions.find(function(r) { return r.emoji === emoji; });
            var updated = reactions.slice();
            if (existing) {
                updated = updated.map(function(r) {
                    if (r.emoji !== emoji) return r;
                    var nextCount = r.reacted ? r.count - 1 : r.count + 1;
                    return { emoji: r.emoji, count: Math.max(nextCount, 0), reacted: !r.reacted };
                }).filter(function(r) { return r.count > 0; });
            } else {
                updated.push({ emoji: emoji, count: 1, reacted: true });
            }
            teamsState.messageReactions = teamsState.messageReactions || {};
            teamsState.messageReactions[messageId] = updated;
            teamsState.activeEmojiPicker = null;
            renderTeamsMessages();
        }

        function toggleTeamsEmojiPicker(messageId) {
            teamsState.activeEmojiPicker = teamsState.activeEmojiPicker === messageId ? null : messageId;
            renderTeamsMessages();
        }

        function setTeamsReply(message) {
            if (!message) return;
            var author = message.from && message.from.user ? message.from.user.displayName : 'Unknown';
            var content = buildTeamsMessageText(message);
            teamsState.replyToMessage = { id: message.id, author: author, content: content };
            renderTeamsReplyPreview();
        }

        function clearTeamsReply() {
            teamsState.replyToMessage = null;
            renderTeamsReplyPreview();
        }

        function renderTeamsReplyPreview() {
            var preview = document.getElementById('teamsReplyPreview');
            var authorEl = document.getElementById('teamsReplyAuthor');
            var snippetEl = document.getElementById('teamsReplySnippet');
            if (!preview || !authorEl || !snippetEl) return;
            if (!teamsState.replyToMessage) {
                preview.style.display = 'none';
                return;
            }
            preview.style.display = 'flex';
            authorEl.textContent = teamsState.replyToMessage.author;
            snippetEl.textContent = teamsState.replyToMessage.content || 'Prazdna zprava';
        }

        function getTeamsMessageReply(messageId) {
            return teamsState.messageReplies && teamsState.messageReplies[messageId]
                ? teamsState.messageReplies[messageId]
                : null;
        }

        function stripTeamsHtml(html) {
            var temp = document.createElement('div');
            temp.innerHTML = html || '';
            return (temp.textContent || '').trim();
        }

        function escapeHtml(value) {
            return (value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function buildTeamsMessageText(message) {
            if (!message) return '';
            var raw = '';
            if (message.body && message.body.content) {
                raw = stripTeamsHtml(message.body.content);
            }
            if (!raw && message.content) {
                raw = message.content;
            }
            if (!raw && message.summary) {
                raw = message.summary;
            }
            if (!raw && message.bodyPreview) {
                raw = message.bodyPreview;
            }
            if (!raw && message.subject) {
                raw = message.subject;
            }
            return raw || '';
        }

        function messageHasAttachmentHint(message) {
            if (!message) return false;
            if (Array.isArray(message.attachments) && message.attachments.length) return true;
            if (message.hasAttachments) return true;
            var body = message.body && message.body.content ? message.body.content : '';
            if (body.indexOf('<attachment') !== -1) return true;
            return false;
        }

        async function loadTeamsAttachmentsForMessage(message) {
            if (!message || !message.id) return;
            if (message._attachmentsLoaded) return;
            message._attachmentsLoaded = true;
            try {
                var path = '';
                if (teamsState.tab === 'chats') {
                    if (!teamsState.selectedChatId) return;
                    path = '/chats/' + teamsState.selectedChatId + '/messages/' + message.id + '/attachments';
                } else {
                    if (!teamsState.selectedTeamId || !teamsState.selectedChannelId) return;
                    path = '/teams/' + teamsState.selectedTeamId + '/channels/' + teamsState.selectedChannelId + '/messages/' + message.id + '/attachments';
                }
                var data = await graphRequest(path);
                message.attachments = data && data.value ? data.value : [];
                renderTeamsMessages();
            } catch (err) {
                message._attachmentsLoaded = true;
                handleTeamsError(err);
                renderTeamsMessages();
            }
        }

        function getChatDisplayName(chat) {
            if (!chat) return '';
            if (chat.topic) return chat.topic;
            var cached = teamsState.chatMembersById[chat.id];
            if (cached && cached.displayName) return cached.displayName;
            if (!cached && chat.chatType === 'oneOnOne') {
                loadChatMembers(chat.id);
            }
            return chat.chatType === 'oneOnOne' ? '1:1 chat' : 'Group chat';
        }

        async function loadChatMembers(chatId) {
            if (!chatId) return;
            var cached = teamsState.chatMembersById[chatId];
            if (cached && cached.loading) return;
            if (cached && cached.displayName) return;
            teamsState.chatMembersById[chatId] = { loading: true };
            try {
                var data = await graphRequest('/chats/' + chatId + '/members');
                var members = data && data.value ? data.value : [];
                var names = members.map(function(member) {
                    if (member.displayName) return member.displayName;
                    if (member.user && member.user.displayName) return member.user.displayName;
                    return '';
                }).filter(Boolean);
                var current = auth && auth.currentUser ? (auth.currentUser.displayName || auth.currentUser.email || '') : '';
                var filtered = names.filter(function(name) { return name && name !== current; });
                var displayName = filtered.join(', ') || names.join(', ') || 'Chat';
                teamsState.chatMembersById[chatId] = { displayName: displayName, members: members };
                renderTeamsChatList();
                if (teamsState.selectedChatId === chatId) {
                    setTeamsThreadHeader(displayName, 'oneOnOne');
                }
            } catch (err) {
                if (err && err.status === 403) {
                    setTeamsStatus('Chybi scope ChatMember.Read.All pro nazvy 1:1 chatu.', true);
                }
                teamsState.chatMembersById[chatId] = { displayName: '1:1 chat' };
            }
        }

        function formatTeamsDate(value) {
            if (!value) return '';
            var date = new Date(value);
            if (Number.isNaN(date.getTime())) return '';
            return date.toLocaleString();
        }

        function getTeamsAttachmentUrl(att) {
            if (!att) return '';
            if (att.contentUrl) return att.contentUrl;
            if (att.content) {
                if (typeof att.content === 'string') {
                    try {
                        var parsed = JSON.parse(att.content);
                        return parsed.webUrl || parsed.contentUrl || '';
                    } catch (err) {
                        return '';
                    }
                }
                if (typeof att.content === 'object') {
                    return att.content.webUrl || att.content.contentUrl || '';
                }
            }
            return '';
        }

        function openTeamsPreviewFromAttachment(att) {
            var url = getTeamsAttachmentUrl(att);
            if (!url) {
                setTeamsStatus('Soubor nema dostupny odkaz.', true);
                return;
            }
            openTeamsPreview(url, att.name || 'Attachment');
        }

        function openTeamsPreview(url, name) {
            teamsState.previewUrl = url || '';
            teamsState.previewName = name || '';
            renderTeamsPreview();
        }

        function clearTeamsPreview() {
            teamsState.previewUrl = '';
            teamsState.previewName = '';
            renderTeamsPreview();
        }

        function renderTeamsPreview() {
            var wrap = document.getElementById('teamsPreviewFrameWrap');
            var frame = document.getElementById('teamsPreviewFrame');
            var empty = document.getElementById('teamsPreviewEmpty');
            var openBtn = document.getElementById('teamsPreviewOpenBtn');
            if (!wrap || !frame || !empty || !openBtn) return;
            if (!teamsState.previewUrl) {
                frame.src = 'about:blank';
                wrap.style.display = 'none';
                empty.style.display = 'block';
                openBtn.style.display = 'none';
                return;
            }
            frame.src = teamsState.previewUrl;
            wrap.style.display = 'block';
            empty.style.display = 'none';
            openBtn.style.display = 'inline-flex';
        }

        function openTeamsPreviewInNewTab() {
            if (!teamsState.previewUrl) return;
            window.open(teamsState.previewUrl, '_blank');
        }

        async function sendTeamsMessage() {
            if (!ensureTeamsAccess()) return;
            var input = document.getElementById('teamsMessageInput');
            if (!input) return;
            var message = input.value.trim();
            if (!message) return;
            var sendBtn = document.getElementById('teamsSendBtn');
            if (sendBtn) sendBtn.disabled = true;
            try {
                var payload = {
                    body: {
                        contentType: 'html',
                        content: escapeHtml(message).replace(/\n/g, '<br>')
                    }
                };
                var path = '';
                if (teamsState.tab === 'chats') {
                    if (!teamsState.selectedChatId) {
                        throw new Error('Vyber chat pro odeslani zpravy.');
                    }
                    path = '/chats/' + teamsState.selectedChatId + '/messages';
                } else {
                    if (!teamsState.selectedTeamId || !teamsState.selectedChannelId) {
                        throw new Error('Vyber kanal pro odeslani zpravy.');
                    }
                    path = '/teams/' + teamsState.selectedTeamId + '/channels/' + teamsState.selectedChannelId + '/messages';
                }
                await graphRequest(path, { method: 'POST', body: JSON.stringify(payload) });
                var localMessage = {
                    id: 'local-' + Date.now(),
                    author: 'Vy',
                    content: message,
                    createdDateTime: new Date().toISOString(),
                    from: {
                        user: {
                            displayName: getTeamsCurrentUserName()
                        }
                    },
                    isLocal: true
                };
                teamsState.localMessages = teamsState.localMessages || [];
                teamsState.localMessages.push(localMessage);
                if (teamsState.replyToMessage) {
                    teamsState.messageReplies = teamsState.messageReplies || {};
                    teamsState.messageReplies[localMessage.id] = {
                        author: teamsState.replyToMessage.author,
                        content: teamsState.replyToMessage.content
                    };
                }
                input.value = '';
                clearTeamsReply();
                renderTeamsMessages();
                setTimeout(function() {
                    loadTeamsMessages();
                }, 1500);
            } catch (err) {
                handleTeamsError(err);
            } finally {
                if (sendBtn) sendBtn.disabled = false;
            }
        }

        function openTeamsChatModal() {
            if (!ensureTeamsAccess()) return;
            var modal = document.getElementById('teamsChatModal');
            if (modal) modal.classList.add('active');
        }

        function closeTeamsChatModal() {
            var modal = document.getElementById('teamsChatModal');
            if (modal) modal.classList.remove('active');
        }

        async function createTeamsChat() {
            if (!ensureTeamsAccess()) return;
            var topicInput = document.getElementById('teamsChatTopic');
            var membersInput = document.getElementById('teamsChatMembers');
            var topic = topicInput ? topicInput.value.trim() : '';
            var membersRaw = membersInput ? membersInput.value.trim() : '';
            var members = membersRaw ? membersRaw.split(',').map(function(item) { return item.trim().toLowerCase(); }).filter(Boolean) : [];
            var currentUser = auth && auth.currentUser ? (auth.currentUser.email || '').toLowerCase() : '';
            if (currentUser && !members.includes(currentUser)) {
                members.unshift(currentUser);
            }
            members = Array.from(new Set(members));
            if (members.length < 2) {
                alert('Pro novy chat zadejte alespon jednoho dalsiho uzivatele.');
                return;
            }
            var payload = {
                chatType: members.length > 2 ? 'group' : 'oneOnOne',
                members: members.map(function(email) {
                    return {
                        '@odata.type': '#microsoft.graph.aadUserConversationMember',
                        roles: ['owner'],
                        'user@odata.bind': "https://graph.microsoft.com/v1.0/users('" + email + "')"
                    };
                })
            };
            if (topic) payload.topic = topic;
            setTeamsStatus('Vytvarim chat...', false);
            try {
                var chat = await graphRequest('/chats', { method: 'POST', body: JSON.stringify(payload) });
                closeTeamsChatModal();
                if (topicInput) topicInput.value = '';
                if (membersInput) membersInput.value = '';
                await loadTeamsData({ force: true });
                if (chat && chat.id) {
                    teamsState.tab = 'chats';
                    switchTeamsTab('chats');
                    selectTeamsChat(chat.id);
                }
                setTeamsStatus('Chat vytvoren.', false);
            } catch (err) {
                handleTeamsError(err);
            }
        }

        async function openTeamsChannelModal() {
            if (!ensureTeamsAccess()) return;
            if (!teamsState.teams.length) {
                await loadTeamsData({ force: true });
            }
            var select = document.getElementById('teamsChannelTeamSelect');
            if (select) {
                select.innerHTML = '';
                if (!teamsState.teams.length) {
                    var option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Zadne teamy';
                    select.appendChild(option);
                } else {
                    teamsState.teams.forEach(function(team) {
                        var option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = team.displayName || team.id;
                        select.appendChild(option);
                    });
                }
            }
            var modal = document.getElementById('teamsChannelModal');
            if (modal) modal.classList.add('active');
        }

        function closeTeamsChannelModal() {
            var modal = document.getElementById('teamsChannelModal');
            if (modal) modal.classList.remove('active');
        }

        async function createTeamsChannel() {
            if (!ensureTeamsAccess()) return;
            var teamSelect = document.getElementById('teamsChannelTeamSelect');
            var nameInput = document.getElementById('teamsChannelName');
            var descInput = document.getElementById('teamsChannelDescription');
            var membershipSelect = document.getElementById('teamsChannelMembership');
            var teamId = teamSelect ? teamSelect.value : '';
            var name = nameInput ? nameInput.value.trim() : '';
            var description = descInput ? descInput.value.trim() : '';
            var membershipType = membershipSelect ? membershipSelect.value : 'standard';
            if (!teamId) {
                alert('Vyberte team.');
                return;
            }
            if (!name) {
                alert('Zadejte nazev kanalu.');
                return;
            }
            var payload = {
                displayName: name,
                description: description || null,
                membershipType: membershipType
            };
            setTeamsStatus('Vytvarim kanal...', false);
            try {
                var channel = await graphRequest('/teams/' + teamId + '/channels', { method: 'POST', body: JSON.stringify(payload) });
                closeTeamsChannelModal();
                if (nameInput) nameInput.value = '';
                if (descInput) descInput.value = '';
                teamsState.channelsByTeam[teamId] = null;
                await loadTeamsChannels(teamId);
                if (channel && channel.id) {
                    teamsState.tab = 'channels';
                    switchTeamsTab('channels');
                    teamsState.selectedTeamId = teamId;
                    selectTeamsChannel(channel.id);
                }
                setTeamsStatus('Kanal vytvoren.', false);
            } catch (err) {
                handleTeamsError(err);
            }
        }

        // Network Visualization
        let networkCanvas, networkCtx;
        let networkNodes = [];
        let networkEdges = [];
        let isDragging = false;
        let dragNode = null;
        let offsetX, offsetY;
        let networkLinkDraft = null;
        
        function initNetworkVisualization() {
            if (!currentClientId) return;
            
            networkCanvas = document.getElementById('networkCanvas');
            if (!networkCanvas) return;
            
            networkCtx = networkCanvas.getContext('2d');
            
            // Set canvas size
            networkCanvas.width = networkCanvas.clientWidth;
            networkCanvas.height = 500;
            
            // Build network data
            buildNetworkData();
            
            // Draw network
            drawNetwork();
            
            // Update stats
            updateNetworkStats();
            
            // Add event listeners
            networkCanvas.addEventListener('mousedown', handleNetworkMouseDown);
            networkCanvas.addEventListener('mousemove', handleNetworkMouseMove);
            networkCanvas.addEventListener('mouseup', handleNetworkMouseUp);
            networkCanvas.addEventListener('dblclick', handleNetworkDoubleClick);
        }
        
        function buildNetworkData() {
            networkNodes = [];
            networkEdges = [];
            
            // Create nodes for each device
            devices.forEach((device, index) => {
                const angle = (index / devices.length) * Math.PI * 2;
                const radius = 150;
                const centerX = networkCanvas.width / 2;
                const centerY = networkCanvas.height / 2;
                
                networkNodes.push({
                    id: device.id,
                    name: device.name,
                    type: device.type,
                    x: centerX + Math.cos(angle) * radius,
                    y: centerY + Math.sin(angle) * radius,
                    ports: device.ports || 24,
                    device: device
                });
            });
            
            // Create edges for connections
            connections.forEach(conn => {
                const fromNode = networkNodes.find(n => n.id === conn.fromDevice);
                const toNode = networkNodes.find(n => n.id === conn.toDevice);
                
                if (fromNode && toNode) {
                    networkEdges.push({
                        from: fromNode,
                        to: toNode,
                        connection: conn
                    });
                }
            });
        }
        
        function drawNetwork() {
            if (!networkCtx) return;
            
            // Clear canvas
            networkCtx.clearRect(0, 0, networkCanvas.width, networkCanvas.height);
            
            // Draw edges
            networkEdges.forEach(edge => {
                networkCtx.beginPath();
                networkCtx.moveTo(edge.from.x, edge.from.y);
                networkCtx.lineTo(edge.to.x, edge.to.y);
                
                // Style based on connection type
                if (edge.connection.type === 'trunk') {
                    networkCtx.strokeStyle = '#ff00ff';
                    networkCtx.lineWidth = 3;
                } else if (edge.connection.type === 'uplink') {
                    networkCtx.strokeStyle = '#00ffff';
                    networkCtx.lineWidth = 4;
                } else {
                    networkCtx.strokeStyle = '#00ff88';
                    networkCtx.lineWidth = 2;
                }
                
                networkCtx.stroke();
                
                // Draw speed label
                const midX = (edge.from.x + edge.to.x) / 2;
                const midY = (edge.from.y + edge.to.y) / 2;
                networkCtx.fillStyle = '#ffffff';
                networkCtx.font = '10px IBM Plex Mono';
                networkCtx.textAlign = 'center';
                const speed = edge.connection.speed >= 1000 ? 
                    (edge.connection.speed / 1000) + 'G' : 
                    edge.connection.speed + 'M';
                networkCtx.fillText(speed, midX, midY - 5);
            });

            if (networkLinkDraft) {
                networkCtx.beginPath();
                networkCtx.setLineDash([6, 6]);
                networkCtx.moveTo(networkLinkDraft.from.x, networkLinkDraft.from.y);
                networkCtx.lineTo(networkLinkDraft.x, networkLinkDraft.y);
                networkCtx.strokeStyle = '#fbbf24';
                networkCtx.lineWidth = 2;
                networkCtx.stroke();
                networkCtx.setLineDash([]);
            }
            
            // Draw nodes
            networkNodes.forEach(node => {
                const nodeColors = getModuleTypeColors(node.type);

                // Node circle
                networkCtx.beginPath();
                networkCtx.arc(node.x, node.y, 30, 0, Math.PI * 2);
                networkCtx.fillStyle = nodeColors.base;
                networkCtx.fill();
                networkCtx.strokeStyle = '#ffffff';
                networkCtx.lineWidth = 2;
                networkCtx.stroke();
                
                // Node label
                networkCtx.fillStyle = nodeColors.text;
                networkCtx.font = 'bold 12px IBM Plex Mono';
                networkCtx.textAlign = 'center';
                networkCtx.fillText(node.name, node.x, node.y + 5);
                
                // Port count
                networkCtx.fillStyle = nodeColors.text;
                networkCtx.font = '10px IBM Plex Mono';
                networkCtx.fillText(node.ports + ' ports', node.x, node.y + 45);
            });
        }

        function getNodeAtPosition(x, y) {
            return networkNodes.find(node => {
                const dx = x - node.x;
                const dy = y - node.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                return distance <= 30;
            });
        }
        
        function handleNetworkMouseDown(e) {
            const rect = networkCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const node = getNodeAtPosition(x, y);

            if (networkLinkDraft) {
                if (!node) {
                    networkLinkDraft = null;
                    drawNetwork();
                }
                return;
            }

            if (e.shiftKey && node) {
                if (!canEditTopology()) {
                    return;
                }
                networkLinkDraft = {
                    from: node,
                    x,
                    y
                };
                networkCanvas.style.cursor = 'crosshair';
                drawNetwork();
                return;
            }

            if (!canEditTopology()) {
                return;
            }

            if (node) {
                const dx = x - node.x;
                const dy = y - node.y;
                isDragging = true;
                dragNode = node;
                offsetX = dx;
                offsetY = dy;
                networkCanvas.style.cursor = 'grabbing';
            }
        }
        
        function handleNetworkMouseMove(e) {
            const rect = networkCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (networkLinkDraft) {
                networkLinkDraft.x = x;
                networkLinkDraft.y = y;
                drawNetwork();
                return;
            }

            if (isDragging && dragNode) {
                dragNode.x = x - offsetX;
                dragNode.y = y - offsetY;
                drawNetwork();
            }
        }
        
        function handleNetworkMouseUp(e) {
            const rect = networkCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (networkLinkDraft) {
                const targetNode = getNodeAtPosition(x, y);
                if (targetNode && targetNode.id !== networkLinkDraft.from.id) {
                    openConnectionModal({
                        fromDevice: networkLinkDraft.from.id,
                        toDevice: targetNode.id
                    });
                }
                networkLinkDraft = null;
                networkCanvas.style.cursor = 'grab';
                drawNetwork();
                return;
            }

            isDragging = false;
            dragNode = null;
            networkCanvas.style.cursor = 'grab';
        }
        
        function handleNetworkDoubleClick(e) {
            const rect = networkCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Check if double-clicking on a node
            const node = getNodeAtPosition(x, y);
            if (node) {
                showPortDetails(node.device);
            }
        }
        
        function resetNetworkView() {
            buildNetworkData();
            drawNetwork();
        }
        
        function exportNetworkDiagram() {
            const link = document.createElement('a');
            link.download = 'network-diagram.png';
            link.href = networkCanvas.toDataURL();
            link.click();
        }
        
        function updateNetworkStats() {
            const totalPortsCount = devices.reduce((sum, d) => sum + (d.ports || 24), 0);
            const usedPortsCount = connections.length * 2; // Each connection uses 2 ports
            const trunkPortsCount = connections.filter(c => c.type === 'trunk').length * 2;
            
            document.getElementById('totalConnections').textContent = connections.length;
            document.getElementById('totalPorts').textContent = totalPortsCount;
            document.getElementById('usedPorts').textContent = usedPortsCount;
            document.getElementById('trunkPorts').textContent = trunkPortsCount;
        }
        
        // Port Management
        let currentPortDeviceId = null;
        let pendingPortSelection = null;
        let portFilterState = {
            query: '',
            showFree: true,
            showConnected: true,
            showTrunk: true,
            showUplink: true
        };

        function findPortConnection(deviceId, portNumber) {
            return connections.find(c =>
                (c.fromDevice === deviceId && c.fromPort === portNumber) ||
                (c.toDevice === deviceId && c.toPort === portNumber)
            );
        }

        function getPortConnections(deviceId, portNumber) {
            return connections.filter(c =>
                (c.fromDevice === deviceId && c.fromPort === portNumber) ||
                (c.toDevice === deviceId && c.toPort === portNumber)
            );
        }

        function isPortUsed(deviceId, portNumber) {
            return getPortConnections(deviceId, portNumber).length > 0;
        }

        function setPortFilter(key, value) {
            portFilterState[key] = value;
            renderPortDetails();
        }

        function renderPortDetails() {
            if (!currentPortDeviceId) return;
            const device = devices.find(d => d.id === currentPortDeviceId);
            if (!device) return;
            document.getElementById('portDetailsTitle').textContent = device.name + ' - Port Management';
            renderPortDetailsContent(device);
        }

        function showPortDetails(device) {
            currentPortDeviceId = device.id;
            document.getElementById('portDetailsOverlay').classList.add('active');
            document.getElementById('portDetailsTitle').textContent = device.name + ' - Port Management';
            renderPortDetailsContent(device);
        }

        function switchPortDevice(deviceId) {
            currentPortDeviceId = deviceId;
            renderPortDetails();
        }

        function renderPortDetailsContent(device) {
            
            const content = document.getElementById('portDetailsContent');
            const portCount = device.ports || 24;
            const hint = canEditTopology()
                ? 'Klikni na volny port pro rychle propojeni.'
                : 'Pro propojeni potrebujes prava pro topologii.';
            
            // Get connections for this device
            const deviceConnections = connections.filter(c => 
                c.fromDevice === device.id || c.toDevice === device.id
            );
            
            const pendingDevice = pendingPortSelection
                ? devices.find(d => d.id === pendingPortSelection.deviceId)
                : null;
            const pendingLabel = pendingPortSelection
                ? `Vybrano: ${(pendingDevice ? pendingDevice.name : 'Zarizeni')}:${pendingPortSelection.portNumber}`
                : '';

            const deviceOptions = devices.map(d =>
                `<option value="${d.id}" ${d.id === device.id ? 'selected' : ''}>${d.name}</option>`
            ).join('');

            let html = `
                <div class="port-hint">${hint}${pendingLabel ? ' | ' + pendingLabel : ''}</div>
                <div class="port-filters">
                    <select class="port-device-select" onchange="switchPortDevice(this.value)">
                        ${deviceOptions}
                    </select>
                    <input class="port-filter-input" type="text" placeholder="Filtr portu (cislo / nazev)" value="${portFilterState.query}" oninput="setPortFilter('query', this.value)">
                    <label class="port-filter-toggle"><input type="checkbox" ${portFilterState.showFree ? 'checked' : ''} onchange="setPortFilter('showFree', this.checked)">Volne</label>
                    <label class="port-filter-toggle"><input type="checkbox" ${portFilterState.showConnected ? 'checked' : ''} onchange="setPortFilter('showConnected', this.checked)">Obsazene</label>
                    <label class="port-filter-toggle"><input type="checkbox" ${portFilterState.showTrunk ? 'checked' : ''} onchange="setPortFilter('showTrunk', this.checked)">Trunk</label>
                    <label class="port-filter-toggle"><input type="checkbox" ${portFilterState.showUplink ? 'checked' : ''} onchange="setPortFilter('showUplink', this.checked)">Uplink</label>
                </div>
                <div class="port-grid">
            `;
            
            for (let i = 1; i <= portCount; i++) {
                const portConnections = deviceConnections.filter(c =>
                    (c.fromDevice === device.id && c.fromPort === i) ||
                    (c.toDevice === device.id && c.toPort === i)
                );
                const conn = portConnections[0];
                
                let portClass = 'port-item';
                let portLabel = '';
                const isConnected = portConnections.length > 0;
                const isTrunk = portConnections.some(c => c.type === 'trunk');
                const isUplink = portConnections.some(c => c.type === 'uplink');
                const isConflict = portConnections.length > 1;
                
                if (isConnected) {
                    portClass += ' connected';
                    if (isTrunk) portClass += ' trunk';
                    if (isUplink) portClass += ' uplink';
                    if (isConflict) portClass += ' conflict';
                    
                    // Find connected device
                    const connectedDeviceId = conn.fromDevice === device.id ? 
                        conn.toDevice : conn.fromDevice;
                    const connectedDevice = devices.find(d => d.id === connectedDeviceId);
                    portLabel = connectedDevice ? connectedDevice.name : 'Connected';
                }

                if (pendingPortSelection && pendingPortSelection.deviceId === device.id && pendingPortSelection.portNumber === i) {
                    portClass += ' pending';
                }

                const searchValue = `${i} ${portLabel} ${isTrunk ? 'trunk' : ''} ${isUplink ? 'uplink' : ''}`.toLowerCase();
                const query = (portFilterState.query || '').trim().toLowerCase();
                if (query && !searchValue.includes(query)) {
                    continue;
                }
                if (!isConnected && !portFilterState.showFree) continue;
                if (isConnected && !portFilterState.showConnected) continue;
                if (isTrunk && !portFilterState.showTrunk) continue;
                if (isUplink && !portFilterState.showUplink) continue;
                
                html += `
                    <div class="${portClass}" onclick="configurePort('${device.id}', ${i})">
                        <div class="port-number">${i}</div>
                        ${portLabel ? `<div class="port-label">${portLabel}</div>` : ''}
                        ${isConflict ? `<div class="port-label" style="color: var(--danger);">Konflikt</div>` : ''}
                        ${conn && conn.vlans ? `<div class="vlan-tag">VLAN ${conn.vlans}</div>` : ''}
                    </div>
                `;
            }
            
            html += `
                </div>
                <div style="margin-top: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Aktivn propojen</h3>
            `;
            
            if (deviceConnections.length > 0) {
                deviceConnections.forEach(conn => {
                    const otherDeviceId = conn.fromDevice === device.id ? 
                        conn.toDevice : conn.fromDevice;
                    const otherDevice = devices.find(d => d.id === otherDeviceId);
                    const fromPort = conn.fromDevice === device.id ? conn.fromPort : conn.toPort;
                    const toPort = conn.fromDevice === device.id ? conn.toPort : conn.fromPort;
                    let tailLabel = '';
                    if (otherDevice && otherDevice.type === 'patch') {
                        const patchPort = otherDevice.id === conn.fromDevice ? conn.fromPort : conn.toPort;
                        tailLabel = getPatchTailLabel(otherDevice.id, patchPort, conn.id);
                    } else if (device.type === 'patch') {
                        const patchPort = device.id === conn.fromDevice ? conn.fromPort : conn.toPort;
                        tailLabel = getPatchTailLabel(device.id, patchPort, conn.id);
                    }
                    
                    html += `
                        <div class="connection-path">
                            <div class="connection-path-device">${device.name}:${fromPort}</div>
                            <div class="connection-path-arrow"></div>
                            <div class="connection-path-device">${otherDevice ? otherDevice.name : 'Unknown'}:${toPort}</div>
                            ${tailLabel ? `<div class="connection-path-arrow"></div><div class="connection-path-device">${tailLabel}</div>` : ''}
                            <div style="margin-left: auto;">
                                <span class="connection-path-port">
                                    ${conn.type} | ${conn.speed >= 1000 ? (conn.speed/1000) + 'G' : conn.speed + 'M'}
                                    ${conn.description ? ' | ' + conn.description : ''}
                                </span>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p style="color: var(--text-secondary);">dn aktivn propojen</p>';
            }
            
            html += '</div>';
            
            content.innerHTML = html;
        }
        
        function closePortDetails() {
            document.getElementById('portDetailsOverlay').classList.remove('active');
            pendingPortSelection = null;
            currentPortDeviceId = null;
        }
        
        function configurePort(deviceId, portNumber) {
            if (!canEditTopology()) {
                alert('Nemate opravneni upravovat topologii');
                return;
            }

            if (isPortUsed(deviceId, portNumber)) {
                alert('Port je uz obsazeny.');
                return;
            }

            if (!pendingPortSelection) {
                pendingPortSelection = { deviceId, portNumber };
                renderPortDetails();
                return;
            }

            if (pendingPortSelection.deviceId === deviceId && pendingPortSelection.portNumber === portNumber) {
                pendingPortSelection = null;
                renderPortDetails();
                return;
            }

            if (pendingPortSelection.deviceId === deviceId) {
                alert('Nelze propojit porty na stejnem zarizeni.');
                return;
            }

            createQuickConnection(pendingPortSelection.deviceId, pendingPortSelection.portNumber, deviceId, portNumber);
            pendingPortSelection = null;
            renderPortDetails();
        }

        function createQuickConnection(fromDevice, fromPort, toDevice, toPort) {
            if (!canEditTopology()) {
                alert('Nemate opravneni upravovat topologii');
                return;
            }
            if (fromDevice === toDevice) {
                alert('Nelze propojit zarizeni samo se sebou');
                return;
            }
            if (isPortUsed(fromDevice, fromPort) || isPortUsed(toDevice, toPort)) {
                alert('Jeden z portu je uz obsazeny');
                return;
            }

            const connection = {
                id: Date.now().toString(),
                fromDevice: fromDevice,
                fromPort: parseInt(fromPort, 10),
                toDevice: toDevice,
                toPort: parseInt(toPort, 10),
                type: 'access',
                vlans: '',
                speed: 1000,
                description: 'Quick link',
                createdAt: new Date().toISOString()
            };

            connections.push(connection);
            saveData();
            render();
        }
        
        // Connection Management
        function openConnectionModal(prefill) {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            if (!canEditTopology()) {
                alert('Nemate opravneni upravovat topologii');
                return;
            }
            if (devices.length < 2) {
                alert('Pro vytvoreni propojeni potrebujete alespon 2 zarizeni');
                return;
            }

            const deviceOptions = devices.map(d => 
                `<option value="${d.id}">${d.name} (${d.type})</option>`
            ).join('');

            const fromSelect = document.getElementById('connFromDevice');
            const toSelect = document.getElementById('connToDevice');

            fromSelect.innerHTML = deviceOptions;
            toSelect.innerHTML = deviceOptions;

            if (prefill && prefill.fromDevice) {
                fromSelect.value = prefill.fromDevice;
            }

            let targetDevice = prefill && prefill.toDevice ? prefill.toDevice : '';
            if (!targetDevice || targetDevice === fromSelect.value) {
                const other = devices.find(d => d.id !== fromSelect.value);
                targetDevice = other ? other.id : fromSelect.value;
            }
            toSelect.value = targetDevice;

            updateFromPorts();
            updateToPorts();

            if (prefill && prefill.fromPort) {
                document.getElementById('connFromPort').value = String(prefill.fromPort);
            }
            if (prefill && prefill.toPort) {
                document.getElementById('connToPort').value = String(prefill.toPort);
            }

            document.getElementById('connectionModal').classList.add('active');
        }
        
        function closeConnectionModal() {
            document.getElementById('connectionModal').classList.remove('active');
            clearConnectionForm();
        }
        
        function updateFromPorts() {
            const deviceId = document.getElementById('connFromDevice').value;
            const device = devices.find(d => d.id === deviceId);
            const portCount = device ? (device.ports || 24) : 24;
            
            let options = '';
            for (let i = 1; i <= portCount; i++) {
                // Check if port is already used
                const isUsed = connections.some(c => 
                    (c.fromDevice === deviceId && c.fromPort === i) ||
                    (c.toDevice === deviceId && c.toPort === i)
                );
                
                if (!isUsed) {
                    options += `<option value="${i}">Port ${i}</option>`;
                }
            }
            
            document.getElementById('connFromPort').innerHTML = options || '<option>Vechny porty obsazeny</option>';
        }
        
        function updateToPorts() {
            const deviceId = document.getElementById('connToDevice').value;
            const device = devices.find(d => d.id === deviceId);
            const portCount = device ? (device.ports || 24) : 24;
            
            let options = '';
            for (let i = 1; i <= portCount; i++) {
                // Check if port is already used
                const isUsed = connections.some(c => 
                    (c.fromDevice === deviceId && c.fromPort === i) ||
                    (c.toDevice === deviceId && c.toPort === i)
                );
                
                if (!isUsed) {
                    options += `<option value="${i}">Port ${i}</option>`;
                }
            }
            
            document.getElementById('connToPort').innerHTML = options || '<option>Vechny porty obsazeny</option>';
        }
        
        function addConnection() {
            if (!canEditTopology()) {
                alert('Nemate opravneni upravovat topologii');
                return;
            }
            const fromDevice = document.getElementById('connFromDevice').value;
            const fromPort = parseInt(document.getElementById('connFromPort').value);
            const toDevice = document.getElementById('connToDevice').value;
            const toPort = parseInt(document.getElementById('connToPort').value);
            const type = document.getElementById('connType').value;
            const vlans = document.getElementById('connVlans').value;
            const speed = parseInt(document.getElementById('connSpeed').value);
            const description = document.getElementById('connDescription').value;

            if (!fromDevice || !toDevice || !fromPort || !toPort) {
                alert('Vyplnte vsechny povinne udaje');
                return;
            }

            if (fromDevice === toDevice) {
                alert('Nelze propojit zarizeni samo se sebou');
                return;
            }

            const connection = {
                id: Date.now().toString(),
                fromDevice,
                fromPort,
                toDevice,
                toPort,
                type,
                vlans,
                speed,
                description,
                createdAt: new Date().toISOString()
            };

            connections.push(connection);
            saveData();
            render();
            closeConnectionModal();
        }
        
        function clearConnectionForm() {
            document.getElementById('connFromPort').value = '';
            document.getElementById('connToPort').value = '';
            document.getElementById('connType').value = 'access';
            document.getElementById('connVlans').value = '';
            document.getElementById('connSpeed').value = '1000';
            document.getElementById('connDescription').value = '';
        }
        
        // Render topology view
        function renderTopologyView() {
            const container = document.getElementById('topologyView');
            
            if (!currentClientId) {
                container.innerHTML = `
                    <div class="no-client-warning">
                        <div class="empty-state-icon"></div>
                        <p><strong>Nejprve vyberte klienta</strong><br>
                        Pro zobrazen topologie muste vybrat klienta z hornho menu.</p>
                    </div>
                `;
                return;
            }
            
            if (devices.length === 0) {
                container.innerHTML = `
                    <div class="rack-container">
                        <div class="empty-state">
                            <div class="empty-state-icon"></div>
                            <p>dn zazen k zobrazen topologie</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Group devices by module type
            const groups = moduleTypes.map((type) => ({
                type,
                devices: devices.filter((device) => device.type === type.id)
            })).filter((group) => group.devices.length > 0);

            const unknownDevices = devices.filter((device) =>
                !moduleTypes.some((type) => type.id === device.type)
            );
            if (unknownDevices.length > 0) {
                groups.push({
                    type: { id: 'other', label: 'Other', color: '#94a3b8', group: 'Other' },
                    devices: unknownDevices
                });
            }

            let html = `
                <div class="rack-container">
                    <h2>Sitova topologie</h2>
                    <div style="display: grid; gap: 2rem; margin-top: 2rem;">
            `;

            groups.forEach((group) => {
                const colors = getModuleTypeColors(group.type.id);
                const heading = group.type.group ? `${group.type.group} - ${group.type.label}` : group.type.label;

                html += `
                    <div class="topology-group" style="border-color: ${colors.base};">
                        <h3 style="color: ${colors.base}; margin-bottom: 1rem;">${heading}</h3>
                        <div class="topology-group-grid">
                `;

                group.devices.forEach((device) => {
                    const label = getModuleTypeLabel(device.type);
                    html += `
                        <div class="client-card" style="cursor: pointer;" onclick="showPortDetails(devices.find(d => d.id === '${device.id}'))">
                            <div style="font-weight: 600; color: ${colors.base};">${device.name}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                ${getSensitiveValue(device.ip || 'No IP')} | ${device.ports || 24} ports
                            </div>
                            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: ${colors.base};">${label}</div>
                        </div>
                    `;
                });

                html += '</div></div>';
            });

            if (groups.length === 0) {
                html += `
                    <div class="topology-group">
                        <p>No devices to display</p>
                    </div>
                `;
            }

            html += '</div></div>';
            container.innerHTML = html;
        }
        
        // Client management functions
        function openClientModal(clientId) {
            switchView('clients');
            const panel = document.getElementById('clientFormPanel');
            const submitBtn = document.getElementById('clientSubmitBtn');
            const editInput = document.getElementById('clientEditId');
            const title = document.getElementById('clientFormTitle');
            const subtitle = document.getElementById('clientFormSubtitle');
            if (!panel) return;
            if (clientId) {
                const client = clients.find(item => item.id === clientId);
                if (!client) return;
                fillClientForm(client);
                if (editInput) editInput.value = client.id;
                if (submitBtn) submitBtn.textContent = 'Ulozit klienta';
                if (title) title.textContent = 'Upravit klienta';
                if (subtitle) subtitle.textContent = 'Uprav kontaktni a pricing nastaveni klienta.';
            } else {
                clearClientForm();
                if (editInput) editInput.value = '';
                if (submitBtn) submitBtn.textContent = 'Vytvorit klienta';
                if (title) title.textContent = 'Novy klient';
                if (subtitle) subtitle.textContent = 'Vypln zakladni a financni udaje klienta.';
            }
            updatePricingFields();
            panel.style.display = 'grid';
            const detail = document.getElementById('clientDetailContent');
            const empty = document.getElementById('clientDetailEmpty');
            if (detail) detail.style.display = 'none';
            if (empty) empty.style.display = 'none';
        }
        
        function closeClientModal() {
            const panel = document.getElementById('clientFormPanel');
            if (panel) panel.style.display = 'none';
            clearClientForm();
            renderClientDetailsPanel();
        }

        function setupClientModalCloseHandlers() {
            document.addEventListener('click', (event) => {
                const panel = document.getElementById('clientFormPanel');
                if (!panel || panel.style.display === 'none') return;
                if (panel.contains(event.target)) return;
                if (event.target.closest('[data-client-form-trigger]')) return;
                closeClientModal();
            });

            document.addEventListener('keydown', (event) => {
                const panel = document.getElementById('clientFormPanel');
                if (event.key === 'Escape' && panel && panel.style.display !== 'none') {
                    closeClientModal();
                }
            });
        }
        
        function openClientManagerModal() {
            switchView('clients');
            closeClientModal();
            renderClientDetailsPanel();
        }
        
        function closeClientManagerModal() {
            renderClientDetailsPanel();
        }
        
        function clearClientForm() {
            document.getElementById('newClientName').value = '';
            document.getElementById('newClientICO').value = '';
            document.getElementById('newClientType').value = 'standard';
            document.getElementById('newClientContact').value = '';
            document.getElementById('newClientEmail').value = '';
            document.getElementById('newClientPhone').value = '';
            document.getElementById('newClientAddress').value = '';
            document.getElementById('newClientColor').value = '#f89a55';
            document.getElementById('newClientNotes').value = '';
            const pricingMode = document.getElementById('newClientPricingMode');
            const retainerAmount = document.getElementById('newClientRetainerAmount');
            const retainerHours = document.getElementById('newClientRetainerHours');
            const hourlyRate = document.getElementById('newClientHourlyRate');
            const overageRate = document.getElementById('newClientOverageRate');
            const editInput = document.getElementById('clientEditId');
            const submitBtn = document.getElementById('clientSubmitBtn');
            if (pricingMode) pricingMode.value = 'retainer-hours';
            if (retainerAmount) retainerAmount.value = '';
            if (retainerHours) retainerHours.value = '';
            if (hourlyRate) hourlyRate.value = '';
            if (overageRate) overageRate.value = '';
            if (editInput) editInput.value = '';
            if (submitBtn) submitBtn.textContent = 'Vytvorit klienta';
            updatePricingFields();
        }

        function fillClientForm(client) {
            if (!client) return;
            document.getElementById('newClientName').value = client.name || '';
            document.getElementById('newClientICO').value = client.ico || '';
            document.getElementById('newClientType').value = client.type || 'standard';
            document.getElementById('newClientContact').value = client.contact || '';
            document.getElementById('newClientEmail').value = client.email || '';
            document.getElementById('newClientPhone').value = client.phone || '';
            document.getElementById('newClientAddress').value = client.address || '';
            document.getElementById('newClientColor').value = client.color || '#f89a55';
            document.getElementById('newClientNotes').value = client.notes || '';
            const pricingMode = document.getElementById('newClientPricingMode');
            const retainerAmount = document.getElementById('newClientRetainerAmount');
            const retainerHours = document.getElementById('newClientRetainerHours');
            const hourlyRate = document.getElementById('newClientHourlyRate');
            const overageRate = document.getElementById('newClientOverageRate');
            if (pricingMode) pricingMode.value = client.pricingMode || 'retainer-hours';
            if (retainerAmount) retainerAmount.value = client.retainerAmount || '';
            if (retainerHours) retainerHours.value = client.retainerHours || '';
            if (hourlyRate) hourlyRate.value = client.hourlyRate || '';
            if (overageRate) overageRate.value = client.overageRate || '';
            updatePricingFields();
        }

        function updatePricingFields() {
            const mode = document.getElementById('newClientPricingMode')?.value || 'retainer-hours';
            const retainerAmountGroup = document.getElementById('pricingRetainerAmountGroup');
            const retainerHoursGroup = document.getElementById('pricingRetainerHoursGroup');
            const hourlyRateGroup = document.getElementById('pricingHourlyRateGroup');
            const overageRateGroup = document.getElementById('pricingOverageRateGroup');

            if (retainerAmountGroup) retainerAmountGroup.style.display = 'block';
            if (retainerHoursGroup) retainerHoursGroup.style.display = mode == 'retainer-hours' ? 'block' : 'none';
            if (hourlyRateGroup) hourlyRateGroup.style.display = mode == 'retainer-hourly' ? 'block' : 'none';
            if (overageRateGroup) overageRateGroup.style.display = mode == 'retainer-hours' ? 'block' : 'none';
        }


        function toggleSidebarSection(button) {
            const section = button ? button.closest('.sidebar-section') : null;
            if (!section) return;
            const key = section.getAttribute('data-section');
            const collapsed = section.classList.toggle('collapsed');
            if (key) {
                localStorage.setItem('sidebarSection_' + key, collapsed ? '1' : '0');
            }
        }

        function restoreSidebarSections() {
            const sections = document.querySelectorAll('.sidebar-section[data-section]');
            sections.forEach((section) => {
                const key = section.getAttribute('data-section');
                const stored = key ? localStorage.getItem('sidebarSection_' + key) : null;
                if (stored === '1') {
                    section.classList.add('collapsed');
                } else if (stored === '0') {
                    section.classList.remove('collapsed');
                }
            });
        }

        
        function addClient() {
            const name = document.getElementById('newClientName').value;
            const ico = document.getElementById('newClientICO').value;
            const type = document.getElementById('newClientType').value;
            const contact = document.getElementById('newClientContact').value;
            const email = document.getElementById('newClientEmail').value;
            const phone = document.getElementById('newClientPhone').value;
            const address = document.getElementById('newClientAddress').value;
            const color = document.getElementById('newClientColor')?.value || '#f89a55';
            const notes = document.getElementById('newClientNotes').value;
            const pricingMode = document.getElementById('newClientPricingMode')?.value || 'retainer-hours';
            const retainerAmount = parseFloat(document.getElementById('newClientRetainerAmount')?.value || '') || 0;
            const retainerHours = parseFloat(document.getElementById('newClientRetainerHours')?.value || '') || 0;
            const hourlyRate = parseFloat(document.getElementById('newClientHourlyRate')?.value || '') || 0;
            const overageRate = parseFloat(document.getElementById('newClientOverageRate')?.value || '') || 0;
            const editId = document.getElementById('clientEditId')?.value || '';
            
            if (!name) {
                alert('Nazev klienta je povinny');
                return;
            }

            const payload = {
                name,
                ico,
                type,
                contact,
                email,
                phone,
                address,
                color,
                notes,
                pricingMode,
                retainerAmount,
                retainerHours,
                hourlyRate,
                overageRate,
                updatedAt: new Date().toISOString()
            };

            if (editId) {
                const existing = clients.find(client => client.id === editId);
                if (!existing) return;
                Object.assign(existing, payload);
                saveData();
                updateClientSelector();
                render();
                closeClientModal();
                return;
            }
            
            const client = {
                id: Date.now().toString(),
                createdAt: new Date().toISOString(),
                ...payload
            };
            
            clients.push(client);
            saveData();
            updateClientSelector();
            
            // Automatically select the new client
            const selector = document.getElementById('clientSelector');
            if (selector) selector.value = client.id;
            const skipView = currentView === 'clients';
            switchClient({ skipView });
            closeClientModal();
        }
        
        function deleteClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            if (confirm(`Opravdu chcete smazat klienta "${client.name}" vetn vech jeho dat?`)) {
                // Remove client
                clients = clients.filter(c => c.id !== clientId);
                
                // Remove client data
                delete clientData[clientId];
                
                // If this was the current client, clear selection
                if (currentClientId === clientId) {
                    currentClientId = null;
                    racks = [];
                    devices = [];
                    connections = [];
                }
                
                saveData();
                updateClientSelector();
                render();
                renderClientList();
            }
        }
        
        function renderClientList() {
            const list = document.getElementById('clientList');
            const searchInput = document.getElementById('clientSearch');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const countEl = document.getElementById('clientsCount');
            if (countEl) countEl.textContent = `${clients.length} klientu`;
            if (!list) return;
            
            const filteredClients = clients.filter(client => 
                client.name.toLowerCase().includes(searchTerm) ||
                (client.ico && client.ico.includes(searchTerm)) ||
                (client.contact && client.contact.toLowerCase().includes(searchTerm))
            );
            
            if (filteredClients.length === 0) {
                list.innerHTML = '<div class="empty-state"><p>Zadni klienti nenalezeni</p></div>';
                return;
            }
            
            list.innerHTML = filteredClients.map(client => {
                const data = clientData[client.id] || { racks: [], devices: [] };
                const isActive = client.id === currentClientId;
                return `
                    <div class="client-card${isActive ? ' is-active' : ''}" onclick="selectClientFromList('${client.id}')">
                        <div class="client-card-header">
                            <div class="client-card-name">
                                <span class="time-client-color" style="--client-color: ${getClientColor(client.id)}"></span>
                                ${client.name}
                            </div>
                            <div class="client-actions" onclick="event.stopPropagation()">
                                <button class="btn-icon" data-client-form-trigger="true" title="Upravit klienta" onclick="openClientModal('${client.id}')">Upr</button>
                                <button class="btn-icon danger" title="Smazat klienta" onclick="deleteClient('${client.id}')">Smaz</button>
                            </div>
                        </div>
                        <div class="client-card-stats">
                            <span>${data.racks.length} racky</span>
                            <span>${data.devices.length} zarizeni</span>
                            <span class="client-badge">${(client.type || 'standard')}</span>
                        </div>
                        <div class="client-card-pricing">Pricing: ${buildPricingSummary(client)}</div>
                        ${client.contact ? `<div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Kontakt: ${client.contact}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderClientDetailsPanel() {
            const detail = document.getElementById('clientDetailContent');
            const empty = document.getElementById('clientDetailEmpty');
            const form = document.getElementById('clientFormPanel');
            if (!detail || !empty) return;

            renderClientList();

            if (form && form.style.display !== 'none') {
                return;
            }

            const client = clients.find(c => c.id === currentClientId);
            if (!client) {
                detail.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            const snapshot = getClientSnapshot(client.id);
            const nameEl = document.getElementById('clientDetailName');
            const metaEl = document.getElementById('clientDetailMeta');
            const typeEl = document.getElementById('clientDetailType');
            const icoEl = document.getElementById('clientDetailIco');
            const colorEl = document.getElementById('clientDetailColor');
            const contactEl = document.getElementById('clientDetailContact');
            const emailEl = document.getElementById('clientDetailEmail');
            const phoneEl = document.getElementById('clientDetailPhone');
            const addressEl = document.getElementById('clientDetailAddress');
            const pricingEl = document.getElementById('clientDetailPricing');
            const racksEl = document.getElementById('clientDetailRacks');
            const devicesEl = document.getElementById('clientDetailDevices');
            const connectionsEl = document.getElementById('clientDetailConnections');
            const notesEl = document.getElementById('clientDetailNotes');

            if (nameEl) nameEl.textContent = client.name || '-';
            if (metaEl) {
                const metaParts = [];
                if (client.contact) metaParts.push(`Kontakt: ${client.contact}`);
                if (client.email) metaParts.push(`E-mail: ${client.email}`);
                if (client.phone) metaParts.push(`Telefon: ${client.phone}`);
                metaEl.textContent = metaParts.length ? metaParts.join(' | ') : 'Bez kontaktu';
            }
            if (typeEl) typeEl.textContent = client.type ? client.type.toUpperCase() : '-';
            if (icoEl) icoEl.textContent = client.ico || '-';
            if (colorEl) {
                const colorValue = client.color || '#f89a55';
                colorEl.innerHTML = `<span class="client-color-chip" style="--client-color: ${colorValue}"></span>${colorValue}`;
            }
            if (contactEl) contactEl.textContent = client.contact || '-';
            if (emailEl) emailEl.textContent = client.email || '-';
            if (phoneEl) phoneEl.textContent = client.phone || '-';
            if (addressEl) addressEl.textContent = client.address || '-';
            if (pricingEl) pricingEl.textContent = buildPricingSummary(client);
            if (racksEl) racksEl.textContent = snapshot.racks.length;
            if (devicesEl) devicesEl.textContent = snapshot.devices.length;
            if (connectionsEl) connectionsEl.textContent = snapshot.connections.length;
            if (notesEl) notesEl.textContent = client.notes || '-';

            empty.style.display = 'none';
            detail.style.display = 'block';
        }

        function selectClientFromList(clientId) {
            const selector = document.getElementById('clientSelector');
            if (selector) selector.value = clientId;
            switchClient({ skipView: true });
            renderClientDetailsPanel();
        }
        
        function searchClients() {
            renderClientList();
        }
        
        // Render all components
        function render() {
            renderRacks();
            renderDeviceTable();
            renderConnections();
            updateStats();
            renderDashboard();
            renderClientDetailsPanel();
        }
        
        // Render racks
        function renderRacks() {
            const grid = document.getElementById('rackGrid');
            
            if (!currentClientId) {
                grid.innerHTML = `
                    <div class="no-client-warning">
                        <div class="empty-state-icon"></div>
                        <p><strong>Nejprve vyberte klienta</strong><br>
                        Pro zobrazen a sprvu rack muste vybrat klienta z hornho menu.</p>
                    </div>
                `;
                return;
            }
            
            if (racks.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <p>Klient ${clients.find(c => c.id === currentClientId)?.name} zatm nem dn racky.<br>Kliknte na "Pidat rack" pro vytvoen prvnho racku.</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = racks.map(rack => `
                <div class="rack">
                    <div class="rack-title">${rack.name}</div>
                    <div class="rack-units">
                        ${generateRackUnits(rack)}
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
                         ${rack.location || 'Neureno'}
                    </div>
                </div>
            `).join('');
            
            // Add event listeners for device hover
            document.querySelectorAll('.rack-unit.occupied').forEach(unit => {
                unit.addEventListener('mouseenter', showDeviceTooltip);
                unit.addEventListener('mouseleave', hideDeviceTooltip);
                unit.addEventListener('click', () => {
                    const deviceId = unit.dataset.deviceId;
                    if (deviceId) {
                        const device = devices.find(d => d.id === deviceId);
                        if (device) {
                            showPortDetails(device);
                        }
                    }
                });
            });
        }
        
        function renderPortDots(portCount) {
            const total = parseInt(portCount, 10) || 0;
            if (total <= 0) {
                return '';
            }
            const maxDots = 12;
            const dots = Math.min(total, maxDots);
            let html = '<span class="ports-dots">';
            for (let i = 0; i < dots; i++) {
                html += '<span class="ports-dot"></span>';
            }
            html += '</span>';
            if (total > maxDots) {
                html += `<span class="ports-overflow">+${total - maxDots}</span>`;
            }
            return html;
        }

        // Generate rack units HTML
        function generateRackUnits(rack) {
            let html = '';
            const rackDevices = devices.filter(d => d.rack === rack.id);
            
            for (let i = 1; i <= rack.units; i++) {
                const device = rackDevices.find(d => 
                    i >= d.position && i < d.position + d.height
                );
                
                if (device) {
                    if (i === device.position) {
                        const moduleStyle = getModuleStyleVars(device.type);
                        const portCount = device.ports || 0;
                        const portDots = renderPortDots(portCount);
                        html += `<div class="rack-unit occupied ${device.type}" 
                                      data-device-id="${device.id}"
                                      data-device-name="${device.name}"
                                      data-device-type="${device.type}"
                                      data-device-position="U${device.position}"
                                      data-device-ip="${device.ip || 'N/A'}"
                                      data-device-model="${device.model || 'N/A'}"
                                      data-device-serial="${device.serial || 'N/A'}"
                                      data-device-ports="${portCount}"
                                      style="${moduleStyle} height: ${20 * device.height + 2 * (device.height - 1)}px;">
                                    <div class="rack-unit-content">
                                        <div class="rack-unit-name">${device.name}</div>
                                        <div class="rack-unit-ports">
                                            <span class="ports-count">${portCount}p</span>
                                            ${portDots}
                                        </div>
                                    </div>
                                </div>`;
                    }
                } else {
                    const isPartOfDevice = rackDevices.some(d => 
                        i > d.position && i < d.position + d.height
                    );
                    if (!isPartOfDevice) {
                        html += `<div class="rack-unit">U${i}</div>`;
                    }
                }
            }
            
            return html;
        }
        
        // Show device tooltip
        function showDeviceTooltip(e) {
            const tooltip = document.getElementById('deviceTooltip');
            const unit = e.currentTarget;
            
            document.getElementById('tooltipName').textContent = unit.dataset.deviceName;
            document.getElementById('tooltipType').textContent = `Typ: ${getModuleTypeLabel(unit.dataset.deviceType)}`;
            document.getElementById('tooltipPosition').textContent = `Pozice: ${unit.dataset.devicePosition}`;
            document.getElementById('tooltipIP').textContent = `IP: ${getSensitiveValue(unit.dataset.deviceIp)}`;
            document.getElementById('tooltipModel').textContent = `Model: ${unit.dataset.deviceModel}`;
            document.getElementById('tooltipPorts').textContent = `Porty: ${unit.dataset.devicePorts || 'N/A'}`;
            document.getElementById('tooltipSerial').textContent = `S/N: ${getSensitiveValue(unit.dataset.deviceSerial)}`;
            
            tooltip.classList.add('active');
            
            const rect = unit.getBoundingClientRect();
            const tooltipWidth = tooltip.offsetWidth;
            const tooltipHeight = tooltip.offsetHeight;
            const padding = 12;

            let left = rect.right + 12;
            if (left + tooltipWidth + padding > window.innerWidth) {
                left = rect.left - tooltipWidth - 12;
            }
            if (left < padding) {
                left = padding;
            }

            let top = rect.top;
            if (top + tooltipHeight + padding > window.innerHeight) {
                top = window.innerHeight - tooltipHeight - padding;
            }
            if (top < padding) {
                top = padding;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }
        
        // Hide device tooltip
        function hideDeviceTooltip() {
            document.getElementById('deviceTooltip').classList.remove('active');
        }
        
        // Render device table
        function renderDeviceTable() {
            const container = document.getElementById('deviceListContainer');
            const tbody = document.getElementById('deviceTableBody');
            
            if (devices.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            tbody.innerHTML = devices.map(device => {
                const rack = racks.find(r => r.id === device.rack);
                const typeLabel = getModuleTypeLabel(device.type);
                const badgeStyle = getModuleBadgeVars(device.type);
                const ipValue = getSensitiveValue(device.ip || 'N/A');
                const deleteDisabled = canManageDevices() ? '' : 'disabled';
                return `
                    <tr style="cursor: pointer;" onclick="openDeviceFromTable('${device.id}')">
                        <td>${device.name}</td>
                        <td><span class="device-type-badge ${device.type}" style="${badgeStyle}">${typeLabel}</span></td>
                        <td>${rack ? rack.name : 'N/A'}</td>
                        <td>U${device.position}</td>
                        <td>${ipValue}</td>
                        <td>${device.model || 'N/A'}</td>
                        <td>
                            <button class="delete-btn" onclick="deleteDeviceFromTable(event, '${device.id}')" ${deleteDisabled}>Smazat</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openDeviceFromTable(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (device) {
                showPortDetails(device);
            }
        }

        function deleteDeviceFromTable(event, deviceId) {
            if (event) {
                event.stopPropagation();
            }
            deleteDevice(deviceId);
        }
        
        // Render connections
        function renderConnections() {
            const container = document.getElementById('connectionsContainer');
            const list = document.getElementById('connectionsList');
            
            if (connections.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            list.innerHTML = connections.map(conn => {
                const fromDevice = devices.find(d => d.id === conn.fromDevice);
                const toDevice = devices.find(d => d.id === conn.toDevice);
                const fromLabel = `${fromDevice ? fromDevice.name : 'Unknown'}:${conn.fromPort}`;
                const toLabel = `${toDevice ? toDevice.name : 'Unknown'}:${conn.toPort}`;

                let tailLabel = '';
                if (toDevice && toDevice.type === 'patch') {
                    tailLabel = getPatchTailLabel(toDevice.id, conn.toPort, conn.id);
                } else if (fromDevice && fromDevice.type === 'patch') {
                    tailLabel = getPatchTailLabel(fromDevice.id, conn.fromPort, conn.id);
                }

                const speedLabel = getConnectionSpeedLabel(conn.speed);
                const metaParts = [conn.type || 'link', speedLabel];
                if (conn.vlans) metaParts.push(`VLAN ${conn.vlans}`);
                if (conn.description) metaParts.push(conn.description);
                const meta = metaParts.join(' | ');

                return `
                    <div class="connection-item">
                        <div class="connection-path-row">
                            <div class="connection-from">${fromLabel}</div>
                            <div class="connection-arrow"></div>
                            <div class="connection-to">${toLabel}</div>
                            ${tailLabel ? `<div class="connection-arrow"></div><div class="connection-to">${tailLabel}</div>` : ''}
                        </div>
                        <div class="connection-meta">${meta}</div>
                    </div>
                `;
            }).join('');
        }

        function getConnectionSpeedLabel(speed) {
            if (!speed) return 'N/A';
            return speed >= 1000 ? (speed / 1000) + 'G' : speed + 'M';
        }

        function getPatchTailLabel(patchId, patchPort, currentConnectionId) {
            const match = connections.find(c => c.id !== currentConnectionId && (
                (c.fromDevice === patchId && c.fromPort === patchPort) ||
                (c.toDevice === patchId && c.toPort === patchPort)
            ));
            if (!match) return '';
            const otherDeviceId = match.fromDevice === patchId ? match.toDevice : match.fromDevice;
            const otherPort = match.fromDevice === patchId ? match.fromPort : match.toPort;
            const otherDevice = devices.find(d => d.id === otherDeviceId);
            return `${otherDevice ? otherDevice.name : 'Unknown'}:${otherPort}`;
        }

        // Time tracking
        function getWeekStart(date) {
            const base = new Date(date);
            const day = (base.getDay() + 6) % 7;
            base.setDate(base.getDate() - day);
            base.setHours(0, 0, 0, 0);
            return base;
        }

        function getWeekBounds(date) {
            const startDate = getWeekStart(date);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            return {
                start: formatDateKey(startDate),
                end: formatDateKey(endDate)
            };
        }

        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function parseDateKey(dateKey) {
            if (!dateKey) return null;
            return new Date(dateKey + 'T00:00:00');
        }

        function shiftTimeWeek(delta) {
            const base = timeViewWeekStart || getWeekStart(new Date());
            const next = new Date(base);
            next.setDate(base.getDate() + delta * 7);
            timeViewWeekStart = getWeekStart(next);
            timeSelectionActive = false;
            loadTimeEntriesForWeek();
        }

        function restoreTimeAllClientsToggle() {
            const stored = localStorage.getItem('rackManagerTimeAllClients');
            timeViewAllClients = stored === '1';
            const toggle = document.getElementById('timeAllClientsToggle');
            if (toggle) {
                toggle.checked = timeViewAllClients;
            }
        }

        function toggleTimeAllClients() {
            const toggle = document.getElementById('timeAllClientsToggle');
            timeViewAllClients = !!(toggle && toggle.checked);
            localStorage.setItem('rackManagerTimeAllClients', timeViewAllClients ? '1' : '0');
            loadTimeEntriesForWeek();
        }

        function applyTimeDefaultsForRole() {
            if (currentUserRole !== 'technician') return;
            const stored = localStorage.getItem('rackManagerTimeAllClients');
            if (stored === null) {
                timeViewAllClients = true;
                localStorage.setItem('rackManagerTimeAllClients', '1');
                const toggle = document.getElementById('timeAllClientsToggle');
                if (toggle) toggle.checked = true;
            }
        }

        function updateTimeTechnicianFilter() {
            const select = document.getElementById('timeTechnicianFilter');
            timeTechnicianFilter = select?.value || 'all';
            renderTimeTracking();
        }

        function buildTimeTechnicianOptions() {
            const wrap = document.getElementById('timeTechnicianFilterWrap');
            const select = document.getElementById('timeTechnicianFilter');
            if (!wrap || !select) return;

            if (!canViewAllTimeEntries()) {
                wrap.style.display = 'none';
                return;
            }

            wrap.style.display = 'inline-flex';
            const techs = new Map();
            timeEntries.forEach((entry) => {
                const key = entry.userEmail || entry.userId;
                if (!key) return;
                techs.set(key, key);
            });
            const sorted = Array.from(techs.keys()).sort((a, b) => a.localeCompare(b, 'cs'));
            const options = ['<option value="all">Vsechny technici</option>']
                .concat(sorted.map((key) => `<option value="${key}">${key}</option>`))
                .join('');
            select.innerHTML = options;

            if (timeTechnicianFilter !== 'all' && !techs.has(timeTechnicianFilter)) {
                timeTechnicianFilter = 'all';
            }
            select.value = timeTechnicianFilter;
        }

        function onTimeReportScopeChange() {
            loadReportEntries();
        }

        function initTimeTracking() {
            timeViewWeekStart = getWeekStart(new Date());
            timeSelectionActive = false;
            loadTimeActivities();
            if (!timeSelectionStart) {
                const todayKey = formatDateKey(new Date());
                timeSelectionStart = { date: todayKey, hour: TIME_GRID_START };
                timeSelectionEnd = { date: todayKey, hour: TIME_GRID_START };
            }
            if (!window.timeMouseUpBound) {
                window.timeMouseUpBound = true;
                document.addEventListener('mouseup', () => {
                    if (isTimeSelecting) {
                        isTimeSelecting = false;
                        openTimeEntryModal();
                    }
                });
            }
            loadTimeEntriesForWeek();
        }

        async function loadTimeEntriesForWeek() {
            if (!currentClientId && !timeViewAllClients) {
                timeEntries = [];
                renderTimeTracking();
                return;
            }
            if (!window.db || !window.auth || !auth.currentUser) {
                timeEntries = [];
                renderTimeTracking();
                return;
            }

            const bounds = getWeekBounds(timeViewWeekStart || new Date());
            if (timeViewAllClients) {
                try {
                    timeEntries = await loadTimeEntriesForAllClients(bounds);
                    renderTimeTracking();
                } catch (err) {
                    console.warn('Time entries load failed (all clients):', err);
                    timeEntries = [];
                    renderTimeTracking();
                }
                return;
            }

            let ref = db.collection('clients')
                .doc(currentClientId)
                .collection('timeEntries')
                .where('date', '>=', bounds.start)
                .where('date', '<=', bounds.end);

            if (!canViewAllTimeEntries()) {
                ref = ref.where('userId', '==', auth.currentUser.uid);
            }

            try {
                const snapshot = await ref.orderBy('date', 'desc').get();
                timeEntries = snapshot.docs.map(doc => ({
                    id: doc.id,
                    clientId: currentClientId,
                    ...doc.data()
                }));
                renderTimeTracking();
            } catch (err) {
                console.warn('Time entries load failed:', err);
                timeEntries = [];
                renderTimeTracking();
            }
        }

        async function loadTimeEntriesForAllClients(bounds) {
            if (!window.db || !window.auth || !auth.currentUser) return [];
            const entries = [];
            const fetches = clients.map(async (client) => {
                try {
                    let ref = db.collection('clients')
                        .doc(client.id)
                        .collection('timeEntries')
                        .where('date', '>=', bounds.start)
                        .where('date', '<=', bounds.end);
                    if (!canViewAllTimeEntries()) {
                        ref = ref.where('userId', '==', auth.currentUser.uid);
                    }
                    const snapshot = await ref.orderBy('date', 'desc').get();
                    snapshot.docs.forEach((doc) => {
                        entries.push({
                            id: doc.id,
                            clientId: client.id,
                            ...doc.data()
                        });
                    });
                } catch (err) {
                    console.warn('Time entries load failed for client:', client.id, err);
                }
            });
            await Promise.all(fetches);
            return entries;
        }

        async function fetchReportEntries(filters) {
            if (!canViewReports() || !window.db || !window.auth || !auth.currentUser) {
                return [];
            }
            const normalized = normalizeReportFilters(filters);
            const startDate = normalized.startDate;
            const endDate = normalized.endDate;
            const clientIds = normalized.clientIds.includes('all')
                ? clients.map(c => c.id)
                : normalized.clientIds;
            const technicianValues = normalized.technicians.includes('all')
                ? []
                : normalized.technicians;

            if (!startDate || !endDate || !clientIds.length) {
                return [];
            }

            const results = await Promise.all(clientIds.map(async (clientId) => {
                const clientName = clients.find(c => c.id === clientId)?.name || clientId;
                let ref = db.collection('clients')
                    .doc(clientId)
                    .collection('timeEntries')
                    .where('date', '>=', startDate)
                    .where('date', '<=', endDate);

                if (technicianValues.length) {
                    const isEmail = technicianValues.every(value => value.includes('@'));
                    const isId = technicianValues.every(value => !value.includes('@'));
                    if (technicianValues.length === 1) {
                        const field = technicianValues[0].includes('@') ? 'userEmail' : 'userId';
                        ref = ref.where(field, '==', technicianValues[0]);
                    } else if ((isEmail || isId) && technicianValues.length <= 10) {
                        const field = isEmail ? 'userEmail' : 'userId';
                        ref = ref.where(field, 'in', technicianValues);
                    }
                }

                const snapshot = await ref.get();
                return snapshot.docs.map(doc => ({
                    id: doc.id,
                    clientId,
                    clientName,
                    ...doc.data()
                }));
            }));

            return results.flat().sort((a, b) => (b.date || '').localeCompare(a.date || ''));
        }

        async function loadReportEntries() {
            if (!canViewReports()) {
                reportEntries = [];
                reportHasLoaded = false;
                renderReportsView();
                return;
            }
            if (!window.db || !window.auth || !auth.currentUser) {
                reportEntries = [];
                reportHasLoaded = false;
                renderReportsView();
                return;
            }

            ensureReportFilterDefaults();
            buildReportClientOptions();
            const filters = getReportFilters();

            try {
                reportHasLoaded = true;
                reportEntries = await fetchReportEntries(filters);
                reportFiltersVisible = false;
                renderReportsView();
            } catch (err) {
                console.warn('Report entries load failed:', err);
                reportEntries = [];
                renderReportsView();
            }
        }

        function renderTimeTracking() {
            const view = document.getElementById('timeView');
            if (!view) return;
            renderTimeWeek();
            renderTimeSummary();
            renderTimeActivities();
            buildTimeTechnicianOptions();
            applyRolePermissions();
        }

        function renderReportsView() {
            const view = document.getElementById('reportsView');
            if (!view) return;
            const client = clients.find((c) => c.id === currentClientId);
            const accessNote = document.getElementById('reportsAccessNote');
            const filterPanel = view.querySelector('.report-filter-panel');
            const layout = view.querySelector('.reports-layout');
            const reportDisplay = view.querySelector('.report-display');
            const filters = view.querySelector('.report-filters');
            const actions = view.querySelector('.report-actions');
            const showFilters = reportFiltersVisible && !reportHasLoaded;
            if (!canViewReports()) {
                if (accessNote) accessNote.style.display = 'block';
                if (filterPanel) filterPanel.style.display = 'none';
                if (filters) filters.style.display = 'none';
                if (actions) actions.style.display = 'none';
                if (layout) layout.classList.add('reports-layout-single');
                if (reportDisplay) reportDisplay.style.display = 'none';
                const table = document.getElementById('timeReportTable');
                if (table) table.innerHTML = '';
                return;
            }
            if (accessNote) accessNote.style.display = 'none';
            if (filterPanel) filterPanel.style.display = showFilters ? 'grid' : 'none';
            if (layout) layout.classList.add('reports-layout-single');
            if (filters) filters.style.display = showFilters ? 'grid' : 'none';
            if (actions) actions.style.display = showFilters ? 'flex' : 'none';
            if (reportDisplay) reportDisplay.style.display = showFilters ? 'none' : 'flex';
            ensureReportFilterDefaults();
            buildReportClientOptions();
            buildReportTechnicianOptions(reportHasLoaded ? reportEntries : []);
            loadReportPresetsFromCloud();
            loadSharedReportPresets(true);
            buildReportPresetOptions();
            buildSharedReportOptions();
            if (showFilters) {
                const table = document.getElementById('timeReportTable');
                if (table) table.innerHTML = '';
                return;
            }
            if (reportHasLoaded) {
                renderTimeReportTable();
            } else {
                renderReportLanding();
            }
        }

        function getTimeSelectionRange() {
            if (!timeSelectionStart || !timeSelectionEnd) return null;
            if (!timeSelectionActive && !isTimeSelecting) return null;
            const startDate = timeSelectionStart.date;
            const endDate = timeSelectionEnd.date;
            if (!startDate || !endDate) return null;
            const startHour = Number.isFinite(timeSelectionStart.hour) ? timeSelectionStart.hour : TIME_GRID_START;
            const endHour = Number.isFinite(timeSelectionEnd.hour) ? timeSelectionEnd.hour : TIME_GRID_START;
            const normalized = {
                startDate: startDate <= endDate ? startDate : endDate,
                endDate: startDate <= endDate ? endDate : startDate,
                startHour: Math.min(startHour, endHour),
                endHour: Math.max(startHour, endHour)
            };
            return normalized;
        }

        function renderTimeWeek() {
            const titleEl = document.getElementById('timeCalendarTitle');
            const header = document.getElementById('timeWeekHeader');
            const grid = document.getElementById('timeWeekGrid');
            if (!titleEl || !header || !grid) return;

            const weekStart = timeViewWeekStart || getWeekStart(new Date());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            const formatShort = (date) => date.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'numeric' });
            titleEl.textContent = `Tyden ${formatShort(weekStart)} - ${formatShort(weekEnd)}`;

            const weekdays = ['Po', 'Ut', 'St', 'Ct', 'Pa', 'So', 'Ne'];
            const entriesByDate = {};
            const filteredEntries = getFilteredTimeEntries();
            filteredEntries.forEach(entry => {
                if (!entriesByDate[entry.date]) {
                    entriesByDate[entry.date] = [];
                }
                entriesByDate[entry.date].push(entry);
            });
            const segmentsByDate = buildTimeSegmentsByDate(filteredEntries);

            let headerHtml = '<div class="time-header-cell">Hod</div>';
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + i);
                const dateKey = formatDateKey(dayDate);
                const dayEntries = entriesByDate[dateKey] || [];
                const totalHours = dayEntries.reduce((sum, entry) => sum + (parseFloat(entry.hours) || 0), 0);
                const dayClass = (i % 2 === 0) ? 'day-even' : 'day-odd';
                headerHtml += `
                    <div class="time-header-cell ${dayClass}">
                        ${weekdays[i]}
                        <strong>${dateKey.split('-')[2]}.${dateKey.split('-')[1]}.</strong>
                        <span>${totalHours} h</span>
                    </div>
                `;
            }
            header.innerHTML = headerHtml;

            const selection = getTimeSelectionRange();
            const todayKey = formatDateKey(new Date());
            const canSelect = canManageTimeEntries();

            let cells = '';
            for (let hour = TIME_GRID_START; hour <= TIME_GRID_END; hour++) {
                const label = String(hour).padStart(2, '0') + ':00';
                cells += `<div class="time-hour-cell">${label}</div>`;

                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    const dayDate = new Date(weekStart);
                    dayDate.setDate(weekStart.getDate() + dayIndex);
                    const dateKey = formatDateKey(dayDate);
                    const dayEntries = entriesByDate[dateKey] || [];
                    const daySegments = segmentsByDate[dateKey] || [];
                    const segmentMatch = daySegments.find(segment =>
                        Number.isFinite(segment.startHour) &&
                        Number.isFinite(segment.endHour) &&
                        hour >= segment.startHour &&
                        hour <= segment.endHour
                    );
                    const hasEntry = !!segmentMatch;
                    const entryColor = segmentMatch ? getClientColor(segmentMatch.clientId) : '';
                    const segmentHours = segmentMatch
                        ? Math.max(0, (segmentMatch.endHour - segmentMatch.startHour + 1))
                        : 0;
                    const entryTitle = segmentMatch
                        ? `${getClientLabel(segmentMatch.clientId)} (${segmentHours} h)`
                        : '';

                    const inRange = selection &&
                        dateKey >= selection.startDate &&
                        dateKey <= selection.endDate &&
                        hour >= selection.startHour &&
                        hour <= selection.endHour;
                    const isStart = selection &&
                        dateKey === selection.startDate &&
                        hour === selection.startHour;
                    const isEnd = selection &&
                        dateKey === selection.endDate &&
                        hour === selection.endHour;
                    const isToday = dateKey === todayKey;

                    const classes = [
                        'time-slot',
                        dayIndex % 2 === 0 ? 'day-even' : 'day-odd',
                        hasEntry ? 'has-entry' : '',
                        hasEntry && segmentMatch && hour === segmentMatch.startHour ? 'is-entry-start' : '',
                        hasEntry && segmentMatch && hour === segmentMatch.endHour ? 'is-entry-end' : '',
                        inRange ? 'in-range' : '',
                        isStart ? 'range-start' : '',
                        isEnd ? 'range-end' : '',
                        isToday ? 'today' : ''
                    ].filter(Boolean).join(' ');

                    const handlers = canSelect
                        ? `onmousedown="startTimeSelection('${dateKey}', ${hour})" onmouseenter="updateTimeSelection('${dateKey}', ${hour})" onmouseup="finishTimeSelection('${dateKey}', ${hour})"`
                        : '';

                    const style = entryColor ? `style="--entry-color: ${entryColor}"` : '';
                    const title = entryTitle ? `title="${entryTitle}"` : '';
                    const label = segmentMatch && hour === segmentMatch.startHour
                        ? `<span class="time-slot-label">${getClientLabel(segmentMatch.clientId)}</span>`
                        : '';
                    cells += `<div class="${classes}" ${handlers} ${style} ${title}>${label}</div>`;
                }
            }

            grid.innerHTML = cells;
        }

        function buildTimeSegmentsByDate(entries) {
            const buckets = {};
            (entries || []).forEach((entry) => {
                if (!entry.date) return;
                if (!Number.isFinite(entry.startHour) || !Number.isFinite(entry.endHour)) return;
                const clientId = entry.clientId || currentClientId || 'unknown';
                if (!buckets[entry.date]) buckets[entry.date] = {};
                if (!buckets[entry.date][clientId]) buckets[entry.date][clientId] = [];
                buckets[entry.date][clientId].push({
                    start: entry.startHour,
                    end: entry.endHour
                });
            });

            const segments = {};
            Object.keys(buckets).forEach((dateKey) => {
                segments[dateKey] = [];
                const clientsForDate = buckets[dateKey];
                Object.keys(clientsForDate).forEach((clientId) => {
                    const ranges = clientsForDate[clientId].sort((a, b) => a.start - b.start);
                    let current = null;
                    ranges.forEach((range) => {
                        if (!current) {
                            current = { clientId, startHour: range.start, endHour: range.end };
                            return;
                        }
                        if (range.start <= current.endHour + 1) {
                            current.endHour = Math.max(current.endHour, range.end);
                        } else {
                            segments[dateKey].push(current);
                            current = { clientId, startHour: range.start, endHour: range.end };
                        }
                    });
                    if (current) segments[dateKey].push(current);
                });
            });
            return segments;
        }

        function startTimeSelection(dateKey, hour) {
            if (!canManageTimeEntries()) return;
            isTimeSelecting = true;
            timeSelectionActive = true;
            timeSelectionStart = { date: dateKey, hour };
            timeSelectionEnd = { date: dateKey, hour };
            renderTimeTracking();
        }

        function updateTimeSelection(dateKey, hour) {
            if (!isTimeSelecting) return;
            timeSelectionEnd = { date: dateKey, hour };
            renderTimeTracking();
        }

        function finishTimeSelection(dateKey, hour) {
            if (!isTimeSelecting) return;
            timeSelectionEnd = { date: dateKey, hour };
            isTimeSelecting = false;
            openTimeEntryModal();
        }

        function openTimeEntryModal(options = {}) {
            if (!canManageTimeEntries()) {
                alert('Nemate opravneni zapisovat hodiny');
                return;
            }
            if (!clients.length) {
                alert('Nejprve vytvorte klienta');
                return;
            }
            const modal = document.getElementById('timeEntryModal');
            if (!modal) return;
            timeEntryDefaults = {
                clientId: options.clientId || currentClientId || null,
                ticketId: options.ticketId || null
            };
            buildTimeClientOptions(timeEntryDefaults.clientId);
            const clientSelect = document.getElementById('timeEntryClient');
            const selectedClientId = clientSelect ? clientSelect.value : timeEntryDefaults.clientId;
            buildTimeTicketOptions(selectedClientId, timeEntryDefaults.ticketId);
            buildTimeActivityOptions();
            fillTimeEntryModal();
            modal.classList.add('active');
        }

        function closeTimeEntryModal() {
            const modal = document.getElementById('timeEntryModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function buildTimeClientOptions(preferredId) {
            const select = document.getElementById('timeEntryClient');
            if (!select) return;
            select.innerHTML = clients.map(client =>
                `<option value="${client.id}">${client.name}</option>`
            ).join('');
            const preferred = preferredId && clients.some(c => c.id === preferredId) ? preferredId : null;
            if (preferred) {
                select.value = preferred;
            } else if (currentClientId && clients.some(c => c.id === currentClientId)) {
                select.value = currentClientId;
            }
        }

        function buildTimeTicketOptions(clientId, selectedTicketId) {
            const select = document.getElementById('timeEntryTicket');
            if (!select) return;
            const tickets = helpdeskTickets
                .filter(ticket => ticket.clientId === clientId)
                .sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
            const options = [
                { value: '', label: 'Bez tiketu' },
                ...tickets.map(ticket => ({
                    value: ticket.id,
                    label: `${ticket.id} - ${ticket.title || 'Bez nazvu'}`
                }))
            ];
            select.innerHTML = options.map(option =>
                `<option value="${escapeHtml(option.value)}">${escapeHtml(option.label)}</option>`
            ).join('');
            if (selectedTicketId && options.some(option => option.value === selectedTicketId)) {
                select.value = selectedTicketId;
            } else {
                select.value = '';
            }
        }

        function onTimeEntryClientChange() {
            const clientSelect = document.getElementById('timeEntryClient');
            const clientId = clientSelect ? clientSelect.value : '';
            timeEntryDefaults.clientId = clientId || null;
            timeEntryDefaults.ticketId = null;
            buildTimeTicketOptions(clientId, null);
        }

        function buildTimeActivityOptions() {
            const list = document.getElementById('timeActivityOptions');
            if (!list) return;
            list.innerHTML = timeActivities.map(item => `<option value="${item}"></option>`).join('');
        }

        function loadTimeActivities() {
            const saved = localStorage.getItem('rackManagerTimeActivities');
            if (saved) {
                try {
                    timeActivities = JSON.parse(saved);
                } catch (err) {
                    timeActivities = [...DEFAULT_TIME_ACTIVITIES];
                }
            } else {
                timeActivities = [...DEFAULT_TIME_ACTIVITIES];
            }
        }

        function saveTimeActivities() {
            localStorage.setItem('rackManagerTimeActivities', JSON.stringify(timeActivities));
        }

        function renderTimeActivities() {
            const list = document.getElementById('timeActivityList');
            if (!list) return;
            const items = timeActivities.length ? timeActivities : DEFAULT_TIME_ACTIVITIES;
            list.innerHTML = items.map(item => `
                <span class="time-activity-chip">
                    ${item}
                    <button onclick="removeTimeActivity('${item}')">x</button>
                </span>
            `).join('');
            buildTimeActivityOptions();
        }

        function addTimeActivity() {
            const input = document.getElementById('timeActivityInput');
            if (!input) return;
            const value = input.value.trim();
            if (!value) return;
            if (!timeActivities.includes(value)) {
                timeActivities.push(value);
                saveTimeActivities();
                renderTimeActivities();
            }
            input.value = '';
        }

        function removeTimeActivity(name) {
            timeActivities = timeActivities.filter(item => item !== name);
            if (!timeActivities.length) {
                timeActivities = [...DEFAULT_TIME_ACTIVITIES];
            }
            saveTimeActivities();
            renderTimeActivities();
        }

        function fillTimeEntryModal() {
            const range = getTimeSelectionRange();
            const start = range ? range.startDate : formatDateKey(new Date());
            const end = range ? range.endDate : start;
            const defaultHours = range ? Math.max(1, range.endHour - range.startHour + 1) : 1;

            const startInput = document.getElementById('timeEntryStart');
            const endInput = document.getElementById('timeEntryEnd');
            const hoursInput = document.getElementById('timeEntryHours');
            const descInput = document.getElementById('timeEntryDesc');
            const activityInput = document.getElementById('timeEntryActivity');
            const categorySelect = document.getElementById('timeEntryCategory');
            const ticketSelect = document.getElementById('timeEntryTicket');

            if (startInput) startInput.value = start;
            if (endInput) endInput.value = end;
            if (hoursInput) hoursInput.value = String(defaultHours);
            if (descInput) descInput.value = '';
            if (activityInput) activityInput.value = '';
            if (categorySelect) categorySelect.value = 'client';
            if (ticketSelect) {
                const ticketId = timeEntryDefaults.ticketId || '';
                ticketSelect.value = Array.from(ticketSelect.options).some(option => option.value === ticketId)
                    ? ticketId
                    : '';
            }
            updateTimeEntrySummary();
        }

        function setTimePreset(hours) {
            const hoursInput = document.getElementById('timeEntryHours');
            if (!hoursInput) return;
            hoursInput.value = String(hours);
            updateTimeEntrySummary();
        }

        function updateTimeEntrySummary() {
            const startInput = document.getElementById('timeEntryStart');
            const endInput = document.getElementById('timeEntryEnd');
            const hoursInput = document.getElementById('timeEntryHours');
            const summary = document.getElementById('timeEntrySummary');
            if (!summary) return;

            const start = startInput ? startInput.value : '';
            const end = endInput ? endInput.value : '';
            const hours = hoursInput ? parseFloat(hoursInput.value) || 0 : 0;
            if (!start || !end) {
                summary.textContent = '';
                return;
            }

            const startDate = parseDateKey(start);
            const endDate = parseDateKey(end);
            if (!startDate || !endDate) return;

            const min = startDate <= endDate ? startDate : endDate;
            const max = startDate <= endDate ? endDate : startDate;
            const days = Math.floor((max - min) / (1000 * 60 * 60 * 24)) + 1;
            summary.textContent = `Pocet dni: ${days}, celkem: ${days * hours} h`;
        }

        function renderTimeSummary() {
            const summary = document.getElementById('timeSummary');
            const clientSummary = document.getElementById('timeClientSummary');
            if (!summary) return;
            if (!currentClientId && !timeViewAllClients) {
                summary.innerHTML = '';
                if (clientSummary) clientSummary.innerHTML = '';
                return;
            }

            const filteredEntries = getFilteredTimeEntries();
            const weekTotal = filteredEntries.reduce((sum, entry) => sum + (parseFloat(entry.hours) || 0), 0);
            const todayKey = formatDateKey(new Date());
            const todayTotal = filteredEntries
                .filter(entry => entry.date === todayKey)
                .reduce((sum, entry) => sum + (parseFloat(entry.hours) || 0), 0);

            const range = getTimeSelectionRange();
            const rangeTotal = range
                ? filteredEntries.filter(entry => entry.date >= range.startDate && entry.date <= range.endDate)
                    .reduce((sum, entry) => sum + (parseFloat(entry.hours) || 0), 0)
                : null;

            summary.innerHTML = `
                <div class="summary-card">
                    <div class="summary-value">${weekTotal} h</div>
                    <div class="summary-label">Tyden</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${todayTotal} h</div>
                    <div class="summary-label">Dnes</div>
                </div>
                ${rangeTotal !== null ? `
                    <div class="summary-card">
                        <div class="summary-value">${rangeTotal} h</div>
                        <div class="summary-label">Vybrany rozsah</div>
                    </div>
                ` : ''}
            `;

            if (!clientSummary) return;
            const totalsByClient = {};
            filteredEntries.forEach((entry) => {
                const clientId = entry.clientId || currentClientId || 'unknown';
                totalsByClient[clientId] = (totalsByClient[clientId] || 0) + (parseFloat(entry.hours) || 0);
            });
            const cards = Object.keys(totalsByClient)
                .sort((a, b) => (totalsByClient[b] || 0) - (totalsByClient[a] || 0))
                .map((clientId) => {
                    const label = getClientLabel(clientId);
                    const total = Math.round((totalsByClient[clientId] || 0) * 100) / 100;
                    const color = getClientColor(clientId);
                    return `
                        <div class="time-client-card" style="--client-color: ${color}">
                            <span class="time-client-color" aria-hidden="true"></span>
                            <span>${label}</span>
                            <strong>${total} h</strong>
                        </div>
                    `;
                })
                .join('');
            clientSummary.innerHTML = cards || '';
        }

        function ensureReportFilterDefaults() {
            const presetSelect = document.getElementById('reportRangePreset');
            const startInput = document.getElementById('reportStartDate');
            const endInput = document.getElementById('reportEndDate');
            if (!startInput || !endInput) return;
            if (presetSelect && !presetSelect.value) {
                presetSelect.value = 'all';
            }
            const preset = presetSelect ? presetSelect.value : 'all';
            if (preset === 'custom') {
                toggleReportDateInputs(true);
                if (!startInput.value || !endInput.value) {
                    const now = new Date();
                    const start = new Date(now.getFullYear(), now.getMonth(), 1);
                    startInput.value = formatDateKey(start);
                    endInput.value = formatDateKey(now);
                }
                return;
            }
            applyReportRangePreset(preset, true);
        }

        function toggleReportDateInputs(isCustom) {
            const startInput = document.getElementById('reportStartDate');
            const endInput = document.getElementById('reportEndDate');
            if (!startInput || !endInput) return;
            startInput.disabled = !isCustom;
            endInput.disabled = !isCustom;
        }

        function applyReportRangePreset(preset, silent) {
            const startInput = document.getElementById('reportStartDate');
            const endInput = document.getElementById('reportEndDate');
            if (!startInput || !endInput) return;
            const now = new Date();
            let start = new Date(now);
            let end = new Date(now);

            switch (preset) {
                case 'all':
                    start = new Date(2000, 0, 1);
                    end = new Date(now);
                    break;
                case 'previous-month':
                    start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    end = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
                case 'year':
                    start = new Date(now.getFullYear(), 0, 1);
                    end = new Date(now);
                    break;
                case 'custom':
                    toggleReportDateInputs(true);
                    if (!startInput.value || !endInput.value) {
                        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                        startInput.value = formatDateKey(monthStart);
                        endInput.value = formatDateKey(now);
                    }
                    if (!silent) loadReportEntries();
                    return;
                default:
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    end = new Date(now);
            }

            startInput.value = formatDateKey(start);
            endInput.value = formatDateKey(end);
            toggleReportDateInputs(false);
            if (!silent) loadReportEntries();
        }

        function onReportRangePresetChange() {
            const presetSelect = document.getElementById('reportRangePreset');
            if (!presetSelect) return;
            const silent = reportFiltersVisible || !reportHasLoaded;
            applyReportRangePreset(presetSelect.value, silent);
        }

        function onReportDateChange() {
            const presetSelect = document.getElementById('reportRangePreset');
            if (presetSelect && presetSelect.value !== 'custom') {
                presetSelect.value = 'custom';
            }
            toggleReportDateInputs(true);
            onReportFilterChange();
        }

        function buildReportClientOptions() {
            const select = document.getElementById('reportClientFilter');
            if (!select) return;
            const previous = getMultiSelectValues(select);
            select.innerHTML = [
                '<option value="all">Vsechny klienty</option>',
                ...clients.map(client => `<option value="${client.id}">${client.name}</option>`)
            ].join('');
            const fallback = currentClientId && clients.some(c => c.id === currentClientId)
                ? currentClientId
                : 'all';
            setMultiSelectValues(select, previous, fallback);
        }

        function buildReportTechnicianOptions(entries) {
            const select = document.getElementById('reportTechnicianFilter');
            if (!select) return;
            const previous = getMultiSelectValues(select);
            const technicians = Array.from(new Set(
                (entries || []).map(entry => entry.userEmail || entry.userId).filter(Boolean)
            )).sort((a, b) => a.localeCompare(b, 'cs', { sensitivity: 'base' }));
            select.innerHTML = [
                '<option value="all">Vsechni technici</option>',
                ...technicians.map(name => `<option value="${name}">${name}</option>`)
            ].join('');
            ensureSelectOptions(select, previous);
            setMultiSelectValues(select, previous, 'all');
        }

        function getMultiSelectValues(select) {
            if (!select) return [];
            return Array.from(select.selectedOptions || []).map(option => option.value);
        }

        function normalizeMultiSelection(values, allValue) {
            const list = Array.isArray(values) ? values : (values ? [values] : []);
            const cleaned = [...new Set(list.map(value => `${value}`.trim()).filter(Boolean))];
            if (!cleaned.length || cleaned.includes(allValue)) {
                return [allValue];
            }
            return cleaned;
        }

        function setMultiSelectValues(select, values, fallbackValue) {
            if (!select) return;
            const normalized = normalizeMultiSelection(values, 'all');
            const available = new Set(Array.from(select.options).map(option => option.value));
            let next = normalized.filter(value => available.has(value));
            if (!next.length) {
                const fallback = fallbackValue && available.has(fallbackValue) ? [fallbackValue] : ['all'];
                next = fallback;
            }
            Array.from(select.options).forEach(option => {
                option.selected = next.includes(option.value);
            });
        }

        function ensureSelectOptions(select, values) {
            if (!select) return;
            const normalized = normalizeMultiSelection(values, 'all');
            normalized.forEach(value => ensureSelectOption(select, value, value));
        }

        function normalizeReportFilters(filters) {
            const next = { ...(filters || {}) };
            next.clientIds = normalizeMultiSelection(next.clientIds || next.clientId, 'all');
            next.technicians = normalizeMultiSelection(next.technicians || next.technician, 'all');
            if (!next.rangePreset) {
                next.rangePreset = 'custom';
            }
            if (!next.startDate) next.startDate = '';
            if (!next.endDate) next.endDate = '';
            return next;
        }

        function getReportFilters() {
            const clientSelect = document.getElementById('reportClientFilter');
            const techSelect = document.getElementById('reportTechnicianFilter');
            const presetSelect = document.getElementById('reportRangePreset');
            const startInput = document.getElementById('reportStartDate');
            const endInput = document.getElementById('reportEndDate');
            return normalizeReportFilters({
                clientIds: normalizeMultiSelection(getMultiSelectValues(clientSelect), 'all'),
                technicians: normalizeMultiSelection(getMultiSelectValues(techSelect), 'all'),
                rangePreset: presetSelect ? presetSelect.value : 'custom',
                startDate: startInput ? startInput.value : '',
                endDate: endInput ? endInput.value : ''
            });
        }

        function onReportFilterChange() {
            reportHasLoaded = false;
            if (reportFiltersVisible) {
                renderReportsView();
            } else {
                renderReportLanding();
            }
        }

        function showReportFilters() {
            reportHasLoaded = false;
            reportFiltersVisible = true;
            renderReportsView();
            setTimeout(() => {
                document.getElementById('reportPresetName')?.focus();
            }, 0);
        }

        function showReportList() {
            reportHasLoaded = false;
            reportFiltersVisible = false;
            renderReportsView();
        }

        async function createReportFromBuilder() {
            const nameInput = document.getElementById('reportPresetName');
            ensureReportFilterDefaults();
            const filters = getReportFilters();
            const name = (nameInput?.value || '').trim();
            const presets = getSavedReportPresets();
            const presetName = name || buildReportPresetName(filters);
            const preset = {
                id: `preset-${Date.now()}`,
                name: presetName,
                filters
            };
            presets.unshift(preset);
            saveReportPresets(presets.slice(0, 30));
            buildReportPresetOptions();
            if (nameInput && !name) {
                nameInput.value = presetName;
            }
            await saveReportPresetToCloud(preset);
            loadReportEntries();
        }

        function getSavedReportPresets() {
            try {
                return JSON.parse(localStorage.getItem('cxtechReportPresets') || '[]');
            } catch (err) {
                return [];
            }
        }

        function saveReportPresets(presets) {
            localStorage.setItem('cxtechReportPresets', JSON.stringify(presets));
        }

        function getReportPresetCollection() {
            if (!window.db || !window.auth || !auth.currentUser) return null;
            return db.collection('users')
                .doc(auth.currentUser.uid)
                .collection('reportPresets');
        }

        async function loadReportPresetsFromGlobal() {
            if (!window.db || !window.auth || !auth.currentUser || !window.GLOBAL_PATH) return false;
            try {
                const snap = await db.doc(GLOBAL_PATH).get();
                if (!snap.exists) return false;
                const data = snap.data() || {};
                const presetsByUser = data.reportPresetsByUser || {};
                const presetMap = presetsByUser[auth.currentUser.uid] || {};
                const presets = Object.values(presetMap).filter(Boolean);
                if (presets.length) {
                    saveReportPresets(presets);
                    buildReportPresetOptions();
                    if (!reportHasLoaded) {
                        renderReportLanding();
                    }
                    return true;
                }
            } catch (err) {
                console.warn('Load report presets from global failed:', err);
            }
            return false;
        }

        async function saveReportPresetToGlobal(preset) {
            if (!window.db || !window.auth || !auth.currentUser || !window.GLOBAL_PATH || !preset) return;
            const fieldPath = `reportPresetsByUser.${auth.currentUser.uid}.${preset.id}`;
            const payload = {
                id: preset.id,
                name: preset.name,
                filters: preset.filters || {},
                updatedAtMs: Date.now(),
                updatedBy: auth.currentUser?.email || auth.currentUser?.uid || ''
            };
            try {
                await db.doc(GLOBAL_PATH).set({ [fieldPath]: payload }, { merge: true });
            } catch (err) {
                console.warn('Save report preset to global failed:', err);
            }
        }

        async function loadReportPresetsFromCloud(force) {
            if (reportPresetsLoaded && !force) return;
            const collectionRef = getReportPresetCollection();
            if (!collectionRef) return;
            reportPresetsLoaded = true;
            const localPresets = getSavedReportPresets();
            try {
                const snapshot = await collectionRef.orderBy('updatedAtMs', 'desc').get();
                if (snapshot.empty) {
                    if (localPresets.length) {
                        await Promise.all(localPresets.map((preset) => saveReportPresetToCloud(preset)));
                    } else {
                        await loadReportPresetsFromGlobal();
                    }
                } else {
                    const presets = snapshot.docs.map(doc => {
                        const data = doc.data() || {};
                        return {
                            id: doc.id,
                            name: data.name || 'Report',
                            filters: data.filters || {}
                        };
                    });
                    saveReportPresets(presets);
                    buildReportPresetOptions();
                    if (!reportHasLoaded) {
                        renderReportLanding();
                    }
                }
            } catch (err) {
                console.warn('Load report presets failed:', err);
                reportPresetsLoaded = false;
                await loadReportPresetsFromGlobal();
            }
        }

        async function saveReportPresetToCloud(preset) {
            const collectionRef = getReportPresetCollection();
            if (!collectionRef || !preset) return;
            try {
                const payload = {
                    name: preset.name,
                    filters: preset.filters || {},
                    updatedAtMs: Date.now(),
                    updatedBy: auth.currentUser?.email || auth.currentUser?.uid || ''
                };
                if (window.firebase?.firestore?.FieldValue) {
                    payload.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                }
                await collectionRef.doc(preset.id).set(payload, { merge: true });
            } catch (err) {
                console.warn('Save report preset failed:', err);
                await saveReportPresetToGlobal(preset);
            }
        }

        function buildReportPresetOptions() {
            const select = document.getElementById('reportPresetSelect');
            if (!select) return;
            const presets = getSavedReportPresets();
            const previous = select.value;
            select.innerHTML = [
                '<option value="">Ulozene reporty</option>',
                ...presets.map(preset => `<option value="${preset.id}">${preset.name}</option>`)
            ].join('');
            if (presets.some(preset => preset.id === previous)) {
                select.value = previous;
            }
        }

        function buildSharedReportOptions() {
            const select = document.getElementById('reportSharedSelect');
            if (!select) return;
            const previous = select.value;
            select.innerHTML = [
                '<option value="">Sdilene reporty</option>',
                ...sharedReportPresets.map(preset => `<option value="${preset.id}">${preset.name}</option>`)
            ].join('');
            if (sharedReportPresets.some(preset => preset.id === previous)) {
                select.value = previous;
            }
        }

        function formatMultiLabel(values, maxItems) {
            const cleaned = (values || []).filter(Boolean);
            if (!cleaned.length) return '-';
            if (cleaned.length <= maxItems) return cleaned.join(', ');
            return `${cleaned.slice(0, maxItems).join(', ')} +${cleaned.length - maxItems}`;
        }

        function formatReportClientLabel(clientIds) {
            const normalized = normalizeMultiSelection(clientIds, 'all');
            if (normalized.includes('all')) return 'Vsechny klienty';
            const names = normalized.map((id) => clients.find(c => c.id === id)?.name || id);
            return formatMultiLabel(names, 2);
        }

        function formatReportTechnicianLabel(technicians) {
            const normalized = normalizeMultiSelection(technicians, 'all');
            if (normalized.includes('all')) return 'Vsechni technici';
            return formatMultiLabel(normalized, 2);
        }

        function getReportSummary(filters) {
            const normalized = normalizeReportFilters(filters);
            const clientLabel = formatReportClientLabel(normalized.clientIds);
            const techLabel = formatReportTechnicianLabel(normalized.technicians);
            const rangeLabel = getReportRangeLabel(normalized);
            return `Klient: ${clientLabel} | Obdobi: ${rangeLabel} | Technik: ${techLabel}`;
        }

        function renderReportLanding() {
            const container = document.getElementById('timeReportTable');
            if (!container) return;
            const saved = getSavedReportPresets();
            const shared = sharedReportPresets || [];

            const buildCards = (items, source) => {
                if (!items.length) {
                    return '<div class="empty-state"><p>Zadne reporty.</p></div>';
                }
                return `
                    <div class="report-list-grid">
                        ${items.map(item => `
                            <button class="report-list-card" onclick="openReportPreset('${source}', '${item.id}')">
                                <div class="report-list-name">${item.name || 'Report'}</div>
                                <div class="report-list-meta">${getReportSummary(item.filters || {})}</div>
                            </button>
                        `).join('')}
                    </div>
                `;
            };

            container.innerHTML = `
                <div class="report-sheet report-sheet-wide">
                    <div class="report-sheet-header">
                        <div>
                            <div class="report-sheet-title">Reporty</div>
                            <div class="report-sheet-subtitle">Vyber ulozeny nebo sdileny report.</div>
                        </div>
                        <div class="report-sheet-logo">CX.TECH</div>
                    </div>
                    <div class="report-sheet-toolbar">
                        <button class="btn-small" onclick="showReportFilters()">Vytvorit report</button>
                    </div>
                    <div class="report-sheet-meta">
                        <div class="report-meta-item"><span>Ulozene</span><div>${saved.length}</div></div>
                        <div class="report-meta-item"><span>Sdilene</span><div>${shared.length}</div></div>
                    </div>
                    <div class="report-list">
                        <div class="report-list-group">
                            <div class="report-list-title">Ulozene reporty</div>
                            ${buildCards(saved, 'local')}
                        </div>
                        <div class="report-list-group">
                            <div class="report-list-title">Sdilene reporty</div>
                            ${buildCards(shared, 'shared')}
                        </div>
                    </div>
                </div>
            `;
        }

        function openReportPreset(source, id) {
            const presets = source === 'shared' ? sharedReportPresets : getSavedReportPresets();
            const preset = presets.find(item => item.id === id);
            if (!preset) return;
            reportHasLoaded = true;
            reportFiltersVisible = false;
            applyReportFilters(preset.filters || {}, true);
        }

        function ensureSelectOption(select, value, label) {
            if (!select || !value) return;
            const exists = Array.from(select.options).some(option => option.value === value);
            if (!exists) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = label || value;
                select.appendChild(option);
            }
        }

        function applyReportFilters(filters, shouldLoad) {
            if (!filters) return;
            const normalized = normalizeReportFilters(filters);
            if (shouldLoad !== false) {
                reportFiltersVisible = false;
            }
            buildReportClientOptions();
            buildReportTechnicianOptions(reportEntries || []);
            const clientSelect = document.getElementById('reportClientFilter');
            const techSelect = document.getElementById('reportTechnicianFilter');
            const presetSelect = document.getElementById('reportRangePreset');
            const startInput = document.getElementById('reportStartDate');
            const endInput = document.getElementById('reportEndDate');

            if (clientSelect) {
                setMultiSelectValues(clientSelect, normalized.clientIds, currentClientId || 'all');
            }
            if (techSelect) {
                ensureSelectOptions(techSelect, normalized.technicians);
                setMultiSelectValues(techSelect, normalized.technicians, 'all');
            }
            if (presetSelect && normalized.rangePreset) presetSelect.value = normalized.rangePreset;

            if (normalized.rangePreset && normalized.rangePreset !== 'custom') {
                applyReportRangePreset(normalized.rangePreset, true);
            } else {
                toggleReportDateInputs(true);
                if (startInput && normalized.startDate) startInput.value = normalized.startDate;
                if (endInput && normalized.endDate) endInput.value = normalized.endDate;
            }

            if (shouldLoad !== false) {
                loadReportEntries();
            } else {
                reportHasLoaded = false;
                renderReportLanding();
            }
        }

        function getReportShareCollection() {
            if (!window.db || !window.auth || !auth.currentUser) return null;
            return db.collection('reportShares');
        }

        async function loadSharedReportPresets(force) {
            if (reportSharedLoaded && !force) return;
            const collectionRef = getReportShareCollection();
            if (!collectionRef) return;
            reportSharedLoaded = true;
            try {
                const snapshot = await collectionRef.where('visibility', '==', 'internal').get();
                sharedReportPresets = snapshot.docs.map(doc => {
                    const data = doc.data() || {};
                    return {
                        id: doc.id,
                        name: data.name || 'Report',
                        filters: data.filters || {},
                        updatedAtMs: data.updatedAtMs || 0
                    };
                }).sort((a, b) => (b.updatedAtMs || 0) - (a.updatedAtMs || 0));
                buildSharedReportOptions();
                if (!reportHasLoaded) {
                    renderReportLanding();
                }
            } catch (err) {
                console.warn('Load shared report presets failed:', err);
                reportSharedLoaded = false;
            }
        }

        async function createReportShare(filters, name, visibility) {
            const collectionRef = getReportShareCollection();
            if (!collectionRef) {
                alert('Nejprve se prihlaste.');
                return null;
            }
            const docRef = collectionRef.doc();
            const payload = {
                name: name || 'Report',
                filters: filters || {},
                visibility: visibility || 'link',
                createdAtMs: Date.now(),
                updatedAtMs: Date.now(),
                createdBy: auth.currentUser?.email || auth.currentUser?.uid || '',
                createdByUid: auth.currentUser?.uid || ''
            };
            if (window.firebase?.firestore?.FieldValue) {
                payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                payload.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
            }
            await docRef.set(payload);
            return docRef.id;
        }

        function buildReportShareLink(shareId) {
            const url = new URL(window.location.href);
            url.searchParams.set('reportShare', shareId);
            return url.toString();
        }

        function openReportShareModal() {
            const modal = document.getElementById('reportShareModal');
            if (modal) modal.classList.add('active');
        }

        function closeReportShareModal() {
            const modal = document.getElementById('reportShareModal');
            if (modal) modal.classList.remove('active');
        }

        async function handleReportShareOption(type) {
            try {
                if (type === 'link') {
                    await createReportShareLink();
                } else if (type === 'internal') {
                    await shareReportInternally();
                }
            } finally {
                closeReportShareModal();
            }
        }

        async function createReportShareLink() {
            ensureReportFilterDefaults();
            const filters = getReportFilters();
            const nameInput = document.getElementById('reportPresetName');
            const name = (nameInput?.value || '').trim() || buildReportPresetName(filters);
            try {
                const shareId = await createReportShare(filters, name, 'link');
                if (!shareId) return;
                const link = buildReportShareLink(shareId);
                const linkInput = document.getElementById('reportShareLink');
                if (linkInput) {
                    linkInput.value = link;
                }
                if (navigator.clipboard?.writeText) {
                    try {
                        await navigator.clipboard.writeText(link);
                        alert('Odkaz zkopirovan.');
                    } catch (err) {
                        alert('Odkaz pripraven.');
                    }
                } else {
                    alert('Odkaz pripraven.');
                }
            } catch (err) {
                console.warn('Share link failed:', err);
                alert('Sdileni selhalo.');
            }
        }

        async function shareReportInternally() {
            ensureReportFilterDefaults();
            const filters = getReportFilters();
            const nameInput = document.getElementById('reportPresetName');
            const name = (nameInput?.value || '').trim() || buildReportPresetName(filters);
            try {
                const shareId = await createReportShare(filters, name, 'internal');
                if (!shareId) return;
                await loadSharedReportPresets(true);
                const sharedSelect = document.getElementById('reportSharedSelect');
                if (sharedSelect) sharedSelect.value = shareId;
            } catch (err) {
                console.warn('Share internally failed:', err);
                alert('Sdileni selhalo.');
            }
        }

        async function applyReportShareFromUrl() {
            if (!pendingReportShareId) return;
            const shareId = pendingReportShareId;
            if (!window.db || !window.auth || !auth.currentUser) return;
            if (!canViewReports()) return;
            try {
                const collectionRef = getReportShareCollection();
                if (!collectionRef) return;
                const snap = await collectionRef.doc(shareId).get();
                if (!snap.exists) {
                    pendingReportShareId = null;
                    return;
                }
                const data = snap.data() || {};
                if (window.switchView) {
                    switchView('reports');
                }
                applyReportFilters(data.filters || {});
                const linkInput = document.getElementById('reportShareLink');
                if (linkInput) linkInput.value = buildReportShareLink(shareId);
                pendingReportShareId = null;
            } catch (err) {
                console.warn('Apply report share failed:', err);
            }
        }

        function getReportRangeLabel(filters) {
            switch (filters.rangePreset) {
                case 'all':
                    return 'Vsechno';
                case 'previous-month':
                    return 'Predchozi mesic';
                case 'year':
                    return 'Aktualni rok';
                case 'custom':
                    return `${filters.startDate || '-'} - ${filters.endDate || '-'}`;
                default:
                    return 'Soucasny mesic';
            }
        }

        function buildReportPresetName(filters) {
            const normalized = normalizeReportFilters(filters);
            const clientLabel = formatReportClientLabel(normalized.clientIds);
            const techLabel = formatReportTechnicianLabel(normalized.technicians);
            const rangeLabel = getReportRangeLabel(normalized);
            return `${clientLabel} | ${rangeLabel} | ${techLabel}`;
        }

        async function saveReportPreset() {
            const nameInput = document.getElementById('reportPresetName');
            ensureReportFilterDefaults();
            const filters = getReportFilters();
            const name = (nameInput?.value || '').trim();
            const presets = getSavedReportPresets();
            const presetName = name || buildReportPresetName(filters);
            const preset = {
                id: `preset-${Date.now()}`,
                name: presetName,
                filters
            };
            presets.unshift(preset);
            saveReportPresets(presets.slice(0, 30));
            if (nameInput) nameInput.value = '';
            buildReportPresetOptions();
            if (!reportHasLoaded) {
                renderReportLanding();
            }
            await saveReportPresetToCloud(preset);
        }

        function applyReportPreset() {
            const select = document.getElementById('reportPresetSelect');
            if (!select || !select.value) return;
            const presets = getSavedReportPresets();
            const preset = presets.find(item => item.id === select.value);
            if (!preset) return;
            applyReportFilters(preset.filters || {});
        }

        function applySharedReportPreset() {
            const select = document.getElementById('reportSharedSelect');
            if (!select || !select.value) return;
            const preset = sharedReportPresets.find(item => item.id === select.value);
            if (!preset) return;
            applyReportFilters(preset.filters || {});
        }

        function getFilteredReportEntries() {
            const filters = normalizeReportFilters(getReportFilters());
            let entries = [...reportEntries];
            if (!filters.clientIds.includes('all')) {
                entries = entries.filter(entry => filters.clientIds.includes(entry.clientId));
            }
            if (!filters.technicians.includes('all')) {
                entries = entries.filter(entry => filters.technicians.includes(entry.userEmail || entry.userId));
            }
            if (filters.startDate) {
                entries = entries.filter(entry => entry.date >= filters.startDate);
            }
            if (filters.endDate) {
                entries = entries.filter(entry => entry.date <= filters.endDate);
            }
            return entries;
        }

        const REPORT_CHUNK_HOURS = 0.5;

        function splitReportEntries(entries) {
            const chunks = [];
            (entries || []).forEach((entry) => {
                const hoursValue = parseFloat(entry.hours);
                if (!Number.isFinite(hoursValue) || hoursValue <= 0) return;

                const fullChunks = Math.floor(hoursValue / REPORT_CHUNK_HOURS);
                const remainder = Math.round((hoursValue - fullChunks * REPORT_CHUNK_HOURS) * 100) / 100;
                const totalChunks = fullChunks + (remainder > 0.01 ? 1 : 0);

                for (let i = 0; i < fullChunks; i += 1) {
                    chunks.push({
                        ...entry,
                        hours: REPORT_CHUNK_HOURS,
                        _chunkIndex: i + 1,
                        _chunkTotal: totalChunks
                    });
                }
                if (remainder > 0.01) {
                    chunks.push({
                        ...entry,
                        hours: remainder,
                        _chunkIndex: fullChunks + 1,
                        _chunkTotal: totalChunks
                    });
                }
            });
            return chunks;
        }

        function renderTimeReportTable() {
            const container = document.getElementById('timeReportTable');
            if (!container) return;

            const filters = normalizeReportFilters(getReportFilters());
            const entries = getFilteredReportEntries();
            const reportTitleInput = document.getElementById('reportPresetName');
            const reportTitle = (reportTitleInput?.value || '').trim() || buildReportPresetName(filters);
            const creator = auth?.currentUser?.displayName || auth?.currentUser?.email || auth?.currentUser?.uid || 'System';
            const clientLabel = formatReportClientLabel(filters.clientIds);
            const techLabel = formatReportTechnicianLabel(filters.technicians);
            const rangeLabel = getReportRangeLabel(filters);
            const creatorSuffix = filters.clientIds.length === 1 && !filters.clientIds.includes('all')
                ? ` (${clientLabel})`
                : '';
            const totalHours = entries.reduce((sum, entry) => sum + (parseFloat(entry.hours) || 0), 0);
            const totalHoursLabel = Number.isFinite(totalHours)
                ? (Math.round(totalHours * 100) / 100).toString()
                : '0';
            const canDelete = canManageTimeEntries();
            const expandedEntries = splitReportEntries(entries);

            const buildTableHtml = (items, showClientColumn) => {
                const headerCells = [
                    '<th>Datum</th>',
                    '<th>Polozka</th>'
                ];
                if (showClientColumn) headerCells.push('<th>Klient</th>');
                headerCells.push('<th>Hodin</th>', '<th>Technik</th>', '<th>Popis</th>');
                if (canDelete) headerCells.push('<th>Akce</th>');
                const headerCols = headerCells.join('');

                const rows = items.map(entry => {
                    const clientName = entry.clientName || (clients.find(c => c.id === entry.clientId)?.name) || '-';
                    const activity = entry.category || entry.activity || '-';
                    const hoursValue = parseFloat(entry.hours);
                    const hoursLabel = Number.isFinite(hoursValue)
                        ? (Math.round(hoursValue * 100) / 100).toString()
                        : '0';
                    const deleteCell = canDelete
                        ? `<td><button class="delete-btn" onclick="deleteReportEntry('${entry.id}', '${entry.clientId || ''}')">Smazat</button></td>`
                        : '';
                    return `
                        <tr>
                            <td>${entry.date || '-'}</td>
                            <td>${activity}</td>
                            ${showClientColumn ? `<td>${clientName}</td>` : ''}
                            <td>${hoursLabel}</td>
                            <td>${entry.userEmail || entry.userId || '-'}</td>
                            <td>${entry.description || '-'}</td>
                            ${deleteCell}
                        </tr>
                    `;
                }).join('');

                return items.length
                    ? `
                        <table class="time-table">
                            <thead><tr>${headerCols}</tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    `
                    : '<div class="empty-state"><p>Zadne vykazane hodiny.</p></div>';
            };

            const grouped = new Map();
            entries.forEach((entry) => {
                const key = entry.clientId || 'unknown';
                if (!grouped.has(key)) grouped.set(key, []);
                grouped.get(key).push(entry);
            });
            const selectedClientIds = filters.clientIds.includes('all')
                ? []
                : filters.clientIds.filter((id) => id && id !== 'all');
            const clientIds = selectedClientIds.length ? selectedClientIds : Array.from(grouped.keys());
            const sortedClientIds = clientIds.sort((a, b) => {
                const nameA = (clients.find(c => c.id === a)?.name || a || '').toLowerCase();
                const nameB = (clients.find(c => c.id === b)?.name || b || '').toLowerCase();
                return nameA.localeCompare(nameB, 'cs');
            });
            const multiClient = sortedClientIds.length > 1;

            if (!multiClient) {
                const tableHtml = buildTableHtml(expandedEntries, true);
                container.innerHTML = `
                    <div class="report-sheet report-sheet-wide">
                        <div class="report-sheet-header">
                            <div>
                                <div class="report-sheet-title">${reportTitle} <span class="report-live">live</span></div>
                                <div class="report-sheet-subtitle">Vytvoril ${creator}${creatorSuffix}</div>
                            </div>
                            <div class="report-sheet-logo">CX.TECH</div>
                        </div>
                        <div class="report-sheet-toolbar">
                            <button class="btn-small" onclick="showReportList()">Zpet na seznam</button>
                        </div>
                        <div class="report-sheet-meta">
                            <div class="report-meta-item"><span>Klient</span><div>${clientLabel}</div></div>
                            <div class="report-meta-item"><span>Uzivatel</span><div>${techLabel}</div></div>
                            <div class="report-meta-item"><span>Obdobi</span><div>${rangeLabel}</div></div>
                            <div class="report-meta-item"><span>Bloky 30m</span><div>${expandedEntries.length}</div></div>
                        </div>
                        <div class="report-sheet-totals">
                            <div>Celkem hodin: ${totalHoursLabel} h</div>
                            <div>Report pripraven</div>
                        </div>
                        ${tableHtml}
                    </div>
                `;
                return;
            }

            const gridCards = sortedClientIds.map((clientId) => {
                const items = grouped.get(clientId) || [];
                const expandedItems = splitReportEntries(items);
                const clientName = clients.find(c => c.id === clientId)?.name || (clientId === 'unknown' ? 'Neprirazeny klient' : '-');
                const total = items.reduce((sum, entry) => sum + (parseFloat(entry.hours) || 0), 0);
                const totalLabel = Number.isFinite(total) ? (Math.round(total * 100) / 100).toString() : '0';
                const tableHtml = buildTableHtml(expandedItems, false);
                return `
                    <div class="report-sheet report-sheet-compact">
                        <div class="report-sheet-header">
                            <div>
                                <div class="report-sheet-title">${clientName}</div>
                                <div class="report-sheet-subtitle">${reportTitle}</div>
                            </div>
                            <div class="report-sheet-logo">CX.TECH</div>
                        </div>
                        <div class="report-sheet-meta">
                            <div class="report-meta-item"><span>Uzivatel</span><div>${techLabel}</div></div>
                            <div class="report-meta-item"><span>Obdobi</span><div>${rangeLabel}</div></div>
                            <div class="report-meta-item"><span>Bloky 30m</span><div>${expandedItems.length}</div></div>
                            <div class="report-meta-item"><span>Hodin</span><div>${totalLabel}</div></div>
                        </div>
                        <div class="report-sheet-totals">
                            <div>Celkem hodin: ${totalLabel} h</div>
                            <div>Report pripraven</div>
                        </div>
                        ${tableHtml}
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="report-grid-stack">
                    <div class="report-sheet report-sheet-wide report-sheet-compact">
                        <div class="report-sheet-header">
                            <div>
                                <div class="report-sheet-title">${reportTitle} <span class="report-live">live</span></div>
                                <div class="report-sheet-subtitle">Vytvoril ${creator}</div>
                            </div>
                            <div class="report-sheet-logo">CX.TECH</div>
                        </div>
                        <div class="report-sheet-toolbar">
                            <button class="btn-small" onclick="showReportList()">Zpet na seznam</button>
                        </div>
                        <div class="report-sheet-meta">
                            <div class="report-meta-item"><span>Klienti</span><div>${clientLabel}</div></div>
                            <div class="report-meta-item"><span>Uzivatel</span><div>${techLabel}</div></div>
                            <div class="report-meta-item"><span>Obdobi</span><div>${rangeLabel}</div></div>
                            <div class="report-meta-item"><span>Polozky</span><div>${entries.length}</div></div>
                        </div>
                        <div class="report-sheet-totals">
                            <div>Celkem hodin: ${totalHoursLabel} h</div>
                            <div>Report pripraven</div>
                        </div>
                    </div>
                    <div class="report-grid">
                        ${gridCards}
                    </div>
                </div>
            `;
        }

        async function saveTimeEntryRange() {
            if (!canManageTimeEntries()) {
                alert('Nemate opravneni zapisovat hodiny');
                return;
            }
            const user = requireAuth();
            const clientSelect = document.getElementById('timeEntryClient');
            const activityInput = document.getElementById('timeEntryActivity');
            const startInput = document.getElementById('timeEntryStart');
            const endInput = document.getElementById('timeEntryEnd');
            const hoursInput = document.getElementById('timeEntryHours');
            const descInput = document.getElementById('timeEntryDesc');
            const categorySelect = document.getElementById('timeEntryCategory');
            const ticketSelect = document.getElementById('timeEntryTicket');
            const clientId = clientSelect ? clientSelect.value : currentClientId;
            const activity = activityInput ? activityInput.value.trim() : '';
            const start = startInput ? startInput.value : '';
            const end = endInput ? endInput.value : '';
            const hours = hoursInput ? parseFloat(hoursInput.value) : 0;
            const description = descInput ? descInput.value.trim() : '';
            const categoryType = categorySelect && categorySelect.value ? categorySelect.value : 'client';
            const ticketId = ticketSelect ? ticketSelect.value : '';

            if (!clientId) {
                alert('Vyberte klienta');
                return;
            }
            if (!start || !end || !hours) {
                alert('Vyplnte rozsah a hodiny');
                return;
            }

            const startDate = parseDateKey(start);
            const endDate = parseDateKey(end);
            if (!startDate || !endDate) {
                alert('Neplatny rozsah dat');
                return;
            }

            const min = startDate <= endDate ? startDate : endDate;
            const max = startDate <= endDate ? endDate : startDate;
            const days = Math.floor((max - min) / (1000 * 60 * 60 * 24)) + 1;

            const selection = getTimeSelectionRange();
            let startHour = null;
            let endHour = null;
            if (selection) {
                const block = Math.max(1, Math.ceil(hours));
                startHour = selection.startHour;
                endHour = Math.min(TIME_GRID_END, startHour + block - 1);
            }

            const batch = db.batch();
            for (let i = 0; i < days; i++) {
                const day = new Date(min);
                day.setDate(min.getDate() + i);
                const dateKey = formatDateKey(day);
                const docRef = db.collection('clients')
                    .doc(clientId)
                    .collection('timeEntries')
                    .doc();
                batch.set(docRef, {
                    date: dateKey,
                    hours,
                    description,
                    category: activity,
                    categoryType,
                    ticketId: ticketId || '',
                    startHour,
                    endHour,
                    userId: user.uid,
                    userEmail: user.email || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            try {
                await batch.commit();
                closeTimeEntryModal();
                timeSelectionStart = { date: start, hour: startHour !== null ? startHour : TIME_GRID_START };
                timeSelectionEnd = { date: end, hour: endHour !== null ? endHour : TIME_GRID_START };
                timeSelectionActive = true;
                if (clientId === currentClientId) {
                    loadTimeEntriesForWeek();
                } else {
                    alert('Zapis ulozen. Pro zobrazeni prepnout na vybraneho klienta.');
                }
            } catch (err) {
                console.error('Time entry save failed:', err);
                alert('Chyba pri ukladani hodin: ' + err.message);
            }
        }

        async function deleteTimeEntry(entryId) {
            if (!canManageTimeEntries()) return;
            if (!currentClientId) return;
            try {
                await db.collection('clients')
                    .doc(currentClientId)
                    .collection('timeEntries')
                    .doc(entryId)
                    .delete();
                loadTimeEntriesForWeek();
            } catch (err) {
                console.error('Time entry delete failed:', err);
                alert('Chyba pri mazani: ' + err.message);
            }
        }

        async function deleteReportEntry(entryId, clientId) {
            if (!canManageTimeEntries()) return;
            const targetClientId = clientId || currentClientId;
            if (!targetClientId) return;
            try {
                await db.collection('clients')
                    .doc(targetClientId)
                    .collection('timeEntries')
                    .doc(entryId)
                    .delete();
                loadReportEntries();
            } catch (err) {
                console.error('Report entry delete failed:', err);
                alert('Chyba pri mazani: ' + err.message);
            }
        }

        function exportTimeReport() {
            if (timeViewAllClients) {
                alert('Export funguje jen pro jednoho klienta.');
                return;
            }
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            const entries = getFilteredTimeEntries();
            const weekLabel = document.getElementById('timeCalendarTitle')?.textContent || '';
            const tableRows = entries.map(entry => `
                <tr>
                    <td>${entry.date || '-'}</td>
                    <td>${entry.hours || 0}</td>
                    <td>${entry.userEmail || entry.userId || '-'}</td>
                    <td>${entry.category || '-'}</td>
                    <td>${entry.description || '-'}</td>
                </tr>
            `).join('');

            const reportHtml = `
                <h1>Vykaz hodin - ${weekLabel}</h1>
                <p>Klient: ${clients.find(c => c.id === currentClientId)?.name || '-'}</p>
                <table>
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Hodiny</th>
                            <th>Uzivatel</th>
                            <th>Cinnost</th>
                            <th>Popis</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows || '<tr><td colspan="6">Zadne zaznamy</td></tr>'}
                    </tbody>
                </table>
            `;

            const printWindow = window.open('', '_blank', 'width=900,height=700');
            if (!printWindow) {
                alert('Pro export povolte vyskakovaci okna.');
                return;
            }
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Vykaz hodin</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 24px; color: #111; }
                            h1 { margin-bottom: 8px; }
                            table { width: 100%; border-collapse: collapse; margin-top: 16px; }
                            th, td { border: 1px solid #ccc; padding: 8px; font-size: 12px; text-align: left; }
                            th { background: #f1f1f1; }
                        </style>
                    </head>
                    <body>${reportHtml}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        function buildAdminReportHtml(entries, filters) {
            const normalized = normalizeReportFilters(filters);
            const clientLabel = formatReportClientLabel(normalized.clientIds);
            const techLabel = formatReportTechnicianLabel(normalized.technicians);
            const periodLabel = `${normalized.startDate || '-'} - ${normalized.endDate || '-'}`;

            const tableRows = entries.map(entry => `
                <tr>
                    <td>${entry.date || '-'}</td>
                    <td>${entry.clientName || (clients.find(c => c.id === entry.clientId)?.name) || '-'}</td>
                    <td>${entry.hours || 0}</td>
                    <td>${entry.userEmail || entry.userId || '-'}</td>
                    <td>${entry.category || '-'}</td>
                    <td>${entry.description || '-'}</td>
                </tr>
            `).join('');

            return `
                <h1>Live reporty</h1>
                <p>Obdobi: ${periodLabel}</p>
                <p>Klient: ${clientLabel}</p>
                <p>Technik: ${techLabel}</p>
                <table>
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Klient</th>
                            <th>Hodiny</th>
                            <th>Technik</th>
                            <th>Cinnost</th>
                            <th>Popis</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows || '<tr><td colspan="6">Zadne zaznamy</td></tr>'}
                    </tbody>
                </table>
            `;
        }

        function openReportPrintWindow(reportHtml) {
            const printWindow = window.open('', '_blank', 'width=900,height=700');
            if (!printWindow) {
                alert('Pro export povolte vyskakovaci okna.');
                return;
            }
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Live reporty</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 24px; color: #111; }
                            h1 { margin-bottom: 8px; }
                            table { width: 100%; border-collapse: collapse; margin-top: 16px; }
                            th, td { border: 1px solid #ccc; padding: 8px; font-size: 12px; text-align: left; }
                            th { background: #f1f1f1; }
                        </style>
                    </head>
                    <body>${reportHtml}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        async function exportAdminReport() {
            if (!canViewReports()) {
                alert('Nemate opravneni zobrazit reporty');
                return;
            }
            ensureReportFilterDefaults();
            const filters = getReportFilters();
            const entries = getFilteredReportEntries();
            openReportPrintWindow(buildAdminReportHtml(entries, filters));
        }

        async function exportAllClientsReport() {
            if (!canViewReports()) {
                alert('Nemate opravneni zobrazit reporty');
                return;
            }
            ensureReportFilterDefaults();
            const filters = normalizeReportFilters({ ...getReportFilters(), clientIds: ['all'] });
            try {
                const entries = await fetchReportEntries(filters);
                openReportPrintWindow(buildAdminReportHtml(entries, filters));
            } catch (err) {
                console.warn('Export all clients failed:', err);
                alert('Export selhal.');
            }
        }
        
        // Update statistics
        function updateStats() {
            document.getElementById('totalDevices').textContent = devices.length;
            document.getElementById('totalRacks').textContent = racks.length;
            
            const totalUnits = racks.reduce((sum, rack) => sum + rack.units, 0);
            const usedUnits = devices.reduce((sum, device) => sum + device.height, 0);
            
            document.getElementById('usedUnits').textContent = usedUnits;
            document.getElementById('freeUnits').textContent = totalUnits - usedUnits;
        }
        
        // Modal functions
        function openRackModal() {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            if (!canManageRacks()) {
                alert('Nemate opravneni spravovat racky');
                return;
            }
            document.getElementById('rackModal').classList.add('active');
        }
        
        function closeRackModal() {
            document.getElementById('rackModal').classList.remove('active');
            clearRackForm();
        }
        
        function openDeviceModal() {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            if (!canManageDevices()) {
                alert('Nemate opravneni spravovat zarizeni');
                return;
            }
            if (racks.length === 0) {
                alert('Nejprve vytvorte rack');
                return;
            }

            const select = document.getElementById('deviceRack');
            select.innerHTML = racks.map(rack => 
                `<option value="${rack.id}">${rack.name}</option>`
            ).join('');

            renderDeviceTypeOptions();
            document.getElementById('deviceModal').classList.add('active');
        }
        
        function closeDeviceModal() {
            document.getElementById('deviceModal').classList.remove('active');
            clearDeviceForm();
        }
        
        // Add rack
        function addRack() {
            if (!canManageRacks()) {
                alert('Nemate opravneni spravovat racky');
                return;
            }
            const name = document.getElementById('rackName').value;
            const units = parseInt(document.getElementById('rackUnits').value);
            const location = document.getElementById('rackLocation').value;
            
            if (!name || !units) {
                alert('Vyplte vechny povinn daje');
                return;
            }
            
            const rack = {
                id: Date.now().toString(),
                name,
                units,
                location
            };
            
            racks.push(rack);
            saveData();
            render();
            closeRackModal();
        }
        
        // Add device
        function addDevice() {
            if (!canManageDevices()) {
                alert('Nemate opravneni spravovat zarizeni');
                return;
            }
            const name = document.getElementById('deviceName').value;
            const type = document.getElementById('deviceType').value;
            const rack = document.getElementById('deviceRack').value;
            const position = parseInt(document.getElementById('devicePosition').value);
            const height = parseInt(document.getElementById('deviceHeight').value);
            const ip = document.getElementById('deviceIP').value;
            const model = document.getElementById('deviceModel').value;
            const serial = document.getElementById('deviceSerial').value;
            const ports = parseInt(document.getElementById('devicePorts').value) || 24;
            
            if (!name || !rack || !position) {
                alert('Vyplte vechny povinn daje');
                return;
            }
            
            // Check if position is available
            const rackObj = racks.find(r => r.id === rack);
            if (position + height - 1 > rackObj.units) {
                alert('Zazen se nevejde do racku');
                return;
            }
            
            const existingDevices = devices.filter(d => d.rack === rack);
            for (let device of existingDevices) {
                if ((position >= device.position && position < device.position + device.height) ||
                    (position + height > device.position && position + height <= device.position + device.height)) {
                    alert('Pozice je ji obsazena');
                    return;
                }
            }
            
            const device = {
                id: Date.now().toString(),
                name,
                type,
                rack,
                position,
                height,
                ip,
                model,
                serial,
                ports
            };
            
            devices.push(device);
            saveData();
            render();
            closeDeviceModal();
        }
        
        // Delete device
        function deleteDevice(id) {
            if (!canManageDevices()) {
                alert('Nemate opravneni spravovat zarizeni');
                return;
            }
            if (confirm('Opravdu chcete smazat toto zazen?')) {
                devices = devices.filter(d => d.id !== id);
                connections = connections.filter(c => c.fromDevice !== id && c.toDevice !== id);
                saveData();
                render();
            }
        }
        
        // Clear forms
        function clearRackForm() {
            document.getElementById('rackName').value = '';
            document.getElementById('rackUnits').value = '42';
            document.getElementById('rackLocation').value = '';
        }
        
        function clearDeviceForm() {
            document.getElementById('deviceName').value = '';
            document.getElementById('deviceType').value = moduleTypes.length ? moduleTypes[0].id : '';
            document.getElementById('devicePosition').value = '';
            document.getElementById('deviceHeight').value = '1';
            document.getElementById('deviceIP').value = '';
            document.getElementById('deviceModel').value = '';
            document.getElementById('deviceSerial').value = '';
            document.getElementById('devicePorts').value = '24';
        }
        
        // Clear all data
        function clearAllRacks() {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            if (!canDeleteRacks()) {
                alert('Nemate opravneni mazat racky');
                return;
            }

            const client = clients.find(c => c.id === currentClientId);
            if (confirm(`Opravdu chcete smazat vsechna data klienta "${client.name}"? Tato akce je nevratna.`)) {
                racks = [];
                devices = [];
                connections = [];
                saveData();
                render();
            }
        }
        
        // Export data
        function exportData() {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            
            const client = clients.find(c => c.id === currentClientId);
            const data = {
                client: client,
                racks,
                devices,
                connections,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rack-manager-${client.name.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Import data
        function importData(event) {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta pro import dat');
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.racks && data.devices) {
                        const client = clients.find(c => c.id === currentClientId);
                        if (confirm(`Import pepe vechna stvajc data klienta "${client.name}". Pokraovat?`)) {
                            racks = data.racks || [];
                            devices = data.devices || [];
                            connections = data.connections || [];
                            saveData();
                            render();
                            alert('Data spn importovna');
                        }
                    } else {
                        alert('Neplatn formt souboru');
                    }
                } catch (err) {
                    alert('Chyba pi importu: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
        
        // ==========================================
        // Firestore Data Functions
        // ==========================================
        
        // Save to Firestore
        function saveToFirebase() {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            
            const client = clients.find(c => c.id === currentClientId);
            if (!client) return;
            
            const dataToSave = {
                client: client,
                racks: racks,
                devices: devices,
                connections: connections,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAtMs: Date.now(),
                savedBy: auth && auth.currentUser ? auth.currentUser.email : 'anonymous'
            };
            
            const clientRef = db.collection('clients').doc(currentClientId);
            
            clientRef.set(dataToSave, { merge: true })
                .then(() => {
                    console.log(' Data saved to Firestore');
                    alert('Data uspesne ulozena do Firestore!');
                    saveData();
                    localStorage.setItem('cxtech_lastUpdate_' + currentClientId, String(Date.now()));
                })
                .catch((error) => {
                    console.error(' Firestore save error:', error);
                    alert('Chyba pri ukladani do Firestore: ' + error.message);
                });
        }
        
        // Load from Firestore
        function loadFromFirebase() {
            if (!currentClientId) {
                alert('Nejprve vyberte klienta');
                return;
            }
            
            const clientRef = db.collection('clients').doc(currentClientId);
            
            clientRef.get()
                .then((doc) => {
                    if (!doc.exists) {
                        alert('Pro tohoto klienta nejsou ve Firestore zadna data');
                        return;
                    }

                    const data = doc.data() || {};
                    
                    if (data.racks) racks = data.racks;
                    if (data.devices) devices = data.devices;
                    if (data.connections) connections = data.connections;
                    
                    saveData();
                    render();
                    localStorage.setItem('cxtech_lastUpdate_' + currentClientId, String(Date.now()));
                    
                    console.log(' Data loaded from Firestore');
                    alert('Data nactena z Firestore!');
                })
                .catch((error) => {
                    console.error(' Firestore load error:', error);
                    alert('Chyba pri nacitani z Firestore: ' + error.message);
                });
        }
        
        // Firestore sync is intentionally disabled (manual save/load only)
        function setupRealtimeSync() {
            return;
        }

        function getLocalGlobalUpdatedAt() {
            return parseInt(localStorage.getItem('rackManagerGlobalUpdatedAtMs') || '0', 10) || 0;
        }

        function setLocalGlobalUpdatedAt(value) {
            if (!value) return;
            localStorage.setItem('rackManagerGlobalUpdatedAtMs', String(value));
        }

        function hasLocalData() {
            try {
                const list = JSON.parse(localStorage.getItem('rackManagerClients') || '[]');
                const tickets = JSON.parse(localStorage.getItem('rackManagerHelpdeskTickets') || '[]');
                return (Array.isArray(list) && list.length > 0) || (Array.isArray(tickets) && tickets.length > 0);
            } catch (err) {
                return false;
            }
        }

        function applyCloudData(data, silent) {
            const payload = data || {};
            const cloudClients = payload.clients || [];
            const cloudClientData = payload.clientData || {};
            const cloudLastClientId = payload.lastClientId || null;
            const cloudM365Config = payload.m365Config || null;
            const hasHelpdeskTickets = Object.prototype.hasOwnProperty.call(payload, 'helpdeskTickets');
            const cloudHelpdeskTickets = payload.helpdeskTickets || [];

            localStorage.setItem('rackManagerClients', JSON.stringify(cloudClients));
            localStorage.setItem('rackManagerClientData', JSON.stringify(cloudClientData));
            if (hasHelpdeskTickets) {
                localStorage.setItem('rackManagerHelpdeskTickets', JSON.stringify(cloudHelpdeskTickets));
            }
            if (cloudLastClientId) {
                localStorage.setItem('rackManagerLastClient', cloudLastClientId);
            } else {
                localStorage.removeItem('rackManagerLastClient');
            }
            if (cloudM365Config) {
                localStorage.setItem('rackManagerM365Config', JSON.stringify(cloudM365Config));
            }
            setLocalGlobalUpdatedAt(payload.updatedAtMs || 0);

            if (typeof init === 'function') {
                init();
            }
            if (!silent) {
                alert('Data byla nactena z Firestore');
            }
        }

        function scheduleCloudSave() {
            if (!window.db || !window.auth || !auth.currentUser) return;
            if (cloudSaveTimer) clearTimeout(cloudSaveTimer);
            cloudSaveTimer = setTimeout(function() {
                saveToCloud(true);
            }, 1200);
        }
        
        // Add Firebase status indicator to UI
        function addFirebaseStatusIndicator() {
            const header = document.querySelector('.topbar');
            if (header && !document.getElementById('firebaseStatus')) {
                const statusDiv = document.createElement('div');
                statusDiv.id = 'firebaseStatus';
                statusDiv.style.cssText = 'font-size: 0.85rem; font-weight: 600; color: #b0b0b0;';
                statusDiv.innerHTML = 'Connecting...';
                header.appendChild(statusDiv);
            }
        }
        
        // Call on init
        addFirebaseStatusIndicator();
        window.addEventListener('load', init);
    </script>
   <!-- Firebase Auth + Firestore -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script>
  var auth;
  var db;

  // Load Firebase config from /api/config (Vercel env)
  async function loadFirebaseConfig() {
    var res = await fetch('/api/config');
    if (!res.ok) {
      throw new Error('Firebase config load failed');
    }
    return await res.json();
  }

  loadFirebaseConfig().then(function(firebaseConfig) {
    firebase.initializeApp(firebaseConfig);
    console.log('Firebase initialized for CX.TECH Rack Manager');

    auth = firebase.auth();
    db = firebase.firestore();
    window.auth = auth;
    window.db = db;

    function isLocalHost() {
      return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    }

    function updateLocalAdminUI(enabled) {
      var statusEl = document.getElementById('authStatus');
      var overlay = document.getElementById('authOverlay');
      var avatarEl = document.getElementById('userMenuAvatar');
      if (enabled) {
        if (statusEl) statusEl.textContent = 'Local admin';
        if (avatarEl) avatarEl.textContent = 'LA';
        if (overlay) overlay.classList.add('hidden');
        document.body.classList.remove('auth-locked');
        if (window.setCurrentRole) {
          window.setCurrentRole('admin');
        } else {
          setCurrentRole('admin');
        }
        if (window.switchView) {
          switchView('dashboard');
        }
      }
    }

    function enableLocalAdmin() {
      if (!isLocalHost()) return;
      localStorage.setItem('localAdmin', 'true');
      updateLocalAdminUI(true);
    }

    function isLocalAdminActive() {
      return isLocalHost() && localStorage.getItem('localAdmin') === 'true';
    }

    if (isLocalHost() && localStorage.getItem('localAdmin') === null) {
      localStorage.setItem('localAdmin', 'true');
    }

    var localAdminBtn = document.getElementById('localAdminBtn');
    if (localAdminBtn && isLocalHost()) {
      localAdminBtn.style.display = 'inline-block';
    }

    var statusElem = document.getElementById('firebaseStatus');
    if (statusElem) {
      statusElem.innerHTML = 'Ready';
      statusElem.style.color = '#4ade80';
    }

    // --- UI pro prihlaseni ---
    function updateAuthUI(user) {
      var statusEl = document.getElementById('authStatus');
      var loginBtn = document.getElementById('loginBtn');
      var loginMicrosoftBtn = document.getElementById('loginMicrosoftBtn');
      var loginMicrosoftOverlayBtn = document.getElementById('loginMicrosoftOverlayBtn');
      var userMenuLogout = document.getElementById('userMenuLogout');
      var logoutBtn = document.getElementById('logoutBtn');
      var overlay = document.getElementById('authOverlay');
      var avatarEl = document.getElementById('userMenuAvatar');
      var m365Config = window.getM365Config ? window.getM365Config() : null;
      var allowM365 = !m365Config || m365Config.enabled !== false;

      if (!statusEl || !loginBtn || !logoutBtn) return;

      if (!user && isLocalAdminActive()) {
        updateLocalAdminUI(true);
        loginBtn.style.display = 'none';
        if (loginMicrosoftBtn) loginMicrosoftBtn.style.display = 'none';
        if (loginMicrosoftOverlayBtn) loginMicrosoftOverlayBtn.style.display = allowM365 ? 'block' : 'none';
        logoutBtn.style.display = 'none';
        if (userMenuLogout) userMenuLogout.style.display = 'none';
        if (window.applyRolePermissions) {
          window.applyRolePermissions();
        }
        return;
      }

      if (user) {
        var providerData = user.providerData || [];
        var providerId = providerData[0] ? providerData[0].providerId : '';
        var hasMicrosoft = providerData.some(function(item) { return item.providerId === 'microsoft.com'; });
        if (!hasMicrosoft) {
          clearM365AccessToken();
        }
        var providerName = providerId === 'google.com'
          ? 'Google'
          : providerId === 'microsoft.com'
            ? 'Microsoft 365'
            : providerId === 'password'
              ? 'Magic link'
              : providerId || '';
        statusEl.textContent = 'Prihlasen: ' + (user.email || user.uid) + (providerName ? ' (' + providerName + ')' : '');
        loginBtn.style.display = 'none';
        if (loginMicrosoftBtn) loginMicrosoftBtn.style.display = 'none';
        if (loginMicrosoftOverlayBtn) loginMicrosoftOverlayBtn.style.display = allowM365 ? 'block' : 'none';
        logoutBtn.style.display = 'inline-block';
        if (userMenuLogout) userMenuLogout.style.display = 'flex';
        if (avatarEl) {
          var label = user.displayName || user.email || user.uid || '';
          var parts = label.split(/\s+|@/).filter(Boolean);
          var initials = parts.slice(0, 2).map(function(part) { return part[0]; }).join('').toUpperCase();
          avatarEl.textContent = initials || 'UA';
        }
        if (overlay) overlay.classList.add('hidden');
        document.body.classList.remove('auth-locked');
        if (window.switchView) {
          switchView('dashboard');
        }
        if (window.reportHasLoaded !== undefined) {
          reportHasLoaded = false;
        }
        if (window.reportFiltersVisible !== undefined) {
          reportFiltersVisible = false;
        }
        if (window.loadReportPresetsFromCloud) {
          loadReportPresetsFromCloud(true);
        }
        if (window.loadSharedReportPresets) {
          loadSharedReportPresets(true);
        }
        if (window.applyReportShareFromUrl) {
          applyReportShareFromUrl();
        }
      } else {
        clearM365AccessToken();
        statusEl.textContent = 'Neprihlasen';
        loginBtn.style.display = 'inline-block';
        if (loginMicrosoftBtn) loginMicrosoftBtn.style.display = allowM365 ? 'inline-block' : 'none';
        if (loginMicrosoftOverlayBtn) loginMicrosoftOverlayBtn.style.display = allowM365 ? 'block' : 'none';
        logoutBtn.style.display = 'none';
        if (userMenuLogout) userMenuLogout.style.display = 'none';
        if (avatarEl) avatarEl.textContent = 'NA';
        if (overlay) overlay.classList.remove('hidden');
        document.body.classList.add('auth-locked');
        if (window.reportPresetsLoaded !== undefined) {
          reportPresetsLoaded = false;
        }
        if (window.reportHasLoaded !== undefined) {
          reportHasLoaded = false;
        }
        if (window.reportFiltersVisible !== undefined) {
          reportFiltersVisible = false;
        }
        if (window.reportSharedLoaded !== undefined) {
          reportSharedLoaded = false;
          sharedReportPresets = [];
          buildSharedReportOptions();
        }
      }
      if (window.applyRolePermissions) {
        window.applyRolePermissions();
      }
      if (window.renderTeamsView && typeof currentView !== 'undefined' && currentView === 'teams') {
        renderTeamsView();
      }
    }

    function loginWithGoogle() {
      var provider = new firebase.auth.GoogleAuthProvider();
      var allowedDomains = window.getAllowedDomains ? window.getAllowedDomains() : [];
      if (allowedDomains.length === 1) {
        provider.setCustomParameters({ hd: allowedDomains[0] });
      }
      auth.signInWithPopup(provider).catch(function (error) {
        if (handleAccountLinking(error)) {
          return;
        }
        console.error('Auth error:', error);
        alert('Chyba pri prihlaseni: ' + error.message);
      });
    }

    function getCredentialFromAuthError(error) {
      if (!error) return null;
      if (error.credential) return error.credential;
      if (firebase.auth && firebase.auth.OAuthProvider && typeof firebase.auth.OAuthProvider.credentialFromError === 'function') {
        return firebase.auth.OAuthProvider.credentialFromError(error);
      }
      return null;
    }

    function handleAccountLinking(error) {
      if (!error || error.code !== 'auth/account-exists-with-different-credential') return false;
      var email = error.email;
      var pendingCred = getCredentialFromAuthError(error);
      if (!email || !pendingCred) {
        alert('Ucet uz existuje pod jinym prihlasenim. Prihlaste se puvodnim providerem a propojte ucty.');
        return true;
      }
      auth.fetchSignInMethodsForEmail(email)
        .then(function(methods) {
          if (!methods || methods.length === 0) {
            var domainInfo = '';
            if (window.isDomainAllowed && !window.isDomainAllowed(email)) {
              domainInfo = ' Email je mimo povolene domeny.';
            }
            if (pendingCred) {
              return auth.signInWithCredential(pendingCred)
                .then(function() {
                  alert('Prihlaseni bylo obnoveno primo z Microsoft kredencialu.');
                })
                .catch(function(err) {
                  console.error('Credential sign-in error:', err);
                  alert('Nenasel jsem existujici metodu prihlaseni pro tento email (' + email + ').' + domainInfo + ' Pokud byl ucet smazan ve Firebase Auth, zkuste ho odstranit i z providers a prihlasit se znovu.');
                });
            }
            alert('Nenasel jsem existujici metodu prihlaseni pro tento email (' + email + ').' + domainInfo);
            return;
          }
          var method = methods[0];
          if (method === 'google.com') {
            var googleProvider = new firebase.auth.GoogleAuthProvider();
            var allowed = window.getAllowedDomains ? window.getAllowedDomains() : [];
            if (allowed.length === 1) {
              googleProvider.setCustomParameters({ hd: allowed[0] });
            }
            return auth.signInWithPopup(googleProvider)
              .then(function(result) {
                if (!result || !result.user) return;
                return result.user.linkWithCredential(pendingCred);
              })
              .then(function() {
                alert('Ucet byl propojen. Nyni se muzete prihlasit pres oba providery.');
              });
          }
          if (method === 'microsoft.com') {
            var config = window.getM365Config ? window.getM365Config() : null;
            var provider = new firebase.auth.OAuthProvider('microsoft.com');
            var scopes = [];
            if (config && config.scopes) {
              scopes = config.scopes.split(/[\s,]+/).filter(Boolean);
            }
            if (scopes.length === 0) {
              scopes = ['openid', 'profile', 'email', 'offline_access', 'User.Read'];
            }
            scopes.forEach(function(scope) {
              provider.addScope(scope);
            });
            var linkParams = { prompt: 'select_account' };
            if (config && config.tenantId) {
              linkParams.tenant = config.tenantId;
            }
            if (email) {
              linkParams.login_hint = email;
            }
            provider.setCustomParameters(linkParams);
            return auth.signInWithPopup(provider)
              .then(function(result) {
                if (!result || !result.user) return;
                return result.user.linkWithCredential(pendingCred);
              })
              .then(function() {
                alert('Ucet byl propojen. Nyni se muzete prihlasit pres oba providery.');
              });
          }
          if (method === 'password') {
            alert('Tento ucet pouziva magic link. Prihlaste se magic linkem a pote zkuste M365 znovu.');
            return;
          }
          alert('Ucet uz existuje pod jinym providerem: ' + method);
        })
        .catch(function(err) {
          console.error('Linking error:', err);
          alert('Chyba pri propojovani uctu: ' + (err.message || err));
        });
      return true;
    }

    function getM365TenantFromResult(result) {
      if (!result || !result.additionalUserInfo || !result.additionalUserInfo.profile) return '';
      var profile = result.additionalUserInfo.profile;
      return profile.tid || profile.tenantId || profile.tenant_id || profile.tenant || '';
    }

    function getTenantFromAccessToken(token) {
      if (!token) return '';
      try {
        var parts = token.split('.');
        if (parts.length < 2) return '';
        var payload = parts[1].replace(/-/g, '+').replace(/_/g, '/');
        var json = atob(payload);
        var data = JSON.parse(json);
        return data.tid || data.tenant || '';
      } catch (err) {
        return '';
      }
    }

    function validateM365Tenant(result) {
      var config = window.getM365Config ? window.getM365Config() : null;
      if (!config || !config.tenantId) {
        console.log('[M365] Tenant check skipped (no tenantId configured).');
        return true;
      }
      if (!window.isGuid || !window.isGuid(config.tenantId)) {
        console.warn('Tenant ID format invalid, skip validation.');
        return true;
      }
      var expected = (config.tenantId || '').toLowerCase();
      var actual = (getM365TenantFromResult(result) || '').toLowerCase();
      if (!actual) {
        var token = '';
        if (result && result.credential && result.credential.accessToken) {
          token = result.credential.accessToken;
        } else {
          token = getM365AccessToken();
        }
        actual = (getTenantFromAccessToken(token) || '').toLowerCase();
      }
      console.log('[M365] Tenant check', { expected: expected, actual: actual });
      if (!actual) {
        alert('Nepodarilo se overit tenant ID z Microsoft prihlaseni.');
        return false;
      }
      if (actual !== expected) {
        alert('Prihlaseni z jineho tenantu neni povoleno.');
        return false;
      }
      return true;
    }

    function handleM365AuthResult(result) {
      if (!result || !result.user) return;
      var providerId = result.additionalUserInfo && result.additionalUserInfo.providerId
        ? result.additionalUserInfo.providerId
        : '';
      if (providerId !== 'microsoft.com') return;
      var accessToken = '';
      if (result && result.credential && result.credential.accessToken) {
        accessToken = result.credential.accessToken;
      } else if (firebase.auth && firebase.auth.OAuthProvider && typeof firebase.auth.OAuthProvider.credentialFromResult === 'function') {
        var credential = firebase.auth.OAuthProvider.credentialFromResult(result);
        accessToken = credential && credential.accessToken ? credential.accessToken : '';
      }
      if (accessToken) {
        setM365AccessToken(accessToken);
      }
      console.log('[M365] Auth result', {
        providerId: providerId,
        tenantId: getM365TenantFromResult(result)
      });
      if (!validateM365Tenant(result)) {
        auth.signOut();
      }
    }

    function getTeamsRequiredScopes() {
      return [
        'Chat.ReadWrite',
        'Chat.Create',
        'ChatMember.Read.All',
        'ChannelMessage.Read.All',
        'ChannelMessage.Send',
        'Team.ReadBasic.All',
        'Channel.ReadBasic.All',
        'Channel.Create',
        'User.Read.All',
        'Files.Read.All',
        'Sites.Read.All'
      ];
    }

    function mergeScopes(baseScopes, extraScopes) {
      var combined = (baseScopes || []).concat(extraScopes || []);
      var seen = {};
      return combined.filter(function(scope) {
        if (!scope) return false;
        if (seen[scope]) return false;
        seen[scope] = true;
        return true;
      });
    }

    function loginWithMicrosoft(options) {
      var opts = options || {};
      var config = window.getM365Config ? window.getM365Config() : null;
      if (config && config.enabled === false) {
        alert('M365 prihlaseni je vypnute v nastaveni.');
        return;
      }
      var tenantToUse = config && config.tenantId ? config.tenantId : '';
      var tenantSource = 'config';
      if (!tenantToUse && window.getAllowedDomains) {
        var domains = window.getAllowedDomains();
        if (domains && domains.length === 1) {
          tenantToUse = domains[0];
          tenantSource = 'allowed-domain';
        }
      }
      console.log('[M365] Login start', {
        tenantId: tenantToUse,
        tenantSource: tenantToUse ? tenantSource : 'common',
        redirectUri: config ? config.redirectUri : '',
        scopes: config ? config.scopes : ''
      });
      var provider = new firebase.auth.OAuthProvider('microsoft.com');
      var scopes = [];
      if (config && config.scopes) {
        scopes = config.scopes.split(/[\s,]+/).filter(Boolean);
      }
      if (scopes.length === 0) {
        scopes = ['openid', 'profile', 'email', 'offline_access', 'User.Read'];
      }
      if (opts.includeTeams) {
        scopes = mergeScopes(scopes, getTeamsRequiredScopes());
      }
      scopes.forEach(function(scope) {
        provider.addScope(scope);
      });
      var customParams = { prompt: opts.forceConsent ? 'consent' : 'select_account' };
      if (tenantToUse) {
        customParams.tenant = tenantToUse;
      }
      if (opts.loginHint) {
        customParams.login_hint = opts.loginHint;
      }
      provider.setCustomParameters(customParams);
      auth.signInWithPopup(provider)
        .then(function(result) {
          handleM365AuthResult(result);
        })
        .catch(function (error) {
          if (handleAccountLinking(error)) {
            return;
          }
          var code = error && error.code ? error.code : '';
          if (code === 'auth/popup-blocked' || code === 'auth/cancelled-popup-request') {
            alert('Popup byl blokovan, pouziji presmerovani.');
            auth.signInWithRedirect(provider);
            return;
          }
          console.error('M365 auth error:', error);
          alert('Chyba pri prihlaseni pres Microsoft 365: ' + error.message);
        });
    }

    function sendMagicLink() {
      var input = document.getElementById('emailLoginInput');
      var email = input ? input.value.trim() : '';
      if (!email || !email.includes('@')) {
        alert('Zadejte platny email');
        return;
      }
      if (window.isDomainAllowed && !window.isDomainAllowed(email)) {
        alert('Tato domena nema povoleny pristup.');
        return;
      }
      var actionCodeSettings = {
        url: window.location.origin + window.location.pathname,
        handleCodeInApp: true
      };
      auth.sendSignInLinkToEmail(email, actionCodeSettings)
        .then(function() {
          window.localStorage.setItem('emailForSignIn', email);
          if (input) input.value = '';
          alert('Magic link byl odeslan na e-mail');
        })
        .catch(function(err) {
          console.error('Magic link error:', err);
          alert('Chyba pri odeslani magic linku: ' + err.message);
        });
    }

    if (auth.isSignInWithEmailLink(window.location.href)) {
      var email = window.localStorage.getItem('emailForSignIn');
      if (!email) {
        email = window.prompt('Zadejte email pro dokon?en? p?ihl??en?');
      }
      auth.signInWithEmailLink(email, window.location.href)
        .then(function() {
          window.localStorage.removeItem('emailForSignIn');
          window.history.replaceState({}, document.title, window.location.pathname);
        })
        .catch(function(err) {
          console.error('Email link sign-in error:', err);
          alert('Chyba pri prihlaseni: ' + err.message);
        });
    }

    function logout() {
      auth.signOut().catch(function (error) {
        console.error('Sign-out error:', error);
        alert('Chyba pri odhlaseni: ' + error.message);
      });
    }

    function toggleUserMenu() {
      var panel = document.getElementById('userMenuPanel');
      if (!panel) return;
      panel.classList.toggle('active');
    }

    function closeUserMenu() {
      var panel = document.getElementById('userMenuPanel');
      if (panel) panel.classList.remove('active');
    }

    document.addEventListener('click', function(event) {
      var panel = document.getElementById('userMenuPanel');
      var btn = document.getElementById('userMenuBtn');
      if (!panel || !btn) return;
      if (panel.classList.contains('active') && !panel.contains(event.target) && !btn.contains(event.target)) {
        panel.classList.remove('active');
      }
    });

    auth.onAuthStateChanged(async function (user) {
      if (user && typeof syncCloudOnLogin === 'function') {
        await syncCloudOnLogin();
      }
      if (user && !enforceAllowedDomains(user)) {
        return;
      }
      updateAuthUI(user);
      if (window.onAuthRoleChanged) {
        window.onAuthRoleChanged(user);
      }
    });

    auth.getRedirectResult()
      .then(function(result) {
        handleM365AuthResult(result);
      })
      .catch(function(err) {
        if (err && err.code) {
          console.warn('Redirect auth error:', err.code);
        }
      });

    function requireAuth() {
      var user = auth.currentUser;
      if (!user) {
        alert('Nejprve se prihlaste.');
        throw new Error('NOT_AUTHENTICATED');
      }
      return user;
    }

    function enforceAllowedDomains(user) {
      if (!user || !window.isDomainAllowed) return true;
      var email = user.email || '';
      var allowed = window.getAllowedDomains ? window.getAllowedDomains() : [];
      if (allowed.length === 0) return true;
      if (!email || !window.isDomainAllowed(email)) {
        alert('Pristup je omezen pouze na povolene domeny.');
        auth.signOut();
        return false;
      }
      return true;
    }

    window.loginWithGoogle = loginWithGoogle;
    window.loginWithMicrosoft = loginWithMicrosoft;
    window.sendMagicLink = sendMagicLink;
    window.logout = logout;
    window.toggleUserMenu = toggleUserMenu;
    window.closeUserMenu = closeUserMenu;
    window.requireAuth = requireAuth;
    window.enableLocalAdmin = enableLocalAdmin;
    window.isGuid = isGuid;
    window.updateAuthUI = updateAuthUI;
    window.getAllowedDomains = getAllowedDomains;
    window.isDomainAllowed = isDomainAllowed;
  }).catch(function(err) {
    console.error('Firebase config error:', err);
    alert('Firebase config error: ' + err.message);
  });

  // --- Firestore doc, kde budeme drzet data ---
  var GLOBAL_PATH = "rackManager/global";
  // Ulozit vsechna data z localStorage do Firestore
  async function saveToCloud(silent) {
    try {
      var user = auth && auth.currentUser ? auth.currentUser : null;
      if (!user) {
        if (!silent) {
          alert('Nejprve se prihlaste.');
        }
        return;
      }

      var clients = JSON.parse(localStorage.getItem('rackManagerClients') || '[]');
      var clientData = JSON.parse(localStorage.getItem('rackManagerClientData') || '{}');
      var lastClientId = localStorage.getItem('rackManagerLastClient') || null;
      var m365Config = JSON.parse(localStorage.getItem('rackManagerM365Config') || '{}');
      var helpdeskTickets = JSON.parse(localStorage.getItem('rackManagerHelpdeskTickets') || '[]');

      var payload = {
        clients: clients,
        clientData: clientData,
        lastClientId: lastClientId,
        m365Config: m365Config,
        helpdeskTickets: helpdeskTickets,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAtMs: Date.now(),
        updatedBy: user.email || user.uid
      };

      await db.doc(GLOBAL_PATH).set(payload, { merge: true });
      setLocalGlobalUpdatedAt(payload.updatedAtMs);
      if (!silent) {
        alert('Data byla ulozena do Firestore');
      }
    } catch (err) {
      if (err.message == 'NOT_AUTHENTICATED') return;
      console.error('Chyba pri ukladani:', err);
      if (!silent) {
        alert('Chyba pri ukladani do cloudu: ' + err.message);
      }
    }
  }
  // Nacist vsechna data z Firestore do localStorage
  async function loadFromCloud(silent) {
    try {
      if (!auth || !auth.currentUser) {
        if (!silent) {
          alert('Nejprve se prihlaste.');
        }
        return false;
      }

      var snap = await db.doc(GLOBAL_PATH).get();
      if (!snap.exists) {
        if (!silent) {
          alert('V cloudu zatim nejsou zadna data');
        }
        return false;
      }

      applyCloudData(snap.data() || {}, silent);
      return true;
    } catch (err) {
      if (err.message == 'NOT_AUTHENTICATED') return false;
      console.error('Chyba pri nacitani:', err);
      if (!silent) {
        alert('Chyba pri nacitani z cloudu: ' + err.message);
      }
      return false;
    }
  }

  async function syncCloudOnLogin() {
    try {
      if (!auth || !auth.currentUser || !db) return;
      var snap = await db.doc(GLOBAL_PATH).get();
      if (!snap.exists) {
        if (hasLocalData()) {
          saveToCloud(true);
        }
        return;
      }

      var data = snap.data() || {};
      var remoteUpdated = data.updatedAtMs || 0;
      var localUpdated = getLocalGlobalUpdatedAt();
      if (remoteUpdated >= localUpdated) {
        applyCloudData(data, true);
      } else {
        saveToCloud(true);
      }
    } catch (err) {
      console.warn('Cloud sync failed:', err);
    }
  }
</script>
</body>
</html>
